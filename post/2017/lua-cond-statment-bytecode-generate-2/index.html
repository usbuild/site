<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.42.1" />

  <title>lua 5.1 åˆ†æ”¯è¯­å¥ bytecode çš„ç”Ÿæˆï¼ˆäºŒï¼‰ &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>lua 5.1 åˆ†æ”¯è¯­å¥ bytecode çš„ç”Ÿæˆï¼ˆäºŒï¼‰</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>25 May 2017, 14:26</time>
  </div>

  

  
  
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/lua">lua</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/bytecode">bytecode</a>
    
  </div>
  
  

</div>

  <p>ä¸Šç¯‡æˆ‘ä»¬è°ˆåˆ°äº† IF è¯­å¥çš„ bytecode ç”Ÿæˆï¼Œä»Šå¤©æ¥è°ˆè°ˆå¸ƒå°”è¡¨è¾¾å¼ä¸çŸ­è·¯æ±‚å€¼ã€‚</p>

<p>è€ƒè™‘åˆ°ä¸‹é¢çš„è¡¨è¾¾å¼</p>

<pre><code class="language-lua">a = a or 1024
</code></pre>

<p>å…¶ç”Ÿæˆçš„å­—èŠ‚ç ä¸º</p>

<pre><code>1       [1]     GETGLOBAL       0 -1    ; a
2       [1]     TEST            0 0 1
3       [1]     JMP             1       ; to 5
4       [1]     LOADK           0 -2    ; 1024
5       [1]     SETGLOBAL       0 -1    ; a
6       [1]     RETURN          0 1
</code></pre>

<p>å…¶å®ä¸</p>

<pre><code class="language-lua">if not a then
    a = 1024
end
</code></pre>

<p>ç”Ÿæˆçš„ä»£ç å‡ ä¹ä¸€è‡´ï¼Œåªæ˜¯å°‘äº†åƒè‡ªå·±èµ‹å€¼çš„é‚£éƒ¨åˆ†ã€‚ç°åœ¨æˆ‘ä»¬çœ‹çœ‹è¿™æ¡çŸ­è·¯æ±‚å€¼è¯­å¥çš„å­—èŠ‚ç æ˜¯æ€ä¹ˆç”Ÿæˆçš„ã€‚</p>

<p><code>a = a or 1024</code> è¿™æ˜¯ä¸€ä¸ªèµ‹å€¼è¯­å¥ï¼Œæ‰€ä»¥è°ƒç”¨ä½¿ç”¨çš„æ˜¯<code>assignment</code>å‡½æ•°ï¼Œå…¶ä¸­æˆ‘ä»¬å…³æ³¨çš„è°ƒç”¨é“¾æ˜¯
<code>assignment -&gt; luaK_storeevar -&gt; luaK_exp2anyreg -&gt; luaK_exp2nextreg -&gt; exp2reg</code> ç”±äº <code>a or 1024</code>æ˜¯ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼Œ
åœ¨ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯»åˆ°<code>or</code>ä¹‹å‰æ˜¯<code>luaK_infix</code>ï¼Œè¯»åˆ°<code>or</code>ä¹‹åæ˜¯<code>luaK_postfix</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸¤è€…çš„åšæ³•ï¼š</p>

<pre><code>-- luaK_infix
716	    case OPR_OR: {
717	      luaK_goiffalse(fs, v);
718	      break;
719	    }
</code></pre>

<pre><code>-- luaK_postfix
746	    case OPR_OR: {
747	      lua_assert(e1-&gt;f == NO_JUMP);  /* list must be closed */
748	      luaK_dischargevars(fs, e2);
749	      luaK_concat(fs, &amp;e2-&gt;t, e1-&gt;t);
750	      *e1 = *e2;
751	      break;
752	    }
</code></pre>

<p>å…³é”®è¿˜æ˜¯ä¸Šæ–‡è¯´åˆ°çš„<code>luaK_goiffalse</code>ï¼Œ</p>

<pre><code>580	  luaK_concat(fs, &amp;e-&gt;t, pc);  /* insert last jump in `t' list */
581	  luaK_patchtohere(fs, e-&gt;f);
</code></pre>

<p>å¦‚æœè¿”å› true çš„è¯ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æŸä¸ªâ€œæœªçŸ¥â€çš„åœ°æ–¹ï¼Œfalse çš„è¯ç›´æ¥æ‰§è¡Œä¸‹ä¸€å¥ã€‚é‚£ä¹ˆè¿™ä¸ªâ€œæœªçŸ¥â€çš„åœ°æ–¹æ˜¯æ€ä¹ˆç¡®å®šçš„å‘¢ï¼Ÿ
ç­”æ¡ˆåœ¨<code>exp2reg</code>é‡Œé¢ã€‚</p>

<pre><code>394	  if (hasjumps(e)) {
395	    int final;  /* position after whole expression */
396	    int p_f = NO_JUMP;  /* position of an eventual LOAD false */
397	    int p_t = NO_JUMP;  /* position of an eventual LOAD true */
398	    if (need_value(fs, e-&gt;t) || need_value(fs, e-&gt;f)) {
399	      int fj = (e-&gt;k == VJMP) ? NO_JUMP : luaK_jump(fs);
400	      p_f = code_label(fs, reg, 0, 1);
401	      p_t = code_label(fs, reg, 1, 0);
402	      luaK_patchtohere(fs, fj);
403	    }
404	    final = luaK_getlabel(fs);
405	    patchlistaux(fs, e-&gt;f, final, reg, p_f);
406	    patchlistaux(fs, e-&gt;t, final, reg, p_t);
407	  }
</code></pre>

<p>ç”±äºæˆ‘ä»¬è®¾ç½®äº†<code>e-&gt;t</code>æˆ–<code>e-&gt;f</code>ï¼Œæ‰€ä»¥<code>hasjumps</code>åˆ¤æ–­æˆç«‹ã€‚ç”±äº<code>TESTSET</code>å·²ç»æä¾›äº†èµ‹å€¼çš„å¯„å­˜å™¨ï¼Œå› æ­¤æ˜¯ä¸éœ€è¦é¢å¤–è®°å½•åˆ¤æ–­ç»“æœçš„ã€‚è€Œå¯¹äºå…¶ä»–çš„å…¥<code>LT</code>ã€<code>JMP</code>ç­‰ï¼Œå…¶æœ¬èº«æ˜¯ä¸è®°å½•ä»»ä½•åˆ¤æ–­ç»“æœçš„ï¼Œä¸ºäº†è®°å½•åªèƒ½åœ¨ JMP å®Œæˆä¹‹åï¼Œè®¾ç½®åˆ°å¯„å­˜å™¨ä¸­ï¼Œ
è¿™ä¹Ÿå°±æ˜¯æ­¤å¤„<code>code_label</code>å­˜åœ¨çš„åŸå› ã€‚æ¥ä¸‹æ¥æ˜¯<code>patchlistaux</code>ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code>150	static void patchlistaux (FuncState *fs, int list, int vtarget, int reg,
151	                          int dtarget) {
152	  while (list != NO_JUMP) {
153	    int next = getjump(fs, list);
154	    if (patchtestreg(fs, list, reg))
155	      fixjump(fs, list, vtarget);
156	    else
157	      fixjump(fs, list, dtarget);  /* jump to default target */
158	    list = next;
159	  }
160	}
</code></pre>

<p>å…¶ä¸­ <code>patchtestreg</code>å®šä¹‰å¦‚ä¸‹ï¼š</p>

<pre><code>131	static int patchtestreg (FuncState *fs, int node, int reg) {
132	  Instruction *i = getjumpcontrol(fs, node);
133	  if (GET_OPCODE(*i) != OP_TESTSET)
134	    return 0;  /* cannot patch other instructions */
135	  if (reg != NO_REG &amp;&amp; reg != GETARG_B(*i))
136	    SETARG_A(*i, reg);
137	  else  /* no register to put value or register already has the value */
138	    *i = CREATE_ABC(OP_TEST, GETARG_B(*i), 0, GETARG_C(*i));
139	
140	  return 1;
141	}
</code></pre>

<p>å…¶ä¸­<code>vtarget</code>æ˜¯æˆ‘ä»¬å½“å‰çš„ä½ç½®<code>final</code>ï¼Œè€Œ<code>dtarget</code>æ˜¯<code>p_f</code>æˆ–<code>p_t</code>ã€‚è¿™ä¸¤æ¡è¯­å¥çš„ä½œç”¨å…¶å®æ˜¯å°†æœ€ç»ˆ<code>TESTSET</code>æŒ‡ä»¤çš„ç»“æœä¼ é€åˆ°<code>reg</code>ï¼Œ
å¦‚æœä¸æ˜¯<code>TESTSET</code>çš„è¯é‚£ä¹ˆè¯´æ˜ä¸äº§ç”Ÿå€¼ï¼Œé‚£<code>reg</code>å°±éœ€è¦ä¸Šé¢çš„<code>codelabel</code>æ¥äº§ç”Ÿäº†ã€‚è‡³æ­¤è¿™éƒ¨åˆ†ä»£ç åˆ†æå®Œæˆã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€äº›å‡½æ•°çš„ç®€å•è§£é‡Šï¼Œå¯ä»¥ç¨å¾®çœ‹çœ‹ï¼š</p>

<p><code>luaK_nil</code>å‡½æ•°ï¼Œç”Ÿæˆçš„æ˜¯<code>LOADNIL</code>å­—èŠ‚ç ï¼Œå…¶ä½œç”¨æ˜¯å°†from ~ from + nä¹‹é—´çš„å¯„å­˜å™¨è®¾ç½®æˆnilï¼Œè¿™é‡Œåšäº†ä¸€äº›ä¼˜åŒ–å¦‚ï¼šå¦‚æœåˆå¹¶ç›¸é‚»çš„<code>LOADNIL</code>ï¼Œå‡½æ•°åˆå§‹åŒ–æ—¶å¯ä»¥ä¸éœ€è¦é‡å¤åˆå§‹åŒ–ç­‰ã€‚
æ³¨æ„ä¼˜åŒ–çš„å‰ææ˜¯<code>fs-&gt;pc &gt; fs-&gt;lasttarget</code>ï¼Œå³è¿™æ¡æŒ‡ä»¤å¿…é¡»å¯ä»¥çœç•¥ã€‚</p>

<p><code>luaK_jump</code>å‡½æ•°ï¼Œå…¶ç›®çš„æ˜¯ç”Ÿæˆä¸€ä¸ª<code>JMP</code>æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸ªæ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ã€‚é‚£ä¹ˆå…¶ç›®æ ‡å‘¢ï¼Ÿå…¶å®å°±æ˜¯ <code>fs-&gt;jps</code>ã€‚æ³¨æ„åé¢çš„<code>luaK_contat</code>ï¼Œå…¶ç›®çš„æ˜¯å°†l2é“¾æ¥åˆ°l1çš„åé¢ï¼Œè¿™æ˜¯ä¸ºäº†è¿ç»­è·³è½¬
è€ƒè™‘çš„ã€‚</p>

<p><code>condjump</code> ç”Ÿæˆæ¡ä»¶è·³è½¬è¯­å¥ï¼Œluaä¸ºäº†ç”Ÿæˆå­—èŠ‚ç çš„ä¾¿åˆ©æ€§ï¼Œæ¯ä¸ªæ¡ä»¶è°ƒè½¬è¯­å¥å¦‚<code>LT</code>, <code>TEST</code>ç­‰åé¢éƒ½è·Ÿç€ä¸€ä¸ª<code>JMP</code>ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ç›´æ¥æŒ‡å‘<code>JMP</code>è¯­å¥ï¼Œå¦åˆ™å°±è·³åˆ°<code>JMP</code>çš„ä¸‹ä¸€æ¡ï¼Œ
å‡å°‘äº†ç¼–ç çš„å¤æ‚åº¦å•Š</p>

<p><code>fixjump</code>æŠŠ<code>PC</code>å¤„çš„æŒ‡ä»¤ï¼ˆå½“ç„¶æ˜¯JMPæŒ‡ä»¤ï¼‰æ”¹æˆç›®æ ‡ä¸º<code>dest</code>ï¼Œå½“ç„¶æ˜¯ç›¸å¯¹åœ°å€äº†</p>

<p><code>luaK_getlabel</code>ï¼Œæ ‡è®°ä¸€ä¸‹ï¼ŒæŠŠå½“å‰çš„lasttargetæ”¹æˆpcï¼Œè¿™ä¸ªlasttargetå°±æ˜¯å’Œä¸Šé¢çš„<code>luaK_nil</code>ç»“åˆèµ·æ¥çš„ï¼Œé˜²æ­¢ä¸Šé¢çš„è¯¯ä¼˜åŒ–ã€‚</p>

<p><code>getjump</code>å’Œä¸Šé¢çš„fixjumpç›¸å¯¹åº”ï¼Œè¿”å›PCæ‰€åœ¨é‚£æ¡æŒ‡ä»¤çš„è·³è½¬ç›®æ ‡ã€‚</p>

<p><code>getjumpcontrol</code> ç”±äº<code>JMP</code>ä¸Šä¸€æ¡å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯è·Ÿç€æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„ï¼Œé‚£ä¹ˆè¿™æ¡æŒ‡ä»¤å°±æ˜¯è·å–è¿™æ¡æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„ã€‚å¦‚æœæ˜¯é‚£ä¹ˆè¿”å›ä¸Šä¸€æ¡ï¼Œå¦åˆ™è¿”å›å½“å‰pcã€‚é™¤äº†<code>jmp</code>ä¹‹å¤–ï¼Œå…¶ä»–å¦‚<code>FORLOOP</code>, <code>FORPREP</code>ç­‰æŒ‡ä»¤ä¹Ÿä¼šäº§ç”Ÿè·³è½¬</p>

<p><code>patchtestreg</code> ä¿®æ”¹<code>TESTSET</code>æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤ä¸€èˆ¬ç”¨äºçŸ­è·¯æ±‚å€¼ï¼Œ</p>

<p><code>patchlistaux</code> å¯¹äºä¸€ä¸ªjump listï¼Œå¦‚æœæ˜¯<code>TESTSET</code>ï¼Œé‚£ä¹ˆå°†èµ‹å€¼å¯„å­˜å™¨ä¿®æ”¹ä¸ºregå¹¶å°†jumpç›®çš„åœ°ä¿®æ”¹ä¸ºvtarget, å¦åˆ™ä¿®æ”¹ä¸ºdtargetã€‚</p>

<p><code>dischargejpc</code> å¯¹jpcè¿›è¡Œ<code>patchlistaux</code>ï¼Œå…¶ä¸­vtargetå’Œdtargetéƒ½æ˜¯pc</p>

<p><code>patchlist</code> å¦‚æœtargetä¸ºpcï¼Œé‚£ä¹ˆè°ƒç”¨patchtohereï¼›å¦åˆ™è°ƒç”¨patchlistaux</p>

<p><code>patchtohere</code>å…ˆgetlabelæ ‡è®°ä¸€ä¸‹ï¼Œç„¶åå°†å½“å‰çš„listæ”¾åˆ°jpcåé¢</p>

<p><code>jpc</code>é‚£äº›å°†è¦è·³åˆ°å½“å‰ä½ç½®çš„é“¾è¡¨ï¼Œç”±äºæ‰€æœ‰codeçš„å¢åŠ çš„æ¬§å¼<code>luaK_code</code>ï¼Œæ‰€ä»¥ä¼šåœ¨è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨<code>dischargejpc</code></p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-1/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-1/">lua 5.1 åˆ†æ”¯è¯­å¥ bytecode çš„ç”Ÿæˆï¼ˆä¸€ï¼‰</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://sysfork.com/post/2017/use-semantic-ui-with-vue/">åœ¨ vue ä¸­ä½¿ç”¨ semantic-ui</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://sysfork.com/post/2017/use-semantic-ui-with-vue/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'sysfork';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19710645-12', 'auto');
  ga('send', 'pageview');

</script>


</script>
</body>
</html>

