<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.42.1" />

  <title>è§£ælua gc ä¸­çš„å‚æ•°æ§åˆ¶ &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2018. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>è§£ælua gc ä¸­çš„å‚æ•°æ§åˆ¶</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>10 May 2017, 20:05</time>
  </div>

  

  
  
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/lua">lua</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/gc">gc</a>
    
  </div>
  
  

</div>

  <p>lua gc è°ƒä¼˜ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªä¸¤ä¸ªå‚æ•°<code>setpause</code>å’Œ<code>setstepmul</code>ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<pre><code>collectgarbage(&quot;setpause&quot;, 200)
collectgarbage(&quot;setstepmul&quot;, 200)
</code></pre>

<p>è¿™ä¸¤ä¸ªå€¼çš„é»˜è®¤å€¼éƒ½æ˜¯<code>200</code>ï¼Œé‚£ä¹ˆè¿™ä»£è¡¨ç€ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé€šè¿‡æŸ¥çœ‹ä»£ç </p>

<pre><code>static const char *const opts[] = {&quot;stop&quot;, &quot;restart&quot;, &quot;collect&quot;,
  &quot;count&quot;, &quot;step&quot;, &quot;setpause&quot;, &quot;setstepmul&quot;, NULL};
static const int optsnum[] = {LUA_GCSTOP, LUA_GCRESTART, LUA_GCCOLLECT,
  LUA_GCCOUNT, LUA_GCSTEP, LUA_GCSETPAUSE, LUA_GCSETSTEPMUL};
</code></pre>

<p>å…¶å®<code>collectgarbage</code>å¯¹åº”çš„å°±æ˜¯<code>lua_gc</code>æ–¹æ³•ï¼Œä¸‹é¢æ˜¯å…¶ä¸­çš„éƒ¨åˆ†é€»è¾‘çš„ï¼š</p>

<pre><code class="language-c">LUA_API int lua_gc (lua_State *L, int what, int data) {
  switch (what) {
    case LUA_GCSTOP: g-&gt;GCthreshold = MAX_LUMEM;
    case LUA_GCRESTART: g-&gt;GCthreshold = g-&gt;totalbytes;
    case LUA_GCCOLLECT: luaC_fullgc(L);
    case LUA_GCCOUNT: res = cast_int(g-&gt;totalbytes &gt;&gt; 10);
    case LUA_GCCOUNTB:  res = cast_int(g-&gt;totalbytes &amp; 0x3ff);
    case LUA_GCSTEP: {
      lu_mem a = (cast(lu_mem, data) &lt;&lt; 10);
      if (a &lt;= g-&gt;totalbytes)
        g-&gt;GCthreshold = g-&gt;totalbytes - a;
      else
        g-&gt;GCthreshold = 0;
      while (g-&gt;GCthreshold &lt;= g-&gt;totalbytes) {
        luaC_step(L);
        if (g-&gt;gcstate == GCSpause) {  /* end of cycle? */
          res = 1;  /* signal it */
          break;
        }
      }
      break;
    }
    case LUA_GCSETPAUSE: res = g-&gt;gcpause; g-&gt;gcpause = data;
    case LUA_GCSETSTEPMUL: res = g-&gt;gcstepmul; g-&gt;gcstepmul = data;
}
</code></pre>

<p>å…¶ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸€äº›æœ‰æ„æ€çš„å‚æ•°ï¼Œåœ¨<code>g(global_State)</code>ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š</p>

<pre><code class="language-c">/*
** `global state', shared by all threads of this state
*/
typedef struct global_State {
//.....
  lu_mem GCthreshold;
  lu_mem totalbytes;  /* number of bytes currently allocated */
  lu_mem estimate;  /* an estimate of number of bytes actually in use */
  lu_mem gcdept;  /* how much GC is `behind schedule' */
  int gcpause;  /* size of pause between successive GCs */
  int gcstepmul;  /* GC `granularity' */
//......
} global_State;
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº<code>LUA_GCSTOP</code>æ˜¯å°†<code>GCthreshold</code>è®¾ç½®æˆä¸€ä¸ªå¾ˆå¤§çš„å€¼<code>MAX_LUMEM</code>(<code>~(size_t)0)-2</code>)ï¼Œè€Œ<code>LUA_GCRESTART</code>åˆ™å°†<code>GCthreshold</code>è®¾ç½®æˆ<code>totalbytes</code>ã€‚å¯¹äº<code>LUA_GCSETPAUSE</code>å’Œ<code>LUA_GCSETSTEPMUL</code>åˆ™æ˜¯åˆ†åˆ«è®¾ç½®äº†<code>gcpause</code>å’Œ<code>gcstepmul</code>çš„å€¼ã€‚ä»æ³¨é‡Šä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å„è‡ªå€¼çš„è§£é‡Šã€‚</p>

<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>æ„ä¹‰</th>
</tr>
</thead>

<tbody>
<tr>
<td>GCthreshold</td>
<td>GCçš„é—¨æ§›ï¼Œå½“totalbyteså¤§äºè¿™ä¸ªå€¼æ—¶è§¦å‘gc step</td>
</tr>

<tr>
<td>totalbytes</td>
<td>ç”±å†…å­˜åˆ†é…å™¨åˆ†é…çš„<strong>å®é™…</strong>å†…å­˜</td>
</tr>

<tr>
<td>estimate</td>
<td><strong>ä¼°è®¡</strong>çš„ï¼Œæ­£åœ¨ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œå°äº <code>totalbytes</code></td>
</tr>
</tbody>
</table>

<p>ä¸‹é¢è¿™æ®µä»£ç æ˜¯ä»£ç ä¸­éšå¤„å¯è§ï¼Œå¦‚<code>lua_createtable</code>ç­‰ï¼Œåœ¨æ‰§è¡Œæ“ä½œä¹‹å‰éƒ½ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘<code>gc</code>ï¼Œä»¥ä¿è¯å†…å­˜åˆ©ç”¨ç‡ã€‚</p>

<pre><code class="language-c">80	#define luaC_checkGC(L) { \
81	  condhardstacktests(luaD_reallocstack(L, L-&gt;stacksize - EXTRA_STACK - 1)); \
82	  if (G(L)-&gt;totalbytes &gt;= G(L)-&gt;GCthreshold) \
83		luaC_step(L); }
</code></pre>

<p>å½“ <code>totalbytes &gt;= GCthreshold</code>æ—¶è§¦å‘stepã€‚å› æ­¤<code>LUA_GCRESTART</code>ä¹‹åï¼Œä¸‹ä¸€æ¬¡<code>checkGC</code>çš„æ—¶å€™ä¼šç«‹å³å‡ºå‘<code>luaC_step</code>ã€‚å¯ä»¥çœ‹åˆ°
<code>totalbytes</code>å’Œ<code>GCthreshold</code>æ˜¯æ§åˆ¶<code>GC</code>çš„å…³é”®å‚æ•°ã€‚</p>

<p>æ¯ä¸ªå›æ”¶å‘¨æœŸç»“æŸé‡ç½®<code>GCthreshold</code> ï¼Œè¿™é‡Œç”¨åˆ°äº†çš„estimateã€‚å› ä¸ºå¸¦æœ‰ __gc å…ƒæ–¹æ³•çš„ <code>userdata</code> éœ€è¦ä¸¤ä¸ªgcå‘¨æœŸ
æ‰èƒ½å›æ”¶ï¼Œåœ¨ç¬¬ä¸€ä¸ªgcå‘¨æœŸä¸­å…¶ <code>__gc</code>å…ƒæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œè€Œåœ¨ç¬¬äºŒä¸ªå›æ”¶å‘¨æœŸå†…å†…å­˜ä¼šè¢«çœŸæ­£å›æ”¶ã€‚å› æ­¤ï¼Œ<code>estimate</code>æ˜¯ä¸åŒ…å«é‚£äº›<code>__gc</code>å…ƒæ–¹æ³•è¢«è°ƒç”¨çš„<code>userdata</code>çš„ï¼Œè€Œ<code>totalbytes</code>ä¼šåŒ…å«ï¼ˆå› ä¸ºå…¶åæ˜ çš„æ˜¯çœŸå®å†…å­˜å ç”¨æƒ…å†µï¼‰ã€‚</p>

<pre><code>#define setthreshold(g)  (g-&gt;GCthreshold = (g-&gt;estimate/100) * g-&gt;gcpause)
</code></pre>

<p>ç”±è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è®¾ç½®çš„<code>gcpause</code>å€¼å½±å“çš„æ˜¯ä¸‹ä¸€å‘¨æœŸå¼€å§‹çš„äº‹ä»¶ï¼Œé»˜è®¤<code>200</code>çš„æ„æ€æ—¶ï¼Œå½“å½“å‰<strong>çœŸå®</strong>å†…å­˜å ç”¨è¶…è¿‡å½“å‰<strong>ä¼°è®¡</strong>å†…å­˜å ç”¨çš„ä¸¤å€æ—¶ï¼Œæ‰å¼€å¯ä¸‹ä¸€å›æ”¶å‘¨æœŸã€‚æ‰€ä»¥å¦‚æœä½ å«<code>__gc</code>æ–¹æ³•çš„<code>userdata</code>è¿‡å¤§çš„è¯ï¼Œå¾ˆå¯èƒ½åœ¨ç¬¬ä¸€æ¬¡å‘¨æœŸç»“æŸåç«‹é©¬å¼€å¯äº†ç¬¬äºŒå‘¨æœŸã€‚å¦‚æœè®¾ç½®çš„<code>gcpause</code>å€¼å°äº<code>100</code>çš„è¯ï¼Œé‚£ä¹ˆåŒæ ·ä¸¤æ¬¡<code>gc</code>å‘¨æœŸä¸­é—´æ˜¯æ²¡æœ‰é—´éš”çš„ã€‚</p>

<p>æ¥ä¸‹æ¥çœ‹<code>luaC_step</code>çš„ä»£ç </p>

<pre><code class="language-c">610	void luaC_step (lua_State *L) {
611	  global_State *g = G(L);
612	  l_mem lim = (GCSTEPSIZE/100) * g-&gt;gcstepmul;
613	  if (lim == 0)
614	    lim = (MAX_LUMEM-1)/2;  /* no limit */
615	  g-&gt;gcdept += g-&gt;totalbytes - g-&gt;GCthreshold;
616	  do {
617	    lim -= singlestep(L);
618	    if (g-&gt;gcstate == GCSpause)
619	      break;
620	  } while (lim &gt; 0);
621	  if (g-&gt;gcstate != GCSpause) {
622	    if (g-&gt;gcdept &lt; GCSTEPSIZE)
623	      g-&gt;GCthreshold = g-&gt;totalbytes + GCSTEPSIZE;  /* - lim/g-&gt;gcstepmul;*/
624	    else {
625	      g-&gt;gcdept -= GCSTEPSIZE;
626	      g-&gt;GCthreshold = g-&gt;totalbytes;
627	    }
628	  }
629	  else {
630	    setthreshold(g);
631	  }
632	}
</code></pre>

<p>è¿™é‡Œ<code>stepmul</code>æ§åˆ¶çš„å°±æ˜¯<code>step</code>çš„é•¿åº¦ï¼Œè¶Šå¤§åˆ™æ¯æ­¥æ‰€è¿›è¡Œçš„æ“ä½œä¹Ÿå°±è¶Šå¤šï¼Œæ‹¥æœ‰æ›´å¤šçš„ã€Œè´¹ã€ã€‚å…¶ä¸­<code>GCSTEPSIZE</code>çš„å€¼ä¸º<code>1024</code>ã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤<code>stepmul</code>ä¸º200çš„æƒ…å†µä¸‹ï¼Œå¤§çº¦å¯å·²è¿›è¡Œ<code>2048</code>ã€Œè´¹ã€ï¼Œé‚£ä¹ˆã€Œè´¹ã€æ˜¯æ€ä¹ˆå®šä¹‰çš„å‘¢ï¼Ÿä»ä»£ç å¯ä»¥çœ‹åˆ°æ¸…é™¤ä¸€æ¡<code>string</code>è¡¨å’Œä»»æ„ä¸€ä¸ª<code>gc</code>å¯¹è±¡ä¸º<code>10</code>ã€Œè´¹ã€ï¼Œè°ƒç”¨<code>__gc</code>å…ƒæ–¹æ³•ä¸º<code>100</code>ã€Œè´¹ã€ï¼Œé™¤éæ˜¯<code>sweep</code>é˜¶æ®µå¦åˆ™å†…å­˜ä¸ä¼šå‡å°‘ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨å†…å­˜å·®å€¼æ¥è¡¨ç¤ºå·¥ä½œè¿›åº¦ï¼Œæ‰€ä»¥å¼•å…¥äº†ã€Œè´¹ã€ã€‚å¦‚æœä½ æŠŠ<code>stepmul</code>è®¾ç½®ä¸º<code>0</code>çš„è¯ï¼Œé‚£ä¹ˆ<code>lim</code>å°±æ˜¯<code>(MAX_LUMEM-1)/2</code>
ä¸ºä»€ä¹ˆæ˜¯è¿™ä¹ˆå¥‡æ€ªçš„æ•°å€¼ï¼Ÿå› ä¸º<code>MAX_LUAEME</code>æ˜¯<code>~(size_t)0)-2</code>ï¼Œæ— ç¬¦å·æ•´å‹ï¼Œè€Œ<code>l_mem</code>æ˜¯æœ‰ç¬¦å·çš„ï¼Œç›´æ¥èµ‹å€¼ä¼šæº¢å‡ºçš„ã€‚</p>

<p><code>luaC_step</code>çš„è®¾è®¡æ€è·¯æ˜¯ï¼š æ¯å½“æ–°å¢åˆ†é…çš„å†…å­˜æ•°è¶…è¿‡<code>GCSTEPSIZE</code>å°±è§¦å‘ä¸€æ¬¡ã€‚ç”±äºluaåªä¼šåœ¨gcè¿‡ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œæ‰€ä»¥
<code>totalbytes</code>åœ¨gcè¿‡ç¨‹å¤–æ—¶åªå¢ä¸å‡çš„ï¼Œå› æ­¤<code>luaC_step</code>æ€»æ˜¯ä¼šå¾—ä»¥è§¦å‘ã€‚ä¸ºäº†å‡†ç¡®è®°å½•æ–°å¢å†…å­˜ä½¿ç”¨é‡ï¼Œlua ä½¿ç”¨äº†<code>gcdept</code>å˜é‡ã€‚
è¿™ç§è®¾è®¡æ˜¯ä¸ºäº†é˜²æ­¢<code>luaC_step</code>è¢«é¢‘ç¹è§¦å‘ï¼Œæ§åˆ¶ä¸€ä¸ªè¾ƒåˆç†çš„ç²’åº¦ã€‚</p>

<p>å¦å¤–ï¼Œ<code>gcdept</code>åœ¨æ¯ä¸ªå‘¨æœŸæœ«å°¾ä¼šæ¸…é›¶ã€‚</p>

<pre><code>592	    case GCSfinalize: {
593	      if (g-&gt;tmudata) {
594	        GCTM(L);
595	        if (g-&gt;estimate &gt; GCFINALIZECOST)
596	          g-&gt;estimate -= GCFINALIZECOST;
597	        return GCFINALIZECOST;
598	      }
599	      else {
600	        g-&gt;gcstate = GCSpause;  /* end collection */
601	        g-&gt;gcdept = 0;
602	        return 0;
603	      }
604	    }
</code></pre>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/2017/a-core-cause-by-curl-sighandler/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/2017/a-core-cause-by-curl-sighandler/">ä¸€ä¸ªç”± libcurl å¯¼è‡´çš„ core åˆ†æ</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-1/">lua 5.1 åˆ†æ”¯è¯­å¥ bytecode çš„ç”Ÿæˆï¼ˆä¸€ï¼‰</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-1/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'sysfork';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19710645-12', 'auto');
  ga('send', 'pageview');

</script>


</script>
</body>
</html>

