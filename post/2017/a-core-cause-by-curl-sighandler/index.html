<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.42.1" />

  <title>ä¸€ä¸ªç”± libcurl å¯¼è‡´çš„ core åˆ†æ &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>ä¸€ä¸ªç”± libcurl å¯¼è‡´çš„ core åˆ†æ</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>10 May 2017, 15:31</time>
  </div>

  

  
  
  
  

  
  
  
  

</div>

  <p>æœ€è¿‘æˆ‘ä»¬çš„é¡¹ç›®æœ‰å¤šä¸ªcoreï¼Œ ä½¿ç”¨gdbæŸ¥çœ‹å¦‚ä¸‹ï¼š</p>

<pre><code>(gdb) info threads
  Id   Target Id         Frame 
  5    Thread 0x7f28943d9700 (LWP 11079) 0x00007f2895cc5c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
  4    Thread 0x7f2895bdc700 (LWP 11076) 0x00007f2895cbcaed in poll () at ../sysdeps/unix/syscall-template.S:81
  3    Thread 0x7f28953db700 (LWP 11077) 0x00007f2895cc5c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
  2    Thread 0x7f2894bda700 (LWP 11078) 0x00007f2895cc5c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
* 1    Thread 0x7f28983af780 (LWP 11036) 0x00007f2895c12067 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
</code></pre>

<p>gameappå¯åŠ¨äº†4ä¸ªå­çº¿ç¨‹ï¼Œå°±æ˜¯ä¸Šé¢çš„2345ï¼Œ1æ˜¯ä¸»çº¿ç¨‹ï¼Œä»LWPç¼–å·ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºã€‚ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ä¸»çº¿ç¨‹æŒ‚æ‰äº†ï¼Œbtä¸€ä¸‹</p>

<pre><code>#0  0x00007f2895c12067 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007f2895c13448 in __GI_abort () at abort.c:89
#2  0x00007f2895c0b266 in __assert_fail_base (fmt=0x7f2895d43f18 &quot;%s%s%s:%u: %s%sAssertion `%s' failed.\n%n&quot;, assertion=assertion@entry=0x7f2897e30a7e &quot;inMainThread()&quot;, 
    file=file@entry=0x7f2897e30a48 &quot;/home/shiwan/publish/engine/src/base/base_context.hpp&quot;, line=line@entry=57, 
    function=function@entry=0x7f2897e313c0 &lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&gt; &quot;void pm::common::BaseContext::assertInThisThread() const&quot;) at assert.c:92
#3  0x00007f2895c0b312 in __GI___assert_fail (assertion=0x7f2897e30a7e &quot;inMainThread()&quot;, file=0x7f2897e30a48 &quot;/home/shiwan/publish/engine/src/base/base_context.hpp&quot;, line=57, 
    function=0x7f2897e313c0 &lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&gt; &quot;void pm::common::BaseContext::assertInThisThread() const&quot;) at assert.c:101
#4  0x00007f289777b26d in pm::common::BaseContext::assertInThisThread (this=0x7f28998d4250) at /home/shiwan/publish/engine/src/base/base_context.hpp:57
...
#27 0x00007f2896555970 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#28 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#29 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
</code></pre>

<p>ä»æ ˆé¡¶å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ä»£ç ä¸­è°ƒç”¨äº†<code>assert</code>å¤±è´¥äº†ã€‚å› ä¸ºæˆ‘ä»¬çš„å¤šçº¿ç¨‹æ¨¡å‹å±äº<code>one loop per thread</code>æ¨¡å¼ï¼Œè·¨çº¿ç¨‹è°ƒç”¨å¿…é¡»é€šè¿‡<code>event loop</code>æ¥è½¬å‘ï¼Œè¿™é‡Œçš„assertå°±æ˜¯ä¸ºäº†é˜²æ­¢è·¨çº¿ç¨‹è°ƒç”¨äº†åˆ«çš„çº¿ç¨‹ä¸­å®ä¾‹çš„æ–¹æ³•ã€‚æ‰€ä»¥ç»§ç»­è¿½è¸ªæ ˆçœ‹çœ‹è°ƒç”¨æ¥æºã€‚çœ‹åˆ°æ ˆä½</p>

<pre><code>#28 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#29 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
</code></pre>

<p>WTF?ä¸»çº¿ç¨‹è°ƒç”¨ä¸åº”è¯¥æ˜¯ä»<code>main</code>å¼€å§‹çš„ä¹ˆï¼Ÿéš¾é“åˆ«çš„çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Ÿ</p>

<pre><code>(gdb) thread apply all bt  -2                                                                                                                                                                                     

Thread 5 (Thread 0x7f28943d9700 (LWP 11079)):
#10 0x00007f2896bbe0a4 in start_thread (arg=0x7f28943d9700) at pthread_create.c:309
#11 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 4 (Thread 0x7f2895bdc700 (LWP 11076)):
#56 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#57 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 3 (Thread 0x7f28953db700 (LWP 11077)):
#10 0x00007f2896bbe0a4 in start_thread (arg=0x7f28953db700) at pthread_create.c:309
#11 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 2 (Thread 0x7f2894bda700 (LWP 11078)):
#10 0x00007f2896bbe0a4 in start_thread (arg=0x7f2894bda700) at pthread_create.c:309
#11 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 1 (Thread 0x7f28983af780 (LWP 11036)):
#28 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#29 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
</code></pre>

<p>æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹å †æ ˆå¯ä»¥çœ‹åˆ°æ‰€æœ‰çº¿ç¨‹çš„å¯åŠ¨å‡½æ•°éƒ½æ˜¯<code>clone</code>ï¼Œè¿™æ˜¯ä¸æ­£å¸¸çš„ã€‚æ‰€ä»¥é—®é¢˜æ˜¯ä¸»çº¿ç¨‹çš„å †æ ˆè¢«è¦†ç›–äº†ï¼Œé‚£æ˜¯è¢«å“ªä¸ªçº¿ç¨‹è¦†ç›–äº†å‘¢ï¼Ÿç»§ç»­åœ¨ä¸»çº¿ç¨‹ä¸‹æŸ¥çœ‹</p>

<pre><code>(gdb) f 4
#4  0x00007f289777b26d in pm::common::BaseContext::assertInThisThread (this=0x7f28998d4250) at /home/shiwan/publish/engine/src/base/base_context.hpp:57
57          void assertInThisThread() const { assert(inMainThread()); }
(gdb) p /x this-&gt;dispatch_thread_id_
$3 = {_M_thread = 0x7f2895bdc700}
</code></pre>

<p>æ ¹æ®çº¿ç¨‹çš„IDå¯ä»¥çœ‹å‡ºè¿™ä¸ªå †æ ˆæœ¬æ¥æ˜¯çº¿ç¨‹4(LWP 11076)çš„ã€‚æŸ¥çœ‹çº¿ç¨‹4çš„å †æ ˆå¦‚ä¸‹</p>

<pre><code>#0  0x00007f2895cbcaed in poll () at ../sysdeps/unix/syscall-template.S:81                                                                                                                               [38/1614]
#1  0x00007f289339dcc0 in send_dg (ansp2_malloced=0x7f2895bdac08, resplen2=0x7f2895bdac04, anssizp2=0x7f2895bdac00, ansp2=0x7f2895bdac20, anscp=0x7f2895bdac10, gotsomewhere=&lt;synthetic pointer&gt;, 
    v_circuit=&lt;synthetic pointer&gt;, ns=0, terrno=0x7f2895bd95c8, anssizp=0x7f2895bd9700, ansp=0x7f2895bd95b8, buflen2=47, buf2=0x7f2895bd9760 &quot;\vd\001&quot;, buflen=47, buf=0x7f2895bd9730 &quot;\344A\001&quot;, 
    statp=0x7f2895bdcdb8) at res_send.c:1200
#2  __libc_res_nsend (statp=statp@entry=0x7f2895bdcdb8, buf=buf@entry=0x7f2895bd9730 &quot;\344A\001&quot;, buflen=47, buf2=buf2@entry=0x7f2895bd9760 &quot;\vd\001&quot;, buflen2=buflen2@entry=47, 
    ans=ans@entry=0x7f2895bda3d0 &quot;\344A\201\200&quot;, anssiz=anssiz@entry=2048, ansp=ansp@entry=0x7f2895bdac10, ansp2=ansp2@entry=0x7f2895bdac20, nansp2=0x7f2895bdac00, nansp2@entry=0x7f2897e5f1c0, 
    resplen2=resplen2@entry=0x7f2895bdac04, ansp2_malloced=0x7f2895bdac08, ansp2_malloced@entry=0x7f2895bdb800) at res_send.c:545
#3  0x00007f289339bc0c in __GI___libc_res_nquery (statp=statp@entry=0x7f2895bdcdb8, name=0x7f288002ef50 &quot;x&quot;, class=32552, class@entry=1, type=type@entry=62321, 
    answer=answer@entry=0x7f2895bda3d0 &quot;\344A\201\200&quot;, anslen=2048, anslen@entry=3, answerp=answerp@entry=0x7f2895bdac10, answerp2=answerp2@entry=0x7f2895bdac20, nanswerp2=nanswerp2@entry=0x7f2895bdac00, 
    resplen2=resplen2@entry=0x7f2895bdac04, answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:227
#4  0x00007f289339c210 in __libc_res_nquerydomain (statp=0x7f2895bdcdb8, statp@entry=0x74007f2895bdcdb8, name=name@entry=0x7f288002ef50 &quot;x&quot;, domain=domain@entry=0x0, class=class@entry=1, 
    type=type@entry=62321, answer=answer@entry=0x7f2895bda3d0 &quot;\344A\201\200&quot;, anslen=3, anslen@entry=-1751285904, answerp=0x0, answerp@entry=0x7f2895bdb4f0, answerp2=0x0, answerp2@entry=0x7f2895bdb4c0, 
    nanswerp2=0x2d7, nanswerp2@entry=0x7f2895bdac00, resplen2=0x7f2895bdac04, resplen2@entry=0x7f2897e5f045, answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:594
#5  0x00007f289339c7a9 in __GI___libc_res_nsearch (statp=0x74007f2895bdcdb8, name=name@entry=0x7f288002ef50 &quot;x&quot;, class=class@entry=1, type=type@entry=62321, answer=answer@entry=0x7f2895bda3d0 &quot;\344A\201\200&quot;, 
    anslen=-1751285904, anslen@entry=2048, answerp=answerp@entry=0x7f2895bdac10, answerp2=answerp2@entry=0x7f2895bdac20, nanswerp2=nanswerp2@entry=0x7f2895bdac00, resplen2=resplen2@entry=0x7f2895bdac04, 
    answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:381
#6  0x00007f28935adacb in _nss_dns_gethostbyname4_r (name=0x7f288002ef50 &quot;x&quot;, name@entry=0x7f2895f83060 &lt;_IO_2_1_stderr_&gt; &quot;\207(\255&quot;, &lt;incomplete sequence \373&gt;, pat=0x7f2895bdb1f8, pat@entry=0xfbad2086, 
    buffer=buffer@entry=0x7f2895bdaca0 &quot;H\025&quot;, &lt;incomplete sequence \310&gt;, buflen=buflen@entry=1064, errnop=0x7f2895bdb1e8, errnop@entry=0x7f2895bdb7b0, herrnop=0x7f2895bdb210, herrnop@entry=0x7f2895d42acf, 
    ttlp=ttlp@entry=0x0) at nss_dns/dns-host.c:315
#7  0x00007f2895cb113c in gaih_inet (name=&lt;optimized out&gt;, service=&lt;optimized out&gt;, req=&lt;optimized out&gt;, pai=&lt;optimized out&gt;, naddrs=&lt;optimized out&gt;) at ../sysdeps/posix/getaddrinfo.c:870
#8  0x00007f2895bdb800 in ?? ()
#9  0x00007f289994d1e0 in ?? ()
#10 0x00007f2895bdb49f in ?? ()
.....
#29 0x00007f2897e30a48 in ?? ()
#30 0x0000000000000039 in ?? ()
#31 0x00007f2895c0b312 in __GI___assert_fail (assertion=0x7f2897e30a7e &quot;inMainThread()&quot;, 
    file=0x7f2897e313c0 &lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&gt; &quot;void pm::common::BaseContext::assertInThisThread() const&quot;, line=2548241344, function=0x7f28998d6280 &quot;&quot;)
    at assert.c:101
#32 0x00007f289777b26d in pm::common::BaseContext::assertInThisThread (this=0x7f28998d4250) at /home/shiwan/publish/engine/src/base/base_context.hpp:57
.....
#54 0x00007f289790e56c in std::thread::_Impl&lt;std::_Bind_simple&lt;pm::common::ThreadBase::start()::&lt;lambda()&gt;()&gt; &gt;::_M_run(void) (this=0x7f28998d0e80) at /usr/include/c++/4.9/thread:115
#55 0x00007f2896555970 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#56 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#57 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

</code></pre>

<p>å †æ ˆä¸‹é¢çš„å†…å®¹å’Œåˆšåˆšåœ¨ä¸»çº¿ç¨‹ä¸­çš„å †æ ˆä¸€è‡´ï¼Œå„ç§å˜é‡çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä»31å·frameå¾€ä¸Šå°±ä¸æ­£å¸¸äº†ã€‚</p>

<pre><code>#29 0x00007f2897e30a48 in ?? ()
#30 0x0000000000000039 in ?? ()
#31 0x00007f2895c0b312 in __GI___assert_fail (assertion=0x7f2897e30a7e &quot;inMainThread()&quot;, 
    file=0x7f2897e313c0 &lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&gt; &quot;void pm::common::BaseContext::assertInThisThread() const&quot;, line=2548241344, function=0x7f28998d6280 &quot;&quot;)
    at assert.c:101
#32 0x00007f289777b26
</code></pre>

<p>æ‰€ä»¥å‡ºç°çš„æƒ…æ™¯æ˜¯å­çº¿ç¨‹4è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹çš„æ ˆæŒ‡é’ˆ<code>%rsp</code>è¢«ä¿®æ”¹åˆ°å­çº¿ç¨‹4çš„æ ˆç©ºé—´äº†ã€‚ç”±äº<code>%rsp</code>è¢«ç ´åï¼Œå‡½æ•°è¿”å›æ—¶ï¼Œä¿å­˜çš„pcå°±ä¸æ˜¯åŸæ¥çš„è¿”å›ç‚¹ï¼Œè€Œæ˜¯çº¿ç¨‹4çš„æ§åˆ¶æµï¼Œè°ƒç”¨æ ˆå°±è¢«é”™è¯¯åœ°è®¾ç½®äº†ã€‚åœ¨å¼€å§‹debugçš„æ—¶å€™ï¼Œæˆ‘é”™è¯¯çš„ä»¥ä¸ºç”±äºçº¿ç¨‹4çš„æ ˆ
è¢«ç ´åï¼ŒåŠ ä¸Šå…¶ä¸­ä¸€å †&rdquo;???&ldquo;ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆå‚è€ƒä»·å€¼ã€‚ä½†æ˜¯ä»”ç»†çœ‹çœ‹æ ˆé¡¶</p>

<pre><code>#0  0x00007f2895cbcaed in poll () at ../sysdeps/unix/syscall-template.S:81                                                                                                                               [38/1614]
#1  0x00007f289339dcc0 in send_dg (ansp2_malloced=0x7f2895bdac08, resplen2=0x7f2895bdac04, anssizp2=0x7f2895bdac00, ansp2=0x7f2895bdac20, anscp=0x7f2895bdac10, gotsomewhere=&lt;synthetic pointer&gt;, 
    v_circuit=&lt;synthetic pointer&gt;, ns=0, terrno=0x7f2895bd95c8, anssizp=0x7f2895bd9700, ansp=0x7f2895bd95b8, buflen2=47, buf2=0x7f2895bd9760 &quot;\vd\001&quot;, buflen=47, buf=0x7f2895bd9730 &quot;\344A\001&quot;, 
    statp=0x7f2895bdcdb8) at res_send.c:1200
#2  __libc_res_nsend (statp=statp@entry=0x7f2895bdcdb8, buf=buf@entry=0x7f2895bd9730 &quot;\344A\001&quot;, buflen=47, buf2=buf2@entry=0x7f2895bd9760 &quot;\vd\001&quot;, buflen2=buflen2@entry=47, 
    ans=ans@entry=0x7f2895bda3d0 &quot;\344A\201\200&quot;, anssiz=anssiz@entry=2048, ansp=ansp@entry=0x7f2895bdac10, ansp2=ansp2@entry=0x7f2895bdac20, nansp2=0x7f2895bdac00, nansp2@entry=0x7f2897e5f1c0, 
    resplen2=resplen2@entry=0x7f2895bdac04, ansp2_malloced=0x7f2895bdac08, ansp2_malloced@entry=0x7f2895bdb800) at res_send.c:545
#3  0x00007f289339bc0c in __GI___libc_res_nquery (statp=statp@entry=0x7f2895bdcdb8, name=0x7f288002ef50 &quot;x&quot;, class=32552, class@entry=1, type=type@entry=62321, 
    answer=answer@entry=0x7f2895bda3d0 &quot;\344A\201\200&quot;, anslen=2048, anslen@entry=3, answerp=answerp@entry=0x7f2895bdac10, answerp2=answerp2@entry=0x7f2895bdac20, nanswerp2=nanswerp2@entry=0x7f2895bdac00, 
    resplen2=resplen2@entry=0x7f2895bdac04, answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:227
</code></pre>

<p>çº¿ç¨‹æ­£åœ¨pollï¼Œä»ä¸Šä¸€å±‚çš„è°ƒç”¨æ¥çœ‹åº”è¯¥æ˜¯åœ¨åšDNSæŸ¥è¯¢, gameappçš„æœ€åä¸€è¡Œlogæ˜¯</p>

<pre><code>I0223 15:06:34.988075 11076 http_manager.cpp:237] Adding curl task url: http://pm01.gmsdk.gameyw.netease.com/app/gen_token.json?game_server=20001&amp;game_uid=4212937&amp;lang=zh_cn&amp;nickname=%E4%BA%8E%E5%AE%B6%E6%AD%8C&amp;pid=pm01&amp;platform=android&amp;refer=%2Fsprite.html&amp;sign=e17e1efcf43bfd036e4410e4b1b844b8&amp;time=1487833594&amp;type=1&amp;uid=aebfpu46xuf3q3ag%40ad.netease.win.163.com&amp;vip=1
</code></pre>

<p>è¿™è¡Œlogæ˜¯çº¿ç¨‹4æ‰“å‡ºæ¥çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ¤å®šï¼Œæ­¤æ—¶çº¿ç¨‹4æ­£åœ¨åšDNSæŸ¥è¯¢ï¼Œè€Œè°ƒç”¨è¿™ä¸ªè¿™ä¸ªDNSçš„æ­£æ˜¯curlã€‚é‚£ä¸€ä¸ªç®€å•çš„DNSæŸ¥è¯¢æ€ä¹ˆä¼šå¯¼è‡´ç¨‹åºæŒ‚æ‰å‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹CURLçš„æºç ï¼š</p>

<p><code>Curl_resolv_timeout</code>æ˜¯curlç”¨äºåšdnsè§£æçš„å…¥å£ï¼Œä»å‡½æ•°åå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸ªæ”¯æŒtimeoutçš„DNSè§£æå‡½æ•°ï¼Œç„¶è€Œæˆ‘ä»¬æ“ä½œç³»ç»Ÿçš„å¦‚<code>getaddrinfo</code>ï¼Œ<code>gethostbyname</code>ä¹‹ç±»çš„å‡½æ•°éƒ½æ˜¯åŒæ­¥é˜»å¡è°ƒç”¨ï¼Œä¸æ”¯æŒè¶…æ—¶å‚æ•°çš„å•Šã€‚ä»”ç»†çœ‹<code>Curl_resolv_timeout</code>
çš„å®ç°å‘ç°å…¶ä½¿ç”¨<code>SIGALRM</code>ä¿¡å·çš„æœºåˆ¶æ¥å®ç°åœ¨çº¿ç¨‹é˜»å¡ç­‰å¾…æ—¶ï¼Œä¾ç„¶èƒ½å¤Ÿåœ¨ä¸€å®šæ—¶é—´ä¹‹åå¾—åˆ°é€šçŸ¥ï¼Œä»è€Œæ”¾å¼ƒç»§ç»­ç­‰å¾…çš„ç›®çš„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–åçš„ä»£ç </p>

<pre><code>static RETSIGTYPE alarmfunc(int sig)
{
  siglongjmp(curl_jmpenv, 1);
  return;
}

int Curl_resolv_timeout()
{
if(sigsetjmp(curl_jmpenv, 1)) {
  failf(data, &quot;name lookup timed out&quot;);
  rc = CURLRESOLV_ERROR;
  goto clean_up;
}

keep_sigact = signal(SIGALRM, alarmfunc);
alarm(curlx_sltoui(timeout/1000L));
Curl_resolv(conn, hostname, port, entry);
signal(SIGALRM, keep_sigact);
}

</code></pre>

<p>é€šè¿‡alarmè§¦å‘è¶…æ—¶ï¼Œåœ¨è°ƒç”¨<code>Curl_resolv</code>ä¹‹å‰è®¾ç½®å¥½jumppointï¼Œä¸€æ—¦alarmè§¦å‘ï¼Œè°ƒç”¨<code>alarmfunc</code>ï¼Œå†<code>longjump</code>åˆ°jumppointä½ç½®ï¼Œé—´æ¥å®ç°äº†ç›®çš„ã€‚</p>

<p><b>ç„¶è€Œè¿™ç§åšæ³•åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ˜¯ç¾éš¾</b></p>

<p>åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªé¢å‘è¿›ç¨‹çš„ä¿¡å·äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šé€‰æ‹©ä»»æ„ä¸€ä¸ªå¯ä»¥å¤„ç†è¯¥ä¿¡å·çš„çº¿ç¨‹æ¥å¤„ç†ã€‚å…¶ä¸­SIGALRMæ­£æ˜¯ä¸€ä¸ªé¢å‘è¿›ç¨‹çš„ä¿¡å·äº‹ä»¶ï¼Œæ‰€ä»¥å…¶å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹å¤„ç†ã€‚
è¿™ä¸ªä¿¡å·è¢«ä¸»çº¿ç¨‹æ•æ‰åˆ°äº†ã€‚ç°åœ¨æ¥è¿˜åŸæ•´ä¸ªäº‹ä»¶ï¼š</p>

<ol>
<li>å­çº¿ç¨‹å‘èµ·è®¾ç½®å¥½alarmï¼Œå‘èµ·DNSè¯·æ±‚å¹¶ç­‰å¾…</li>
<li>ç”±äºDNSæŸ¥è¯¢é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼ŒALARMä¿¡å·äº‹ä»¶è§¦å‘</li>
<li>ä¸»çº¿ç¨‹æ•æ‰åˆ°è¿™ä¸€ä¿¡å·ï¼Œè°ƒç”¨<code>alarmfunc</code></li>
<li><code>alarmfunc</code>çš„ä½œç”¨æ˜¯<code>longjump</code>ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒè¢«æ›¿æ¢æˆå­çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒï¼Œæ ˆè¢«ç ´å</li>
</ol>

<p>è§£å†³æ–¹æ¡ˆï¼š
é€šè¿‡æŸ¥çœ‹curlä»£ç ï¼Œå‘ç°å…¶è¿˜æœ‰ä¸€ç§å¼‚æ­¥dnsæ¨¡å¼ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨<a href="https://c-ares.haxx.se">c-ares</a>åº“ï¼Œæ‰€ä»¥æœ€ç»ˆå¼•è¿›äº†è¿™ä¸ªåº“ï¼Œæ›¿æ¢æ‰äº†åŸæ¥çš„ä½¿ç”¨ç³»ç»ŸDNSæŸ¥è¯¢æ–¹æ¡ˆã€‚</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/2017/compatible-embed-luajit-ffi-load/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/2017/compatible-embed-luajit-ffi-load/">åµŒå…¥ luajit æ—¶åŒæ—¶ä½¿ç”¨ ffi å’Œ c api çš„è§£å†³æ–¹æ¡ˆ</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://sysfork.com/post/2017/lua-gc-paramter-internal/">è§£ælua gc ä¸­çš„å‚æ•°æ§åˆ¶</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://sysfork.com/post/2017/lua-gc-paramter-internal/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'sysfork';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19710645-12', 'auto');
  ga('send', 'pageview');

</script>


</script>
</body>
</html>

