<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>åµŒå…¥ luajit æ—¶åŒæ—¶ä½¿ç”¨ ffi å’Œ c api çš„è§£å†³æ–¹æ¡ˆ &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>åµŒå…¥ luajit æ—¶åŒæ—¶ä½¿ç”¨ ffi å’Œ c api çš„è§£å†³æ–¹æ¡ˆ</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>09 May 2017, 22:05</time>
  </div>

  

  
  
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/luajit">luajit</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/ffi">ffi</a>
    
  </div>
  
  

</div>

  <p>æˆ‘ä»¬éƒ½å–œæ¬¢<a href="http://luajit.org/ext_ffi.html">ffi</a>ã€‚</p>

<p>ffi çš„æ¥å£ç®€å•æ˜“ç”¨ï¼Œå½“ä½¿ç”¨ç¬¬ä¸‰æ–¹æ²¡æœ‰æä¾› lua æ¥å£çš„åº“æ¥è¯´ï¼Œä½¿ç”¨ ffi æ¥å…¥ç›¸å½“å®¹æ˜“ã€‚
è€Œä¸”æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé€šè¿‡ ffi è°ƒç”¨çš„æ¥å£æ˜¯å¯ä»¥è¢« jit ç¼–è¯‘çš„ï¼Œæ•ˆç‡ç›¸å¯¹äºä½¿ç”¨ä¼ ç»Ÿçš„ <a href="https://www.lua.org/pil/24.html">lua c api</a>æ¥è¯´è¦
é«˜å¾—å¤šã€‚ffi ç›´æ¥ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿçš„è°ƒç”¨æ¨¡å‹ï¼Œé™¤äº†æ•°æ®ç»“æ„è½¬åŒ–çš„ä»£ä»·å¤–æ²¡æœ‰é¢å¤–çš„è´Ÿæ‹…ã€‚è€Œä½¿ç”¨ä¼ ç»Ÿ c api åˆ™æ˜¯
é€šè¿‡ lua è™šæ‹Ÿæ ˆæ¥å®ç°ï¼Œå¹¶ä¸”éœ€è¦å’Œ lua çš„è°ƒç”¨æ¨¡å‹å…¼å®¹ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚</p>

<p>ä½†æ˜¯ï¼Œå¯¹äºæ¥å…¥ lua çš„ç¨‹åºè€Œè¨€ï¼Œä»…ä»…æ”¯æŒ luajit æ˜¯æœ‰ä¸€å®šé£é™©çš„ï¼Œç›¸å¯¹äº <a href="https://www.lua.org/">puc lua</a>ï¼Œ luajit çš„ä¸»è¦å¼€å‘è€…å’Œç»´æŠ¤è€…
æ¯”è¾ƒå°‘ï¼Œåº”ç”¨é¢ä¹Ÿä¸å¦‚ luaã€‚æ‰€ä»¥å¤§éƒ¨åˆ†çš„é¢ç›¸ lua çš„ç¨‹åºéƒ½ä¼šåŒæ—¶æ”¯æŒ luajit å’Œ luaã€‚ffi æ˜¯ luajit å†…ç½®çš„æ¨¡å—ï¼Œè€Œ lua å´ä¸æºå¸¦è¿™ä¸ªæ¨¡å—ï¼Œ
æœ‰ä¸€äº›å¼€æºçš„é¡¹ç›®ï¼Œ å¦‚ facebook å¼€å‘çš„<a href="https://github.com/facebook/luaffifb">è¿™ä¸ª</a>ï¼Œä½†æ˜¯ç»è¿‡æˆ‘ä»¬çš„æµ‹è¯•å…¶æ•ˆç‡æ¯”æ™®é€šçš„c apiè¿˜æ…¢: (ã€‚
æ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒæŠ˜ä¸­çš„æ–¹æ¡ˆæ˜¯åŒæ—¶æä¾› ffi binding å’Œ c binding çš„æ–¹æ¡ˆï¼Œè¿™æ˜¯å¤§éƒ¨åˆ† lua åº“çš„é€‰æ‹©ã€‚</p>

<p>å¦‚æœæä¾›çš„æ˜¯ä¸€ä¸ª so åº“ï¼Œé‚£ä¹ˆåªéœ€è¦æä¾›ä¸ª lua å…¥å£æ–‡ä»¶ï¼Œå¦‚æœä½¿ç”¨ ffi çš„è¯ï¼Œåˆ™è°ƒç”¨ç›¸å…³çš„ lua æ–‡ä»¶ã€‚å¦‚æœæ˜¯ c binding çš„è¯ï¼Œé‚£å°±è°ƒç”¨å…·ä½“çš„
soæ–‡ä»¶ã€‚ç„¶è€Œè¿™åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­æ˜¯ä¸å¯è¡Œçš„ï¼Œä¸ºäº†ä¿è¯éƒ¨ç½²çš„ç®€åŒ–ï¼Œæˆ‘ä»¬çš„ç¨‹åºåªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸ä¼šä¾èµ–é™¤ä¸€äº›æ ¸å¿ƒ so åº“ä¹‹å¤–çš„ so åº“ã€‚æ‰€æœ‰çš„
c binding ä»£ç éƒ½æ˜¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢çš„ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ <code>ffi.load</code> æˆ‘ä»¬è‡ªå·±çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¤§æ¦‚çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code class="language-C">// main.c

char* encode(const char* input, size_t size, size_t *out_size) { // å‡è®¾è¿™æ˜¯æˆ‘ä»¬çš„å·¥ä½œå‡½æ•°
    //...
}

// c api
int l_encode(lua_State* L) { // ä¸ºäº†è®©ä¸Šé¢çš„æ¥å£èƒ½è¢« lua è°ƒç”¨ï¼Œéœ€è¦è½¬æ¢ä¸€ä¸‹
    size_t length, out_size;
    char *in_data, *out_data;
    in_data = lua_tolstring(L, 1, &amp;length);
    out_data = encode(in_data, length, &amp;out_size);
    lua_pushlstring(L, out_data, out_size);
    return 1;
}

// register in some place 
lua_pushcfunction(L, l_encode); // æ³¨å†Œåˆ° lua è™šæ‹Ÿæœºä¸­
lua_setglobal(L, &quot;c_encode&quot;);
</code></pre>

<p>è¿™é‡Œæ˜¯ç»Ÿä¸€çš„å…¥å£æ–‡ä»¶ï¼š</p>

<pre><code class="language-lua">-- ffi.lua

if ffi then -- å¦‚æœèƒ½ä½¿ç”¨ ffi çš„è¯
    lib = ffi.load(????) -- è¿™é‡Œæ”¹æ€ä¹ˆå†™
    ffi.cdef[[
        char* encode(const char* input, size_t size, size_t *out_size);
    ]]
    -- do some dirty jobs
    lib.encode -- ...
else
    encode = c_encode -- ä½¿ç”¨ c api ç‰ˆæœ¬
end


</code></pre>

<p>ç„¶è€Œè¿™æ˜¯ä¸å¯è¡Œçš„ã€‚</p>

<p>ffi load è°ƒç”¨çš„å…¶å®å°±æ˜¯<a href="http://man7.org/linux/man-pages/man3/dlopen.3.html">dlopen</a>ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ <code>a.out</code>ï¼Œåœ¨è¿™é‡Œé¢
è°ƒç”¨ <code>dlopen(&quot;a.out&quot;, ...)</code>ï¼Œå…¶ä½œç”¨æ˜¯å°† <code>a.out</code> çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼ŒåŠ ä¸Šæˆ‘ä»¬ä¹‹å‰è¿è¡Œ <code>a.out</code> çš„ç¨‹åºï¼ˆå…¶å®ä¹Ÿæ˜¯ç”¨ <code>/lib64/ld-linux-x86-64.so</code> åŠ è½½çš„ï¼‰ã€‚
è¿™æ ·å†…å­˜ä¸­å°±æœ‰äº†ä¸¤ä»½ä¸€æ ·çš„é•œåƒï¼Œä¸€ä¸ªå…¨å±€å˜é‡ä¼šå¯¹åº”ä¸¤ä¸ªå†…å­˜åœ°å€ã€‚è¿™ç§äº§ç”Ÿçš„åŸå› å¯ä»¥å‚è€ƒ<a href="https://book.douban.com/subject/3652388/">ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»</a>ã€‚</p>

<p>ä½¿ç”¨ç°æœ‰çš„ luajit æ¥å£æ˜¯æ— æ³•åšåˆ°çš„ã€‚ä½†æ˜¯ <code>dlopen</code> å¯ä»¥</p>

<blockquote>
<p>If filename is  NULL,  then  the  returned handle  is for the main program</p>
</blockquote>

<p>å½“ filename ä¸º NULL æ—¶ï¼Œç›´æ¥è¿”å›å½“å‰ç¨‹åºçš„ dl handleï¼Œå¯ä»¥å–å¾—å„ç§ symbol çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¨å¾®ä¿®æ”¹ä¸‹ luajit çš„å®ç°:</p>

<pre><code class="language-c">// in lj_clib.c
static const char *clib_extname(lua_State *L, const char *name
{
  if (!name[0]) return NULL; // æ·»åŠ è¿™ä¸€è¡Œ
  if (!strchr(name, '/')
#if LJ_TARGET_CYGWIN
      &amp;&amp; !strchr(name, '\\')
#endif
     ) {
    if (!strchr(name, '.')) {
      name = lj_strfmt_pushf(L, CLIB_SOEXT, name);
      L-&gt;top--;
// ...
</code></pre>

<p>é‚£ä¹ˆåœ¨åº”ç”¨ä¸­å°±å¯ä»¥è¿™æ ·ä½¿ç”¨äº†</p>

<pre><code class="language-lua">local ffi = require(&quot;ffi&quot;)
local lib = ffi.load(&quot;&quot;)
ffi.cdef[[...]]
-- lib.doSomething
</code></pre>

<p>è¿™æ ·å¯¹äºå•å¯æ‰§è¡Œæ–‡ä»¶å°±å¯ä»¥æ˜¯çš„ c binding å’Œ ffi binding å…±å­˜äº†ã€‚</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/2017/use-disqus-in-china/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/2017/use-disqus-in-china/">è®©disqusæ”¯æŒå¤§é™†è®¿é—®</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://sysfork.com/post/2017/a-core-cause-by-curl-sighandler/">ä¸€ä¸ªç”± libcurl å¯¼è‡´çš„ core åˆ†æ</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://sysfork.com/post/2017/a-core-cause-by-curl-sighandler/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'sysfork-com';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>



</script>
</body>
</html>

