<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>ä½¿ç”¨C&#43;&#43; mapå®ç°æ³¨å†Œå›è°ƒçš„åŠŸèƒ½ &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>ä½¿ç”¨C&#43;&#43; mapå®ç°æ³¨å†Œå›è°ƒçš„åŠŸèƒ½</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>29 Apr 2017, 15:38</time>
  </div>

  

  
  
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/meta-programming">meta-programming</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/c&#43;&#43;">C&#43;&#43;</a>
    
  </div>
  
  

</div>

  

<p>åœ¨<code>C++/lua</code>æ··åˆç¼–ç¨‹ä¸­ï¼Œå¾€å¾€å­˜åœ¨éœ€è¦å›è°ƒçš„æƒ…å†µã€‚æ¯”å¦‚åœ¨æ¸¸æˆä¸­ï¼Œé€»è¾‘è¿›ç¨‹ä¸­çš„è„šæœ¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“è®¿é—®æ“ä½œï¼Œå¦‚ä¸‹:</p>

<pre><code class="language-lua">dbmgr.query({name=&quot;hello&quot;}, function(ret)
-- do something
end)
</code></pre>

<p>ç”±äº<code>dbmgr.query</code>æ˜¯å¼‚æ­¥æ“ä½œï¼Œè¿™æ¡è¯­å¥æ˜¯ç«‹å³è¿”å›çš„ã€‚å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡å‘<code>dbmgr</code>è¿›ç¨‹å‘é€ä¸€ä¸ª<code>query</code>è¯·æ±‚ï¼Œç„¶åé€»è¾‘è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚å½“<code>dbmgr</code>æ”¶åˆ°è¯·æ±‚åï¼Œå…¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œå¾—åˆ°
ç»“æœç„¶åä¹Ÿæ˜¯é€šè¿‡ç½‘ç»œå°†å…¶å‘é€ç»™é€»è¾‘è¿›ç¨‹ã€‚é€»è¾‘è¿›ç¨‹æ”¶åˆ°ç»“æœåè°ƒç”¨åˆ°<code>lua</code>çš„å›è°ƒå‡½æ•°é‡Œã€‚</p>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªç®€åŒ–æ–¹æ¡ˆï¼Œå¦‚æœæ—¶ä»…ä»…é’ˆå¯¹<code>lua</code>çš„è¯ï¼Œåªéœ€è¦åœ¨å‘<code>dbmgr</code>è¿›ç¨‹å‘é€è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Š<code>lua function</code>çš„æ³¨å†ŒIDå°±å¥½äº†ï¼ŒæŸ¥è¯¢åˆ°ç»“æœåè¿”å›è¿‡æ¥å°±èƒ½ç›´æ¥è°ƒç”¨ã€‚ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæ¥å£ä¸ä»…ä»…åœ¨
<code>lua</code>ä¸­ä½¿ç”¨ï¼Œå¸Œæœ›åœ¨<code>C++</code>ä¸­ä¹Ÿèƒ½è°ƒç”¨ï¼Œå¹¶ä¸”å¸Œæœ›æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¨¡å—æ¥è´Ÿè´£è¿™ç±»äº‹æƒ…ï¼Œè¯¥å¦‚ä½•è®¾è®¡ï¼Ÿä¸€ä¸ªç®€åŒ–åçš„é—®é¢˜å¦‚ä¸‹ï¼š</p>

<pre><code>#include &lt;functional&gt;
#include &lt;map&gt;

std::map&lt;int, std::function&lt;void(void*)&gt;&gt; callbacks;
int last_idx = 0;

//ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œéœ€è¦æ”¯æŒå„ç§function
template&lt;typename T&gt;
int addCallback(T &amp;&amp; t) {
}

//ç”¨äºè°ƒç”¨å›è°ƒå‡½æ•°
template&lt;typename ... ARGS&gt;
void call(int idx, ARGS &amp;&amp; ... args) {
}

void func(int i) {}

class Functor {
public:
	void operator()(const std::string &amp;s, int i) {}
};

int main() {
	int c1 = addCallback(&amp;func);
	int i;
	int c2 = addCallback([i](double j) {});
	int c3 = addCallback(Functor());

	call(c1, 1);
	call(c2, 1.0);
	call(c3, std::string(&quot;string&quot;), 1);

	return 0;
}
</code></pre>

<p>å…¶ä¸­<code>addCallback</code>çš„ä½œç”¨ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯<code>std::function</code>ã€<code>lambda</code>ã€<code>functor</code>ã€æ™®é€šçš„å‡½æ•°ã€æˆå‘˜å‡½æ•°ç­‰ç­‰ã€‚è¿™é‡Œä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œæˆ‘ä»¬åª
å¤„ç†<code>std::function</code>ã€<code>lambda</code>å’Œæ™®é€šå‡½æ•°ï¼Œå…¶ä½™çš„ä¸å†èµ˜è¿°ã€‚ä¸‹é¢æ˜¯ä¸€äº›é—®é¢˜ï¼š</p>

<h1 id="å‚æ•°çš„å¤„ç†">å‚æ•°çš„å¤„ç†ï¼Ÿ</h1>

<p>ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code>map</code>ï¼Œ<code>value_type</code>æ˜¯ä¸€å®šçš„ï¼Œä½ æ— æ³•å°†å¤šä¸ªä¸åŒç±»å‹çš„<code>std::function</code>æ”¾è¿›å»ï¼Œæ‰€ä»¥éœ€è¦éœ€è¦åŒ…ä¸€å±‚ï¼Œè¿™é‡Œå­˜å‚¨çš„æ˜¯<code>std::function&lt;void(void*)&gt;</code>ï¼Œ
ç”±äºæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œè¿”å›å€¼æˆ‘ä»¬ä¸å…³å¿ƒã€‚å‚æ•°ä½¿ç”¨çš„æ˜¯<code>void*</code>ï¼Œå°†ç±»å‹ç»™æŠ¹é™¤æ‰äº†ã€‚é‚£ä¹ˆå‚æ•°çš„å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨<code>std::tuple</code>æ¥å­˜å‚¨ï¼Œé‚£<code>call</code>çš„å®ç°å°±å¾ˆç®€å•äº†:</p>

<pre><code>template&lt;typename ... ARGS&gt;
void call(int idx, ARGS &amp;&amp; ... args) {
	auto it = callbacks.find(idx);
	if (it != callbacks.end() {
		auto tuple = std::tuple&lt;ARGS...&gt;(args...);
		it-&gt;second(&amp;tuple);
	}
}
</code></pre>

<h1 id="callbacks-å­˜å‚¨çš„å†…å®¹æ˜¯"><code>callbacks</code>å­˜å‚¨çš„å†…å®¹æ˜¯ï¼Ÿ</h1>

<p>ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œ<code>map</code>çš„<code>value_type</code>æ˜¯<code>std::function&lt;void(*)&gt;</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°†å¤–éƒ¨ä¼ å…¥çš„å›è°ƒè®¾ç½®è¿›å»ï¼Œéœ€è¦å†åŒ…ä¸€å±‚</p>

<pre><code>template&lt;typename T&gt;
int addCallback(T &amp;&amp; t) {
    last_idx++;
    callbacks[last_idx] = [t](void *data){
        auto ptr = static_cast&lt;std::tuple&lt;...&gt; *&gt;(data); // æ¨¡æ¿å‚æ•°æ€ä¹ˆå¤„ç†ï¼Ÿ
        std::apply(t, *ptr);
    };
}
</code></pre>

<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†<code>C++17</code>ä¸­çš„<a href="http://en.cppreference.com/w/cpp/utility/apply">std::apply</a>ï¼Œå…¶ä½œç”¨å°±æ˜¯è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°æ˜¯ä¸€ä¸ª<code>tuple</code>ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ä»æºç ä¸­çœ‹çœ‹<code>apply</code>çš„å®ç°ï¼Œ
è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚
é—®é¢˜æ˜¯ï¼Œ<code>tuple</code>çš„å‚æ•°å¦‚ä½•å¤„ç†ï¼Ÿæˆ‘ä»¬æ²¡æ³•ä»<code>data</code>ä¸­å¾—åˆ°ç±»å‹å¿ƒç³»ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯ä»<code>T</code>ä¸­è·å–ï¼Œé‚£å¦‚ä½•è·å–å‘¢ï¼Ÿ</p>

<h1 id="callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–">callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–</h1>

<p>ç°åœ¨çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œå¦‚ä½•ä»<code>std::function</code>ã€<code>lambda</code>ã€æ™®é€šå‡½æ•°ç­‰ç±»å‹ä¸­æå–å‚æ•°ä¿¡æ¯ã€‚å¯¹äºæ™®é€šå‡½æ•°å’Œ<code>std::function</code>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‰¹åŒ–æ¥åš</p>

<pre><code>template&lt;typename T&gt;
struct CallbackTypeHelper;

template&lt;typename RET, typename ... ARGS&gt;
struct CallbackTypeHelper&lt;RET(*)(ARGS...)&gt; {
    typedef std::tuple&lt;ARGS...&gt; typle_type;
}

template&lt;typename RET, typename ... ARGS&gt;
struct CallbackTypeHelper&lt;std::function&lt;RET(ARGS...)&gt;&gt; {
    typedef std::tuple&lt;ARGS...&gt; typle_type;
}
</code></pre>

<p>å¯¹äº<code>lambda</code>è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>

<p><code>lambda</code>ä½œä¸º<code>C++11</code>ä¸­æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå…¶ä½œç”¨æ˜¯å®ç°ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç”±äºæ•è·ç»„çš„å­˜åœ¨ï¼Œå…¶ä¸èƒ½ä»…ä»…å®ç°æˆä¸€ä¸ª<code>C Function</code>ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼Œå„ä¸ªæ•è·å‚æ•°å³ä¸ºæˆå‘˜
å˜é‡ï¼Œä¸ºäº†å®ç°å¯è¢«è°ƒç”¨ï¼Œå…¶é‡è½½äº†<code>operator()</code>ã€‚æ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è·å–å‚æ•°çš„æ–¹æ³•ï¼š</p>

<pre><code>template&lt;typename T&gt;
struct CallbackFunctorHelper;

template&lt;typename RET, typename C, typename ... ARGS&gt;
struct CallbackFunctorHelper&lt;RET(C::*)(ARGS...) const&gt; {
  typedef std::tuple&lt;ARGS...&gt; tuple_type;
};

template&lt;typename RET, typename C, typename ... ARGS&gt;
struct CallbackFunctorHelper&lt;RET(C::*)(ARGS...)&gt; {
  typedef std::tuple&lt;ARGS...&gt; tuple_type;
};

template &lt;typename T, typename Enabled=void&gt;
struct CallbackTypeHelper {
  typedef typename CallbackFunctorHelper&lt;decltype(&amp;std::decay&lt;T&gt;::type::operator())&gt;::tuple_type tuple_type;
};

</code></pre>

<p>æ³¨æ„ç”±äºå‚æ•°æœ‰å¯èƒ½æ˜¯å¼•ç”¨ï¼Œæ‰€æœ‰è¿™é‡Œéœ€è¦<a href="http://en.cppreference.com/w/cpp/types/decay">decay</a>æ¥å¤„ç†è¿™äº›å¼•ç”¨ã€‚åŒæ—¶ç”±äº<code>lambda</code>çš„<code>mutable</code>å±æ€§çš„å­˜åœ¨ï¼Œæ‰€ä»¥<code>CallbackFunctorHelper</code>
éœ€è¦<code>const</code>å’Œ<code>non-const</code>çš„ç‰¹åŒ–ã€‚</p>

<p>æœ€åï¼Œç”±äºè¿™åªæ˜¯æ¼”ç¤ºæ€§è´¨çš„ä»£ç ï¼Œæœ‰äº›é€»è¾‘å¦‚æˆå‘˜å‡½æ•°ç­‰å¹¶æ²¡æœ‰è€ƒè™‘è¿›å»ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥ä½¿ç”¨<code>enable_if</code>åšä¸ªå•ç‹¬çš„ç‰¹åŒ–ï¼Œè€Œä¸éœ€è¦åœ¨é»˜è®¤å‡½æ•°ä¸Šå†™<code>functor</code>çš„å®ç°ç­‰ã€‚åœ¨å®é™…
åº”ç”¨ä¸­å¯ä»¥ä¿®æ”¹å¾—æ›´åŠ å…¨é¢å’Œä¼˜é›…ã€‚</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/2017/lua-c-detect-inifinite-loop/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/2017/lua-c-detect-inifinite-loop/">luaä¸Cäº¤äº’ä¸­çš„æ­»å¾ªç¯æ£€æµ‹</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://sysfork.com/post/2017/a-solution-for-elf-integrate-scripts/">ä¸€ç§åœ¨elfä¸­é›†æˆè„šæœ¬æ–‡ä»¶çš„æ–¹æ¡ˆ</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://sysfork.com/post/2017/a-solution-for-elf-integrate-scripts/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'sysfork-com';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>



</script>
</body>
</html>

