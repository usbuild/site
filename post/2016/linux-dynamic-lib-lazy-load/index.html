<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>ç†è§£Linuxä¸‹åŠ¨æ€é“¾æ¥åº“å»¶è¿Ÿç»‘å®š &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>ç†è§£Linuxä¸‹åŠ¨æ€é“¾æ¥åº“å»¶è¿Ÿç»‘å®š</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>07 Sep 2016, 22:08</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/linux">Linux</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/elf">ELF</a>
    
  </div>
  
  

</div>

  <script src="//cdn.bootcss.com/highlight.js/9.6.0/languages/x86asm.min.js"></script>

<p>åœ¨ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“æ—¶ï¼Œä¸ºäº†ä¿è¯èƒ½è¢«æ­£å¸¸ä½¿ç”¨ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šåŠ ä¸Š-fPICå‚æ•°ã€‚åœ¨ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°æ—¶ï¼ŒLinuxä½¿ç”¨äº†ä¸€ç§
å«å»¶è¿Ÿç»‘å®šçš„æŠ€æœ¯å®ç°è¿è¡Œæ—¶çš„symbol relocationã€‚å…¶ä¸­çš„å…³é”®å°±æ˜¯GOT(Global Offset Table)å’ŒPLT(Procedure linkage Table)ã€‚ä¸‹é¢å°±
è¿™ä¸€æŠ€æœ¯çš„å®ç°ç®€å•è§£é‡Šä¸€ä¸‹ã€‚</p>

<p>é¦–å…ˆå†™ä¸€ä¸ªå¾ˆç®€å•çš„éœ€è¦åŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼Œå¦‚ä¸‹</p>

<pre><code class="language-c">//dl_test.c
#include &lt;stdio.h&gt;
int main(int argc, const char *argv[])
{
    puts(&quot;1234&quot;);
    puts(&quot;1234&quot;);
    return 0;
}
</code></pre>

<p>ç„¶åä½¿ç”¨<code>gcc</code>ç¼–è¯‘å¹¶é“¾æ¥: <code>gcc -g dl_test.c -o dl_test.c</code>ã€‚å…ˆåˆ«æ€¥ç€è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæˆ‘ä»¬ä½¿ç”¨<code>objdump</code>åç¼–è¯‘ä¸€ä¸‹çœ‹çœ‹ï¼š</p>

<pre><code class="language-bash">$ objdump -S dl_test
......
0000000000400506 &lt;main&gt;:
#include &lt;stdio.h&gt;
int main(int argc, const char *argv[])
{
  400506:       55                      push   %rbp
  400507:       48 89 e5                mov    %rsp,%rbp
  40050a:       48 83 ec 10             sub    $0x10,%rsp
  40050e:       89 7d fc                mov    %edi,-0x4(%rbp)
  400511:       48 89 75 f0             mov    %rsi,-0x10(%rbp)
    puts(&quot;1234&quot;);
  400515:       bf b4 05 40 00          mov    $0x4005b4,%edi
  40051a:       e8 c1 fe ff ff          callq  4003e0 &lt;puts@plt&gt;
    puts(&quot;1234&quot;);
  40051f:       bf b4 05 40 00          mov    $0x4005b4,%edi
  400524:       e8 b7 fe ff ff          callq  4003e0 &lt;puts@plt&gt;
    return 0;
  400529:       b8 00 00 00 00          mov    $0x0,%eax
}
  40052e:       c9                      leaveq
  40052f:       c3                      retq
......
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>40051a</code>å’Œ<code>400524</code>ä¸¤å¤„éƒ½è°ƒç”¨äº†æˆ‘ä»¬çš„<code>puts</code>å‡½æ•°ã€‚ä½†æ˜¯çœ‹åé¢çš„æ³¨è§£ï¼Œ<code>&lt;puts@plt&gt;</code>è¡¨ç¤ºè¿™å¹¶ä¸æ˜¯<code>puts</code>çš„åœ°å€ï¼Œè€Œæ˜¯å¦æœ‰ç›®çš„ã€‚
æˆ‘ä»¬ä½¿ç”¨<code>gdb</code>æ¥è·Ÿè¸ªä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ï¼š<code>gdb dl_test</code></p>

<pre><code>(gdb) l
1	#include &lt;stdio.h&gt;
2	int main(int argc, const char *argv[])
3	{
4	    puts(&quot;1234&quot;);
5	    puts(&quot;1234&quot;);
6	    return 0;
7	}
(gdb) b 4
Breakpoint 1 at 0x400515: file dl_test.c, line 4.
(gdb) r
Starting program: /home/zqc/workspace/cpptest/dl_test

Breakpoint 1, main (argc=1, argv=0x7fffffffeb98) at dl_test.c:4
4	    puts(&quot;1234&quot;);
(gdb)
</code></pre>

<p>è¿™é‡Œè®¾ç½®äº†ä¸€ä¸‹æ–­ç‚¹åˆ°ç¬¬ä¸€ä¸ª<code>puts</code>çš„è°ƒç”¨å‡ºï¼Œä½¿ç”¨<code>layout asm</code>åˆ‡æ¢æˆæ±‡ç¼–æ¨¡å¼:</p>

<pre><code class="language-x86asm">(gdb) layout asm
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
B+&gt;â”‚0x400515 &lt;main+15&gt;              mov    $0x4005b4,%edi                                       â”‚
   â”‚0x40051a &lt;main+20&gt;              callq  0x4003e0 &lt;puts@plt&gt;                                  â”‚
   â”‚0x40051f &lt;main+25&gt;              mov    $0x4005b4,%edi                                       â”‚
   â”‚0x400524 &lt;main+30&gt;              callq  0x4003e0 &lt;puts@plt&gt;                                  â”‚
   â”‚0x400529 &lt;main+35&gt;              mov    $0x0,%eax                                            â”‚
   â”‚0x40052e &lt;main+40&gt;              leaveq                                                      â”‚
   â”‚0x40052f &lt;main+41&gt;              retq                                                        â”‚
   â”‚0x400530 &lt;__libc_csu_init&gt;      push   %r15                                                 â”‚
   â”‚0x400532 &lt;__libc_csu_init+2&gt;    mov    %edi,%r15d                                           â”‚
   â”‚0x400535 &lt;__libc_csu_init+5&gt;    push   %r14                                                 â”‚
   â”‚0x400537 &lt;__libc_csu_init+7&gt;    mov    %rsi,%r14                                            â”‚
   â”‚0x40053a &lt;__libc_csu_init+10&gt;   push   %r13                                                 â”‚
   â”‚0x40053c &lt;__libc_csu_init+12&gt;   mov    %rdx,%r13                                            â”‚
   â”‚0x40053f &lt;__libc_csu_init+15&gt;   push   %r12                                                 â”‚
   â”‚0x400541 &lt;__libc_csu_init+17&gt;   lea    0x2001a0(%rip),%r12        # 0x6006e8                â”‚
   â”‚0x400548 &lt;__libc_csu_init+24&gt;   push   %rbp                                                 â”‚
   â”‚0x400549 &lt;__libc_csu_init+25&gt;   lea    0x2001a0(%rip),%rbp        # 0x6006f0                â”‚
   â”‚0x400550 &lt;__libc_csu_init+32&gt;   push   %rbx                                                 â”‚
   â”‚0x400551 &lt;__libc_csu_init+33&gt;   sub    %r12,%rbp                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
child process 8855 In: main                                              Line: 4    PC: 0x400515
</code></pre>

<p>ä½¿ç”¨<code>stepi</code>æˆ–è€…ç®€å†™ä¸º<code>si</code>æ‰§è¡Œä¸‹ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤ã€‚æˆ‘ä»¬ä¸€ç›´è·Ÿè¸ªåˆ°<code>call</code>æŒ‡ä»¤ä¸­å»ï¼š</p>

<pre><code class="language-x86asm">   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  &gt;â”‚0x4003e0 &lt;puts@plt&gt;                     jmpq   *0x20050a(%rip)   # 0x6008f0 &lt;puts@got.plt&gt;              â”‚
   â”‚0x4003e6 &lt;puts@plt+6&gt;                   pushq  $0x0                                                     â”‚
   â”‚0x4003eb &lt;puts@plt+11&gt;                  jmpq   0x4003d0                                                 â”‚
   â”‚0x4003f0 &lt;__libc_start_main@plt&gt;        jmpq   *0x200502(%rip)   # 0x6008f8 &lt;__libc_start_main@got.plt&gt; â”‚
   â”‚0x4003f6 &lt;__libc_start_main@plt+6&gt;      pushq  $0x1                                                     â”‚
   â”‚0x4003fb &lt;__libc_start_main@plt+11&gt;     jmpq   0x4003d0                                                 â”‚
   â”‚0x400400 &lt;__gmon_start__@plt&gt;           jmpq   *0x2004fa(%rip)   # 0x600900 &lt;__gmon_start__@got.plt&gt;    â”‚
   â”‚0x400406 &lt;__gmon_start__@plt+6&gt;         pushq  $0x2                                                     â”‚
   â”‚0x40040b &lt;__gmon_start__@plt+11&gt;        jmpq   0x4003d0                                                 â”‚
   â”‚0x400410 &lt;_start&gt;                       xor    %ebp,%ebp                                                â”‚
   â”‚0x400412 &lt;_start+2&gt;                     mov    %rdx,%r9                                                 â”‚
   â”‚0x400415 &lt;_start+5&gt;                     pop    %rsi                                                     â”‚
   â”‚0x400416 &lt;_start+6&gt;                     mov    %rsp,%rdx                                                â”‚
   â”‚0x400419 &lt;_start+9&gt;                     and    $0xfffffffffffffff0,%rsp                                 â”‚
   â”‚0x40041d &lt;_start+13&gt;                    push   %rax                                                     â”‚
   â”‚0x40041e &lt;_start+14&gt;                    push   %rsp                                                     â”‚
   â”‚0x40041f &lt;_start+15&gt;                    mov    $0x4005a0,%r8                                            â”‚
   â”‚0x400426 &lt;_start+22&gt;                    mov    $0x400530,%rcx                                           â”‚
   â”‚0x40042d &lt;_start+29&gt;                    mov    $0x400506,%rdi                                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
child process 9211 In: puts@plt                                                      Line: ??   PC: 0x4003e0
0x00000000004003e0 in puts@plt ()
(gdb)
</code></pre>

<p><code>0x4003e0</code>æ˜¯åˆšåˆšè·³è½¬çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯<code>&lt;puts@plt&gt;</code>ï¼Œä»è¿™ä¸ªåå­—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªåœ°å€æ˜¯å±äº<code>plt</code>çš„ã€‚å…ˆè¯´ä¸€ä¸‹<code>plt</code>çš„ä½œç”¨ï¼Œ<code>plt</code>çš„å…¨ç§°æ˜¯
è¿‡ç¨‹é“¾æ¥è¡¨ï¼Œæ„æ€å°±æ˜¯å½“è°ƒç”¨ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°æ—¶ï¼Œå…¶è®¿é—®çš„æ˜¯å…¶å®æ˜¯<code>plt</code>ä¸­çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå®ŒæˆçœŸæ­£çš„è°ƒç”¨ã€‚æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å±äº<code>puts</code>ä¸­
<code>plt</code>çš„é¡¹ç›®</p>

<pre><code class="language-x86asm">  &gt;â”‚0x4003e0 &lt;puts@plt&gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &lt;puts@got.plt&gt;     â”‚
   â”‚0x4003e6 &lt;puts@plt+6&gt;                   pushq  $0x0                                                 â”‚
   â”‚0x4003eb &lt;puts@plt+11&gt;                  jmpq   0x4003d0                                             â”‚
</code></pre>

<p>å…¶ä¸­ <code>0x20050a(%rip)</code> å³ <code>got</code>ä¸­çš„åœ°å€ï¼Œåœ¨åˆå§‹æƒ…å†µä¸‹ï¼Œè¯¥é€‰é¡¹ä¸º<code>plt</code>é¡¹ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>jmpq   *0x20050a(%rip)</code> ç›´æ¥ä¼šè¿›å…¥åˆ°
ä¸‹ä¸€æ¡æŒ‡ä»¤<code>pushq</code>ï¼Œ <code>pushq $0x0</code>çš„ç›®çš„æ˜¯æŠŠå½“å‰åœ¨ç¬¦å·(<code>puts</code>)åœ¨<code>.rela.plt</code>ä¸­çš„indexã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>readelf</code>æŒ‡ä»¤çœ‹ä¸‹ï¼š</p>

<pre><code class="language-bash">$ readelf -r dl_test

Relocation section '.rela.dyn' at offset 0x348 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000006008d0  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0

Relocation section '.rela.plt' at offset 0x360 contains 3 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000006008f0  000100000007 R_X86_64_JUMP_SLO 0000000000000000 puts + 0
0000006008f8  000200000007 R_X86_64_JUMP_SLO 0000000000000000 __libc_start_main + 0
000000600900  000300000007 R_X86_64_JUMP_SLO 0000000000000000 __gmon_start__ + 0
</code></pre>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>puts</code>çš„indexä¸º0ï¼Œç¬¬ä¸€é¡¹ï¼Œæ‰€ä»¥è¿™é‡Œpushçš„æ˜¯<code>$0x0</code>ã€‚åŒç†ï¼Œä¸‹é¢çš„<code>__libc_start_main</code>å°±æ˜¯<code>$0x1</code>ã€‚ ä¸‹ä¸€è¡Œè¯­å¥æ˜¯<code>jmpq   0x4003d0</code>ï¼Œè¿™ä¸ªåœ°å€æ˜¯
å›ºå®šçš„ï¼Œæ‰€æœ‰çš„<code>plt</code>å…¥å£æœ€åä¸€å¥è¯­å¥éƒ½æ˜¯è¿™ä¸ªï¼Œè¿™æ˜¯ä¸ªé€šç”¨çš„è¿‡ç¨‹ã€‚
ç»§ç»­<code>stepi</code>åˆ°jumpçš„ä½ç½®</p>

<pre><code class="language-x86asm">  &gt;â”‚0x4003d0                                pushq  0x20050a(%rip)        # 0x6008e0                     â”‚
   â”‚0x4003d6                                jmpq   *0x20050c(%rip)        # 0x6008e8                    â”‚
   â”‚0x4003dc                                nopl   0x0(%rax)                                            â”‚
   â”‚0x4003e0 &lt;puts@plt&gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &lt;puts@got.plt&gt;     â”‚
</code></pre>

<p>å‘ç°è¿™ä¸ªåœ°å€å°±æ˜¯åœ¨<code>puts@plt</code>çš„ä¸Šé¢ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯å’Œæ™®é€š<code>plt</code>å…¥å£é¡¹ç›®å¤§å°(<code>0x10</code>)ï¼Œå…¶æœ«å°¾è¿˜ç”¨0è¡¥é½äº†(<code>nopl   0x0(%rax)</code>)ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹å‰é¢ä¸¤å¥ã€‚</p>

<p><code>pushq  0x20050a(%rip)        # 0x6008e0</code>ï¼Œè¿™é‡Œpushäº†ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯å¹²å˜›çš„ï¼Ÿæˆ‘ä»¬ä½¿ç”¨<code>gdb</code>çœ‹ä¸€ä¸‹ï¼š</p>

<pre><code>(gdb) x /16x 0x6008e0
0x6008e0:       0xf7ffe1a8      0x00007fff      0xf7df02b0      0x00007fff
0x6008f0 &lt;puts@got.plt&gt;:        0x004003e6      0x00000000      0xf7a52a50      0x00007fff
0x600900 &lt;__gmon_start__@got.plt&gt;:      0x00400406      0x00000000      0x00000000      0x00000000
0x600910:       0x00000000      0x00000000      0x00000000      0x00000000
</code></pre>

<p>è¿™ä¸ªåœ°å€å…¶å®å°±æ˜¯<code>got</code>ä¸­çš„ä¸€é¡¹ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰æ™®é€šç¬¦å·<code>got</code>çš„å‰é¢ã€‚é‚£ä¹ˆç›®å‰æ ˆä¸Šçš„å…ƒç´ æ˜¯ï¼š</p>

<pre><code>| 0x00007ffff7ffe1a8 |
| 0x0                |
</code></pre>

<p>æ¥ä¸‹æ¥åˆ°æ˜¯<code>jmpq   *0x20050c(%rip)</code> è¿™ä¸ªåœ°å€ä¹Ÿæ˜¯åœ¨pltä¸Šï¼Œç´§æŒ¨ç€ä¸Šé¢pushçš„åœ°å€ï¼Œå€¼ä¸º<code>0x00007ffff7df02b0</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­<code>stepi</code>è¿›å»ï¼Œä¹Ÿå¯ä»¥
é€šè¿‡<code>disassemble 0x00007ffff7df02b0</code>æŸ¥çœ‹ã€‚æˆ–è€…ï¼Œä½¿ç”¨<code>info symbol 0x00007ffff7df02b0</code>ç›´æ¥æŸ¥çœ‹ã€‚</p>

<pre><code>(gdb) info symbol 0x00007ffff7df02b0
_dl_runtime_resolve in section .text of /lib64/ld-linux-x86-64.so.2
</code></pre>

<p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯å±äº<code>ld-linux-x86-64.so.2</code>é‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•ã€‚è¿™ä¸ªsoå±äº<code>glibc</code>çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸‹è½½<a href="ftp://ftp.gnu.org/gnu/glibc">glibc</a>æ¥æŸ¥çœ‹ã€‚æœ€ç»ˆæˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªç¬¦å·å®šä¹‰æ–‡ä»¶ï¼Œ
å…¶ä½ç½®åœ¨<code>sysdeps/x86_64/dl-trampoline.S</code>ï¼Œå†…å®¹å¦‚ä¸‹</p>

<pre><code class="language-x86asm"> 28     .globl _dl_runtime_resolve
 29     .type _dl_runtime_resolve, @function
 30     .align 16
 31     cfi_startproc
 32 _dl_runtime_resolve:
 33     cfi_adjust_cfa_offset(16) # Incorporate PLT
 34     subq $56,%rsp
 35     cfi_adjust_cfa_offset(56)
 36     movq %rax,(%rsp)    # Preserve registers otherwise clobbered.
 37     movq %rcx, 8(%rsp)
 38     movq %rdx, 16(%rsp)
 39     movq %rsi, 24(%rsp)
 40     movq %rdi, 32(%rsp)
 41     movq %r8, 40(%rsp)
 42     movq %r9, 48(%rsp)
 43     movq 64(%rsp), %rsi # Copy args pushed by PLT in register.
 44     movq 56(%rsp), %rdi # %rdi: link_map, %rsi: reloc_index
 45     call _dl_fixup      # Call resolver.
 46     movq %rax, %r11     # Save return value
 47     movq 48(%rsp), %r9  # Get register content back.
 48     movq 40(%rsp), %r8
 49     movq 32(%rsp), %rdi
 50     movq 24(%rsp), %rsi
 51     movq 16(%rsp), %rdx
 52     movq 8(%rsp), %rcx
 53     movq (%rsp), %rax
 54     addq $72, %rsp      # Adjust stack(PLT did 2 pushes)
 55     cfi_adjust_cfa_offset(-72)
 56     jmp *%r11       # Jump to function address.
 57     cfi_endproc
 58     .size _dl_runtime_resolve, .-_dl_runtime_resolve
</code></pre>

<p>ä»43è¡Œå¼€å§‹æ˜¯æˆ‘ä»¬çš„é€»è¾‘ã€‚43è¡Œå–å‡ºäº†æˆ‘ä»¬åˆšåˆšpushçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯<code>$0x0</code>ï¼Œæ”¾åˆ°<code>%rsi</code>ä¸­ï¼Œç„¶åæ˜¯æˆ‘ä»¬pushçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ<code>0x00007ffff7ffe1a8</code>åˆ°<code>%rsi</code>ä¸­ã€‚
ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸¤ä¸ªå¯„å­˜å™¨å‘¢ï¼Ÿæˆ‘ä»¬<code>man syscall</code>ä¸€ä¸‹ï¼š</p>

<pre><code>       arch/ABI   arg1   arg2   arg3   arg4   arg5   arg6   arg7
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       x86_64     rdi    rsi    rdx    r10    r8     r9     -
</code></pre>

<p>å¯ä»¥çœ‹å‡ºlinuxä¸‹çš„å‡½æ•°ä¼ å‚æ–¹å¼ï¼Œ é‚£ä¹ˆ<code>%rdi</code>å°±æ˜¯å‚æ•°1ï¼Œè€Œ<code>%rsi</code>å°±æ˜¯å‚æ•°2äº†ã€‚æ¥ä¸‹æ¥æ˜¯<code>call _dl_fixup</code>ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›å€¼å°±æ˜¯æŒ‡å‘<code>puts</code>å­˜å‚¨åœ°å€ä½ç½®çš„æŒ‡é’ˆäº†ï¼Œåé¢å¯ä»¥çœ‹åˆ°
ä»£ç ä¸­å°†è¿™ä¸ªæŒ‡é’ˆä¿å­˜åˆ°äº†<code>%r11</code>ï¼Œç„¶å<code>jmp *%r11</code>ã€‚å®Œæˆäº†ä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹<code>_dl_fixup</code>åšäº†äº›ä»€ä¹ˆã€‚åŒæ ·ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯<code>gblic</code>ä¸­å®šä¹‰çš„ï¼Œä½ç½®åœ¨<code>elf/dl-runtime.c</code>ä¸­ï¼š</p>

<pre><code class="language-c">59 DL_FIXUP_VALUE_TYPE
60 __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE
61 _dl_fixup (
62 # ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS
63        ELF_MACHINE_RUNTIME_FIXUP_ARGS,
64 # endif
65        struct link_map *l, ElfW(Word) reloc_arg)
66 {
</code></pre>

<p>ä»å‡½æ•°åŸå‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¹‹å‰<code>push</code>çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯<code>link_map</code>å’Œ<code>reloc_arg</code>ï¼Œ</p>

<pre><code class="language-c"> 67   const ElfW(Sym) *const symtab
 68     = (const void *) D_PTR (l, l_info[DT_SYMTAB]);
 69   const char *strtab = (const void *) D_PTR (l, l_info[DT_STRTAB]);
 70 
 71   const PLTREL *const reloc
 72     = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);
 73   const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];
 74   void *const rel_addr = (void *)(l-&gt;l_addr + reloc-&gt;r_offset);
</code></pre>

<p>è¿™é‡Œåšäº†ä¸€ä¸‹è½¬å‹ï¼Œé‚£ä¹ˆ<code>symtab</code>å’Œ<code>strtab</code>åˆ†åˆ«æ˜¯å¯¹äº<code>section</code>çš„åœ°å€ï¼Œè€Œ<code>reloc_addr</code>å°±æ˜¯æˆ‘ä»¬<code>got</code>ä¸­çš„<code>puts@got.plt</code>çš„åœ°å€ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç¬¦å·è§£æè¿‡ç¨‹äº†ï¼Œ
åé¢å¯èƒ½ä¼šæœ‰æ–‡ç« æ¥è§£é‡Šè¿™ä¸ªè¿‡ç¨‹ã€‚å½“æ‰¾åˆ°ç›®æ ‡åœ°å€å</p>

<pre><code class="language-c">//elf/dl-runtime.c
148   return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);
//sysdeps/x86_64/dl-machine.h
205 static inline ElfW(Addr)
206 elf_machine_fixup_plt (struct link_map *map, lookup_t t,
207                const ElfW(Rela) *reloc,
208                ElfW(Addr) *reloc_addr, ElfW(Addr) value)
209 {
210   return *reloc_addr = value;
211 }
</code></pre>

<p>è¿™é‡Œçš„<code>value</code>å°±æ˜¯ç›®æ ‡å‡½æ•°åœ°å€ï¼Œä¹Ÿå°±æ˜¯<code>puts</code>çš„çœŸæ­£åœ°å€ï¼Œä»£ç ä¸­è®¾ç½®å…¶åˆ°äº†<code>puts@got.plt</code>çš„ä½ç½®å¹¶è¿”å›ã€‚</p>

<p>ä»¥ä¸Šå°±æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨<code>puts</code>çš„è¿‡ç¨‹äº†ï¼Œå½“ç¬¬äºŒæ¬¡è°ƒç”¨<code>puts</code>æ—¶ï¼Œç”±äº<code>puts@got.plt</code>å·²ç»æœ‰äº†æ­£ç¡®çš„åœ°å€ï¼Œæ‰€ä»¥</p>

<pre><code class="language-x86asm">  &gt;â”‚0x4003e0 &lt;puts@plt&gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &lt;puts@got.plt&gt;    â”‚
</code></pre>

<p>å°±ç›´æ¥è·³è½¬åˆ°æ­£ç¡®çš„<code>puts</code>ä½ç½®ï¼Œå®Œæˆäº†å‡½æ•°è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œ<code>linux</code>ä¸‹çš„è¿™ç§æ‡’ç»‘å®šæ–¹å¼å®ç°äº†åœ¨ä¸ä½¿ç”¨ç¬¦å·çš„æ—¶å€™ä¸è§£æï¼Œè€Œéœ€è¦ä½¿ç”¨çš„æ—¶å€™
åªåœ¨ç¬¬ä¸€æ­¥å¼€é”€æ¯”è¾ƒå¤§ï¼Œåé¢çš„è°ƒç”¨å¼€é”€æ— éå¤šäº†ä¸€æ¬¡è·³è½¬å’Œä¸€æ¬¡å¯»å€æ“ä½œè€Œå·²ã€‚</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/2016/integrate-mathjax-viz-with-hugo/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/2016/integrate-mathjax-viz-with-hugo/">Hugo é›†æˆ Mathjaxå’Œgraphviz</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://sysfork.com/post/2016/about-cpp-alignment/">æµ…è°ˆC&#43;&#43;ä¸­çš„åœ°å€å¯¹é½</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://sysfork.com/post/2016/about-cpp-alignment/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'lecoding';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
    
        
        <script type="text/javascript" src="//cdn.bootcss.com/viz.js/1.3.0/viz.js"> </script>
<script type="text/javascript">
(function(){
    var vizPrefix = "language-viz-";
    Array.prototype.forEach.call(document.querySelectorAll("[class^=" + vizPrefix + "]"), function(x){
        var engine;
        x.getAttribute("class").split(" ").forEach(function(cls){
            if (cls.startsWith(vizPrefix)) {
                engine = cls.substr(vizPrefix.length);
            }
        });
        var image = new DOMParser().parseFromString(Viz(x.innerText, {format:"svg", engine:engine}), "image/svg+xml");
        x.parentNode.insertBefore(image.documentElement, x);
        x.style.display = 'none'
    });
})();
</script>
    

</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19710645-12', 'auto');
  ga('send', 'pageview');

</script>


</script>
</body>
</html>

