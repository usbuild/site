<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on sysğŸ”±fork</title>
    <link>http://sysfork.com/post/</link>
    <description>Recent content in Posts on sysğŸ”±fork</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>&amp;copy; 2017. All rights reserved.</copyright>
    <lastBuildDate>Tue, 30 May 2017 17:03:21 +0800</lastBuildDate>
    <atom:link href="http://sysfork.com/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>åœ¨ vue ä¸­ä½¿ç”¨ semantic-ui</title>
      <link>http://sysfork.com/post/2017/use-semantic-ui-with-vue/</link>
      <pubDate>Tue, 30 May 2017 17:03:21 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/use-semantic-ui-with-vue/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://cn.vuejs.org/&#34;&gt;Vue&lt;/a&gt; æ˜¯ä¸€ä¸ªå¾ˆå¥½å‘€çš„ MVVM æ¡†æ¶ï¼Œæˆ‘æœ€è¿‘åœ¨ä¸€ä¸ªå†…éƒ¨ä½¿ç”¨çš„ç®¡ç†åå°åˆæ¬¡ä½¿ç”¨ã€‚è€Œ &lt;a href=&#34;https://semantic-ui.com/&#34;&gt;semantic-ui&lt;/a&gt; åˆ™æ˜¯
ä¸€ä¸ªæ¯”è¾ƒç¾è§‚å…¨é¢çš„ css æ¡†æ¶ï¼Œä¹Ÿæ˜¯æˆ‘æ¯”è¾ƒåå¥½ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œåœ¨è¿™æ¬¡é‡æ„ç®¡ç†åå°æ—¶ï¼Œè¿™ä¸¤è€…å°±è¢«æˆ‘é€‰æ‹©ä½¿ç”¨ã€‚PSï¼š æœåŠ¡å™¨ç«¯ç”¨çš„æ˜¯ &lt;a href=&#34;https://www.djangoproject.com/&#34;&gt;Django&lt;/a&gt;ï¼Œ
ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ã€‚&lt;/p&gt;

&lt;p&gt;semantic-ui å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä½¿ç”¨å…¶ css éƒ¨åˆ†æ˜¯æ²¡é—®é¢˜çš„ï¼Œå¦‚ &lt;a href=&#34;https://semantic-ui.com/elements/button.html&#34;&gt;button&lt;/a&gt;, &lt;a href=&#34;https://semantic-ui.com/collections/table.html&#34;&gt;table&lt;/a&gt;
ç­‰ï¼Œç›´æ¥å¥—ç”¨å¯¹åº”çš„ css æ ·å¼å³å¯ã€‚ä½†æ˜¯å¯¹äºæŸäº›éœ€è¦ js åˆå§‹åŒ–çš„æ§ä»¶ï¼Œå¦‚ &lt;a href=&#34;https://semantic-ui.com/modules/dropdown.html&#34;&gt;dropdown&lt;/a&gt;, &lt;a href=&#34;https://semantic-ui.com/modules/popup.html&#34;&gt;popup&lt;/a&gt;
ç­‰ï¼Œéƒ½éœ€è¦è°ƒç”¨å¯¹åº”çš„å‡½æ•°ï¼Œå¦‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$(&#39;.ui.dropdown&#39;)
  .dropdown()
;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‚£ä¹ˆå¯¹äº Vue ä¸­åŠ¨æ€ç”Ÿæˆçš„æ§ä»¶è¦æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ æˆ‘ä»¬å¸Œæœ›åœ¨æ§ä»¶åŠ å…¥åˆ° dom åèƒ½å¤Ÿè°ƒç”¨å¯¹åº”çš„ semnatic-ui åˆå§‹åŒ–å‡½æ•°ï¼Œä½†æ˜¯ç”±äº Vue çš„æ’å…¥æ˜¯è‡ªåŠ¨å®Œæˆçš„ï¼Œæˆ‘ä»¬ä¸å¥½åˆ¤æ–­æ—¶æœºï¼Œå¥½åœ¨ Vue æä¾›äº†
&lt;a href=&#34;https://cn.vuejs.org/v2/guide/custom-directive.html&#34;&gt;è‡ªå®šä¹‰æŒ‡ä»¤&lt;/a&gt;ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹æ³•æ¥åšï¼š&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå‡è®¾æˆ‘ä»¬çš„ html æ˜¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;div id=&amp;quot;main&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶å Vue å®ä¾‹ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;let data = {
    data: [&amp;quot;Male&amp;quot;, &amp;quot;Female&amp;quot;]
}
new Vue({
    el: &amp;quot;#main&amp;quot;,
    data,
    template: `
    &amp;lt;select class=&amp;quot;ui dropdown&amp;quot;&amp;gt;
        &amp;lt;option value=&amp;quot;&amp;quot;&amp;gt;Gender&amp;lt;/option&amp;gt;
        &amp;lt;option v-for=&amp;quot;(v, k) in data&amp;quot; :value=&amp;quot;k&amp;quot;&amp;gt;{{ v }}&amp;lt;/option&amp;gt;
    &amp;lt;/select&amp;gt;
    `
})
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä»¥ dropdown æ§ä»¶ä¸ºä¾‹ï¼ŒæŒ‰ç…§ä»¥å¾€çš„åšæ³•ï¼Œæˆ‘ä»¬æ­¤æ—¶å¯ä»¥è°ƒç”¨&lt;code&gt;$(&amp;quot;.ui.dropdown&amp;quot;).dropdown()&lt;/code&gt;æ¥å¤„ç†ï¼Œä½†æ˜¯å¯¹äº Vue åˆ™å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰æŒ‡ä»¤ã€‚å‡è®¾æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæŒ‡ä»¤åä¸º&lt;code&gt;v-sudropdown&lt;/code&gt;ï¼Œ
ç„¶åå°†å…¶åŠ åˆ° &lt;code&gt;select&lt;/code&gt; ä¸­ï¼Œäºæ˜¯å˜ä¸º&lt;code&gt;&amp;lt;select class=&amp;quot;ui dropdown&amp;quot; v-sudropdown&amp;gt;&lt;/code&gt;ï¼Œé‚£è¿™ä¸ª directive è¯¥æ€ä¹ˆå†™å‘¢ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;Vue.directive (&amp;quot;sudropdown&amp;quot;, {
        inserted: el =&amp;gt; $(el).dropdown({})
    })

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ï¼Œ&lt;code&gt;inserted&lt;/code&gt; æ˜¯ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œä¸€æ—¦å¸¦æœ‰è¿™ä¸ª &lt;code&gt;directive&lt;/code&gt; çš„å…ƒç´ è¢«æ’å…¥åˆ° dom æ—¶ï¼Œè¿™ä¸ªé’©å­å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®Œæˆæˆ‘ä»¬çš„åˆå§‹åŒ–æ“ä½œã€‚è¿™æ · vue å’Œ semantic-ui å°±èƒ½å®Œç¾å…±å­˜äº†ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>lua 5.1 åˆ†æ”¯è¯­å¥ bytecode çš„ç”Ÿæˆï¼ˆäºŒï¼‰</title>
      <link>http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-2/</link>
      <pubDate>Thu, 25 May 2017 14:26:47 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-2/</guid>
      <description>&lt;p&gt;ä¸Šç¯‡æˆ‘ä»¬è°ˆåˆ°äº† IF è¯­å¥çš„ bytecode ç”Ÿæˆï¼Œä»Šå¤©æ¥è°ˆè°ˆå¸ƒå°”è¡¨è¾¾å¼ä¸çŸ­è·¯æ±‚å€¼ã€‚&lt;/p&gt;

&lt;p&gt;è€ƒè™‘åˆ°ä¸‹é¢çš„è¡¨è¾¾å¼&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;a = a or 1024
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ç”Ÿæˆçš„å­—èŠ‚ç ä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;1       [1]     GETGLOBAL       0 -1    ; a
2       [1]     TEST            0 0 1
3       [1]     JMP             1       ; to 5
4       [1]     LOADK           0 -2    ; 1024
5       [1]     SETGLOBAL       0 -1    ; a
6       [1]     RETURN          0 1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶å®ä¸&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;if not a then
    a = 1024
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”Ÿæˆçš„ä»£ç å‡ ä¹ä¸€è‡´ï¼Œåªæ˜¯å°‘äº†åƒè‡ªå·±èµ‹å€¼çš„é‚£éƒ¨åˆ†ã€‚ç°åœ¨æˆ‘ä»¬çœ‹çœ‹è¿™æ¡çŸ­è·¯æ±‚å€¼è¯­å¥çš„å­—èŠ‚ç æ˜¯æ€ä¹ˆç”Ÿæˆçš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;a = a or 1024&lt;/code&gt; è¿™æ˜¯ä¸€ä¸ªèµ‹å€¼è¯­å¥ï¼Œæ‰€ä»¥è°ƒç”¨ä½¿ç”¨çš„æ˜¯&lt;code&gt;assignment&lt;/code&gt;å‡½æ•°ï¼Œå…¶ä¸­æˆ‘ä»¬å…³æ³¨çš„è°ƒç”¨é“¾æ˜¯
&lt;code&gt;assignment -&amp;gt; luaK_storeevar -&amp;gt; luaK_exp2anyreg -&amp;gt; luaK_exp2nextreg -&amp;gt; exp2reg&lt;/code&gt; ç”±äº &lt;code&gt;a or 1024&lt;/code&gt;æ˜¯ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼Œ
åœ¨ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¯»åˆ°&lt;code&gt;or&lt;/code&gt;ä¹‹å‰æ˜¯&lt;code&gt;luaK_infix&lt;/code&gt;ï¼Œè¯»åˆ°&lt;code&gt;or&lt;/code&gt;ä¹‹åæ˜¯&lt;code&gt;luaK_postfix&lt;/code&gt;ï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸¤è€…çš„åšæ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;-- luaK_infix
716	    case OPR_OR: {
717	      luaK_goiffalse(fs, v);
718	      break;
719	    }
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;-- luaK_postfix
746	    case OPR_OR: {
747	      lua_assert(e1-&amp;gt;f == NO_JUMP);  /* list must be closed */
748	      luaK_dischargevars(fs, e2);
749	      luaK_concat(fs, &amp;amp;e2-&amp;gt;t, e1-&amp;gt;t);
750	      *e1 = *e2;
751	      break;
752	    }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…³é”®è¿˜æ˜¯ä¸Šæ–‡è¯´åˆ°çš„&lt;code&gt;luaK_goiffalse&lt;/code&gt;ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;580	  luaK_concat(fs, &amp;amp;e-&amp;gt;t, pc);  /* insert last jump in `t&#39; list */
581	  luaK_patchtohere(fs, e-&amp;gt;f);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœè¿”å› true çš„è¯ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æŸä¸ªâ€œæœªçŸ¥â€çš„åœ°æ–¹ï¼Œfalse çš„è¯ç›´æ¥æ‰§è¡Œä¸‹ä¸€å¥ã€‚é‚£ä¹ˆè¿™ä¸ªâ€œæœªçŸ¥â€çš„åœ°æ–¹æ˜¯æ€ä¹ˆç¡®å®šçš„å‘¢ï¼Ÿ
ç­”æ¡ˆåœ¨&lt;code&gt;exp2reg&lt;/code&gt;é‡Œé¢ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;394	  if (hasjumps(e)) {
395	    int final;  /* position after whole expression */
396	    int p_f = NO_JUMP;  /* position of an eventual LOAD false */
397	    int p_t = NO_JUMP;  /* position of an eventual LOAD true */
398	    if (need_value(fs, e-&amp;gt;t) || need_value(fs, e-&amp;gt;f)) {
399	      int fj = (e-&amp;gt;k == VJMP) ? NO_JUMP : luaK_jump(fs);
400	      p_f = code_label(fs, reg, 0, 1);
401	      p_t = code_label(fs, reg, 1, 0);
402	      luaK_patchtohere(fs, fj);
403	    }
404	    final = luaK_getlabel(fs);
405	    patchlistaux(fs, e-&amp;gt;f, final, reg, p_f);
406	    patchlistaux(fs, e-&amp;gt;t, final, reg, p_t);
407	  }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬è®¾ç½®äº†&lt;code&gt;e-&amp;gt;t&lt;/code&gt;æˆ–&lt;code&gt;e-&amp;gt;f&lt;/code&gt;ï¼Œæ‰€ä»¥&lt;code&gt;hasjumps&lt;/code&gt;åˆ¤æ–­æˆç«‹ã€‚ç”±äº&lt;code&gt;TESTSET&lt;/code&gt;å·²ç»æä¾›äº†èµ‹å€¼çš„å¯„å­˜å™¨ï¼Œå› æ­¤æ˜¯ä¸éœ€è¦é¢å¤–è®°å½•åˆ¤æ–­ç»“æœçš„ã€‚è€Œå¯¹äºå…¶ä»–çš„å…¥&lt;code&gt;LT&lt;/code&gt;ã€&lt;code&gt;JMP&lt;/code&gt;ç­‰ï¼Œå…¶æœ¬èº«æ˜¯ä¸è®°å½•ä»»ä½•åˆ¤æ–­ç»“æœçš„ï¼Œä¸ºäº†è®°å½•åªèƒ½åœ¨ JMP å®Œæˆä¹‹åï¼Œè®¾ç½®åˆ°å¯„å­˜å™¨ä¸­ï¼Œ
è¿™ä¹Ÿå°±æ˜¯æ­¤å¤„&lt;code&gt;code_label&lt;/code&gt;å­˜åœ¨çš„åŸå› ã€‚æ¥ä¸‹æ¥æ˜¯&lt;code&gt;patchlistaux&lt;/code&gt;ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;150	static void patchlistaux (FuncState *fs, int list, int vtarget, int reg,
151	                          int dtarget) {
152	  while (list != NO_JUMP) {
153	    int next = getjump(fs, list);
154	    if (patchtestreg(fs, list, reg))
155	      fixjump(fs, list, vtarget);
156	    else
157	      fixjump(fs, list, dtarget);  /* jump to default target */
158	    list = next;
159	  }
160	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ &lt;code&gt;patchtestreg&lt;/code&gt;å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;131	static int patchtestreg (FuncState *fs, int node, int reg) {
132	  Instruction *i = getjumpcontrol(fs, node);
133	  if (GET_OPCODE(*i) != OP_TESTSET)
134	    return 0;  /* cannot patch other instructions */
135	  if (reg != NO_REG &amp;amp;&amp;amp; reg != GETARG_B(*i))
136	    SETARG_A(*i, reg);
137	  else  /* no register to put value or register already has the value */
138	    *i = CREATE_ABC(OP_TEST, GETARG_B(*i), 0, GETARG_C(*i));
139	
140	  return 1;
141	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;vtarget&lt;/code&gt;æ˜¯æˆ‘ä»¬å½“å‰çš„ä½ç½®&lt;code&gt;final&lt;/code&gt;ï¼Œè€Œ&lt;code&gt;dtarget&lt;/code&gt;æ˜¯&lt;code&gt;p_f&lt;/code&gt;æˆ–&lt;code&gt;p_t&lt;/code&gt;ã€‚è¿™ä¸¤æ¡è¯­å¥çš„ä½œç”¨å…¶å®æ˜¯å°†æœ€ç»ˆ&lt;code&gt;TESTSET&lt;/code&gt;æŒ‡ä»¤çš„ç»“æœä¼ é€åˆ°&lt;code&gt;reg&lt;/code&gt;ï¼Œ
å¦‚æœä¸æ˜¯&lt;code&gt;TESTSET&lt;/code&gt;çš„è¯é‚£ä¹ˆè¯´æ˜ä¸äº§ç”Ÿå€¼ï¼Œé‚£&lt;code&gt;reg&lt;/code&gt;å°±éœ€è¦ä¸Šé¢çš„&lt;code&gt;codelabel&lt;/code&gt;æ¥äº§ç”Ÿäº†ã€‚è‡³æ­¤è¿™éƒ¨åˆ†ä»£ç åˆ†æå®Œæˆã€‚&lt;/p&gt;

&lt;p&gt;ä¸‹é¢æ˜¯ä¸€äº›å‡½æ•°çš„ç®€å•è§£é‡Šï¼Œå¯ä»¥ç¨å¾®çœ‹çœ‹ï¼š&lt;/p&gt;

&lt;p&gt;&lt;code&gt;luaK_nil&lt;/code&gt;å‡½æ•°ï¼Œç”Ÿæˆçš„æ˜¯&lt;code&gt;LOADNIL&lt;/code&gt;å­—èŠ‚ç ï¼Œå…¶ä½œç”¨æ˜¯å°†from ~ from + nä¹‹é—´çš„å¯„å­˜å™¨è®¾ç½®æˆnilï¼Œè¿™é‡Œåšäº†ä¸€äº›ä¼˜åŒ–å¦‚ï¼šå¦‚æœåˆå¹¶ç›¸é‚»çš„&lt;code&gt;LOADNIL&lt;/code&gt;ï¼Œå‡½æ•°åˆå§‹åŒ–æ—¶å¯ä»¥ä¸éœ€è¦é‡å¤åˆå§‹åŒ–ç­‰ã€‚
æ³¨æ„ä¼˜åŒ–çš„å‰ææ˜¯&lt;code&gt;fs-&amp;gt;pc &amp;gt; fs-&amp;gt;lasttarget&lt;/code&gt;ï¼Œå³è¿™æ¡æŒ‡ä»¤å¿…é¡»å¯ä»¥çœç•¥ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;luaK_jump&lt;/code&gt;å‡½æ•°ï¼Œå…¶ç›®çš„æ˜¯ç”Ÿæˆä¸€ä¸ª&lt;code&gt;JMP&lt;/code&gt;æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸ªæ— æ¡ä»¶è·³è½¬æŒ‡ä»¤ã€‚é‚£ä¹ˆå…¶ç›®æ ‡å‘¢ï¼Ÿå…¶å®å°±æ˜¯ &lt;code&gt;fs-&amp;gt;jps&lt;/code&gt;ã€‚æ³¨æ„åé¢çš„&lt;code&gt;luaK_contat&lt;/code&gt;ï¼Œå…¶ç›®çš„æ˜¯å°†l2é“¾æ¥åˆ°l1çš„åé¢ï¼Œè¿™æ˜¯ä¸ºäº†è¿ç»­è·³è½¬
è€ƒè™‘çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;condjump&lt;/code&gt; ç”Ÿæˆæ¡ä»¶è·³è½¬è¯­å¥ï¼Œluaä¸ºäº†ç”Ÿæˆå­—èŠ‚ç çš„ä¾¿åˆ©æ€§ï¼Œæ¯ä¸ªæ¡ä»¶è°ƒè½¬è¯­å¥å¦‚&lt;code&gt;LT&lt;/code&gt;, &lt;code&gt;TEST&lt;/code&gt;ç­‰åé¢éƒ½è·Ÿç€ä¸€ä¸ª&lt;code&gt;JMP&lt;/code&gt;ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ç›´æ¥æŒ‡å‘&lt;code&gt;JMP&lt;/code&gt;è¯­å¥ï¼Œå¦åˆ™å°±è·³åˆ°&lt;code&gt;JMP&lt;/code&gt;çš„ä¸‹ä¸€æ¡ï¼Œ
å‡å°‘äº†ç¼–ç çš„å¤æ‚åº¦å•Š&lt;/p&gt;

&lt;p&gt;&lt;code&gt;fixjump&lt;/code&gt;æŠŠ&lt;code&gt;PC&lt;/code&gt;å¤„çš„æŒ‡ä»¤ï¼ˆå½“ç„¶æ˜¯JMPæŒ‡ä»¤ï¼‰æ”¹æˆç›®æ ‡ä¸º&lt;code&gt;dest&lt;/code&gt;ï¼Œå½“ç„¶æ˜¯ç›¸å¯¹åœ°å€äº†&lt;/p&gt;

&lt;p&gt;&lt;code&gt;luaK_getlabel&lt;/code&gt;ï¼Œæ ‡è®°ä¸€ä¸‹ï¼ŒæŠŠå½“å‰çš„lasttargetæ”¹æˆpcï¼Œè¿™ä¸ªlasttargetå°±æ˜¯å’Œä¸Šé¢çš„&lt;code&gt;luaK_nil&lt;/code&gt;ç»“åˆèµ·æ¥çš„ï¼Œé˜²æ­¢ä¸Šé¢çš„è¯¯ä¼˜åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;getjump&lt;/code&gt;å’Œä¸Šé¢çš„fixjumpç›¸å¯¹åº”ï¼Œè¿”å›PCæ‰€åœ¨é‚£æ¡æŒ‡ä»¤çš„è·³è½¬ç›®æ ‡ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;getjumpcontrol&lt;/code&gt; ç”±äº&lt;code&gt;JMP&lt;/code&gt;ä¸Šä¸€æ¡å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯è·Ÿç€æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„ï¼Œé‚£ä¹ˆè¿™æ¡æŒ‡ä»¤å°±æ˜¯è·å–è¿™æ¡æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„ã€‚å¦‚æœæ˜¯é‚£ä¹ˆè¿”å›ä¸Šä¸€æ¡ï¼Œå¦åˆ™è¿”å›å½“å‰pcã€‚é™¤äº†&lt;code&gt;jmp&lt;/code&gt;ä¹‹å¤–ï¼Œå…¶ä»–å¦‚&lt;code&gt;FORLOOP&lt;/code&gt;, &lt;code&gt;FORPREP&lt;/code&gt;ç­‰æŒ‡ä»¤ä¹Ÿä¼šäº§ç”Ÿè·³è½¬&lt;/p&gt;

&lt;p&gt;&lt;code&gt;patchtestreg&lt;/code&gt; ä¿®æ”¹&lt;code&gt;TESTSET&lt;/code&gt;æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤ä¸€èˆ¬ç”¨äºçŸ­è·¯æ±‚å€¼ï¼Œ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;patchlistaux&lt;/code&gt; å¯¹äºä¸€ä¸ªjump listï¼Œå¦‚æœæ˜¯&lt;code&gt;TESTSET&lt;/code&gt;ï¼Œé‚£ä¹ˆå°†èµ‹å€¼å¯„å­˜å™¨ä¿®æ”¹ä¸ºregå¹¶å°†jumpç›®çš„åœ°ä¿®æ”¹ä¸ºvtarget, å¦åˆ™ä¿®æ”¹ä¸ºdtargetã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;dischargejpc&lt;/code&gt; å¯¹jpcè¿›è¡Œ&lt;code&gt;patchlistaux&lt;/code&gt;ï¼Œå…¶ä¸­vtargetå’Œdtargetéƒ½æ˜¯pc&lt;/p&gt;

&lt;p&gt;&lt;code&gt;patchlist&lt;/code&gt; å¦‚æœtargetä¸ºpcï¼Œé‚£ä¹ˆè°ƒç”¨patchtohereï¼›å¦åˆ™è°ƒç”¨patchlistaux&lt;/p&gt;

&lt;p&gt;&lt;code&gt;patchtohere&lt;/code&gt;å…ˆgetlabelæ ‡è®°ä¸€ä¸‹ï¼Œç„¶åå°†å½“å‰çš„listæ”¾åˆ°jpcåé¢&lt;/p&gt;

&lt;p&gt;&lt;code&gt;jpc&lt;/code&gt;é‚£äº›å°†è¦è·³åˆ°å½“å‰ä½ç½®çš„é“¾è¡¨ï¼Œç”±äºæ‰€æœ‰codeçš„å¢åŠ çš„æ¬§å¼&lt;code&gt;luaK_code&lt;/code&gt;ï¼Œæ‰€ä»¥ä¼šåœ¨è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨&lt;code&gt;dischargejpc&lt;/code&gt;&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>lua 5.1 åˆ†æ”¯è¯­å¥ bytecode çš„ç”Ÿæˆï¼ˆä¸€ï¼‰</title>
      <link>http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-1/</link>
      <pubDate>Sat, 20 May 2017 15:57:13 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/lua-cond-statment-bytecode-generate-1/</guid>
      <description>

&lt;p&gt;æœ¬æ–‡åªå¯¹ &lt;code&gt;IF cond THEN block {ELSEIF cond THEN block} [ELSE block] END&lt;/code&gt; è¯­æ³•çš„å­—èŠ‚ç ç”Ÿæˆè¿‡ç¨‹è¿›è¡Œæè¿°ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç”Ÿæˆçš„ç»“æœ&#34;&gt;ç”Ÿæˆçš„ç»“æœ&lt;/h2&gt;

&lt;p&gt;é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼Œä»…ä¸ºæ¼”ç¤ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;local cond1 = true
local cond2 = true
if cond1 then
    cond1 = false
elseif cond2 then
    cond2 = false
else
    cond1 = false
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;luac -l -l&lt;/code&gt;é€‰é¡¹åˆ—å‡ºæ¥çš„ç»“æœä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;main &amp;lt;test.lua:0,0&amp;gt; (12 instructions, 48 bytes at 0x184e530)
0+ params, 2 slots, 0 upvalues, 2 locals, 0 constants, 0 functions
        1       [1]     LOADBOOL        0 1 0
        2       [2]     LOADBOOL        1 1 0
        3       [3]     TEST            0 0 0
        4       [3]     JMP             2       ; to 7
        5       [4]     LOADBOOL        0 0 0
        6       [4]     JMP             5       ; to 12
        7       [5]     TEST            1 0 0
        8       [5]     JMP             2       ; to 11
        9       [6]     LOADBOOL        1 0 0
        10      [6]     JMP             1       ; to 12
        11      [8]     LOADBOOL        0 0 0
        12      [9]     RETURN          0 1
constants (0) for 0x184e530:
locals (2) for 0x184e530:
        0       cond1   2       12
        1       cond2   3       12
upvalues (0) for 0x184e530:
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„ç”Ÿæˆç»“æœã€‚æˆ‘ä»¬å…³æ³¨çš„æ˜¯å…¶ä¸­çš„&lt;code&gt;TEST&lt;/code&gt;å’Œ&lt;code&gt;JUMP&lt;/code&gt;ã€‚åœ¨ç¬¬3è¡Œçš„&lt;code&gt;TEST&lt;/code&gt;ï¼Œå…¶æ„æ€æ˜¯å¦‚æœ0å·å¯„å­˜å™¨ä¸­çš„å†…å®¹(cond1)
ä¸ºfalse(0)çš„è¯ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œä¸‹é¢çš„&lt;code&gt;JMP&lt;/code&gt;è¯­å¥ï¼Œå¦åˆ™å°±è°ƒè¿‡&lt;code&gt;JMP&lt;/code&gt;ç›´æ¥åˆ°ç¬¬5è¡Œã€‚&lt;code&gt;LUA&lt;/code&gt;ä¸­çš„åˆ†æ”¯å®ç°éƒ½æ˜¯ä½¿ç”¨&lt;code&gt;TEST&lt;/code&gt;ç­‰åé¢ç´§è·Ÿ&lt;code&gt;JMP&lt;/code&gt;å®ç°çš„ï¼Œ
ä»ä¸» dispatch ä»£ç ä¸­å¯ä»¥çœ‹åˆ°&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    // ...
      case OP_TEST: {
        if (l_isfalse(ra) != GETARG_C(i))
          dojump(L, pc, GETARG_sBx(*pc));
        pc++;
        continue;
      }
      case OP_TESTSET: {
        TValue *rb = RB(i);
        if (l_isfalse(rb) != GETARG_C(i)) {
          setobjs2s(L, ra, rb);
          dojump(L, pc, GETARG_sBx(*pc));
        }
        pc++;
        continue;
      }
      // ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;JMP&lt;/code&gt;è·³è½¬ï¼Œæ°¸è¿œéƒ½æ˜¯åˆ†æ”¯ä¸æˆç«‹çš„æƒ…å†µï¼Œè€Œ&lt;code&gt;TEST&lt;/code&gt;æˆåŠŸåçš„è·³è½¬æ°¸è¿œæ˜¯è·³è¿‡ä¸‹ä¸€è¡Œï¼Œå¤±è´¥çš„è¯ç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„JMPã€‚&lt;code&gt;if&lt;/code&gt;è¯­å¥çš„å­—èŠ‚ç è§£æå°±åˆ°è¿™é‡Œï¼Œåé¢çš„&lt;code&gt;elseif&lt;/code&gt;ç­‰éƒ½æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå†äº†è§£è¿™ä¸ªäº‹å®ä¹‹åã€‚
é‚£ä¹ˆè¿™ç§å­—èŠ‚ç æ˜¯æ€ä¹ˆç”Ÿæˆçš„å‘¢ï¼Ÿä¸‹é¢æ¥åˆ†æä¸‹ã€‚&lt;/p&gt;

&lt;h2 id=&#34;ç”Ÿæˆçš„è¿‡ç¨‹&#34;&gt;ç”Ÿæˆçš„è¿‡ç¨‹&lt;/h2&gt;

&lt;p&gt;&lt;code&gt;if&lt;/code&gt;è¯­å¥çš„ä»£ç åœ¨&lt;code&gt;lparser.c&lt;/code&gt;é‡Œé¢ï¼Œæœ€ä¸Šå±‚å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static void ifstat (LexState *ls, int line) {
  /* ifstat -&amp;gt; IF cond THEN block {ELSEIF cond THEN block} [ELSE block] END */
  FuncState *fs = ls-&amp;gt;fs;
  int flist;
  int escapelist = NO_JUMP;
  flist = test_then_block(ls);  /* IF cond THEN block */
  while (ls-&amp;gt;t.token == TK_ELSEIF) {
    luaK_concat(fs, &amp;amp;escapelist, luaK_jump(fs)); // å°† escapelist ä¸²èµ·æ¥ï¼Œè¿™é‡Œçš„ luaK_jump ä¼šè·³è½¬åˆ° end
    luaK_patchtohere(fs, flist); // æŠŠä¸Šé¢é‚£ä¸ª`JMP(1/3)` åœ°å€ä¿®æ”¹å¯¹
    flist = test_then_block(ls);  /* ELSEIF cond THEN block */
  }
  if (ls-&amp;gt;t.token == TK_ELSE) {
    luaK_concat(fs, &amp;amp;escapelist, luaK_jump(fs));
    luaK_patchtohere(fs, flist);
    luaX_next(ls);  /* skip ELSE (after patch, for correct line info) */
    block(ls);  /* `else&#39; part */
  }
  else
    luaK_concat(fs, &amp;amp;escapelist, flist); // è¿™é‡ŒæŠŠ flist ä¸²èµ·æ¥äº†ï¼Œæ„æ€æ˜¯æ²¡æœ‰ else è¯­å¥ï¼Œæ­¤æ—¶ flist æŒ‡å‘å°±æ˜¯ end
  luaK_patchtohere(fs, escapelist); // ä¿®æ”¹ escapelist åˆ° end è¯­å¥çš„ç»“å°¾
  check_match(ls, TK_END, TK_IF, line);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åœ¨è¯»å– token çš„æ—¶å€™ï¼Œé‡åˆ° &lt;code&gt;if ... then&lt;/code&gt; ä¼šç”Ÿæˆ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;TEST reg 0 predict
JMP ??? (1)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬ä¸çŸ¥é“åé¢ä»£ç çš„å†…å®¹ï¼Œæ‰€ä»¥æ— æ³•ç¡®å®š&lt;code&gt;???&lt;/code&gt;è¯¥å¡«å†™å¤šå°‘ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è¦è®°ä½è¿™ä¸ªä½ç½®ï¼Œå°†æ¥æˆ‘ä»¬è¦æŠŠå€¼å¡«å†™è¿›å»ï¼Œè¿™ä¸ªå€¼å…¶å®å°±å­˜
åœ¨&lt;code&gt;flist&lt;/code&gt;ã€‚ç„¶åæˆ‘ä»¬è¯»åˆ°&lt;code&gt;elseif cond then&lt;/code&gt;è¯­å¥ï¼Œè¿™å°±æ„å‘³ç€ç¬¬ä¸€æ®µä»£ç çš„ç»“æŸæ­¤æ—¶åº”è¯¥è¦è·³è½¬å‡ºè¿™ä¸ª&lt;code&gt;if&lt;/code&gt;
è¯­å¥ï¼Œæ‰€ä»¥æ­¤æ—¶åº”è¯¥æ’å…¥ä¸€ä¸ª&lt;code&gt;JMP(2)&lt;/code&gt;åˆ°æ•´ä¸ªè¯­å¥çš„ç»“æŸï¼Œå› ä¸ºæœ‰å¤šä¸ª block çš„å­˜åœ¨ï¼Œåé¢å¯èƒ½ä¼šæœ‰å¾ˆå¤šè¿™ç§ç±»ä¼¼çš„
&lt;code&gt;JMP&lt;/code&gt;ï¼Œå¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„å„ç§&lt;code&gt;to 12&lt;/code&gt;ï¼Œè¿™äº›ä½ç½®éƒ½æ— æ³•ç¡®å®šï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªescapelistæ¥æŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œæ–¹ä¾¿åé¢å¤„ç†ã€‚
ç°åœ¨å›å¤´çœ‹&lt;code&gt;JMP(1)&lt;/code&gt;ä½ç½®å°±ç¡®å®šäº†ï¼Œæ‰€ä»¥å½“å‰çš„PCå°±æ˜¯&lt;code&gt;flist&lt;/code&gt;çš„æŒ‡å‘ç”±äº&lt;code&gt;elseif&lt;/code&gt;åˆæ˜¯ä¸€ä¸ªåˆ†æ”¯è¯­å¥ï¼Œæ‰€ä»¥åˆå¯ä»¥ç”Ÿæˆä¸€æ®µ &lt;code&gt;TEST &amp;amp; JMP(3)&lt;/code&gt;ä»£ç äº†ã€‚åŒæ ·&lt;code&gt;JMP(2)&lt;/code&gt;çš„ä½ç½®æ˜¯æ— æ³•ç¡®å®šçš„ã€‚
ç°åœ¨æ¥è°ˆè°ˆ&lt;code&gt;escapelist&lt;/code&gt;ï¼Œå®šä¹‰&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;int escapelist = NO_JUMP;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ˜¯ä¸ª int å•Šï¼Œå¯¹äºå¤šä¸ªä½ç½®çš„&lt;code&gt;JMP(2)&lt;/code&gt;è¦æ€ä¹ˆå¤„ç†ï¼Ÿlua é‡‡ç”¨äº†ä¸€ç§å·§å¦™çš„æœºåˆ¶ï¼Œç”±äºæ­¤æ—¶çš„&lt;code&gt;JMP&lt;/code&gt;æ˜¯æ— æ•ˆçš„ï¼Œè¿˜æ²¡æœ‰è§£æåˆ°æ­£å¼åœ°å€çš„ï¼Œ
æ‰€ä»¥å…¶ä¸­çš„ç›®æ ‡åœ°å€åŸŸæ˜¯æ²¡æœ‰ä½¿ç”¨çš„ã€‚å› æ­¤ï¼Œå¯ä»¥é‡‡ç”¨ä¸²èµ·æ¥çš„æ–¹å¼ï¼ŒescapcelistæŒ‡å‘ç¬¬ä¸€ä¸ªæ²¡æœ‰è§£æçš„&lt;code&gt;JMP&lt;/code&gt;ï¼Œç„¶åè¿™ä¸ª&lt;code&gt;JMP&lt;/code&gt;çš„æŒ‡å‘åœ°å€
æ˜¯ä¸‹ä¸€ä¸ªæ²¡æœ‰è§£æçš„&lt;code&gt;JMP&lt;/code&gt;ï¼Œè¿™æ ·ä¸€æ¥å°±å½¢æˆäº†é“¾è¡¨çš„ç»“æ„ã€‚åé¢å¯ä»¥ä¸€èµ·ä¿®æ”¹ç›®æ ‡åœ°å€é€šè¿‡&lt;code&gt;luaK_patchtohere&lt;/code&gt;æ¥å®ç°ã€‚&lt;/p&gt;

&lt;h2 id=&#34;äº‹æƒ…æ²¡é‚£ä¹ˆç®€å•&#34;&gt;äº‹æƒ…æ²¡é‚£ä¹ˆç®€å•&lt;/h2&gt;

&lt;p&gt;æˆ‘ä»¬æˆ‘ä»¬è¯¦ç»†æŸ¥çœ‹çš„è¯ï¼Œ&lt;code&gt;test_then_block&lt;/code&gt; -&amp;gt; &lt;code&gt;cond&lt;/code&gt; -&amp;gt; &lt;code&gt;luaK_goiftrue&lt;/code&gt;ï¼Œçœ‹çœ‹&lt;code&gt;luaK_goiftrue&lt;/code&gt;å‡½æ•°çš„å®ç°ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;void luaK_goiftrue (FuncState *fs, expdesc *e) {
  int pc;  /* pc of last jump */
  luaK_dischargevars(fs, e);
  switch (e-&amp;gt;k) {
    case VK: case VKNUM: case VTRUE: {
      pc = NO_JUMP;  /* always true; do nothing */
      break;
    }
    case VFALSE: {
      pc = luaK_jump(fs);  /* always jump */
      break;
    }
    case VJMP: {
      invertjump(fs, e);
      pc = e-&amp;gt;u.s.info;
      break;
    }
    default: {
      pc = jumponcond(fs, e, 0);
      break;
    }
  }
  luaK_concat(fs, &amp;amp;e-&amp;gt;f, pc);  /* insert last jump in `f&#39; list */
  luaK_patchtohere(fs, e-&amp;gt;t);
  e-&amp;gt;t = NO_JUMP;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‰é¢çš„å‡ ç§ï¼Œå¦‚VKã€VKNUMã€VTRUEéƒ½æ˜¯å§‹ç»ˆæˆç«‹çš„ï¼Œæ‰€ä»¥å…¶&lt;code&gt;e-&amp;gt;f&lt;/code&gt;æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤ä¸º&lt;code&gt;NO_JUMP&lt;/code&gt;ï¼Œè€Œå¯¹äº VFALSEï¼Œå…¶å§‹ç»ˆåº”è¯¥èµ°é”™è¯¯åˆ†æ”¯ï¼Œå› æ­¤å…¶&lt;code&gt;e-&amp;gt;f&lt;/code&gt;ä¸ºä¸€æ¡JMPã€‚&lt;code&gt;VJUMP&lt;/code&gt;æ˜¯æ¯”è¾ƒè¯­å¥ç”Ÿæˆçš„, æ‰€ä»¥å…¶å€¼å°±æ˜¯ä»£è¡¨äº†&lt;code&gt;e-&amp;gt;t&lt;/code&gt;å’Œ&lt;code&gt;e-&amp;gt;f&lt;/code&gt;ï¼Œå› æ­¤å…¶&lt;code&gt;e-&amp;gt;f&lt;/code&gt;
å°±æ˜¯&lt;code&gt;invertjump&lt;/code&gt;äº†ã€‚åœ¨å„ç§é”™è¯¯JMPéƒ½ç”Ÿæˆå®Œä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ­£ç¡®åˆ†æ”¯äº†ï¼Œæ‰€ä»¥ç›´æ¥å°±&lt;code&gt;luaK_patchtohere&lt;/code&gt;äº†ï¼Œå½“å‰çš„å°±æ˜¯æ­£ç¡®çš„é€»è¾‘ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹å…¶å®æ˜¯ &lt;code&gt;jumponcond&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static int jumponcond (FuncState *fs, expdesc *e, int cond) {
  if (e-&amp;gt;k == VRELOCABLE) {
    Instruction ie = getcode(fs, e);
    if (GET_OPCODE(ie) == OP_NOT) {
      fs-&amp;gt;pc--;  /* remove previous OP_NOT */
      return condjump(fs, OP_TEST, GETARG_B(ie), 0, !cond);
    }
    /* else go through */
  }
  discharge2anyreg(fs, e);
  freeexp(fs, e);
  return condjump(fs, OP_TESTSET, NO_REG, e-&amp;gt;u.s.info, cond);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¹äº &lt;code&gt;if not xxxx then&lt;/code&gt;ä¹‹ç±»çš„è¯­å¥ï¼Œæ˜¾ç„¶å…¶åˆ¤æ–­ç»“æœå€¼ä¸ä¼šè¢«å¼•ç”¨ï¼ˆåªæ˜¯è¢«åˆ¤æ–­è¯­å¥ä½¿ç”¨è€Œå·²ï¼‰æ‰€ä»¥è¿™é‡Œä½¿ç”¨&lt;code&gt;OP_TEST&lt;/code&gt;ï¼Œå…¶ä»–æ‰€æœ‰æƒ…å†µ
éƒ½æ˜¯ä½¿ç”¨çš„&lt;code&gt;OP_TESTSET&lt;/code&gt;ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹&lt;code&gt;TESTSET&lt;/code&gt;çš„å®šä¹‰ï¼š&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;TESTSET A B C if (R(B) &amp;lt;=&amp;gt; C) then R(A) := R(B) else PC++&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Used to implement and and or logical operators, or for testing a single
register in a conditional statement.&lt;/p&gt;

&lt;p&gt;For TESTSET, register R(B) is coerced into a boolean and compared to
the boolean field C. If R(B) matches C, the next instruction is skipped,
otherwise R(B) is assigned to R(A) and the VM continues with the next
instruction. The and operator uses a C of 0 (false) while or uses a C value
of 1 (true).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å¦‚æœ Bè½¬æ¢ä¸º booleanå å’Œ Cç›¸ç­‰ï¼Œåˆ™è·³è¿‡ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼›å¦åˆ™å°†Bèµ‹ç»™Aç„¶åç»§ç»­æ‰§è¡Œã€‚è¿™æ¡æŒ‡ä»¤çš„ç›®çš„æ˜¯ä¸ºçŸ­è·¯æ±‚å€¼æœåŠ¡çš„ã€‚é‚£ä¹ˆ&lt;code&gt;TESTSET&lt;/code&gt;æ€
ä¹ˆåˆ°åé¢å˜æˆäº†&lt;code&gt;TEST&lt;/code&gt;å‘¢ï¼Ÿå…¶è¿‡ç¨‹å°±åœ¨&lt;code&gt;dischargejpc&lt;/code&gt;-&amp;gt;&lt;code&gt;patchlistaux&lt;/code&gt;-&amp;gt;&lt;code&gt;patchtestreg&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ä¸Šé¢æˆ‘ä»¬è¯´åˆ°&lt;code&gt;luaK_patchtohere&lt;/code&gt;å°†å¾…å®š&lt;code&gt;JMP&lt;/code&gt;æ”¹æˆå½“å‰pcçš„åŠŸèƒ½ï¼Œå…¶å®å¹¶ä¸æ˜¯ç›´æ¥ä¿®æ”¹çš„ï¼Œè€Œæ˜¯é€šè¿‡æ¯æ¬¡ç”Ÿæˆæ–°çš„å­—èŠ‚ç çš„æ—¶å€™ï¼Œè°ƒç”¨&lt;code&gt;dischargejpc&lt;/code&gt;å®ç°çš„ï¼Œpatch çš„æ—¶å€™åªæ˜¯å°†è¿™ä¸ªä½ç½®ä¸²èµ·æ¥ï¼Œç„¶å &lt;code&gt;dischargejpc&lt;/code&gt;ä¼šä¾¿åˆ©è¿™ä¸ªé“¾è¡¨è¿›è¡Œä¿®æ”¹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;patchlistaux(fs, fs-&amp;gt;jpc, fs-&amp;gt;pc, NO_REG, fs-&amp;gt;pc);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œ&lt;code&gt;patchlistaux&lt;/code&gt;è¿˜è¿›è¡Œçš„ä¸€é¡¹æ“ä½œå°±æ˜¯&lt;code&gt;patchtestreg&lt;/code&gt;ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å¤„ç†&lt;code&gt;TESTSET&lt;/code&gt;ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;131	static int patchtestreg (FuncState *fs, int node, int reg) {
132	  Instruction *i = getjumpcontrol(fs, node);
133	  if (GET_OPCODE(*i) != OP_TESTSET)
134	    return 0;  /* cannot patch other instructions */
135	  if (reg != NO_REG &amp;amp;&amp;amp; reg != GETARG_B(*i)) // å‰è€…è¡¨ç¤ºä¸éœ€è¦å¯„å­˜ï¼Œåè€…ä¸¤è€…ç›¸åŒçš„è¯ä¹Ÿæ˜¯ä¸éœ€è¦ä¿®æ”¹çš„
136	    SETARG_A(*i, reg);
137	  else  /* no register to put value or register already has the value */
138	    *i = CREATE_ABC(OP_TEST, GETARG_B(*i), 0, GETARG_C(*i)); // å¯¹äºä¸éœ€è¦è¿”å›å€¼çš„æƒ…å†µï¼Œç›´æ¥ä¿®æ”¹ä¸º TEST
139	
140	  return 1;
141	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸Šé¢çš„ä»‹ç»åªæ˜¯ æ¡ä»¶è¯­å¥çš„ä¸€éƒ¨åˆ†ï¼Œåé¢çš„æ–‡ç« ä¼šå¯¹çŸ­è·¯æ±‚å€¼ï¼Œcompare è¿ç®—ç¬¦ç­‰åšè§£é‡Šã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>è§£ælua gc ä¸­çš„å‚æ•°æ§åˆ¶</title>
      <link>http://sysfork.com/post/2017/lua-gc-paramter-internal/</link>
      <pubDate>Wed, 10 May 2017 20:05:41 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/lua-gc-paramter-internal/</guid>
      <description>&lt;p&gt;lua gc è°ƒä¼˜ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªä¸¤ä¸ªå‚æ•°&lt;code&gt;setpause&lt;/code&gt;å’Œ&lt;code&gt;setstepmul&lt;/code&gt;ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;collectgarbage(&amp;quot;setpause&amp;quot;, 200)
collectgarbage(&amp;quot;setstepmul&amp;quot;, 200)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¸¤ä¸ªå€¼çš„é»˜è®¤å€¼éƒ½æ˜¯&lt;code&gt;200&lt;/code&gt;ï¼Œé‚£ä¹ˆè¿™ä»£è¡¨ç€ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé€šè¿‡æŸ¥çœ‹ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static const char *const opts[] = {&amp;quot;stop&amp;quot;, &amp;quot;restart&amp;quot;, &amp;quot;collect&amp;quot;,
  &amp;quot;count&amp;quot;, &amp;quot;step&amp;quot;, &amp;quot;setpause&amp;quot;, &amp;quot;setstepmul&amp;quot;, NULL};
static const int optsnum[] = {LUA_GCSTOP, LUA_GCRESTART, LUA_GCCOLLECT,
  LUA_GCCOUNT, LUA_GCSTEP, LUA_GCSETPAUSE, LUA_GCSETSTEPMUL};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶å®&lt;code&gt;collectgarbage&lt;/code&gt;å¯¹åº”çš„å°±æ˜¯&lt;code&gt;lua_gc&lt;/code&gt;æ–¹æ³•ï¼Œä¸‹é¢æ˜¯å…¶ä¸­çš„éƒ¨åˆ†é€»è¾‘çš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;LUA_API int lua_gc (lua_State *L, int what, int data) {
  switch (what) {
    case LUA_GCSTOP: g-&amp;gt;GCthreshold = MAX_LUMEM;
    case LUA_GCRESTART: g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes;
    case LUA_GCCOLLECT: luaC_fullgc(L);
    case LUA_GCCOUNT: res = cast_int(g-&amp;gt;totalbytes &amp;gt;&amp;gt; 10);
    case LUA_GCCOUNTB:  res = cast_int(g-&amp;gt;totalbytes &amp;amp; 0x3ff);
    case LUA_GCSTEP: {
      lu_mem a = (cast(lu_mem, data) &amp;lt;&amp;lt; 10);
      if (a &amp;lt;= g-&amp;gt;totalbytes)
        g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes - a;
      else
        g-&amp;gt;GCthreshold = 0;
      while (g-&amp;gt;GCthreshold &amp;lt;= g-&amp;gt;totalbytes) {
        luaC_step(L);
        if (g-&amp;gt;gcstate == GCSpause) {  /* end of cycle? */
          res = 1;  /* signal it */
          break;
        }
      }
      break;
    }
    case LUA_GCSETPAUSE: res = g-&amp;gt;gcpause; g-&amp;gt;gcpause = data;
    case LUA_GCSETSTEPMUL: res = g-&amp;gt;gcstepmul; g-&amp;gt;gcstepmul = data;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸€äº›æœ‰æ„æ€çš„å‚æ•°ï¼Œåœ¨&lt;code&gt;g(global_State)&lt;/code&gt;ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;/*
** `global state&#39;, shared by all threads of this state
*/
typedef struct global_State {
//.....
  lu_mem GCthreshold;
  lu_mem totalbytes;  /* number of bytes currently allocated */
  lu_mem estimate;  /* an estimate of number of bytes actually in use */
  lu_mem gcdept;  /* how much GC is `behind schedule&#39; */
  int gcpause;  /* size of pause between successive GCs */
  int gcstepmul;  /* GC `granularity&#39; */
//......
} global_State;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº&lt;code&gt;LUA_GCSTOP&lt;/code&gt;æ˜¯å°†&lt;code&gt;GCthreshold&lt;/code&gt;è®¾ç½®æˆä¸€ä¸ªå¾ˆå¤§çš„å€¼&lt;code&gt;MAX_LUMEM&lt;/code&gt;(&lt;code&gt;~(size_t)0)-2&lt;/code&gt;)ï¼Œè€Œ&lt;code&gt;LUA_GCRESTART&lt;/code&gt;åˆ™å°†&lt;code&gt;GCthreshold&lt;/code&gt;è®¾ç½®æˆ&lt;code&gt;totalbytes&lt;/code&gt;ã€‚å¯¹äº&lt;code&gt;LUA_GCSETPAUSE&lt;/code&gt;å’Œ&lt;code&gt;LUA_GCSETSTEPMUL&lt;/code&gt;åˆ™æ˜¯åˆ†åˆ«è®¾ç½®äº†&lt;code&gt;gcpause&lt;/code&gt;å’Œ&lt;code&gt;gcstepmul&lt;/code&gt;çš„å€¼ã€‚ä»æ³¨é‡Šä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å„è‡ªå€¼çš„è§£é‡Šã€‚&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å‚æ•°&lt;/th&gt;
&lt;th&gt;æ„ä¹‰&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;GCthreshold&lt;/td&gt;
&lt;td&gt;GCçš„é—¨æ§›ï¼Œå½“totalbyteså¤§äºè¿™ä¸ªå€¼æ—¶è§¦å‘gc step&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;totalbytes&lt;/td&gt;
&lt;td&gt;ç”±å†…å­˜åˆ†é…å™¨åˆ†é…çš„&lt;strong&gt;å®é™…&lt;/strong&gt;å†…å­˜&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;estimate&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;ä¼°è®¡&lt;/strong&gt;çš„ï¼Œæ­£åœ¨ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œå°äº &lt;code&gt;totalbytes&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;ä¸‹é¢è¿™æ®µä»£ç æ˜¯ä»£ç ä¸­éšå¤„å¯è§ï¼Œå¦‚&lt;code&gt;lua_createtable&lt;/code&gt;ç­‰ï¼Œåœ¨æ‰§è¡Œæ“ä½œä¹‹å‰éƒ½ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘&lt;code&gt;gc&lt;/code&gt;ï¼Œä»¥ä¿è¯å†…å­˜åˆ©ç”¨ç‡ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;80	#define luaC_checkGC(L) { \
81	  condhardstacktests(luaD_reallocstack(L, L-&amp;gt;stacksize - EXTRA_STACK - 1)); \
82	  if (G(L)-&amp;gt;totalbytes &amp;gt;= G(L)-&amp;gt;GCthreshold) \
83		luaC_step(L); }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å½“ &lt;code&gt;totalbytes &amp;gt;= GCthreshold&lt;/code&gt;æ—¶è§¦å‘stepã€‚å› æ­¤&lt;code&gt;LUA_GCRESTART&lt;/code&gt;ä¹‹åï¼Œä¸‹ä¸€æ¬¡&lt;code&gt;checkGC&lt;/code&gt;çš„æ—¶å€™ä¼šç«‹å³å‡ºå‘&lt;code&gt;luaC_step&lt;/code&gt;ã€‚å¯ä»¥çœ‹åˆ°
&lt;code&gt;totalbytes&lt;/code&gt;å’Œ&lt;code&gt;GCthreshold&lt;/code&gt;æ˜¯æ§åˆ¶&lt;code&gt;GC&lt;/code&gt;çš„å…³é”®å‚æ•°ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸ªå›æ”¶å‘¨æœŸç»“æŸé‡ç½®&lt;code&gt;GCthreshold&lt;/code&gt; ï¼Œè¿™é‡Œç”¨åˆ°äº†çš„estimateã€‚å› ä¸ºå¸¦æœ‰ __gc å…ƒæ–¹æ³•çš„ &lt;code&gt;userdata&lt;/code&gt; éœ€è¦ä¸¤ä¸ªgcå‘¨æœŸ
æ‰èƒ½å›æ”¶ï¼Œåœ¨ç¬¬ä¸€ä¸ªgcå‘¨æœŸä¸­å…¶ &lt;code&gt;__gc&lt;/code&gt;å…ƒæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œè€Œåœ¨ç¬¬äºŒä¸ªå›æ”¶å‘¨æœŸå†…å†…å­˜ä¼šè¢«çœŸæ­£å›æ”¶ã€‚å› æ­¤ï¼Œ&lt;code&gt;estimate&lt;/code&gt;æ˜¯ä¸åŒ…å«é‚£äº›&lt;code&gt;__gc&lt;/code&gt;å…ƒæ–¹æ³•è¢«è°ƒç”¨çš„&lt;code&gt;userdata&lt;/code&gt;çš„ï¼Œè€Œ&lt;code&gt;totalbytes&lt;/code&gt;ä¼šåŒ…å«ï¼ˆå› ä¸ºå…¶åæ˜ çš„æ˜¯çœŸå®å†…å­˜å ç”¨æƒ…å†µï¼‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#define setthreshold(g)  (g-&amp;gt;GCthreshold = (g-&amp;gt;estimate/100) * g-&amp;gt;gcpause)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è®¾ç½®çš„&lt;code&gt;gcpause&lt;/code&gt;å€¼å½±å“çš„æ˜¯ä¸‹ä¸€å‘¨æœŸå¼€å§‹çš„äº‹ä»¶ï¼Œé»˜è®¤&lt;code&gt;200&lt;/code&gt;çš„æ„æ€æ—¶ï¼Œå½“å½“å‰&lt;strong&gt;çœŸå®&lt;/strong&gt;å†…å­˜å ç”¨è¶…è¿‡å½“å‰&lt;strong&gt;ä¼°è®¡&lt;/strong&gt;å†…å­˜å ç”¨çš„ä¸¤å€æ—¶ï¼Œæ‰å¼€å¯ä¸‹ä¸€å›æ”¶å‘¨æœŸã€‚æ‰€ä»¥å¦‚æœä½ å«&lt;code&gt;__gc&lt;/code&gt;æ–¹æ³•çš„&lt;code&gt;userdata&lt;/code&gt;è¿‡å¤§çš„è¯ï¼Œå¾ˆå¯èƒ½åœ¨ç¬¬ä¸€æ¬¡å‘¨æœŸç»“æŸåç«‹é©¬å¼€å¯äº†ç¬¬äºŒå‘¨æœŸã€‚å¦‚æœè®¾ç½®çš„&lt;code&gt;gcpause&lt;/code&gt;å€¼å°äº&lt;code&gt;100&lt;/code&gt;çš„è¯ï¼Œé‚£ä¹ˆåŒæ ·ä¸¤æ¬¡&lt;code&gt;gc&lt;/code&gt;å‘¨æœŸä¸­é—´æ˜¯æ²¡æœ‰é—´éš”çš„ã€‚&lt;/p&gt;

&lt;p&gt;æ¥ä¸‹æ¥çœ‹&lt;code&gt;luaC_step&lt;/code&gt;çš„ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;610	void luaC_step (lua_State *L) {
611	  global_State *g = G(L);
612	  l_mem lim = (GCSTEPSIZE/100) * g-&amp;gt;gcstepmul;
613	  if (lim == 0)
614	    lim = (MAX_LUMEM-1)/2;  /* no limit */
615	  g-&amp;gt;gcdept += g-&amp;gt;totalbytes - g-&amp;gt;GCthreshold;
616	  do {
617	    lim -= singlestep(L);
618	    if (g-&amp;gt;gcstate == GCSpause)
619	      break;
620	  } while (lim &amp;gt; 0);
621	  if (g-&amp;gt;gcstate != GCSpause) {
622	    if (g-&amp;gt;gcdept &amp;lt; GCSTEPSIZE)
623	      g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes + GCSTEPSIZE;  /* - lim/g-&amp;gt;gcstepmul;*/
624	    else {
625	      g-&amp;gt;gcdept -= GCSTEPSIZE;
626	      g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes;
627	    }
628	  }
629	  else {
630	    setthreshold(g);
631	  }
632	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œ&lt;code&gt;stepmul&lt;/code&gt;æ§åˆ¶çš„å°±æ˜¯&lt;code&gt;step&lt;/code&gt;çš„é•¿åº¦ï¼Œè¶Šå¤§åˆ™æ¯æ­¥æ‰€è¿›è¡Œçš„æ“ä½œä¹Ÿå°±è¶Šå¤šï¼Œæ‹¥æœ‰æ›´å¤šçš„ã€Œè´¹ã€ã€‚å…¶ä¸­&lt;code&gt;GCSTEPSIZE&lt;/code&gt;çš„å€¼ä¸º&lt;code&gt;1024&lt;/code&gt;ã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤&lt;code&gt;stepmul&lt;/code&gt;ä¸º200çš„æƒ…å†µä¸‹ï¼Œå¤§çº¦å¯å·²è¿›è¡Œ&lt;code&gt;2048&lt;/code&gt;ã€Œè´¹ã€ï¼Œé‚£ä¹ˆã€Œè´¹ã€æ˜¯æ€ä¹ˆå®šä¹‰çš„å‘¢ï¼Ÿä»ä»£ç å¯ä»¥çœ‹åˆ°æ¸…é™¤ä¸€æ¡&lt;code&gt;string&lt;/code&gt;è¡¨å’Œä»»æ„ä¸€ä¸ª&lt;code&gt;gc&lt;/code&gt;å¯¹è±¡ä¸º&lt;code&gt;10&lt;/code&gt;ã€Œè´¹ã€ï¼Œè°ƒç”¨&lt;code&gt;__gc&lt;/code&gt;å…ƒæ–¹æ³•ä¸º&lt;code&gt;100&lt;/code&gt;ã€Œè´¹ã€ï¼Œé™¤éæ˜¯&lt;code&gt;sweep&lt;/code&gt;é˜¶æ®µå¦åˆ™å†…å­˜ä¸ä¼šå‡å°‘ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨å†…å­˜å·®å€¼æ¥è¡¨ç¤ºå·¥ä½œè¿›åº¦ï¼Œæ‰€ä»¥å¼•å…¥äº†ã€Œè´¹ã€ã€‚å¦‚æœä½ æŠŠ&lt;code&gt;stepmul&lt;/code&gt;è®¾ç½®ä¸º&lt;code&gt;0&lt;/code&gt;çš„è¯ï¼Œé‚£ä¹ˆ&lt;code&gt;lim&lt;/code&gt;å°±æ˜¯&lt;code&gt;(MAX_LUMEM-1)/2&lt;/code&gt;
ä¸ºä»€ä¹ˆæ˜¯è¿™ä¹ˆå¥‡æ€ªçš„æ•°å€¼ï¼Ÿå› ä¸º&lt;code&gt;MAX_LUAEME&lt;/code&gt;æ˜¯&lt;code&gt;~(size_t)0)-2&lt;/code&gt;ï¼Œæ— ç¬¦å·æ•´å‹ï¼Œè€Œ&lt;code&gt;l_mem&lt;/code&gt;æ˜¯æœ‰ç¬¦å·çš„ï¼Œç›´æ¥èµ‹å€¼ä¼šæº¢å‡ºçš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;luaC_step&lt;/code&gt;çš„è®¾è®¡æ€è·¯æ˜¯ï¼š æ¯å½“æ–°å¢åˆ†é…çš„å†…å­˜æ•°è¶…è¿‡&lt;code&gt;GCSTEPSIZE&lt;/code&gt;å°±è§¦å‘ä¸€æ¬¡ã€‚ç”±äºluaåªä¼šåœ¨gcè¿‡ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œæ‰€ä»¥
&lt;code&gt;totalbytes&lt;/code&gt;åœ¨gcè¿‡ç¨‹å¤–æ—¶åªå¢ä¸å‡çš„ï¼Œå› æ­¤&lt;code&gt;luaC_step&lt;/code&gt;æ€»æ˜¯ä¼šå¾—ä»¥è§¦å‘ã€‚ä¸ºäº†å‡†ç¡®è®°å½•æ–°å¢å†…å­˜ä½¿ç”¨é‡ï¼Œlua ä½¿ç”¨äº†&lt;code&gt;gcdept&lt;/code&gt;å˜é‡ã€‚
è¿™ç§è®¾è®¡æ˜¯ä¸ºäº†é˜²æ­¢&lt;code&gt;luaC_step&lt;/code&gt;è¢«é¢‘ç¹è§¦å‘ï¼Œæ§åˆ¶ä¸€ä¸ªè¾ƒåˆç†çš„ç²’åº¦ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œ&lt;code&gt;gcdept&lt;/code&gt;åœ¨æ¯ä¸ªå‘¨æœŸæœ«å°¾ä¼šæ¸…é›¶ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;592	    case GCSfinalize: {
593	      if (g-&amp;gt;tmudata) {
594	        GCTM(L);
595	        if (g-&amp;gt;estimate &amp;gt; GCFINALIZECOST)
596	          g-&amp;gt;estimate -= GCFINALIZECOST;
597	        return GCFINALIZECOST;
598	      }
599	      else {
600	        g-&amp;gt;gcstate = GCSpause;  /* end collection */
601	        g-&amp;gt;gcdept = 0;
602	        return 0;
603	      }
604	    }
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>ä¸€ä¸ªç”± libcurl å¯¼è‡´çš„ core åˆ†æ</title>
      <link>http://sysfork.com/post/2017/a-core-cause-by-curl-sighandler/</link>
      <pubDate>Wed, 10 May 2017 15:31:06 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/a-core-cause-by-curl-sighandler/</guid>
      <description>&lt;p&gt;æœ€è¿‘æˆ‘ä»¬çš„é¡¹ç›®æœ‰å¤šä¸ªcoreï¼Œ ä½¿ç”¨gdbæŸ¥çœ‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) info threads
  Id   Target Id         Frame 
  5    Thread 0x7f28943d9700 (LWP 11079) 0x00007f2895cc5c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
  4    Thread 0x7f2895bdc700 (LWP 11076) 0x00007f2895cbcaed in poll () at ../sysdeps/unix/syscall-template.S:81
  3    Thread 0x7f28953db700 (LWP 11077) 0x00007f2895cc5c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
  2    Thread 0x7f2894bda700 (LWP 11078) 0x00007f2895cc5c03 in epoll_wait () at ../sysdeps/unix/syscall-template.S:81
* 1    Thread 0x7f28983af780 (LWP 11036) 0x00007f2895c12067 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;gameappå¯åŠ¨äº†4ä¸ªå­çº¿ç¨‹ï¼Œå°±æ˜¯ä¸Šé¢çš„2345ï¼Œ1æ˜¯ä¸»çº¿ç¨‹ï¼Œä»LWPç¼–å·ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºã€‚ä»è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ä¸»çº¿ç¨‹æŒ‚æ‰äº†ï¼Œbtä¸€ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#0  0x00007f2895c12067 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007f2895c13448 in __GI_abort () at abort.c:89
#2  0x00007f2895c0b266 in __assert_fail_base (fmt=0x7f2895d43f18 &amp;quot;%s%s%s:%u: %s%sAssertion `%s&#39; failed.\n%n&amp;quot;, assertion=assertion@entry=0x7f2897e30a7e &amp;quot;inMainThread()&amp;quot;, 
    file=file@entry=0x7f2897e30a48 &amp;quot;/home/shiwan/publish/engine/src/base/base_context.hpp&amp;quot;, line=line@entry=57, 
    function=function@entry=0x7f2897e313c0 &amp;lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&amp;gt; &amp;quot;void pm::common::BaseContext::assertInThisThread() const&amp;quot;) at assert.c:92
#3  0x00007f2895c0b312 in __GI___assert_fail (assertion=0x7f2897e30a7e &amp;quot;inMainThread()&amp;quot;, file=0x7f2897e30a48 &amp;quot;/home/shiwan/publish/engine/src/base/base_context.hpp&amp;quot;, line=57, 
    function=0x7f2897e313c0 &amp;lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&amp;gt; &amp;quot;void pm::common::BaseContext::assertInThisThread() const&amp;quot;) at assert.c:101
#4  0x00007f289777b26d in pm::common::BaseContext::assertInThisThread (this=0x7f28998d4250) at /home/shiwan/publish/engine/src/base/base_context.hpp:57
...
#27 0x00007f2896555970 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#28 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#29 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»æ ˆé¡¶å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ä»£ç ä¸­è°ƒç”¨äº†&lt;code&gt;assert&lt;/code&gt;å¤±è´¥äº†ã€‚å› ä¸ºæˆ‘ä»¬çš„å¤šçº¿ç¨‹æ¨¡å‹å±äº&lt;code&gt;one loop per thread&lt;/code&gt;æ¨¡å¼ï¼Œè·¨çº¿ç¨‹è°ƒç”¨å¿…é¡»é€šè¿‡&lt;code&gt;event loop&lt;/code&gt;æ¥è½¬å‘ï¼Œè¿™é‡Œçš„assertå°±æ˜¯ä¸ºäº†é˜²æ­¢è·¨çº¿ç¨‹è°ƒç”¨äº†åˆ«çš„çº¿ç¨‹ä¸­å®ä¾‹çš„æ–¹æ³•ã€‚æ‰€ä»¥ç»§ç»­è¿½è¸ªæ ˆçœ‹çœ‹è°ƒç”¨æ¥æºã€‚çœ‹åˆ°æ ˆä½&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#28 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#29 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;WTF?ä¸»çº¿ç¨‹è°ƒç”¨ä¸åº”è¯¥æ˜¯ä»&lt;code&gt;main&lt;/code&gt;å¼€å§‹çš„ä¹ˆï¼Ÿéš¾é“åˆ«çš„çº¿ç¨‹æ˜¯ä¸»çº¿ç¨‹ï¼Ÿ&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) thread apply all bt  -2                                                                                                                                                                                     

Thread 5 (Thread 0x7f28943d9700 (LWP 11079)):
#10 0x00007f2896bbe0a4 in start_thread (arg=0x7f28943d9700) at pthread_create.c:309
#11 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 4 (Thread 0x7f2895bdc700 (LWP 11076)):
#56 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#57 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 3 (Thread 0x7f28953db700 (LWP 11077)):
#10 0x00007f2896bbe0a4 in start_thread (arg=0x7f28953db700) at pthread_create.c:309
#11 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 2 (Thread 0x7f2894bda700 (LWP 11078)):
#10 0x00007f2896bbe0a4 in start_thread (arg=0x7f2894bda700) at pthread_create.c:309
#11 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

Thread 1 (Thread 0x7f28983af780 (LWP 11036)):
#28 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#29 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹å †æ ˆå¯ä»¥çœ‹åˆ°æ‰€æœ‰çº¿ç¨‹çš„å¯åŠ¨å‡½æ•°éƒ½æ˜¯&lt;code&gt;clone&lt;/code&gt;ï¼Œè¿™æ˜¯ä¸æ­£å¸¸çš„ã€‚æ‰€ä»¥é—®é¢˜æ˜¯ä¸»çº¿ç¨‹çš„å †æ ˆè¢«è¦†ç›–äº†ï¼Œé‚£æ˜¯è¢«å“ªä¸ªçº¿ç¨‹è¦†ç›–äº†å‘¢ï¼Ÿç»§ç»­åœ¨ä¸»çº¿ç¨‹ä¸‹æŸ¥çœ‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) f 4
#4  0x00007f289777b26d in pm::common::BaseContext::assertInThisThread (this=0x7f28998d4250) at /home/shiwan/publish/engine/src/base/base_context.hpp:57
57          void assertInThisThread() const { assert(inMainThread()); }
(gdb) p /x this-&amp;gt;dispatch_thread_id_
$3 = {_M_thread = 0x7f2895bdc700}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ ¹æ®çº¿ç¨‹çš„IDå¯ä»¥çœ‹å‡ºè¿™ä¸ªå †æ ˆæœ¬æ¥æ˜¯çº¿ç¨‹4(LWP 11076)çš„ã€‚æŸ¥çœ‹çº¿ç¨‹4çš„å †æ ˆå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#0  0x00007f2895cbcaed in poll () at ../sysdeps/unix/syscall-template.S:81                                                                                                                               [38/1614]
#1  0x00007f289339dcc0 in send_dg (ansp2_malloced=0x7f2895bdac08, resplen2=0x7f2895bdac04, anssizp2=0x7f2895bdac00, ansp2=0x7f2895bdac20, anscp=0x7f2895bdac10, gotsomewhere=&amp;lt;synthetic pointer&amp;gt;, 
    v_circuit=&amp;lt;synthetic pointer&amp;gt;, ns=0, terrno=0x7f2895bd95c8, anssizp=0x7f2895bd9700, ansp=0x7f2895bd95b8, buflen2=47, buf2=0x7f2895bd9760 &amp;quot;\vd\001&amp;quot;, buflen=47, buf=0x7f2895bd9730 &amp;quot;\344A\001&amp;quot;, 
    statp=0x7f2895bdcdb8) at res_send.c:1200
#2  __libc_res_nsend (statp=statp@entry=0x7f2895bdcdb8, buf=buf@entry=0x7f2895bd9730 &amp;quot;\344A\001&amp;quot;, buflen=47, buf2=buf2@entry=0x7f2895bd9760 &amp;quot;\vd\001&amp;quot;, buflen2=buflen2@entry=47, 
    ans=ans@entry=0x7f2895bda3d0 &amp;quot;\344A\201\200&amp;quot;, anssiz=anssiz@entry=2048, ansp=ansp@entry=0x7f2895bdac10, ansp2=ansp2@entry=0x7f2895bdac20, nansp2=0x7f2895bdac00, nansp2@entry=0x7f2897e5f1c0, 
    resplen2=resplen2@entry=0x7f2895bdac04, ansp2_malloced=0x7f2895bdac08, ansp2_malloced@entry=0x7f2895bdb800) at res_send.c:545
#3  0x00007f289339bc0c in __GI___libc_res_nquery (statp=statp@entry=0x7f2895bdcdb8, name=0x7f288002ef50 &amp;quot;x&amp;quot;, class=32552, class@entry=1, type=type@entry=62321, 
    answer=answer@entry=0x7f2895bda3d0 &amp;quot;\344A\201\200&amp;quot;, anslen=2048, anslen@entry=3, answerp=answerp@entry=0x7f2895bdac10, answerp2=answerp2@entry=0x7f2895bdac20, nanswerp2=nanswerp2@entry=0x7f2895bdac00, 
    resplen2=resplen2@entry=0x7f2895bdac04, answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:227
#4  0x00007f289339c210 in __libc_res_nquerydomain (statp=0x7f2895bdcdb8, statp@entry=0x74007f2895bdcdb8, name=name@entry=0x7f288002ef50 &amp;quot;x&amp;quot;, domain=domain@entry=0x0, class=class@entry=1, 
    type=type@entry=62321, answer=answer@entry=0x7f2895bda3d0 &amp;quot;\344A\201\200&amp;quot;, anslen=3, anslen@entry=-1751285904, answerp=0x0, answerp@entry=0x7f2895bdb4f0, answerp2=0x0, answerp2@entry=0x7f2895bdb4c0, 
    nanswerp2=0x2d7, nanswerp2@entry=0x7f2895bdac00, resplen2=0x7f2895bdac04, resplen2@entry=0x7f2897e5f045, answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:594
#5  0x00007f289339c7a9 in __GI___libc_res_nsearch (statp=0x74007f2895bdcdb8, name=name@entry=0x7f288002ef50 &amp;quot;x&amp;quot;, class=class@entry=1, type=type@entry=62321, answer=answer@entry=0x7f2895bda3d0 &amp;quot;\344A\201\200&amp;quot;, 
    anslen=-1751285904, anslen@entry=2048, answerp=answerp@entry=0x7f2895bdac10, answerp2=answerp2@entry=0x7f2895bdac20, nanswerp2=nanswerp2@entry=0x7f2895bdac00, resplen2=resplen2@entry=0x7f2895bdac04, 
    answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:381
#6  0x00007f28935adacb in _nss_dns_gethostbyname4_r (name=0x7f288002ef50 &amp;quot;x&amp;quot;, name@entry=0x7f2895f83060 &amp;lt;_IO_2_1_stderr_&amp;gt; &amp;quot;\207(\255&amp;quot;, &amp;lt;incomplete sequence \373&amp;gt;, pat=0x7f2895bdb1f8, pat@entry=0xfbad2086, 
    buffer=buffer@entry=0x7f2895bdaca0 &amp;quot;H\025&amp;quot;, &amp;lt;incomplete sequence \310&amp;gt;, buflen=buflen@entry=1064, errnop=0x7f2895bdb1e8, errnop@entry=0x7f2895bdb7b0, herrnop=0x7f2895bdb210, herrnop@entry=0x7f2895d42acf, 
    ttlp=ttlp@entry=0x0) at nss_dns/dns-host.c:315
#7  0x00007f2895cb113c in gaih_inet (name=&amp;lt;optimized out&amp;gt;, service=&amp;lt;optimized out&amp;gt;, req=&amp;lt;optimized out&amp;gt;, pai=&amp;lt;optimized out&amp;gt;, naddrs=&amp;lt;optimized out&amp;gt;) at ../sysdeps/posix/getaddrinfo.c:870
#8  0x00007f2895bdb800 in ?? ()
#9  0x00007f289994d1e0 in ?? ()
#10 0x00007f2895bdb49f in ?? ()
.....
#29 0x00007f2897e30a48 in ?? ()
#30 0x0000000000000039 in ?? ()
#31 0x00007f2895c0b312 in __GI___assert_fail (assertion=0x7f2897e30a7e &amp;quot;inMainThread()&amp;quot;, 
    file=0x7f2897e313c0 &amp;lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&amp;gt; &amp;quot;void pm::common::BaseContext::assertInThisThread() const&amp;quot;, line=2548241344, function=0x7f28998d6280 &amp;quot;&amp;quot;)
    at assert.c:101
#32 0x00007f289777b26d in pm::common::BaseContext::assertInThisThread (this=0x7f28998d4250) at /home/shiwan/publish/engine/src/base/base_context.hpp:57
.....
#54 0x00007f289790e56c in std::thread::_Impl&amp;lt;std::_Bind_simple&amp;lt;pm::common::ThreadBase::start()::&amp;lt;lambda()&amp;gt;()&amp;gt; &amp;gt;::_M_run(void) (this=0x7f28998d0e80) at /usr/include/c++/4.9/thread:115
#55 0x00007f2896555970 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6
#56 0x00007f2896bbe0a4 in start_thread (arg=0x7f2895bdc700) at pthread_create.c:309
#57 0x00007f2895cc562d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:111

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å †æ ˆä¸‹é¢çš„å†…å®¹å’Œåˆšåˆšåœ¨ä¸»çº¿ç¨‹ä¸­çš„å †æ ˆä¸€è‡´ï¼Œå„ç§å˜é‡çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä»31å·frameå¾€ä¸Šå°±ä¸æ­£å¸¸äº†ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#29 0x00007f2897e30a48 in ?? ()
#30 0x0000000000000039 in ?? ()
#31 0x00007f2895c0b312 in __GI___assert_fail (assertion=0x7f2897e30a7e &amp;quot;inMainThread()&amp;quot;, 
    file=0x7f2897e313c0 &amp;lt;pm::common::BaseContext::assertInThisThread() const::__PRETTY_FUNCTION__&amp;gt; &amp;quot;void pm::common::BaseContext::assertInThisThread() const&amp;quot;, line=2548241344, function=0x7f28998d6280 &amp;quot;&amp;quot;)
    at assert.c:101
#32 0x00007f289777b26
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰€ä»¥å‡ºç°çš„æƒ…æ™¯æ˜¯å­çº¿ç¨‹4è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹çš„æ ˆæŒ‡é’ˆ&lt;code&gt;%rsp&lt;/code&gt;è¢«ä¿®æ”¹åˆ°å­çº¿ç¨‹4çš„æ ˆç©ºé—´äº†ã€‚ç”±äº&lt;code&gt;%rsp&lt;/code&gt;è¢«ç ´åï¼Œå‡½æ•°è¿”å›æ—¶ï¼Œä¿å­˜çš„pcå°±ä¸æ˜¯åŸæ¥çš„è¿”å›ç‚¹ï¼Œè€Œæ˜¯çº¿ç¨‹4çš„æ§åˆ¶æµï¼Œè°ƒç”¨æ ˆå°±è¢«é”™è¯¯åœ°è®¾ç½®äº†ã€‚åœ¨å¼€å§‹debugçš„æ—¶å€™ï¼Œæˆ‘é”™è¯¯çš„ä»¥ä¸ºç”±äºçº¿ç¨‹4çš„æ ˆ
è¢«ç ´åï¼ŒåŠ ä¸Šå…¶ä¸­ä¸€å †&amp;rdquo;???&amp;ldquo;ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆå‚è€ƒä»·å€¼ã€‚ä½†æ˜¯ä»”ç»†çœ‹çœ‹æ ˆé¡¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#0  0x00007f2895cbcaed in poll () at ../sysdeps/unix/syscall-template.S:81                                                                                                                               [38/1614]
#1  0x00007f289339dcc0 in send_dg (ansp2_malloced=0x7f2895bdac08, resplen2=0x7f2895bdac04, anssizp2=0x7f2895bdac00, ansp2=0x7f2895bdac20, anscp=0x7f2895bdac10, gotsomewhere=&amp;lt;synthetic pointer&amp;gt;, 
    v_circuit=&amp;lt;synthetic pointer&amp;gt;, ns=0, terrno=0x7f2895bd95c8, anssizp=0x7f2895bd9700, ansp=0x7f2895bd95b8, buflen2=47, buf2=0x7f2895bd9760 &amp;quot;\vd\001&amp;quot;, buflen=47, buf=0x7f2895bd9730 &amp;quot;\344A\001&amp;quot;, 
    statp=0x7f2895bdcdb8) at res_send.c:1200
#2  __libc_res_nsend (statp=statp@entry=0x7f2895bdcdb8, buf=buf@entry=0x7f2895bd9730 &amp;quot;\344A\001&amp;quot;, buflen=47, buf2=buf2@entry=0x7f2895bd9760 &amp;quot;\vd\001&amp;quot;, buflen2=buflen2@entry=47, 
    ans=ans@entry=0x7f2895bda3d0 &amp;quot;\344A\201\200&amp;quot;, anssiz=anssiz@entry=2048, ansp=ansp@entry=0x7f2895bdac10, ansp2=ansp2@entry=0x7f2895bdac20, nansp2=0x7f2895bdac00, nansp2@entry=0x7f2897e5f1c0, 
    resplen2=resplen2@entry=0x7f2895bdac04, ansp2_malloced=0x7f2895bdac08, ansp2_malloced@entry=0x7f2895bdb800) at res_send.c:545
#3  0x00007f289339bc0c in __GI___libc_res_nquery (statp=statp@entry=0x7f2895bdcdb8, name=0x7f288002ef50 &amp;quot;x&amp;quot;, class=32552, class@entry=1, type=type@entry=62321, 
    answer=answer@entry=0x7f2895bda3d0 &amp;quot;\344A\201\200&amp;quot;, anslen=2048, anslen@entry=3, answerp=answerp@entry=0x7f2895bdac10, answerp2=answerp2@entry=0x7f2895bdac20, nanswerp2=nanswerp2@entry=0x7f2895bdac00, 
    resplen2=resplen2@entry=0x7f2895bdac04, answerp2_malloced=answerp2_malloced@entry=0x7f2895bdac08) at res_query.c:227
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;çº¿ç¨‹æ­£åœ¨pollï¼Œä»ä¸Šä¸€å±‚çš„è°ƒç”¨æ¥çœ‹åº”è¯¥æ˜¯åœ¨åšDNSæŸ¥è¯¢, gameappçš„æœ€åä¸€è¡Œlogæ˜¯&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;I0223 15:06:34.988075 11076 http_manager.cpp:237] Adding curl task url: http://pm01.gmsdk.gameyw.netease.com/app/gen_token.json?game_server=20001&amp;amp;game_uid=4212937&amp;amp;lang=zh_cn&amp;amp;nickname=%E4%BA%8E%E5%AE%B6%E6%AD%8C&amp;amp;pid=pm01&amp;amp;platform=android&amp;amp;refer=%2Fsprite.html&amp;amp;sign=e17e1efcf43bfd036e4410e4b1b844b8&amp;amp;time=1487833594&amp;amp;type=1&amp;amp;uid=aebfpu46xuf3q3ag%40ad.netease.win.163.com&amp;amp;vip=1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™è¡Œlogæ˜¯çº¿ç¨‹4æ‰“å‡ºæ¥çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆ¤å®šï¼Œæ­¤æ—¶çº¿ç¨‹4æ­£åœ¨åšDNSæŸ¥è¯¢ï¼Œè€Œè°ƒç”¨è¿™ä¸ªè¿™ä¸ªDNSçš„æ­£æ˜¯curlã€‚é‚£ä¸€ä¸ªç®€å•çš„DNSæŸ¥è¯¢æ€ä¹ˆä¼šå¯¼è‡´ç¨‹åºæŒ‚æ‰å‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹CURLçš„æºç ï¼š&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Curl_resolv_timeout&lt;/code&gt;æ˜¯curlç”¨äºåšdnsè§£æçš„å…¥å£ï¼Œä»å‡½æ•°åå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸ªæ”¯æŒtimeoutçš„DNSè§£æå‡½æ•°ï¼Œç„¶è€Œæˆ‘ä»¬æ“ä½œç³»ç»Ÿçš„å¦‚&lt;code&gt;getaddrinfo&lt;/code&gt;ï¼Œ&lt;code&gt;gethostbyname&lt;/code&gt;ä¹‹ç±»çš„å‡½æ•°éƒ½æ˜¯åŒæ­¥é˜»å¡è°ƒç”¨ï¼Œä¸æ”¯æŒè¶…æ—¶å‚æ•°çš„å•Šã€‚ä»”ç»†çœ‹&lt;code&gt;Curl_resolv_timeout&lt;/code&gt;
çš„å®ç°å‘ç°å…¶ä½¿ç”¨&lt;code&gt;SIGALRM&lt;/code&gt;ä¿¡å·çš„æœºåˆ¶æ¥å®ç°åœ¨çº¿ç¨‹é˜»å¡ç­‰å¾…æ—¶ï¼Œä¾ç„¶èƒ½å¤Ÿåœ¨ä¸€å®šæ—¶é—´ä¹‹åå¾—åˆ°é€šçŸ¥ï¼Œä»è€Œæ”¾å¼ƒç»§ç»­ç­‰å¾…çš„ç›®çš„ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–åçš„ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static RETSIGTYPE alarmfunc(int sig)
{
  siglongjmp(curl_jmpenv, 1);
  return;
}

int Curl_resolv_timeout()
{
if(sigsetjmp(curl_jmpenv, 1)) {
  failf(data, &amp;quot;name lookup timed out&amp;quot;);
  rc = CURLRESOLV_ERROR;
  goto clean_up;
}

keep_sigact = signal(SIGALRM, alarmfunc);
alarm(curlx_sltoui(timeout/1000L));
Curl_resolv(conn, hostname, port, entry);
signal(SIGALRM, keep_sigact);
}

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€šè¿‡alarmè§¦å‘è¶…æ—¶ï¼Œåœ¨è°ƒç”¨&lt;code&gt;Curl_resolv&lt;/code&gt;ä¹‹å‰è®¾ç½®å¥½jumppointï¼Œä¸€æ—¦alarmè§¦å‘ï¼Œè°ƒç”¨&lt;code&gt;alarmfunc&lt;/code&gt;ï¼Œå†&lt;code&gt;longjump&lt;/code&gt;åˆ°jumppointä½ç½®ï¼Œé—´æ¥å®ç°äº†ç›®çš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;b&gt;ç„¶è€Œè¿™ç§åšæ³•åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹æ˜¯ç¾éš¾&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªé¢å‘è¿›ç¨‹çš„ä¿¡å·äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šé€‰æ‹©ä»»æ„ä¸€ä¸ªå¯ä»¥å¤„ç†è¯¥ä¿¡å·çš„çº¿ç¨‹æ¥å¤„ç†ã€‚å…¶ä¸­SIGALRMæ­£æ˜¯ä¸€ä¸ªé¢å‘è¿›ç¨‹çš„ä¿¡å·äº‹ä»¶ï¼Œæ‰€ä»¥å…¶å¯èƒ½ä¼šè¢«å…¶ä»–çº¿ç¨‹å¤„ç†ã€‚
è¿™ä¸ªä¿¡å·è¢«ä¸»çº¿ç¨‹æ•æ‰åˆ°äº†ã€‚ç°åœ¨æ¥è¿˜åŸæ•´ä¸ªäº‹ä»¶ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;å­çº¿ç¨‹å‘èµ·è®¾ç½®å¥½alarmï¼Œå‘èµ·DNSè¯·æ±‚å¹¶ç­‰å¾…&lt;/li&gt;
&lt;li&gt;ç”±äºDNSæŸ¥è¯¢é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼ŒALARMä¿¡å·äº‹ä»¶è§¦å‘&lt;/li&gt;
&lt;li&gt;ä¸»çº¿ç¨‹æ•æ‰åˆ°è¿™ä¸€ä¿¡å·ï¼Œè°ƒç”¨&lt;code&gt;alarmfunc&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;alarmfunc&lt;/code&gt;çš„ä½œç”¨æ˜¯&lt;code&gt;longjump&lt;/code&gt;ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒè¢«æ›¿æ¢æˆå­çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒï¼Œæ ˆè¢«ç ´å&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è§£å†³æ–¹æ¡ˆï¼š
é€šè¿‡æŸ¥çœ‹curlä»£ç ï¼Œå‘ç°å…¶è¿˜æœ‰ä¸€ç§å¼‚æ­¥dnsæ¨¡å¼ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨&lt;a href=&#34;https://c-ares.haxx.se&#34;&gt;c-ares&lt;/a&gt;åº“ï¼Œæ‰€ä»¥æœ€ç»ˆå¼•è¿›äº†è¿™ä¸ªåº“ï¼Œæ›¿æ¢æ‰äº†åŸæ¥çš„ä½¿ç”¨ç³»ç»ŸDNSæŸ¥è¯¢æ–¹æ¡ˆã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>åµŒå…¥ luajit æ—¶åŒæ—¶ä½¿ç”¨ ffi å’Œ c api çš„è§£å†³æ–¹æ¡ˆ</title>
      <link>http://sysfork.com/post/2017/compatible-embed-luajit-ffi-load/</link>
      <pubDate>Tue, 09 May 2017 22:05:47 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/compatible-embed-luajit-ffi-load/</guid>
      <description>&lt;p&gt;æˆ‘ä»¬éƒ½å–œæ¬¢&lt;a href=&#34;http://luajit.org/ext_ffi.html&#34;&gt;ffi&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ffi çš„æ¥å£ç®€å•æ˜“ç”¨ï¼Œå½“ä½¿ç”¨ç¬¬ä¸‰æ–¹æ²¡æœ‰æä¾› lua æ¥å£çš„åº“æ¥è¯´ï¼Œä½¿ç”¨ ffi æ¥å…¥ç›¸å½“å®¹æ˜“ã€‚
è€Œä¸”æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé€šè¿‡ ffi è°ƒç”¨çš„æ¥å£æ˜¯å¯ä»¥è¢« jit ç¼–è¯‘çš„ï¼Œæ•ˆç‡ç›¸å¯¹äºä½¿ç”¨ä¼ ç»Ÿçš„ &lt;a href=&#34;https://www.lua.org/pil/24.html&#34;&gt;lua c api&lt;/a&gt;æ¥è¯´è¦
é«˜å¾—å¤šã€‚ffi ç›´æ¥ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿçš„è°ƒç”¨æ¨¡å‹ï¼Œé™¤äº†æ•°æ®ç»“æ„è½¬åŒ–çš„ä»£ä»·å¤–æ²¡æœ‰é¢å¤–çš„è´Ÿæ‹…ã€‚è€Œä½¿ç”¨ä¼ ç»Ÿ c api åˆ™æ˜¯
é€šè¿‡ lua è™šæ‹Ÿæ ˆæ¥å®ç°ï¼Œå¹¶ä¸”éœ€è¦å’Œ lua çš„è°ƒç”¨æ¨¡å‹å…¼å®¹ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯ï¼Œå¯¹äºæ¥å…¥ lua çš„ç¨‹åºè€Œè¨€ï¼Œä»…ä»…æ”¯æŒ luajit æ˜¯æœ‰ä¸€å®šé£é™©çš„ï¼Œç›¸å¯¹äº &lt;a href=&#34;https://www.lua.org/&#34;&gt;puc lua&lt;/a&gt;ï¼Œ luajit çš„ä¸»è¦å¼€å‘è€…å’Œç»´æŠ¤è€…
æ¯”è¾ƒå°‘ï¼Œåº”ç”¨é¢ä¹Ÿä¸å¦‚ luaã€‚æ‰€ä»¥å¤§éƒ¨åˆ†çš„é¢ç›¸ lua çš„ç¨‹åºéƒ½ä¼šåŒæ—¶æ”¯æŒ luajit å’Œ luaã€‚ffi æ˜¯ luajit å†…ç½®çš„æ¨¡å—ï¼Œè€Œ lua å´ä¸æºå¸¦è¿™ä¸ªæ¨¡å—ï¼Œ
æœ‰ä¸€äº›å¼€æºçš„é¡¹ç›®ï¼Œ å¦‚ facebook å¼€å‘çš„&lt;a href=&#34;https://github.com/facebook/luaffifb&#34;&gt;è¿™ä¸ª&lt;/a&gt;ï¼Œä½†æ˜¯ç»è¿‡æˆ‘ä»¬çš„æµ‹è¯•å…¶æ•ˆç‡æ¯”æ™®é€šçš„c apiè¿˜æ…¢: (ã€‚
æ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒæŠ˜ä¸­çš„æ–¹æ¡ˆæ˜¯åŒæ—¶æä¾› ffi binding å’Œ c binding çš„æ–¹æ¡ˆï¼Œè¿™æ˜¯å¤§éƒ¨åˆ† lua åº“çš„é€‰æ‹©ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœæä¾›çš„æ˜¯ä¸€ä¸ª so åº“ï¼Œé‚£ä¹ˆåªéœ€è¦æä¾›ä¸ª lua å…¥å£æ–‡ä»¶ï¼Œå¦‚æœä½¿ç”¨ ffi çš„è¯ï¼Œåˆ™è°ƒç”¨ç›¸å…³çš„ lua æ–‡ä»¶ã€‚å¦‚æœæ˜¯ c binding çš„è¯ï¼Œé‚£å°±è°ƒç”¨å…·ä½“çš„
soæ–‡ä»¶ã€‚ç„¶è€Œè¿™åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­æ˜¯ä¸å¯è¡Œçš„ï¼Œä¸ºäº†ä¿è¯éƒ¨ç½²çš„ç®€åŒ–ï¼Œæˆ‘ä»¬çš„ç¨‹åºåªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸ä¼šä¾èµ–é™¤ä¸€äº›æ ¸å¿ƒ so åº“ä¹‹å¤–çš„ so åº“ã€‚æ‰€æœ‰çš„
c binding ä»£ç éƒ½æ˜¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢çš„ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ &lt;code&gt;ffi.load&lt;/code&gt; æˆ‘ä»¬è‡ªå·±çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¤§æ¦‚çš„ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-C&#34;&gt;// main.c

char* encode(const char* input, size_t size, size_t *out_size) { // å‡è®¾è¿™æ˜¯æˆ‘ä»¬çš„å·¥ä½œå‡½æ•°
    //...
}

// c api
int l_encode(lua_State* L) { // ä¸ºäº†è®©ä¸Šé¢çš„æ¥å£èƒ½è¢« lua è°ƒç”¨ï¼Œéœ€è¦è½¬æ¢ä¸€ä¸‹
    size_t length, out_size;
    char *in_data, *out_data;
    in_data = lua_tolstring(L, 1, &amp;amp;length);
    out_data = encode(in_data, length, &amp;amp;out_size);
    lua_pushlstring(L, out_data, out_size);
    return 1;
}

// register in some place 
lua_pushcfunction(L, l_encode); // æ³¨å†Œåˆ° lua è™šæ‹Ÿæœºä¸­
lua_setglobal(L, &amp;quot;c_encode&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæ˜¯ç»Ÿä¸€çš„å…¥å£æ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;-- ffi.lua

if ffi then -- å¦‚æœèƒ½ä½¿ç”¨ ffi çš„è¯
    lib = ffi.load(????) -- è¿™é‡Œæ”¹æ€ä¹ˆå†™
    ffi.cdef[[
        char* encode(const char* input, size_t size, size_t *out_size);
    ]]
    -- do some dirty jobs
    lib.encode -- ...
else
    encode = c_encode -- ä½¿ç”¨ c api ç‰ˆæœ¬
end


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶è€Œè¿™æ˜¯ä¸å¯è¡Œçš„ã€‚&lt;/p&gt;

&lt;p&gt;ffi load è°ƒç”¨çš„å…¶å®å°±æ˜¯&lt;a href=&#34;http://man7.org/linux/man-pages/man3/dlopen.3.html&#34;&gt;dlopen&lt;/a&gt;ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ &lt;code&gt;a.out&lt;/code&gt;ï¼Œåœ¨è¿™é‡Œé¢
è°ƒç”¨ &lt;code&gt;dlopen(&amp;quot;a.out&amp;quot;, ...)&lt;/code&gt;ï¼Œå…¶ä½œç”¨æ˜¯å°† &lt;code&gt;a.out&lt;/code&gt; çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼ŒåŠ ä¸Šæˆ‘ä»¬ä¹‹å‰è¿è¡Œ &lt;code&gt;a.out&lt;/code&gt; çš„ç¨‹åºï¼ˆå…¶å®ä¹Ÿæ˜¯ç”¨ &lt;code&gt;/lib64/ld-linux-x86-64.so&lt;/code&gt; åŠ è½½çš„ï¼‰ã€‚
è¿™æ ·å†…å­˜ä¸­å°±æœ‰äº†ä¸¤ä»½ä¸€æ ·çš„é•œåƒï¼Œä¸€ä¸ªå…¨å±€å˜é‡ä¼šå¯¹åº”ä¸¤ä¸ªå†…å­˜åœ°å€ã€‚è¿™ç§äº§ç”Ÿçš„åŸå› å¯ä»¥å‚è€ƒ&lt;a href=&#34;https://book.douban.com/subject/3652388/&#34;&gt;ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ç°æœ‰çš„ luajit æ¥å£æ˜¯æ— æ³•åšåˆ°çš„ã€‚ä½†æ˜¯ &lt;code&gt;dlopen&lt;/code&gt; å¯ä»¥&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If filename is  NULL,  then  the  returned handle  is for the main program&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å½“ filename ä¸º NULL æ—¶ï¼Œç›´æ¥è¿”å›å½“å‰ç¨‹åºçš„ dl handleï¼Œå¯ä»¥å–å¾—å„ç§ symbol çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¨å¾®ä¿®æ”¹ä¸‹ luajit çš„å®ç°:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// in lj_clib.c
static const char *clib_extname(lua_State *L, const char *name
{
  if (!name[0]) return NULL; // æ·»åŠ è¿™ä¸€è¡Œ
  if (!strchr(name, &#39;/&#39;)
#if LJ_TARGET_CYGWIN
      &amp;amp;&amp;amp; !strchr(name, &#39;\\&#39;)
#endif
     ) {
    if (!strchr(name, &#39;.&#39;)) {
      name = lj_strfmt_pushf(L, CLIB_SOEXT, name);
      L-&amp;gt;top--;
// ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‚£ä¹ˆåœ¨åº”ç”¨ä¸­å°±å¯ä»¥è¿™æ ·ä½¿ç”¨äº†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local ffi = require(&amp;quot;ffi&amp;quot;)
local lib = ffi.load(&amp;quot;&amp;quot;)
ffi.cdef[[...]]
-- lib.doSomething
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å¯¹äºå•å¯æ‰§è¡Œæ–‡ä»¶å°±å¯ä»¥æ˜¯çš„ c binding å’Œ ffi binding å…±å­˜äº†ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>è®©disqusæ”¯æŒå¤§é™†è®¿é—®</title>
      <link>http://sysfork.com/post/2017/use-disqus-in-china/</link>
      <pubDate>Sun, 07 May 2017 18:11:51 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/use-disqus-in-china/</guid>
      <description>

&lt;p&gt;ç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œ&lt;a href=&#34;https://disqus.com/&#34;&gt;disqus&lt;/a&gt; åœ¨å¤§é™†éš¾ä»¥è®¿é—®ï¼Œéšç€&lt;a href=&#34;https://duoshuo.com&#34;&gt;å¤šè¯´&lt;/a&gt;çš„å…³é—­ï¼Œæ— æ³•æ­£å¸¸åœ°ä½¿ç”¨è¯„è®ºåŠŸèƒ½å·²ç»æˆä¸º
ã€Œé™æ€åšå®¢ç”Ÿæˆå™¨ç±»åšå®¢ã€çš„ä¸€ä¸ªé—®é¢˜ã€‚ å¥½åœ¨ disqus æä¾›äº†ä¸€äº› &lt;a href=&#34;https://disqus.com/api/docs/&#34;&gt;api&lt;/a&gt; ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æ–¹æ³•å®ç°è¯„è®ºçš„åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;h1 id=&#34;åç«¯&#34;&gt;åç«¯&lt;/h1&gt;

&lt;p&gt;ä¹‹å‰å·²ç»æœ‰éƒ¨åˆ†çš„è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­æœ€å®Œå–„çš„æ˜¯ &lt;a href=&#34;https://shijianan.com/2017/01/02/build-your-own-disqus/&#34;&gt;è¿™é‡Œ&lt;/a&gt; ï¼Œå…¶ä¸­ä½¿ç”¨çš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ª
&lt;a href=&#34;https://disqus.com/api/applications/&#34;&gt;disqus application&lt;/a&gt; ï¼Œ
ç„¶åä½¿ç”¨å„ç§ api ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ python æˆ–è€…ç›´æ¥ä½¿ç”¨ nginx çš„åå‘ä»£ç†ã€‚æˆ‘ä¹Ÿæ›´æ–°è¿™æ®µ &lt;a href=&#34;https://github.com/shijn/disqus-proxy&#34;&gt;python&lt;/a&gt; ä»£ç ï¼Œä½†æ˜¯åœ¨
åˆ›å»ºè¯„è®ºçš„æ—¶å€™æ€»æ˜¯å‡ºé”™ï¼Œ æç¤º &lt;code&gt;This application cannot create posts on the chosen forum (code 12)&lt;/code&gt; ã€‚åœ¨å°è¯•äº†å¤šç§
&lt;a href=&#34;http://stackoverflow.com/questions/15416688/disqus-api-create-comment-as-guest&#34;&gt;æ–¹æ³•&lt;/a&gt;ï¼ŒæŸ¥é˜…äº†ä¼—å¤šç½‘é¡µå‡æ²¡æœ‰è§£å†³ã€‚åæ¥æ‰¾åˆ°ä¸€ç§è¯´æ³•ï¼Œè¯´æ˜¯è¿™ä¸ªæ¥å£æ— æ³•ä½¿ç”¨
è‡ªå·±åˆ›å»ºçš„&lt;code&gt;api_key&lt;/code&gt;ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†&lt;a href=&#34;http://spirytoos.blogspot.com/2013/12/not-so-easy-posting-as-guest-via-disqus.html&#34;&gt;è§£å†³æ–¹æ¡ˆ&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å…¶å®ç­”æ¡ˆå°±åœ¨ disqus çš„å‰ç«¯ js é‡Œé¢ã€‚ä½¿ç”¨ chrome network tools å¯ä»¥çœ‹åˆ°æœ‰ä¸€äº›è®¿é—®ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Request URL:https://disqus.com/api/3.0/embed/threadDetails.json?thread=5781899723
&amp;amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
Request Method:GET
Status Code:200 OK
Remote Address:127.0.0.1:1081
Referrer Policy:no-referrer-when-downgrade
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ disqus å®˜æ–¹çš„ js ä¹Ÿæ˜¯ä½¿ç”¨äº†è¿™å¥— api ï¼Œå…¶ä¸­ api_key èµ«ç„¶åœ¨åˆ—ï¼Œå¹¶ä¸”åœ¨3å¹´åçš„ä»Šå¤©è¿™ä¸ª key ä¾ç„¶æœ‰æ•ˆï¼Œå¹¶ä¸”è¿™ä¸ª key cd æ˜¯æ— é™çš„ï¼Œä¸åƒ &lt;a href=&#34;https://data.disqus.com/capabilities/&#34;&gt;disqus application &lt;/a&gt;
æœ‰ç€ 1000 æ¬¡/hour çš„å…¨å±€é™åˆ¶ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨è¿™ä¸ª api_key è¦æ±‚å¿…é¡»æä¾› Referer å’Œ Originï¼Œå¹¶ä¸”éƒ½è¦æ˜¯å®˜æ–¹çš„åœ°å€ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Referer https://disqus.com;
Origin https://disqus.com;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰€ä»¥æœ¬ç«™é‡‡ç”¨çš„ä¸€ä¸ªåå‘ä»£ç†çš„é…ç½®ä¸º&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;location ~ ^/disqus/(.*) {
    proxy_pass https://disqus.com/api/3.0/$1?api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F&amp;amp;$args;
    proxy_set_header Referer https://disqus.com;
    proxy_set_header Origin https://disqus.com;
    proxy_redirect off;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨æ­£å¸¸çš„æ¥å£äº†ã€‚å¤§éƒ¨åˆ†çš„æ¥å£éƒ½æ˜¯æ”¯æŒ jsonp çš„ï¼Œæ‰€ä»¥å¯ä»¥è·¨åŸŸè°ƒç”¨ï¼Œå¯¹äº POST è¯·æ±‚å¦‚å‘è¡¨è¯„è®ºç­‰æ— æ³•ä½¿ç”¨ jsonp çš„æƒ…å†µï¼Œåªèƒ½æ”¾åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨ä¸‹é¢äº†ã€‚æœŸå¾…æœ‰äººèƒ½åšä¸€ä¸ªæ”¯æŒè·¨åŸŸçš„å…¬å…±æ¥å£ :)ã€‚&lt;/p&gt;

&lt;h1 id=&#34;å‰ç«¯&#34;&gt;å‰ç«¯&lt;/h1&gt;

&lt;p&gt;å‰ç«¯çš„éƒ¨åˆ†æœ‰ç‚¹éº»çƒ¦ï¼Œä½†æ˜¯è‡³å°‘æ˜¯æœ‰è§£å†³æ–¹æ¡ˆçš„ï¼Œå¯ä»¥ä½¿ç”¨å„ç§æ’ä»¶å¦‚&lt;a href=&#34;https://github.com/Viima/jquery-comments&#34;&gt;jquery comments&lt;/a&gt;ç­‰ï¼Œæœ¬ç«™ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªè‡ªå·±éšä¾¿å†™çš„å®ç°ï¼Œæ‰€ä»¥ç•Œé¢æ¯”è¾ƒæŒ«ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹
æœ¬ç«™çš„&lt;a href=&#34;https://github.com/usbuild/site&#34;&gt;ä»£ç å®ç°&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;å¯¹äºä¸€äº›æœ‰ã€Œæ¢¯å­ã€çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿè¿™äº›ç”¨æˆ·èƒ½å¤Ÿæ­£å¸¸è®¿é—®ï¼Œæ‰€ä»¥ä½¿ç”¨äº†ä¸€ä¸ªç­–ç•¥ï¼šå½“èƒ½å¤Ÿæ­£å¸¸åŠ è½½ disqus å®˜æ–¹ js æ—¶å°±ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬ï¼Œå¦åˆ™å°±ä½¿ç”¨ç®€æ˜“ç‰ˆæœ¬ï¼Œä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;function RenderComment(forum, apiPath, selector, url) {
  var done = false;
  var dsq = document.createElement(&#39;script&#39;);
  dsq.src = &#39;//&#39;+forum+&#39;.disqus.com/embed.js&#39;;
  dsq.onload = function()  {
    done = true;
  };
  document.head.appendChild(dsq);
  setTimeout(function () { if (!done)
    api = new CommentAPI(forum, apiPath, selector, url);
  }, 2000);
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æœ¬ç«™çš„ä»£ç å®ç°ç›¸å½“ç®€é™‹ï¼Œä»…ä»…æä¾›ä¸€ä¸ªæ€è·¯ï¼Œå¸Œæœ›èƒ½æœ‰æ‰€å¸®åŠ©ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ä¸€ç§åœ¨elfä¸­é›†æˆè„šæœ¬æ–‡ä»¶çš„æ–¹æ¡ˆ</title>
      <link>http://sysfork.com/post/2017/a-solution-for-elf-integrate-scripts/</link>
      <pubDate>Mon, 01 May 2017 22:30:00 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/a-solution-for-elf-integrate-scripts/</guid>
      <description>

&lt;p&gt;è¿›è¡Œæ¸¸æˆæœåŠ¡å™¨å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å°†&lt;code&gt;C++&lt;/code&gt;çš„éƒ¨åˆ†ç§°ä¹‹ä¸ºå¼•æ“å±‚ï¼Œè€Œ&lt;code&gt;lua&lt;/code&gt;ç§°ä¹‹ä¸ºè„šæœ¬å±‚ã€‚ä½†æ˜¯å¾€å¾€æœ‰äº›æ ¸å¿ƒé€»è¾‘æ˜¯å„ä¸ªæ¸¸æˆå…¬ç”¨çš„ï¼Œ
æˆ–è€…è¯´æœ‰äº›å¼•æ“å±‚çš„ä»£ç ç”¨&lt;code&gt;C++&lt;/code&gt;å†™èµ·æ¥ååˆ†éº»çƒ¦ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šä½¿ç”¨&lt;code&gt;lua&lt;/code&gt;æ¥ç¼–å†™ã€‚è¿™å°±å¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬çš„æ¸¸æˆç›®å½•ç»“æ„å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;â”œâ”€bin               // å¯æ‰§è¡Œæ–‡ä»¶
â””â”€scripts           // è„šæœ¬ç›®å½•ï¼Œluaæ–‡ä»¶
    â”œâ”€framework     // æ ¸å¿ƒluaæ–‡ä»¶ï¼Œå„ä¸ªé¡¹ç›®å…¬ç”¨çš„
    â””â”€server        // æ¸¸æˆé€»è¾‘luaæ–‡ä»¶
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;scripts/framework&lt;/code&gt;æ˜¯å„ä¸ªé¡¹ç›®å…¬ç”¨çš„ï¼Œå¹¶ä¸”å’Œ&lt;code&gt;bin&lt;/code&gt;ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶åŒæ—¶å‘å¸ƒå’Œæ›´æ–°ã€‚æ‰€ä»¥æœ‰ä¸€ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯å°†&lt;code&gt;framework&lt;/code&gt;ä¸­
çš„luaæ–‡ä»¶é›†æˆåˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå‡å°‘ç»´æŠ¤çš„æˆæœ¬ã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ–‡ä»¶å­˜å‚¨&#34;&gt;æ–‡ä»¶å­˜å‚¨&lt;/h1&gt;

&lt;p&gt;ä¸‹é¢æ˜¯elfæ–‡ä»¶çš„ç¤ºæ„å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/thumb/7/77/Elf-layout--en.svg/260px-Elf-layout--en.svg.png&#34; alt=&#34;elf&#34; /&gt;&lt;/p&gt;

&lt;p&gt;elfæ–‡ä»¶æœ‰å¤šä¸ªsectionï¼Œé™¤äº†ä¸€äº›é¢„å®šä¹‰çš„sectionå¦‚&lt;code&gt;.rodata&lt;/code&gt;ã€&lt;code&gt;.text&lt;/code&gt;ã€&lt;code&gt;.init&lt;/code&gt;ç­‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€äº›è‡ªå·±çš„sectionã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æ‰€éœ€è¦çš„luaæ–‡ä»¶
æ”¾è¿›è¿™ä¸ªsectionä¸­ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™åŠ¨æ€è¯»å‡ºæ¥ï¼Œå®ç°ç›®çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://linux.die.net/man/1/objcopy&#34;&gt;objcopy&lt;/a&gt;å‘½ä»¤æ¥å®ç°åˆ›å»ºè‡ªå®šä¹‰sectionçš„åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;objcopy infile.out --add-section .lua-data=section_file outfile.out
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶è€Œ&lt;code&gt;framework&lt;/code&gt;é‡Œé¢æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œè€Œä¸”åŒ…å«åµŒå¥—çš„æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå°†æ–‡ä»¶å¤¹å˜æˆå•ä¸ªæ–‡ä»¶çš„åŠŸèƒ½ï¼Œç±»ä¼¼äº&lt;a href=&#34;https://linux.die.net/man/1/tar&#34;&gt;tar&lt;/a&gt;ã€‚è™½ç„¶åˆ›å»º
sectionæ—¶ä½¿ç”¨&lt;code&gt;tar&lt;/code&gt;å‘½ä»¤æ˜¯ç®€å•çš„ï¼Œä½†æ˜¯åœ¨è¯»å–çš„æ—¶å€™éœ€è¦ä¸€äº›ç¬¬ä¸‰æ–¹çš„åº“æ¥æ”¯æŒï¼Œè¿™æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚è€Œç”±äºæˆ‘ä»¬çš„ç›®å½•ä¸­åªåŒ…å«&lt;code&gt;lua&lt;/code&gt;æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–è®¾è®¡ã€‚
é¦–å…ˆç©ºæ–‡ä»¶å¤¹å¯¹äºæˆ‘ä»¬æ˜¯æ— æ„ä¹‰çš„ï¼Œåªéœ€è¦&lt;code&gt;lua&lt;/code&gt;æ–‡ä»¶å°±å¯ä»¥ã€‚æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹çš„è¡¨:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ libs/json.lua      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core/entity.lua    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ app/game.lua       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libs/bson.lua      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ ¼å¼è½¬æ¢æˆå•ä¸ªæ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚name_lenâ”‚content_lenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core.entity        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚name_lenâ”‚content_lenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libs.bson          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .................  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;name_len&lt;/code&gt;ä¸ºæ–‡ä»¶åçš„é•¿åº¦ï¼Œè¿™é‡Œç›´æ¥è½¬æ¢æˆäº†luaä¸­&lt;code&gt;require&lt;/code&gt;çš„æ ¼å¼ï¼Œä½¿ç”¨ç‚¹ç¬¦å·ã€‚&lt;code&gt;content_len&lt;/code&gt;æ˜¯æ–‡ä»¶å†…å®¹çš„é•¿åº¦ï¼Œå³æ–‡ä»¶çš„å…·ä½“å†…å®¹é•¿åº¦ã€‚æœ€åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code&gt;zip&lt;/code&gt;æŒ‡ä»¤
å°†è¿™éƒ¨åˆ†å†…å®¹å‹ç¼©å­˜å‚¨åœ¨&lt;code&gt;elf&lt;/code&gt;æ–‡ä»¶ä¸­ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/env python
#coding: utf-8

import os, struct, StringIO, zlib, subprocess, sys, tempfile, argparse

argParser = argparse.ArgumentParser()

argParser.add_argument(&amp;quot;luafolder&amp;quot;, type=str)
argParser.add_argument(&amp;quot;exe&amp;quot;, type=str)
argParser.add_argument(&amp;quot;out&amp;quot;, type=str)

args = argParser.parse_args()

files = []

path = args.luafolder

for (dirpath, dirname, filenames) in os.walk(path):
    dirp = dirpath[len(path):]
    if dirp:
        if dirp[-1] != &amp;quot;/&amp;quot;:
            dirp += &amp;quot;/&amp;quot;

        while dirp[0] == &amp;quot;/&amp;quot;:
            dirp = dirp[1:]

    files.extend([dirp + x for x in filenames])

output = StringIO.StringIO()

for fpath in files:
    realp = path + &amp;quot;/&amp;quot; + fpath
    filesize = os.path.getsize(realp)

    if fpath.endswith(&amp;quot;.lua&amp;quot;):
        fpath = fpath[:-4]
    elif fpath.endswith(&amp;quot;.luac&amp;quot;):
        fpath = fpath[:-5]
    else:
        continue

    package_pattern = fpath.replace(&amp;quot;/&amp;quot;, &amp;quot;.&amp;quot;)
    package_pattern = &amp;quot;pg.&amp;quot; + package_pattern
    with open(realp, &amp;quot;rb&amp;quot;) as rf:
        content = rf.read()
        output.write(struct.pack(&amp;quot;=hL&amp;quot;, len(package_pattern), len(content)))
        output.write(package_pattern)
        output.write(content)

f = tempfile.NamedTemporaryFile()

outdata = output.getvalue()
f.write(struct.pack(&amp;quot;=L&amp;quot;, len(outdata)))
f.write(zlib.compress(output.getvalue()))
f.flush()

subprocess.call(&amp;quot;objcopy %s --remove-section .lua-data&amp;quot;%(args.exe, ), shell=True)
subprocess.call(&amp;quot;objcopy %s --add-section .lua-data=%s %s&amp;quot;%(args.exe, f.name, args.out), shell=True)

&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;æ–‡ä»¶å†…å®¹çš„è¯»å–&#34;&gt;æ–‡ä»¶å†…å®¹çš„è¯»å–&lt;/h1&gt;

&lt;p&gt;æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code&gt;elf.h&lt;/code&gt;æ–‡ä»¶æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚æ ¹æ®ä¸Šè¿°çš„æ ¼å¼ç¤ºæ„å›¾ï¼Œ&lt;code&gt;elf&lt;/code&gt;æ–‡ä»¶å¼€å¤´çš„æ˜¯Headerï¼Œå…¶æ ¼å¼ä¸º&lt;code&gt;ElfXX_Ehdr&lt;/code&gt;ï¼Œ
æˆ‘ä»¬å¯ä»¥ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹åˆ°å†…å­˜ã€‚ç„¶åè¯»å–&lt;code&gt;e_shoff&lt;/code&gt;å­—æ®µè·å¾—section headerçš„ä½ç½®ï¼Œå®šä½åˆ°ä½ç½®å¹¶ä¾æ¬¡è¯»å–å†…å®¹åˆ°&lt;code&gt;ElfXX_Shdr&lt;/code&gt;
ç»“æ„ä½“ä¸­ï¼Œç„¶åé€šè¿‡å„ä¸ªentryçš„&lt;code&gt;sh_name&lt;/code&gt;å¾—åˆ°æœ€ç»ˆsectionï¼Œç„¶åè¯»å–æ–‡ä»¶è¾¾åˆ°ç›®çš„ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static std::map&amp;lt;std::string, std::string&amp;gt; readElfLuaData(const std::string &amp;amp;filepath) {
    std::map&amp;lt;std::string, std::string&amp;gt; files;
#if __x86_64__
    typedef Elf64_Ehdr ELF_EHDR;
    typedef Elf64_Shdr ELF_SHDR;
#else
    typedef Elf32_Ehdr ELF_EHDR;
    typedef Elf32_Shdr ELF_SHDR;
#endif

    std::ifstream ifs(filepath);

    ELF_EHDR hdr;
    ifs.read(reinterpret_cast&amp;lt;char *&amp;gt;(&amp;amp;hdr), sizeof(hdr));

    std::vector&amp;lt;ELF_SHDR&amp;gt; sh_tables(hdr.e_shnum);
    ifs.seekg(static_cast&amp;lt;long&amp;gt;(hdr.e_shoff));

    for (size_t i = 0; i &amp;lt; hdr.e_shnum; ++i) {
        ifs.read(reinterpret_cast&amp;lt;char *&amp;gt;(&amp;amp;sh_tables[i]), sizeof(sh_tables[i]));
    }

    // read shstr

    std::vector&amp;lt;char&amp;gt; shstr(sh_tables[hdr.e_shstrndx].sh_size);
    ifs.seekg(static_cast&amp;lt;long&amp;gt;(sh_tables[hdr.e_shstrndx].sh_offset));
    ifs.read(shstr.data(), static_cast&amp;lt;long&amp;gt;(shstr.size()));

    ELF_SHDR *lua_sh = nullptr;

    for (size_t i = 0; i &amp;lt; hdr.e_shnum; ++i) {
        char *name = shstr.data() + sh_tables[i].sh_name;
        if (strcmp(name, &amp;quot;.lua-data&amp;quot;) == 0) {
            lua_sh = &amp;amp;sh_tables[i];
            break;
        }
    }

    if (lua_sh) {
        std::vector&amp;lt;char&amp;gt; buf(lua_sh-&amp;gt;sh_size);
        ifs.seekg(static_cast&amp;lt;long&amp;gt;(lua_sh-&amp;gt;sh_offset));
        ifs.read(buf.data(), static_cast&amp;lt;std::streamsize&amp;gt;(buf.size()));

        size_t idx = 0;
#define READ_TO(TARGET, SIZE)                                                                      \
    memcpy(TARGET, buf.data() + idx, SIZE);                                                        \
    idx += SIZE;

        uint32_t raw_len = 0;
        READ_TO(&amp;amp;raw_len, sizeof(raw_len));

        std::vector&amp;lt;char&amp;gt; tmp(raw_len);
        uLongf dest_len = tmp.size();
        uncompress(reinterpret_cast&amp;lt;Bytef *&amp;gt;(tmp.data()), &amp;amp;dest_len,
                   reinterpret_cast&amp;lt;Bytef *&amp;gt;(buf.data() + idx), buf.size() - idx);

        buf.swap(tmp);
        idx = 0;

        while (idx &amp;lt; dest_len) {
            uint16_t name_len;
            uint32_t content_len;
            READ_TO(&amp;amp;name_len, sizeof(name_len));
            READ_TO(&amp;amp;content_len, sizeof(content_len));
            std::string filename(name_len, 0), content(content_len, 0);
            READ_TO(&amp;amp;*filename.begin(), filename.size());
            READ_TO(&amp;amp;*content.begin(), content.size());
            files.emplace(std::piecewise_construct, std::forward_as_tuple(std::move(filename)),
                          std::forward_as_tuple(std::move(content)));
        }
#undef READ_TO
    }
    return files;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥ä¾¿å¯ä»¥é€šè¿‡æ·»åŠ åˆ°&lt;code&gt;package.preload&lt;/code&gt;å®ç°åœ¨luaä¸­è°ƒç”¨è¿™äº›æ–‡ä»¶çš„ç›®çš„ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ä½¿ç”¨C&#43;&#43; mapå®ç°æ³¨å†Œå›è°ƒçš„åŠŸèƒ½</title>
      <link>http://sysfork.com/post/2017/cpp-function-container/</link>
      <pubDate>Sat, 29 Apr 2017 15:38:38 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/cpp-function-container/</guid>
      <description>

&lt;p&gt;åœ¨&lt;code&gt;C++/lua&lt;/code&gt;æ··åˆç¼–ç¨‹ä¸­ï¼Œå¾€å¾€å­˜åœ¨éœ€è¦å›è°ƒçš„æƒ…å†µã€‚æ¯”å¦‚åœ¨æ¸¸æˆä¸­ï¼Œé€»è¾‘è¿›ç¨‹ä¸­çš„è„šæœ¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“è®¿é—®æ“ä½œï¼Œå¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;dbmgr.query({name=&amp;quot;hello&amp;quot;}, function(ret)
-- do something
end)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äº&lt;code&gt;dbmgr.query&lt;/code&gt;æ˜¯å¼‚æ­¥æ“ä½œï¼Œè¿™æ¡è¯­å¥æ˜¯ç«‹å³è¿”å›çš„ã€‚å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡å‘&lt;code&gt;dbmgr&lt;/code&gt;è¿›ç¨‹å‘é€ä¸€ä¸ª&lt;code&gt;query&lt;/code&gt;è¯·æ±‚ï¼Œç„¶åé€»è¾‘è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚å½“&lt;code&gt;dbmgr&lt;/code&gt;æ”¶åˆ°è¯·æ±‚åï¼Œå…¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œå¾—åˆ°
ç»“æœç„¶åä¹Ÿæ˜¯é€šè¿‡ç½‘ç»œå°†å…¶å‘é€ç»™é€»è¾‘è¿›ç¨‹ã€‚é€»è¾‘è¿›ç¨‹æ”¶åˆ°ç»“æœåè°ƒç”¨åˆ°&lt;code&gt;lua&lt;/code&gt;çš„å›è°ƒå‡½æ•°é‡Œã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ªç®€åŒ–æ–¹æ¡ˆï¼Œå¦‚æœæ—¶ä»…ä»…é’ˆå¯¹&lt;code&gt;lua&lt;/code&gt;çš„è¯ï¼Œåªéœ€è¦åœ¨å‘&lt;code&gt;dbmgr&lt;/code&gt;è¿›ç¨‹å‘é€è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Š&lt;code&gt;lua function&lt;/code&gt;çš„æ³¨å†ŒIDå°±å¥½äº†ï¼ŒæŸ¥è¯¢åˆ°ç»“æœåè¿”å›è¿‡æ¥å°±èƒ½ç›´æ¥è°ƒç”¨ã€‚ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæ¥å£ä¸ä»…ä»…åœ¨
&lt;code&gt;lua&lt;/code&gt;ä¸­ä½¿ç”¨ï¼Œå¸Œæœ›åœ¨&lt;code&gt;C++&lt;/code&gt;ä¸­ä¹Ÿèƒ½è°ƒç”¨ï¼Œå¹¶ä¸”å¸Œæœ›æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¨¡å—æ¥è´Ÿè´£è¿™ç±»äº‹æƒ…ï¼Œè¯¥å¦‚ä½•è®¾è®¡ï¼Ÿä¸€ä¸ªç®€åŒ–åçš„é—®é¢˜å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;functional&amp;gt;
#include &amp;lt;map&amp;gt;

std::map&amp;lt;int, std::function&amp;lt;void(void*)&amp;gt;&amp;gt; callbacks;
int last_idx = 0;

//ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œéœ€è¦æ”¯æŒå„ç§function
template&amp;lt;typename T&amp;gt;
int addCallback(T &amp;amp;&amp;amp; t) {
}

//ç”¨äºè°ƒç”¨å›è°ƒå‡½æ•°
template&amp;lt;typename ... ARGS&amp;gt;
void call(int idx, ARGS &amp;amp;&amp;amp; ... args) {
}

void func(int i) {}

class Functor {
public:
	void operator()(const std::string &amp;amp;s, int i) {}
};

int main() {
	int c1 = addCallback(&amp;amp;func);
	int i;
	int c2 = addCallback([i](double j) {});
	int c3 = addCallback(Functor());

	call(c1, 1);
	call(c2, 1.0);
	call(c3, std::string(&amp;quot;string&amp;quot;), 1);

	return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;addCallback&lt;/code&gt;çš„ä½œç”¨ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;ã€&lt;code&gt;functor&lt;/code&gt;ã€æ™®é€šçš„å‡½æ•°ã€æˆå‘˜å‡½æ•°ç­‰ç­‰ã€‚è¿™é‡Œä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œæˆ‘ä»¬åª
å¤„ç†&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;å’Œæ™®é€šå‡½æ•°ï¼Œå…¶ä½™çš„ä¸å†èµ˜è¿°ã€‚ä¸‹é¢æ˜¯ä¸€äº›é—®é¢˜ï¼š&lt;/p&gt;

&lt;h1 id=&#34;å‚æ•°çš„å¤„ç†&#34;&gt;å‚æ•°çš„å¤„ç†ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯&lt;code&gt;map&lt;/code&gt;ï¼Œ&lt;code&gt;value_type&lt;/code&gt;æ˜¯ä¸€å®šçš„ï¼Œä½ æ— æ³•å°†å¤šä¸ªä¸åŒç±»å‹çš„&lt;code&gt;std::function&lt;/code&gt;æ”¾è¿›å»ï¼Œæ‰€ä»¥éœ€è¦éœ€è¦åŒ…ä¸€å±‚ï¼Œè¿™é‡Œå­˜å‚¨çš„æ˜¯&lt;code&gt;std::function&amp;lt;void(void*)&amp;gt;&lt;/code&gt;ï¼Œ
ç”±äºæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œè¿”å›å€¼æˆ‘ä»¬ä¸å…³å¿ƒã€‚å‚æ•°ä½¿ç”¨çš„æ˜¯&lt;code&gt;void*&lt;/code&gt;ï¼Œå°†ç±»å‹ç»™æŠ¹é™¤æ‰äº†ã€‚é‚£ä¹ˆå‚æ•°çš„å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨&lt;code&gt;std::tuple&lt;/code&gt;æ¥å­˜å‚¨ï¼Œé‚£&lt;code&gt;call&lt;/code&gt;çš„å®ç°å°±å¾ˆç®€å•äº†:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename ... ARGS&amp;gt;
void call(int idx, ARGS &amp;amp;&amp;amp; ... args) {
	auto it = callbacks.find(idx);
	if (it != callbacks.end() {
		auto tuple = std::tuple&amp;lt;ARGS...&amp;gt;(args...);
		it-&amp;gt;second(&amp;amp;tuple);
	}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;callbacks-å­˜å‚¨çš„å†…å®¹æ˜¯&#34;&gt;&lt;code&gt;callbacks&lt;/code&gt;å­˜å‚¨çš„å†…å®¹æ˜¯ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œ&lt;code&gt;map&lt;/code&gt;çš„&lt;code&gt;value_type&lt;/code&gt;æ˜¯&lt;code&gt;std::function&amp;lt;void(*)&amp;gt;&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°†å¤–éƒ¨ä¼ å…¥çš„å›è°ƒè®¾ç½®è¿›å»ï¼Œéœ€è¦å†åŒ…ä¸€å±‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
int addCallback(T &amp;amp;&amp;amp; t) {
    last_idx++;
    callbacks[last_idx] = [t](void *data){
        auto ptr = static_cast&amp;lt;std::tuple&amp;lt;...&amp;gt; *&amp;gt;(data); // æ¨¡æ¿å‚æ•°æ€ä¹ˆå¤„ç†ï¼Ÿ
        std::apply(t, *ptr);
    };
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†&lt;code&gt;C++17&lt;/code&gt;ä¸­çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/utility/apply&#34;&gt;std::apply&lt;/a&gt;ï¼Œå…¶ä½œç”¨å°±æ˜¯è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°æ˜¯ä¸€ä¸ª&lt;code&gt;tuple&lt;/code&gt;ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ä»æºç ä¸­çœ‹çœ‹&lt;code&gt;apply&lt;/code&gt;çš„å®ç°ï¼Œ
è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚
é—®é¢˜æ˜¯ï¼Œ&lt;code&gt;tuple&lt;/code&gt;çš„å‚æ•°å¦‚ä½•å¤„ç†ï¼Ÿæˆ‘ä»¬æ²¡æ³•ä»&lt;code&gt;data&lt;/code&gt;ä¸­å¾—åˆ°ç±»å‹å¿ƒç³»ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯ä»&lt;code&gt;T&lt;/code&gt;ä¸­è·å–ï¼Œé‚£å¦‚ä½•è·å–å‘¢ï¼Ÿ&lt;/p&gt;

&lt;h1 id=&#34;callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–&#34;&gt;callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–&lt;/h1&gt;

&lt;p&gt;ç°åœ¨çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œå¦‚ä½•ä»&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;ã€æ™®é€šå‡½æ•°ç­‰ç±»å‹ä¸­æå–å‚æ•°ä¿¡æ¯ã€‚å¯¹äºæ™®é€šå‡½æ•°å’Œ&lt;code&gt;std::function&lt;/code&gt;æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‰¹åŒ–æ¥åš&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
struct CallbackTypeHelper;

template&amp;lt;typename RET, typename ... ARGS&amp;gt;
struct CallbackTypeHelper&amp;lt;RET(*)(ARGS...)&amp;gt; {
    typedef std::tuple&amp;lt;ARGS...&amp;gt; typle_type;
}

template&amp;lt;typename RET, typename ... ARGS&amp;gt;
struct CallbackTypeHelper&amp;lt;std::function&amp;lt;RET(ARGS...)&amp;gt;&amp;gt; {
    typedef std::tuple&amp;lt;ARGS...&amp;gt; typle_type;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¹äº&lt;code&gt;lambda&lt;/code&gt;è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;lambda&lt;/code&gt;ä½œä¸º&lt;code&gt;C++11&lt;/code&gt;ä¸­æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå…¶ä½œç”¨æ˜¯å®ç°ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç”±äºæ•è·ç»„çš„å­˜åœ¨ï¼Œå…¶ä¸èƒ½ä»…ä»…å®ç°æˆä¸€ä¸ª&lt;code&gt;C Function&lt;/code&gt;ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼Œå„ä¸ªæ•è·å‚æ•°å³ä¸ºæˆå‘˜
å˜é‡ï¼Œä¸ºäº†å®ç°å¯è¢«è°ƒç”¨ï¼Œå…¶é‡è½½äº†&lt;code&gt;operator()&lt;/code&gt;ã€‚æ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è·å–å‚æ•°çš„æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
struct CallbackFunctorHelper;

template&amp;lt;typename RET, typename C, typename ... ARGS&amp;gt;
struct CallbackFunctorHelper&amp;lt;RET(C::*)(ARGS...) const&amp;gt; {
  typedef std::tuple&amp;lt;ARGS...&amp;gt; tuple_type;
};

template&amp;lt;typename RET, typename C, typename ... ARGS&amp;gt;
struct CallbackFunctorHelper&amp;lt;RET(C::*)(ARGS...)&amp;gt; {
  typedef std::tuple&amp;lt;ARGS...&amp;gt; tuple_type;
};

template &amp;lt;typename T, typename Enabled=void&amp;gt;
struct CallbackTypeHelper {
  typedef typename CallbackFunctorHelper&amp;lt;decltype(&amp;amp;std::decay&amp;lt;T&amp;gt;::type::operator())&amp;gt;::tuple_type tuple_type;
};

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ³¨æ„ç”±äºå‚æ•°æœ‰å¯èƒ½æ˜¯å¼•ç”¨ï¼Œæ‰€æœ‰è¿™é‡Œéœ€è¦&lt;a href=&#34;http://en.cppreference.com/w/cpp/types/decay&#34;&gt;decay&lt;/a&gt;æ¥å¤„ç†è¿™äº›å¼•ç”¨ã€‚åŒæ—¶ç”±äº&lt;code&gt;lambda&lt;/code&gt;çš„&lt;code&gt;mutable&lt;/code&gt;å±æ€§çš„å­˜åœ¨ï¼Œæ‰€ä»¥&lt;code&gt;CallbackFunctorHelper&lt;/code&gt;
éœ€è¦&lt;code&gt;const&lt;/code&gt;å’Œ&lt;code&gt;non-const&lt;/code&gt;çš„ç‰¹åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;æœ€åï¼Œç”±äºè¿™åªæ˜¯æ¼”ç¤ºæ€§è´¨çš„ä»£ç ï¼Œæœ‰äº›é€»è¾‘å¦‚æˆå‘˜å‡½æ•°ç­‰å¹¶æ²¡æœ‰è€ƒè™‘è¿›å»ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;enable_if&lt;/code&gt;åšä¸ªå•ç‹¬çš„ç‰¹åŒ–ï¼Œè€Œä¸éœ€è¦åœ¨é»˜è®¤å‡½æ•°ä¸Šå†™&lt;code&gt;functor&lt;/code&gt;çš„å®ç°ç­‰ã€‚åœ¨å®é™…
åº”ç”¨ä¸­å¯ä»¥ä¿®æ”¹å¾—æ›´åŠ å…¨é¢å’Œä¼˜é›…ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>luaä¸Cäº¤äº’ä¸­çš„æ­»å¾ªç¯æ£€æµ‹</title>
      <link>http://sysfork.com/post/2017/lua-c-detect-inifinite-loop/</link>
      <pubDate>Fri, 21 Apr 2017 17:37:30 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/lua-c-detect-inifinite-loop/</guid>
      <description>

&lt;p&gt;ç°åœ¨å¾ˆå¤šæ¸¸æˆå¼•æ“éƒ½æ˜¯&lt;code&gt;C++&lt;/code&gt; + &lt;code&gt;lua&lt;/code&gt;çš„ç»“æ„ï¼Œä¸€æ—¦æŸä¸ªæœåŠ¡å™¨å¼€å‘äººå‘˜å¤§æ„å†™å‡ºæ­»å¾ªç¯ä»£ç ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æœåŠ¡æ— å“åº”ï¼Œå½±å“æœåŠ¡å™¨ç¨³å®šã€‚æ‰€ä»¥å¼•æ“ä¸­æœ€å¥½èƒ½æä¾›ä¸€ä¸ªæ­»å¾ªç¯çš„æ£€æµ‹æœºåˆ¶ï¼Œä¸€æ—¦å‡ºç°æ­»å¾ªç¯åˆ™æ‰§è¡Œä¸€äº›è¡Œä¸ºæ‰“æ–­å½“å‰æµç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;æ­»å¾ªç¯çš„æ£€æµ‹æ˜¯ä¸€ä¸ª&lt;a href=&#34;https://en.wikipedia.org/wiki/Halting_problem&#34;&gt;åœæœºé—®é¢˜&lt;/a&gt;ã€‚æˆ‘ä»¬æ— æ³•åˆ¤æ–­åˆ°åº•æ˜¯ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¿˜æ˜¯è¿›å…¥äº†çœŸæ­£çš„æ­»å¾ªç¯ï¼Œå¥½åœ¨è¿™å¯¹æˆ‘ä»¬çš„æœåŠ¡æ¥è¯´åŒºåˆ«å¹¶ä¸é‡è¦ã€‚æ‰€ä»¥ä¸€ä¸ªç®€å•çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼Œæ‰§è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡äº†é¢„å®šçš„é˜ˆå€¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;C++&lt;/code&gt;ä¸­é›†æˆ&lt;code&gt;lua&lt;/code&gt;ï¼Œè°ƒç”¨åˆ°æ¸¸æˆé€»è¾‘æ—¶ï¼Œä¸€èˆ¬é€šè¿‡&lt;a href=&#34;http://pgl.yoyo.org/luai/i/lua_pcall&#34;&gt;pcall&lt;/a&gt;ï¼Œä½†æ˜¯ä¸€æ—¦è°ƒç”¨äº†&lt;code&gt;pcall&lt;/code&gt;ï¼Œä»£ç çš„æ‰§è¡Œè·¯å¾„ä¾¿è¿›å…¥äº†&lt;code&gt;lua&lt;/code&gt;çš„ä¸–ç•Œï¼Œé™¤éé€šè¿‡ä¿¡å·æœºåˆ¶æ‰èƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­ä¸­æ–­ï¼Œå®ç°æ‰§è¡Œå…¶ä»–åˆ†æ”¯çš„ç›®çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ&lt;code&gt;lua&lt;/code&gt;è¿˜æä¾›äº†&lt;code&gt;debug.sethook&lt;/code&gt;å‡½æ•°ï¼Œå¯ä»¥åœ¨æ‰§è¡Œæ­£å¸¸é€»è¾‘ä¸­è§¦å‘&lt;code&gt;hook&lt;/code&gt;ï¼Œå®ç°ç›‘æµ‹è¶…æ—¶çš„åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š&lt;/p&gt;

&lt;h1 id=&#34;ä½¿ç”¨-debug-sethook-æ¥å®ç°&#34;&gt;ä½¿ç”¨&lt;code&gt;debug.sethook()&lt;/code&gt;æ¥å®ç°&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;debug.sethook ([thread,] hook, mask [, count])
Sets the given function as a hook. The string mask and the number count describe when the hook will be called. The string mask may have the following characters, with the given meaning:&lt;/p&gt;

&lt;p&gt;&amp;ldquo;c&amp;rdquo;: the hook is called every time Lua calls a function;
&amp;ldquo;r&amp;rdquo;: the hook is called every time Lua returns from a function;
&amp;ldquo;l&amp;rdquo;: the hook is called every time Lua enters a new line of code.
With a count different from zero, the hook is called after every count instructions.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨æ‰§è¡Œ&lt;code&gt;pcall&lt;/code&gt;ä¹‹å‰è®¾å®šç±»ä¼¼å¦‚ä¸‹çš„ä»£ç :&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;debug.sethook(function()error(&amp;quot;timeout&amp;quot;)end, &amp;quot;c&amp;quot;, 10000)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç†è®ºä¸Šåªè¦ä»£ç æŒ‡ä»¤æ•°è¶…è¿‡10000æ¡å°±èƒ½è§¦å‘&lt;code&gt;error&lt;/code&gt;ã€‚å¥½åƒæŒºå®Œç¾çš„ã€‚&lt;/p&gt;

&lt;p&gt;Butï¼Œåœ¨&lt;code&gt;luajit&lt;/code&gt;ä¸‹è¿™æ¡ä¸ä¸€å®šæˆç«‹ï¼Œå› ä¸ºæ‰§è¡Œçš„é€»è¾‘è¢«&lt;code&gt;jit&lt;/code&gt;ç¼–è¯‘äº†ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ&lt;code&gt;hook&lt;/code&gt;æ˜¯ä¸ä¼šè§¦å‘çš„&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If your program is running in a tight loop and never falls back to the interpreter, the debug hook never runs and can&amp;rsquo;t throw the &amp;ldquo;interrupted!&amp;rdquo; error.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªæœªå…¬å¼€çš„ç¼–è¯‘é€‰é¡¹&lt;code&gt;LUAJIT_ENABLE_CHECKHOOK&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;lj_record.c&lt;/code&gt;æ–‡ä»¶çš„æœ€åé¢ï¼Œä¸Šé¢å†™é“&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Regularly check for instruction/line hooks from compiled code and
exit to the interpreter if the hooks are set.&lt;/p&gt;

&lt;p&gt;This is a compile-time option and disabled by default, since the
hook checks may be quite expensive in tight loops.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;çœ‹ä¼¼å¯ä»¥ï¼Œä½†æ˜¯æ³¨æ„ï¼Œå¦‚æœ&lt;code&gt;hook&lt;/code&gt;è¢«è®¾ç½®äº†ï¼Œåˆ™æ‰§è¡Œçš„ä»£ä»·æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ã€‚å¯¹äºæ¸¸æˆè€Œè¨€ï¼Œå¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½åœ¨&lt;code&gt;lua&lt;/code&gt;å±‚ï¼Œè€Œä¸ºäº†ç›‘æµ‹æ­»å¾ªç¯ï¼Œå‡ ä¹
è¦åœ¨æ‰€æœ‰çš„luaæ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®&lt;code&gt;hook&lt;/code&gt;ï¼Œè¿™æ˜¯ä¸å¤ªå®¹æ˜“æ¥å—çš„ã€‚å¥½åœ¨ä¸‹é¢çš„æ³¨é‡Šæåˆ°äº†&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;You can set the instruction hook via lua_sethook() with a count of 1
from a signal handler or another native thread. Please have a look
at the first few functions in luajit.c for an example (Ctrl-C handler).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å—¯ï¼Œçœ‹æ ·å­åªèƒ½ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆäº†ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ä½¿ç”¨ä¿¡å·æ¥å®ç°&#34;&gt;ä½¿ç”¨ä¿¡å·æ¥å®ç°&lt;/h1&gt;

&lt;p&gt;åœ¨luaçš„å‘½ä»¤è¡Œç¨‹åºä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;code&gt;Ctrl-C&lt;/code&gt;ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ç¨‹åº&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;  for i=1,10000000 do sum = sum + i end
^Cinterrupted!
stack traceback:
        stdin:1: in main chunk
        [C]: in ?

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»”ç»†çœ‹&lt;code&gt;lua.c&lt;/code&gt;æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-C&#34;&gt;static void lstop (lua_State *L, lua_Debug *ar) {
  (void)ar;  /* unused arg. */
  lua_sethook(L, NULL, 0, 0);
  luaL_error(L, &amp;quot;interrupted!&amp;quot;);
}


static void laction (int i) {
  signal(i, SIG_DFL); /* if another SIGINT happens before lstop,
                              terminate process (default action) */
  lua_sethook(globalL, lstop, LUA_MASKCALL | LUA_MASKRET | LUA_MASKCOUNT, 1);
}

// ....
//in docall
signal(SIGINT, laction);
status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
signal(SIGINT, SIG_DFL);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å—¯ï¼Œåœ¨æ‰§è¡Œ&lt;code&gt;pcall&lt;/code&gt;ä¹‹å‰è®¾ç½®äº†ä¿¡å·å¤„ç†å‡½æ•°ï¼Œæ•æ‰&lt;code&gt;Ctrl-C&lt;/code&gt;çš„ä¿¡å·ï¼Œä¸€æ—¦å‘ç”Ÿï¼Œåˆ™ç«‹é©¬è°ƒç”¨&lt;code&gt;lua_sethook&lt;/code&gt;å‡½æ•°ï¼ŒæŒ‡å®šåœ¨æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç æ—¶è°ƒç”¨&lt;code&gt;lstop&lt;/code&gt;ï¼Œè€Œåœ¨&lt;code&gt;lstop&lt;/code&gt;ä¸­å°±ç›´æ¥æŠ›å‡º&lt;code&gt;error&lt;/code&gt;äº†ã€‚æ‰€ä»¥é—®é¢˜æ˜¯ &lt;strong&gt;&lt;code&gt;lua_sethook&lt;/code&gt;æ˜¯å¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨çš„&lt;/strong&gt;ï¼Ÿ&lt;/p&gt;

&lt;p&gt;ç­”æ¡ˆï¼šæ˜¯&lt;/p&gt;

&lt;p&gt;ä»æºç ä¸­å¯ä»¥çœ‹åˆ°&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/* This function can be called asynchronously (e.g. during a signal). */
LUA_API int lua_sethook(lua_State *L, lua_Hook func, int mask, int count)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œä»&lt;code&gt;luajit&lt;/code&gt;çš„æºç æ³¨é‡Šæ¥çœ‹ï¼Œä¸ä»…ä»…åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­ï¼Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­ä¹Ÿèƒ½è¢«è°ƒç”¨
&amp;gt; from a signal handler or another native thread.&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ï¼Œè¿™ç§æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚å› æ­¤ï¼Œå¯¹äºå•çº¿ç¨‹ç¨‹åºè€Œè¨€ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®&lt;code&gt;alarm&lt;/code&gt;æ¥å®ç°è¶…æ—¶è®¾ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;alarm(10);// trigger after 10s
signal(SIGALRM, laction);
status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
alarm(0)
signal(SIGALRM, SIG_DFL);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è€Œå¯¹äºå¤šçº¿ç¨‹ç¨‹åºï¼Œå¯ä»¥ç›´æ¥å¯ä¸€ä¸ªå®šæ—¶å™¨æ¥æ¥&lt;code&gt;check&lt;/code&gt;ï¼Œè€Œä¸ç”¨ä½¿ç”¨å¾ˆæ¶å¿ƒçš„ä¿¡å·ã€‚&lt;/p&gt;

&lt;p&gt;å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼è§¦å‘è¶…æ—¶&lt;code&gt;error&lt;/code&gt;å¯ä»¥å¾ˆè½»æ˜“åœ°åœ¨&lt;code&gt;pcall&lt;/code&gt;ä¸­æ•è·ï¼Œä»è€Œè€Œå·²å®ç°å †æ ˆçš„æ‰“å°ç­‰åŠŸèƒ½ï¼Œæ–¹ä¾¿æŸ¥æ‰¾å’Œå®šä½é—®é¢˜ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>æµ…è°ˆC&#43;&#43;ä¸­çš„åœ°å€å¯¹é½</title>
      <link>http://sysfork.com/post/2016/about-cpp-alignment/</link>
      <pubDate>Sun, 25 Sep 2016 09:13:27 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2016/about-cpp-alignment/</guid>
      <description>

&lt;h1 id=&#34;åŠ¨æœº&#34;&gt;åŠ¨æœº&lt;/h1&gt;

&lt;p&gt;æœ€è¿‘åœ¨æ•´ç†C++11ä¸­çš„æ–°å¢ç‰¹æ€§ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª&lt;a href=&#34;http://en.cppreference.com/w/cpp/language/alignas&#34;&gt;alignas&lt;/a&gt;å…³é”®å­—ã€‚åœ¨å­¦ä¹ è¿™ä¸ªçš„æ—¶å€™é¡ºä¾¿ç ”ç©¶äº†
ä¸‹C/C++ä¸­çš„å­—èŠ‚å¯¹é½é—®é¢˜ï¼Œå‘ç°æœ‰å¾ˆå¤šå¯ä»¥æ¢ç´¢çš„åœ°æ–¹ã€‚&lt;/p&gt;

&lt;h1 id=&#34;ä»€ä¹ˆæ˜¯åœ°å€å¯¹é½&#34;&gt;ä»€ä¹ˆæ˜¯åœ°å€å¯¹é½&lt;/h1&gt;

&lt;p&gt;å‚è€ƒç»´åŸºç™¾ç§‘çš„è§£é‡Šï¼š&lt;a href=&#34;https://en.wikipedia.org/wiki/Data_structure_alignment&#34;&gt;Data_structure_alignment&lt;/a&gt;ã€‚æ‰€è°“åœ°å€å¯¹é½ï¼Œå³æŸä¸ªåœ°å€Aæ»¡è¶³æ˜¯nçš„å€æ•°ï¼Œå…¶ä¸­næ˜¯2çš„å¹‚æ¬¡æ–¹(å¦‚1ã€2ã€4ã€8ç­‰ç­‰)ã€‚å¦‚æœç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„è¯ï¼Œé‚£ä¹ˆ
Açš„æœ«å°¾è‡³å°‘æœ‰&lt;code&gt;log&lt;sub&gt;2&lt;/sub&gt;n&lt;/code&gt;ä¸ª0(åºŸè¯)ã€‚å½“æˆ‘ä»¬è¯´åˆ°æŸä¸ªå˜é‡æ˜¯nå­—èŠ‚å¯¹é½çš„æ—¶å€™ï¼Œå…¶æ„æ€æ˜¯æŒ‡è¿™ä¸ªå˜é‡çš„åœ°å€æ˜¯å¯¹é½çš„ã€‚&lt;/p&gt;

&lt;h1 id=&#34;åœ°å€å¯¹é½çš„æ„ä¹‰&#34;&gt;åœ°å€å¯¹é½çš„æ„ä¹‰&lt;/h1&gt;

&lt;p&gt;ä»æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºæ¥çœ‹ï¼ŒCPUå¥½åƒå¯ä»¥è®¿é—®å†…å­˜ä¸­çš„ä»»æ„ä½ç½®ï¼›ä½†æ˜¯å®é™…ä¸ŠCPUå¾€å¾€æ˜¯æŒ‰ç…§å—ä¸ºåŸºæœ¬å•ä½è®¿é—®å†…å­˜çš„ã€‚å¦‚æœæŸä¸ªå˜é‡çš„èµ·å§‹åœ°å€ä½äºæŸä¸ªå—çš„çš„èµ·å§‹å¤„ï¼Œåˆ™åªéœ€è¾ƒå°‘çš„æ¬¡æ•°ä¾¿èƒ½å®Œæˆè¯»å–ã€‚
æ¯”å¦‚åœ¨æŸä¸ªCPUä¸­ï¼Œå…¶æ¯æ¬¡å–å†…å­˜çš„å¤§å°ä¸º8å­—èŠ‚ï¼Œå¯¹äºä¸€ä¸ª8å­—èŠ‚çš„longç±»å‹å˜é‡ï¼Œå¦‚æœè¯¥å˜é‡çš„åœ°å€æ˜¯8çš„å€æ•°ï¼Œé‚£ä¹ˆæ¯æ¬¡loadè¿™ä¸ªlongå˜é‡åªéœ€è¦ä¸€æ¬¡æ“ä½œã€‚å¦‚æœä¸æ˜¯8çš„å€æ•°åˆ™éœ€è¦ä¸¤æ¬¡ï¼Œå½±å“äº†æ•ˆç‡ã€‚
æ›´å¤šçš„æ•°æ®æµ‹è¯„å‚è€ƒ&lt;a href=&#34;http://www.ibm.com/developerworks/library/pa-dalign/&#34;&gt;è¿™é‡Œ&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;è‡ªç„¶å¯¹é½&#34;&gt;è‡ªç„¶å¯¹é½&lt;/h1&gt;

&lt;p&gt;ä¸ºäº†ä¿è¯è¿è¡Œæ•ˆç‡ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºçš„æ—¶å€™ä¼šå¯¹æˆ‘ä»¬ä½¿ç”¨çš„å˜é‡è‡ªåŠ¨å¯¹é½ã€‚è¿™ä¸ªå€¼å¾€å¾€å°±æ˜¯å˜é‡ç±»å‹çš„sizeæˆ–æ˜¯èƒ½è¢«sizeæ•´é™¤ã€‚å¦‚charçš„è‡ªç„¶å¯¹é½åœ°å€ä¸º1ï¼Œè€Œintåˆ™æ˜¯4æˆ–8ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯æœ‰ä¸Šé™çš„ã€‚åœ¨&lt;code&gt;C++11&lt;/code&gt;ä¸­ï¼Œ
ä¸Šé™ä¸º&lt;code&gt;std::max_align_t&lt;/code&gt;çš„å¯¹é½å€¼ï¼Œåœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œè¿™ä¸ªç±»å‹éƒ½è¢«å®šä¹‰ä¸º&lt;code&gt;long double&lt;/code&gt;ï¼Œå› ä¸ºè¿™å¾€å¾€ä¹Ÿæ˜¯æœ€å¤§çš„æ ‡é‡ã€‚å½“æˆ‘ä»¬å®šä¹‰æ•°ç»„æ—¶ï¼Œå¦‚ &lt;code&gt;TYPE f[10]&lt;/code&gt;ï¼Œå…¶ä¸­ç¬¬Nä¸ªå…ƒç´ çš„åœ°å€ä¸º&lt;code&gt;f + sizeof(TYPE) * N&lt;/code&gt;ã€‚
å¦‚æœ&lt;code&gt;TYPE&lt;/code&gt;çš„å¯¹é½å€¼èƒ½è¢«&lt;code&gt;sizeof(TYPE)&lt;/code&gt;æ•´é™¤çš„è¯ï¼Œåˆ™èƒ½ä¿è¯åªè¦æ•°ç»„å¼€å§‹åœ°å€æ—¶å¯¹é½çš„ï¼Œé‚£ä¹ˆæ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¯¹é½çš„ã€‚&lt;/p&gt;

&lt;h1 id=&#34;å˜é‡çš„å†…å­˜å¯¹é½æ§åˆ¶&#34;&gt;å˜é‡çš„å†…å­˜å¯¹é½æ§åˆ¶&lt;/h1&gt;

&lt;p&gt;GCCæœ‰ä¸€ä¸ªè‡ªå·±çš„æ‰©å±•æ¥æ§åˆ¶å˜é‡çš„å¯¹é½å†…å­˜ï¼Œ&lt;code&gt;__attribute__((aligned()))&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;int __attribute__((aligned(16))) i;                          //(1)
int j __attribute__((aligned(16)));                          //(2)
struct S { short f[3]; } __attribute__ ((aligned (8)));      //(3)
typedef int more_aligned_int __attribute__ ((aligned (8)));  //(4)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(1)å’Œ(2)å£°æ˜äº†ä¸¤ä¸ªå˜é‡ï¼ŒæŒ‡å®šè¿™ä¸¤ä¸ªå˜é‡çš„å¯¹é½å¤§å°ä¸º16ï¼›(3)å’Œ(4)åˆ™ä½œç”¨ä¸ç±»å‹ï¼Œä½¿å¾—Så’Œ&lt;code&gt;more_aligned_int&lt;/code&gt;ç±»å‹çš„å˜é‡å¯¹é½éƒ½æ˜¯8ã€‚
è¿™ä¸ªå¯¹é½çš„å¤§å°å¯ä»¥ä¸ºä»»æ„2çš„å¹‚æ¬¡æ•°ï¼Œä½†æ˜¯æœ‰æœ€å¤§ä¸Šé™ï¼Œåœ¨æˆ‘çš„x86_64çš„ubuntuä¸Šè¿™ä¸ªå€¼æ˜¯2&lt;sup&gt;28&lt;/sup&gt;ã€‚æŒ‰ç…§GCC&lt;a href=&#34;https://gcc.gnu.org/onlinedocs/gcc-3.3/gcc/Type-Attributes.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ä¸­çš„è§£é‡Šï¼Œ
è¿™ä¸ªattributeå¹¶ä¸èƒ½ä¿è¯å˜é‡çš„å¯¹é½ä¸€å®šæ˜¯æŒ‡å®šçš„å¤§å°ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ªæœ€å°å€¼ã€‚ä½†æ˜¯å®æµ‹çš„æ—¶å€™ï¼Œå¯¹äºæ ‡é‡ï¼Œå…¶æä¾›çš„å€¼å°±æ˜¯æœ€åå¯¹é½çš„å€¼ã€‚å¦‚intçš„è‡ªç„¶å¯¹é½ä¸º4ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨&lt;code&gt;__attribute__&lt;/code&gt;æŒ‡å®šæ—¶ï¼Œæ— è®ºæ—¶&lt;code&gt;1&lt;/code&gt;æˆ–&lt;code&gt;8&lt;/code&gt;
éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯å¯¹äºSï¼ŒæŒ‡å®šå…¶å¯¹é½å¤§å°ä¸º1å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œå…¶ä¾ç„¶æ˜¯2ï¼Œå…¶æŒ‘é€‰äº†ä¸€ä¸ªæŒ‡å®šå€¼ä¸è‡ªç„¶å¯¹é½ä¸­è¾ƒå¤§çš„é‚£ä¸ªã€‚&lt;/p&gt;

&lt;p&gt;C++å¼•å…¥äº†æ–°çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/language/alignas&#34;&gt;alignas&lt;/a&gt;å…³é”®å­—ï¼Œå…¶å¹¶ä¸æ˜¯ç›´æ¥æŒ‡å®šå˜é‡æˆ–ç±»å‹çš„å¯¹é½å€¼ï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ªæœ€ä¸¥æ ¼çš„éœ€æ±‚ã€‚ç”±äºå¯¹é½å€¼æ˜¯è¶Šå¤§è¶Šä¸¥æ ¼çš„ï¼ˆ8å­—èŠ‚å¯¹å…¶çš„ä¸€å®šæ˜¯4å­—èŠ‚å¯¹é½ï¼‰ï¼Œ
å› æ­¤å…¶å®šä¹‰çš„æ˜¯ä¸€ä¸ªä¸Šé™ã€‚åœ¨GCCä¸­ï¼Œæˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™æ²¡æœ‰å‘ç°ä¸&lt;code&gt;__attribute__((aligned()))&lt;/code&gt;çš„åŒºåˆ«ï¼ŒåŒæ ·å¯ä»¥è®¾ç½®intçš„å¯¹é½å€¼ä¸º1ï¼Œå’Œè¯´å¥½çš„ä¸ä¸€æ ·å•Šï¼ˆæ‘”ï¼‰ï¼ä½†æ˜¯åœ¨clangä¸­å°±ç¬¦åˆè¦æ±‚äº†ï¼Œä¼šæç¤º&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;alignment.cpp:15:3: error: requested alignment is less than minimum alignment of 4 for type &#39;int&#39;
  alignas(1) int b;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰€ä»¥å¤§å®¶åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±ä¸è¦éšä¾¿å°†ä¸€ä¸ªå˜é‡è®¾ç½®æˆå°äºè‡ªç„¶å¯¹é½çš„å€¼ï¼Œå¦åˆ™å®¹æ˜“å¯¼è‡´è·¨å¹³å°é—®é¢˜ã€‚&lt;/p&gt;

&lt;h1 id=&#34;struct&#34;&gt;struct&lt;/h1&gt;

&lt;p&gt;structä¸æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ•°æ®ç±»å‹ã€‚è¿™é‡Œæœ‰ESRçš„&lt;a href=&#34;http://www.catb.org/esr/structure-packing/&#34;&gt;ä¸€ç¯‡æ–‡ç« &lt;/a&gt;ï¼Œæœ¬æ–‡ç®€å•çš„æ€»ç»“ä¸€èµ·ä»–çš„æ„æ€ã€‚
structä¸­çš„å…ƒç´ å¹¶ä¸æ˜¯ç´§è‡´æ’åˆ—çš„ï¼Œä¸ºäº†ä¿è¯æ¯ä¸ªæˆå‘˜éƒ½æ˜¯å¯¹é½çš„ï¼Œç¼–è¯‘å™¨ä¼šåœ¨structä¸­çš„å…ƒç´ ä¹‹é—´æ’å…¥padï¼Œä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo1 {
    char *p;
    char c;
    long x;
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‡è®¾åœ¨64bitçš„æœºå™¨ä¸Šï¼Œé‚£ä¹ˆfoo1çš„å¯¹é½å€¼ä¸º8ï¼Œè¿™ä¸ªå€¼å…¶å®å°±æ˜¯æ‰€æœ‰æˆå‘˜å˜é‡ä¸­å¯¹é½å€¼æœ€å¤§çš„é‚£ä¸ªï¼ˆä¸€æ—¦æ»¡è¶³æœ€å¤§çš„é‚£ä¸ªéœ€æ±‚ï¼Œå…¶ä»–å°±éƒ½èƒ½æ»¡è¶³äº†ï¼‰ï¼Œå°±æ˜¯&lt;code&gt;char *p&lt;/code&gt;ã€‚ä¸ºäº†ä¿è¯æ‰€æœ‰æˆå‘˜éƒ½æ˜¯å¯¹é½çš„ï¼Œç¼–è¯‘å™¨ä¼š
è°ƒæ•´å†…å­˜å¸ƒå±€ï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo1 {
    char *p;     /* 8 bytes */
    char c;      /* 1 byte  */
    char pad[7]; /* 7 bytes */
    long x;      /* 8 bytes */
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äº&lt;code&gt;long&lt;/code&gt;æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œè€Œ&lt;code&gt;char&lt;/code&gt;æ˜¯1å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥æ’å…¥äº†7ä¸ªcharä»¥ä¿è¯éƒ½æ˜¯å¯¹é½çš„ã€‚
åœ¨ä¸Šé¢æˆ‘ä»¬è¯´åˆ°ï¼Œæ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¯¹é½çš„ï¼Œå¯¹äºstructä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo4 {
    short s;     /* 2 bytes */
    char c;      /* 1 byte */
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;foo4çš„å¯¹é½å€¼ä¸º2ï¼Œä½†æ˜¯å…¶sizeä¸º3ï¼Œè¿™æ ·æ”¾åˆ°æ•°ç»„ä¸­ä¸æ˜¯å¯¹é½çš„ã€‚æ‰€ä»¥ï¼Œä¸ºäº†è¾¾åˆ°éœ€æ±‚ï¼Œç¼–è¯‘å™¨ä¼šåœ¨structçš„æœ«å°¾æ’å…¥ç©ºç™½ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo4 {
    short s;     /* 2 bytes */
    char c;      /* 1 byte */
    char pad[1];
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å…¶sizeä¸º4ï¼Œå°±èƒ½æ»¡è¶³éœ€æ±‚äº†ã€‚ä»¥ä¸Šçš„è¦æ±‚å¯¹äºåµŒå¥—çš„structä¹Ÿæ˜¯éœ€è¦æ»¡è¶³çš„ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶è€Œæˆ‘ä»¬åœ¨ç¼–ç æ—¶å¾€å¾€éœ€è¦ç¼–è¯‘å™¨ä¿è¯structæˆå‘˜æ—¶ç´§å¯†ç›¸è¿çš„ï¼Œè¿™æ ·å¯ä»¥ç²¾ç¡®æ§åˆ¶å†…å­˜çš„layoutã€‚ç°ä»£ç¼–è¯‘å™¨ä¸€èˆ¬éƒ½æä¾›&lt;code&gt;#pragma pack&lt;/code&gt;è¯­å¥æ¥å®Œæˆè¿™ä¸€ç›®çš„ã€‚
ä¸€æ—¦å®šä¹‰äº†packï¼Œé‚£ä¹ˆåé¢æ‰€æœ‰çš„structéƒ½è¦æ»¡è¶³è¿™ä¸ªå…¶éœ€æ±‚ã€‚å…¶ä¿è¯æˆå‘˜å˜é‡çš„å¯¹é½å€¼å–è‡ªç„¶å¯¹é½å¤§å°å’Œpackä¸­çš„è¾ƒå°å€¼ã€‚æ‰€ä»¥å¯¹äºä»¥ä¸‹ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#pragma pack(1)
struct S1 {
    char a;
    long b;
};
#pragma pack()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœæ²¡æœ‰packï¼Œç¼–è¯‘å™¨ä¼šåœ¨å…¶ä¸­æ’å…¥7ä¸ªå­—èŠ‚çš„padï¼Œæœ€åçš„sizeä¸º16å­—èŠ‚ã€‚æœ‰äº†packä¹‹åï¼Œlong bçš„å¯¹é½å€¼æˆäº†1ï¼Œé‚£ä¹ˆå°±æ˜¯ç´§å‡‘æ’åˆ—äº†ï¼Œ sizeä¸º9å­—èŠ‚ã€‚å¦‚æœä»¬å°†1æ”¹æˆ2å‘¢ï¼Ÿ
æ­¤æ—¶long bçš„å¯¹é½å€¼ä¸º2ï¼Œé‚£ä¹ˆæ’å…¥ä¸€ä¸ªpadï¼Œsizeä¸º10å­—èŠ‚ã€‚å¦‚æœpackçš„å€¼ä¸º16å‘¢ï¼Ÿç”±äºå…¶è¶…è¿‡äº†longçš„alignå€¼8ï¼Œé‚£ä¹ˆä¿æŒlongçš„è‡ªç„¶å¯¹é½å°±å¥½äº†ï¼Œæœ€ç»ˆçš„å€¼sizeä¸º16ã€‚&lt;/p&gt;

&lt;p&gt;é¡ºä¾¿è¯´ä¸€å¥ï¼Œpackä»…ä»…å¯¹structå’Œclassæœ‰æ•ˆï¼Œä¸€æ—¦è®¾ç½®åï¼Œå¯¹äºåé¢æ‰€æœ‰çš„struct/classéƒ½ç”Ÿæ•ˆï¼Œé™¤éä½¿ç”¨ç©ºçš„&lt;code&gt;pack()&lt;/code&gt;å–æ¶ˆï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™å¾€å¾€åœ¨structçš„å®šä¹‰
å‰åéƒ½å†™ä¸Šé¢„å¤„ç†è¯­å¥ã€‚é™¤æ­¤è¿˜æœ‰&lt;code&gt;push&lt;/code&gt;å’Œ&lt;code&gt;pop&lt;/code&gt;ï¼Œå…¶ä½œç”¨ä¸&lt;code&gt;pack&lt;/code&gt;ç›¸åŒï¼Œåªæ˜¯ä¿å­˜äº†å†å²çºªå½•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#pragma pack(push, 1)
struct A {
  char c;
  double lf;
#pragma pack(push, 2)
  struct C {
    char e;
    double f;
    char s;
  } e;
#pragma pack(pop)
};
#pragma pack(pop)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶sizeä¸º&lt;code&gt;21 = 1(char) + 8(double) + 1(pad) + 1(char) + 1(pad) + 8(double) + 1(char) + 1(pad)&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;h1 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h1&gt;

&lt;p&gt;alignåœ¨å®é™…å¼€å‘ä¸­åº”ç”¨å¾—å¹¶ä¸å¤šï¼Œä½†æ˜¯å½“æˆ‘ä»¬äº†è§£å…¶åŸç†ï¼Œå°±èƒ½æ›´å¥½åœ°ä¼˜åŒ–structæˆ–ç±»çš„ç»“æ„ï¼Œå‡å°‘æ— è°“çš„padï¼Œä»è¾¾åˆ°å‡å°‘å†…å­˜å ç”¨çš„ç›®çš„ã€‚é™¤æ­¤åªç©ï¼Œå½“ç¼–å†™æŸäº›éœ€è¦ä¸¥æ ¼æ§åˆ¶å†…å­˜
layoutçš„æ—¶å€™ï¼Œpackèƒ½è®©æˆ‘ä»¬æ›´å¥½åœ°æ§åˆ¶äº§å‡ºçš„ä»£ç ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ç†è§£Linuxä¸‹åŠ¨æ€é“¾æ¥åº“å»¶è¿Ÿç»‘å®š</title>
      <link>http://sysfork.com/post/2016/linux-dynamic-lib-lazy-load/</link>
      <pubDate>Wed, 07 Sep 2016 22:08:20 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2016/linux-dynamic-lib-lazy-load/</guid>
      <description>&lt;script src=&#34;//cdn.bootcss.com/highlight.js/9.6.0/languages/x86asm.min.js&#34;&gt;&lt;/script&gt;

&lt;p&gt;åœ¨ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“æ—¶ï¼Œä¸ºäº†ä¿è¯èƒ½è¢«æ­£å¸¸ä½¿ç”¨ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šåŠ ä¸Š-fPICå‚æ•°ã€‚åœ¨ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°æ—¶ï¼ŒLinuxä½¿ç”¨äº†ä¸€ç§
å«å»¶è¿Ÿç»‘å®šçš„æŠ€æœ¯å®ç°è¿è¡Œæ—¶çš„symbol relocationã€‚å…¶ä¸­çš„å…³é”®å°±æ˜¯GOT(Global Offset Table)å’ŒPLT(Procedure linkage Table)ã€‚ä¸‹é¢å°±
è¿™ä¸€æŠ€æœ¯çš„å®ç°ç®€å•è§£é‡Šä¸€ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå†™ä¸€ä¸ªå¾ˆç®€å•çš„éœ€è¦åŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;//dl_test.c
#include &amp;lt;stdio.h&amp;gt;
int main(int argc, const char *argv[])
{
    puts(&amp;quot;1234&amp;quot;);
    puts(&amp;quot;1234&amp;quot;);
    return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åä½¿ç”¨&lt;code&gt;gcc&lt;/code&gt;ç¼–è¯‘å¹¶é“¾æ¥: &lt;code&gt;gcc -g dl_test.c -o dl_test.c&lt;/code&gt;ã€‚å…ˆåˆ«æ€¥ç€è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæˆ‘ä»¬ä½¿ç”¨&lt;code&gt;objdump&lt;/code&gt;åç¼–è¯‘ä¸€ä¸‹çœ‹çœ‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ objdump -S dl_test
......
0000000000400506 &amp;lt;main&amp;gt;:
#include &amp;lt;stdio.h&amp;gt;
int main(int argc, const char *argv[])
{
  400506:       55                      push   %rbp
  400507:       48 89 e5                mov    %rsp,%rbp
  40050a:       48 83 ec 10             sub    $0x10,%rsp
  40050e:       89 7d fc                mov    %edi,-0x4(%rbp)
  400511:       48 89 75 f0             mov    %rsi,-0x10(%rbp)
    puts(&amp;quot;1234&amp;quot;);
  400515:       bf b4 05 40 00          mov    $0x4005b4,%edi
  40051a:       e8 c1 fe ff ff          callq  4003e0 &amp;lt;puts@plt&amp;gt;
    puts(&amp;quot;1234&amp;quot;);
  40051f:       bf b4 05 40 00          mov    $0x4005b4,%edi
  400524:       e8 b7 fe ff ff          callq  4003e0 &amp;lt;puts@plt&amp;gt;
    return 0;
  400529:       b8 00 00 00 00          mov    $0x0,%eax
}
  40052e:       c9                      leaveq
  40052f:       c3                      retq
......
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œåœ¨&lt;code&gt;40051a&lt;/code&gt;å’Œ&lt;code&gt;400524&lt;/code&gt;ä¸¤å¤„éƒ½è°ƒç”¨äº†æˆ‘ä»¬çš„&lt;code&gt;puts&lt;/code&gt;å‡½æ•°ã€‚ä½†æ˜¯çœ‹åé¢çš„æ³¨è§£ï¼Œ&lt;code&gt;&amp;lt;puts@plt&amp;gt;&lt;/code&gt;è¡¨ç¤ºè¿™å¹¶ä¸æ˜¯&lt;code&gt;puts&lt;/code&gt;çš„åœ°å€ï¼Œè€Œæ˜¯å¦æœ‰ç›®çš„ã€‚
æˆ‘ä»¬ä½¿ç”¨&lt;code&gt;gdb&lt;/code&gt;æ¥è·Ÿè¸ªä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ï¼š&lt;code&gt;gdb dl_test&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) l
1	#include &amp;lt;stdio.h&amp;gt;
2	int main(int argc, const char *argv[])
3	{
4	    puts(&amp;quot;1234&amp;quot;);
5	    puts(&amp;quot;1234&amp;quot;);
6	    return 0;
7	}
(gdb) b 4
Breakpoint 1 at 0x400515: file dl_test.c, line 4.
(gdb) r
Starting program: /home/zqc/workspace/cpptest/dl_test

Breakpoint 1, main (argc=1, argv=0x7fffffffeb98) at dl_test.c:4
4	    puts(&amp;quot;1234&amp;quot;);
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œè®¾ç½®äº†ä¸€ä¸‹æ–­ç‚¹åˆ°ç¬¬ä¸€ä¸ª&lt;code&gt;puts&lt;/code&gt;çš„è°ƒç”¨å‡ºï¼Œä½¿ç”¨&lt;code&gt;layout asm&lt;/code&gt;åˆ‡æ¢æˆæ±‡ç¼–æ¨¡å¼:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;(gdb) layout asm
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
B+&amp;gt;â”‚0x400515 &amp;lt;main+15&amp;gt;              mov    $0x4005b4,%edi                                       â”‚
   â”‚0x40051a &amp;lt;main+20&amp;gt;              callq  0x4003e0 &amp;lt;puts@plt&amp;gt;                                  â”‚
   â”‚0x40051f &amp;lt;main+25&amp;gt;              mov    $0x4005b4,%edi                                       â”‚
   â”‚0x400524 &amp;lt;main+30&amp;gt;              callq  0x4003e0 &amp;lt;puts@plt&amp;gt;                                  â”‚
   â”‚0x400529 &amp;lt;main+35&amp;gt;              mov    $0x0,%eax                                            â”‚
   â”‚0x40052e &amp;lt;main+40&amp;gt;              leaveq                                                      â”‚
   â”‚0x40052f &amp;lt;main+41&amp;gt;              retq                                                        â”‚
   â”‚0x400530 &amp;lt;__libc_csu_init&amp;gt;      push   %r15                                                 â”‚
   â”‚0x400532 &amp;lt;__libc_csu_init+2&amp;gt;    mov    %edi,%r15d                                           â”‚
   â”‚0x400535 &amp;lt;__libc_csu_init+5&amp;gt;    push   %r14                                                 â”‚
   â”‚0x400537 &amp;lt;__libc_csu_init+7&amp;gt;    mov    %rsi,%r14                                            â”‚
   â”‚0x40053a &amp;lt;__libc_csu_init+10&amp;gt;   push   %r13                                                 â”‚
   â”‚0x40053c &amp;lt;__libc_csu_init+12&amp;gt;   mov    %rdx,%r13                                            â”‚
   â”‚0x40053f &amp;lt;__libc_csu_init+15&amp;gt;   push   %r12                                                 â”‚
   â”‚0x400541 &amp;lt;__libc_csu_init+17&amp;gt;   lea    0x2001a0(%rip),%r12        # 0x6006e8                â”‚
   â”‚0x400548 &amp;lt;__libc_csu_init+24&amp;gt;   push   %rbp                                                 â”‚
   â”‚0x400549 &amp;lt;__libc_csu_init+25&amp;gt;   lea    0x2001a0(%rip),%rbp        # 0x6006f0                â”‚
   â”‚0x400550 &amp;lt;__libc_csu_init+32&amp;gt;   push   %rbx                                                 â”‚
   â”‚0x400551 &amp;lt;__libc_csu_init+33&amp;gt;   sub    %r12,%rbp                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
child process 8855 In: main                                              Line: 4    PC: 0x400515
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;stepi&lt;/code&gt;æˆ–è€…ç®€å†™ä¸º&lt;code&gt;si&lt;/code&gt;æ‰§è¡Œä¸‹ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤ã€‚æˆ‘ä»¬ä¸€ç›´è·Ÿè¸ªåˆ°&lt;code&gt;call&lt;/code&gt;æŒ‡ä»¤ä¸­å»ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  &amp;gt;â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)   # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;              â”‚
   â”‚0x4003e6 &amp;lt;puts@plt+6&amp;gt;                   pushq  $0x0                                                     â”‚
   â”‚0x4003eb &amp;lt;puts@plt+11&amp;gt;                  jmpq   0x4003d0                                                 â”‚
   â”‚0x4003f0 &amp;lt;__libc_start_main@plt&amp;gt;        jmpq   *0x200502(%rip)   # 0x6008f8 &amp;lt;__libc_start_main@got.plt&amp;gt; â”‚
   â”‚0x4003f6 &amp;lt;__libc_start_main@plt+6&amp;gt;      pushq  $0x1                                                     â”‚
   â”‚0x4003fb &amp;lt;__libc_start_main@plt+11&amp;gt;     jmpq   0x4003d0                                                 â”‚
   â”‚0x400400 &amp;lt;__gmon_start__@plt&amp;gt;           jmpq   *0x2004fa(%rip)   # 0x600900 &amp;lt;__gmon_start__@got.plt&amp;gt;    â”‚
   â”‚0x400406 &amp;lt;__gmon_start__@plt+6&amp;gt;         pushq  $0x2                                                     â”‚
   â”‚0x40040b &amp;lt;__gmon_start__@plt+11&amp;gt;        jmpq   0x4003d0                                                 â”‚
   â”‚0x400410 &amp;lt;_start&amp;gt;                       xor    %ebp,%ebp                                                â”‚
   â”‚0x400412 &amp;lt;_start+2&amp;gt;                     mov    %rdx,%r9                                                 â”‚
   â”‚0x400415 &amp;lt;_start+5&amp;gt;                     pop    %rsi                                                     â”‚
   â”‚0x400416 &amp;lt;_start+6&amp;gt;                     mov    %rsp,%rdx                                                â”‚
   â”‚0x400419 &amp;lt;_start+9&amp;gt;                     and    $0xfffffffffffffff0,%rsp                                 â”‚
   â”‚0x40041d &amp;lt;_start+13&amp;gt;                    push   %rax                                                     â”‚
   â”‚0x40041e &amp;lt;_start+14&amp;gt;                    push   %rsp                                                     â”‚
   â”‚0x40041f &amp;lt;_start+15&amp;gt;                    mov    $0x4005a0,%r8                                            â”‚
   â”‚0x400426 &amp;lt;_start+22&amp;gt;                    mov    $0x400530,%rcx                                           â”‚
   â”‚0x40042d &amp;lt;_start+29&amp;gt;                    mov    $0x400506,%rdi                                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
child process 9211 In: puts@plt                                                      Line: ??   PC: 0x4003e0
0x00000000004003e0 in puts@plt ()
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;0x4003e0&lt;/code&gt;æ˜¯åˆšåˆšè·³è½¬çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯&lt;code&gt;&amp;lt;puts@plt&amp;gt;&lt;/code&gt;ï¼Œä»è¿™ä¸ªåå­—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªåœ°å€æ˜¯å±äº&lt;code&gt;plt&lt;/code&gt;çš„ã€‚å…ˆè¯´ä¸€ä¸‹&lt;code&gt;plt&lt;/code&gt;çš„ä½œç”¨ï¼Œ&lt;code&gt;plt&lt;/code&gt;çš„å…¨ç§°æ˜¯
è¿‡ç¨‹é“¾æ¥è¡¨ï¼Œæ„æ€å°±æ˜¯å½“è°ƒç”¨ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°æ—¶ï¼Œå…¶è®¿é—®çš„æ˜¯å…¶å®æ˜¯&lt;code&gt;plt&lt;/code&gt;ä¸­çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå®ŒæˆçœŸæ­£çš„è°ƒç”¨ã€‚æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å±äº&lt;code&gt;puts&lt;/code&gt;ä¸­
&lt;code&gt;plt&lt;/code&gt;çš„é¡¹ç›®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;  &amp;gt;â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;     â”‚
   â”‚0x4003e6 &amp;lt;puts@plt+6&amp;gt;                   pushq  $0x0                                                 â”‚
   â”‚0x4003eb &amp;lt;puts@plt+11&amp;gt;                  jmpq   0x4003d0                                             â”‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ &lt;code&gt;0x20050a(%rip)&lt;/code&gt; å³ &lt;code&gt;got&lt;/code&gt;ä¸­çš„åœ°å€ï¼Œåœ¨åˆå§‹æƒ…å†µä¸‹ï¼Œè¯¥é€‰é¡¹ä¸º&lt;code&gt;plt&lt;/code&gt;é¡¹ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥æ‰§è¡Œ&lt;code&gt;jmpq   *0x20050a(%rip)&lt;/code&gt; ç›´æ¥ä¼šè¿›å…¥åˆ°
ä¸‹ä¸€æ¡æŒ‡ä»¤&lt;code&gt;pushq&lt;/code&gt;ï¼Œ &lt;code&gt;pushq $0x0&lt;/code&gt;çš„ç›®çš„æ˜¯æŠŠå½“å‰åœ¨ç¬¦å·(&lt;code&gt;puts&lt;/code&gt;)åœ¨&lt;code&gt;.rela.plt&lt;/code&gt;ä¸­çš„indexã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code&gt;readelf&lt;/code&gt;æŒ‡ä»¤çœ‹ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ readelf -r dl_test

Relocation section &#39;.rela.dyn&#39; at offset 0x348 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000006008d0  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0

Relocation section &#39;.rela.plt&#39; at offset 0x360 contains 3 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000006008f0  000100000007 R_X86_64_JUMP_SLO 0000000000000000 puts + 0
0000006008f8  000200000007 R_X86_64_JUMP_SLO 0000000000000000 __libc_start_main + 0
000000600900  000300000007 R_X86_64_JUMP_SLO 0000000000000000 __gmon_start__ + 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code&gt;puts&lt;/code&gt;çš„indexä¸º0ï¼Œç¬¬ä¸€é¡¹ï¼Œæ‰€ä»¥è¿™é‡Œpushçš„æ˜¯&lt;code&gt;$0x0&lt;/code&gt;ã€‚åŒç†ï¼Œä¸‹é¢çš„&lt;code&gt;__libc_start_main&lt;/code&gt;å°±æ˜¯&lt;code&gt;$0x1&lt;/code&gt;ã€‚ ä¸‹ä¸€è¡Œè¯­å¥æ˜¯&lt;code&gt;jmpq   0x4003d0&lt;/code&gt;ï¼Œè¿™ä¸ªåœ°å€æ˜¯
å›ºå®šçš„ï¼Œæ‰€æœ‰çš„&lt;code&gt;plt&lt;/code&gt;å…¥å£æœ€åä¸€å¥è¯­å¥éƒ½æ˜¯è¿™ä¸ªï¼Œè¿™æ˜¯ä¸ªé€šç”¨çš„è¿‡ç¨‹ã€‚
ç»§ç»­&lt;code&gt;stepi&lt;/code&gt;åˆ°jumpçš„ä½ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;  &amp;gt;â”‚0x4003d0                                pushq  0x20050a(%rip)        # 0x6008e0                     â”‚
   â”‚0x4003d6                                jmpq   *0x20050c(%rip)        # 0x6008e8                    â”‚
   â”‚0x4003dc                                nopl   0x0(%rax)                                            â”‚
   â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;     â”‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‘ç°è¿™ä¸ªåœ°å€å°±æ˜¯åœ¨&lt;code&gt;puts@plt&lt;/code&gt;çš„ä¸Šé¢ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯å’Œæ™®é€š&lt;code&gt;plt&lt;/code&gt;å…¥å£é¡¹ç›®å¤§å°(&lt;code&gt;0x10&lt;/code&gt;)ï¼Œå…¶æœ«å°¾è¿˜ç”¨0è¡¥é½äº†(&lt;code&gt;nopl   0x0(%rax)&lt;/code&gt;)ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹å‰é¢ä¸¤å¥ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;pushq  0x20050a(%rip)        # 0x6008e0&lt;/code&gt;ï¼Œè¿™é‡Œpushäº†ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯å¹²å˜›çš„ï¼Ÿæˆ‘ä»¬ä½¿ç”¨&lt;code&gt;gdb&lt;/code&gt;çœ‹ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) x /16x 0x6008e0
0x6008e0:       0xf7ffe1a8      0x00007fff      0xf7df02b0      0x00007fff
0x6008f0 &amp;lt;puts@got.plt&amp;gt;:        0x004003e6      0x00000000      0xf7a52a50      0x00007fff
0x600900 &amp;lt;__gmon_start__@got.plt&amp;gt;:      0x00400406      0x00000000      0x00000000      0x00000000
0x600910:       0x00000000      0x00000000      0x00000000      0x00000000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¸ªåœ°å€å…¶å®å°±æ˜¯&lt;code&gt;got&lt;/code&gt;ä¸­çš„ä¸€é¡¹ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰æ™®é€šç¬¦å·&lt;code&gt;got&lt;/code&gt;çš„å‰é¢ã€‚é‚£ä¹ˆç›®å‰æ ˆä¸Šçš„å…ƒç´ æ˜¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;| 0x00007ffff7ffe1a8 |
| 0x0                |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥åˆ°æ˜¯&lt;code&gt;jmpq   *0x20050c(%rip)&lt;/code&gt; è¿™ä¸ªåœ°å€ä¹Ÿæ˜¯åœ¨pltä¸Šï¼Œç´§æŒ¨ç€ä¸Šé¢pushçš„åœ°å€ï¼Œå€¼ä¸º&lt;code&gt;0x00007ffff7df02b0&lt;/code&gt;ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­&lt;code&gt;stepi&lt;/code&gt;è¿›å»ï¼Œä¹Ÿå¯ä»¥
é€šè¿‡&lt;code&gt;disassemble 0x00007ffff7df02b0&lt;/code&gt;æŸ¥çœ‹ã€‚æˆ–è€…ï¼Œä½¿ç”¨&lt;code&gt;info symbol 0x00007ffff7df02b0&lt;/code&gt;ç›´æ¥æŸ¥çœ‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) info symbol 0x00007ffff7df02b0
_dl_runtime_resolve in section .text of /lib64/ld-linux-x86-64.so.2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯å±äº&lt;code&gt;ld-linux-x86-64.so.2&lt;/code&gt;é‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•ã€‚è¿™ä¸ªsoå±äº&lt;code&gt;glibc&lt;/code&gt;çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸‹è½½&lt;a href=&#34;ftp://ftp.gnu.org/gnu/glibc&#34;&gt;glibc&lt;/a&gt;æ¥æŸ¥çœ‹ã€‚æœ€ç»ˆæˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªç¬¦å·å®šä¹‰æ–‡ä»¶ï¼Œ
å…¶ä½ç½®åœ¨&lt;code&gt;sysdeps/x86_64/dl-trampoline.S&lt;/code&gt;ï¼Œå†…å®¹å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt; 28     .globl _dl_runtime_resolve
 29     .type _dl_runtime_resolve, @function
 30     .align 16
 31     cfi_startproc
 32 _dl_runtime_resolve:
 33     cfi_adjust_cfa_offset(16) # Incorporate PLT
 34     subq $56,%rsp
 35     cfi_adjust_cfa_offset(56)
 36     movq %rax,(%rsp)    # Preserve registers otherwise clobbered.
 37     movq %rcx, 8(%rsp)
 38     movq %rdx, 16(%rsp)
 39     movq %rsi, 24(%rsp)
 40     movq %rdi, 32(%rsp)
 41     movq %r8, 40(%rsp)
 42     movq %r9, 48(%rsp)
 43     movq 64(%rsp), %rsi # Copy args pushed by PLT in register.
 44     movq 56(%rsp), %rdi # %rdi: link_map, %rsi: reloc_index
 45     call _dl_fixup      # Call resolver.
 46     movq %rax, %r11     # Save return value
 47     movq 48(%rsp), %r9  # Get register content back.
 48     movq 40(%rsp), %r8
 49     movq 32(%rsp), %rdi
 50     movq 24(%rsp), %rsi
 51     movq 16(%rsp), %rdx
 52     movq 8(%rsp), %rcx
 53     movq (%rsp), %rax
 54     addq $72, %rsp      # Adjust stack(PLT did 2 pushes)
 55     cfi_adjust_cfa_offset(-72)
 56     jmp *%r11       # Jump to function address.
 57     cfi_endproc
 58     .size _dl_runtime_resolve, .-_dl_runtime_resolve
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»43è¡Œå¼€å§‹æ˜¯æˆ‘ä»¬çš„é€»è¾‘ã€‚43è¡Œå–å‡ºäº†æˆ‘ä»¬åˆšåˆšpushçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯&lt;code&gt;$0x0&lt;/code&gt;ï¼Œæ”¾åˆ°&lt;code&gt;%rsi&lt;/code&gt;ä¸­ï¼Œç„¶åæ˜¯æˆ‘ä»¬pushçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ&lt;code&gt;0x00007ffff7ffe1a8&lt;/code&gt;åˆ°&lt;code&gt;%rsi&lt;/code&gt;ä¸­ã€‚
ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸¤ä¸ªå¯„å­˜å™¨å‘¢ï¼Ÿæˆ‘ä»¬&lt;code&gt;man syscall&lt;/code&gt;ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;       arch/ABI   arg1   arg2   arg3   arg4   arg5   arg6   arg7
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       x86_64     rdi    rsi    rdx    r10    r8     r9     -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºlinuxä¸‹çš„å‡½æ•°ä¼ å‚æ–¹å¼ï¼Œ é‚£ä¹ˆ&lt;code&gt;%rdi&lt;/code&gt;å°±æ˜¯å‚æ•°1ï¼Œè€Œ&lt;code&gt;%rsi&lt;/code&gt;å°±æ˜¯å‚æ•°2äº†ã€‚æ¥ä¸‹æ¥æ˜¯&lt;code&gt;call _dl_fixup&lt;/code&gt;ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›å€¼å°±æ˜¯æŒ‡å‘&lt;code&gt;puts&lt;/code&gt;å­˜å‚¨åœ°å€ä½ç½®çš„æŒ‡é’ˆäº†ï¼Œåé¢å¯ä»¥çœ‹åˆ°
ä»£ç ä¸­å°†è¿™ä¸ªæŒ‡é’ˆä¿å­˜åˆ°äº†&lt;code&gt;%r11&lt;/code&gt;ï¼Œç„¶å&lt;code&gt;jmp *%r11&lt;/code&gt;ã€‚å®Œæˆäº†ä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹&lt;code&gt;_dl_fixup&lt;/code&gt;åšäº†äº›ä»€ä¹ˆã€‚åŒæ ·ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯&lt;code&gt;gblic&lt;/code&gt;ä¸­å®šä¹‰çš„ï¼Œä½ç½®åœ¨&lt;code&gt;elf/dl-runtime.c&lt;/code&gt;ä¸­ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;59 DL_FIXUP_VALUE_TYPE
60 __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE
61 _dl_fixup (
62 # ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS
63        ELF_MACHINE_RUNTIME_FIXUP_ARGS,
64 # endif
65        struct link_map *l, ElfW(Word) reloc_arg)
66 {
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»å‡½æ•°åŸå‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¹‹å‰&lt;code&gt;push&lt;/code&gt;çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯&lt;code&gt;link_map&lt;/code&gt;å’Œ&lt;code&gt;reloc_arg&lt;/code&gt;ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt; 67   const ElfW(Sym) *const symtab
 68     = (const void *) D_PTR (l, l_info[DT_SYMTAB]);
 69   const char *strtab = (const void *) D_PTR (l, l_info[DT_STRTAB]);
 70 
 71   const PLTREL *const reloc
 72     = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);
 73   const ElfW(Sym) *sym = &amp;amp;symtab[ELFW(R_SYM) (reloc-&amp;gt;r_info)];
 74   void *const rel_addr = (void *)(l-&amp;gt;l_addr + reloc-&amp;gt;r_offset);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œåšäº†ä¸€ä¸‹è½¬å‹ï¼Œé‚£ä¹ˆ&lt;code&gt;symtab&lt;/code&gt;å’Œ&lt;code&gt;strtab&lt;/code&gt;åˆ†åˆ«æ˜¯å¯¹äº&lt;code&gt;section&lt;/code&gt;çš„åœ°å€ï¼Œè€Œ&lt;code&gt;reloc_addr&lt;/code&gt;å°±æ˜¯æˆ‘ä»¬&lt;code&gt;got&lt;/code&gt;ä¸­çš„&lt;code&gt;puts@got.plt&lt;/code&gt;çš„åœ°å€ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç¬¦å·è§£æè¿‡ç¨‹äº†ï¼Œ
åé¢å¯èƒ½ä¼šæœ‰æ–‡ç« æ¥è§£é‡Šè¿™ä¸ªè¿‡ç¨‹ã€‚å½“æ‰¾åˆ°ç›®æ ‡åœ°å€å&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;//elf/dl-runtime.c
148   return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);
//sysdeps/x86_64/dl-machine.h
205 static inline ElfW(Addr)
206 elf_machine_fixup_plt (struct link_map *map, lookup_t t,
207                const ElfW(Rela) *reloc,
208                ElfW(Addr) *reloc_addr, ElfW(Addr) value)
209 {
210   return *reloc_addr = value;
211 }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œçš„&lt;code&gt;value&lt;/code&gt;å°±æ˜¯ç›®æ ‡å‡½æ•°åœ°å€ï¼Œä¹Ÿå°±æ˜¯&lt;code&gt;puts&lt;/code&gt;çš„çœŸæ­£åœ°å€ï¼Œä»£ç ä¸­è®¾ç½®å…¶åˆ°äº†&lt;code&gt;puts@got.plt&lt;/code&gt;çš„ä½ç½®å¹¶è¿”å›ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šå°±æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨&lt;code&gt;puts&lt;/code&gt;çš„è¿‡ç¨‹äº†ï¼Œå½“ç¬¬äºŒæ¬¡è°ƒç”¨&lt;code&gt;puts&lt;/code&gt;æ—¶ï¼Œç”±äº&lt;code&gt;puts@got.plt&lt;/code&gt;å·²ç»æœ‰äº†æ­£ç¡®çš„åœ°å€ï¼Œæ‰€ä»¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;  &amp;gt;â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;    â”‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°±ç›´æ¥è·³è½¬åˆ°æ­£ç¡®çš„&lt;code&gt;puts&lt;/code&gt;ä½ç½®ï¼Œå®Œæˆäº†å‡½æ•°è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œ&lt;code&gt;linux&lt;/code&gt;ä¸‹çš„è¿™ç§æ‡’ç»‘å®šæ–¹å¼å®ç°äº†åœ¨ä¸ä½¿ç”¨ç¬¦å·çš„æ—¶å€™ä¸è§£æï¼Œè€Œéœ€è¦ä½¿ç”¨çš„æ—¶å€™
åªåœ¨ç¬¬ä¸€æ­¥å¼€é”€æ¯”è¾ƒå¤§ï¼Œåé¢çš„è°ƒç”¨å¼€é”€æ— éå¤šäº†ä¸€æ¬¡è·³è½¬å’Œä¸€æ¬¡å¯»å€æ“ä½œè€Œå·²ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Hugo é›†æˆ Mathjaxå’Œgraphviz</title>
      <link>http://sysfork.com/post/2016/integrate-mathjax-viz-with-hugo/</link>
      <pubDate>Fri, 02 Sep 2016 09:41:17 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2016/integrate-mathjax-viz-with-hugo/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://gohugo.io/&#34;&gt;hugo&lt;/a&gt;æ˜¯ä¸€ä¸ªæ¯”&lt;a href=&#34;https://hexo.io&#34;&gt;hexo&lt;/a&gt;æ›´ç®€å•æ˜“ç”¨çš„é™æ€é¡µé¢ç”Ÿæˆå·¥å…·ï¼Œå…¶åªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²ç¯å¢ƒç®€å•ï¼Œæœ¬åšå®¢å°±æ˜¯åŸºäºhugoæ„å»ºçš„ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åœ¨å†™åšå®¢çš„æ—¶å€™ç»å¸¸åº”ç”¨åˆ°å…¬å¼å’Œå›¾è¡¨ï¼Œè¿™åˆ†åˆ«å¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://www.mathjax.org/&#34;&gt;mathjax&lt;/a&gt;å’Œ&lt;a href=&#34;https://github.com/mdaines/viz.js&#34;&gt;viz.js&lt;/a&gt;å®ç°ã€‚hugoå¹¶æ²¡æœ‰æä¾›
å†…ç½®çš„æ”¯æŒï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±å†™ç›¸å…³çš„æ”¯æŒã€‚&lt;/p&gt;

&lt;p&gt;ç”±äºå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ–‡ç« éƒ½éœ€è¦mathjaxå’Œviz.jsï¼Œæ‰€ä»¥éœ€è¦æŒ‰éœ€ä½¿ç”¨ï¼Œè¿™ä¸ªå¯ä»¥åœ¨æ¯ä¸ªpostçš„å‰è¨€ä¸Šå®šä¹‰&lt;code&gt;plugins&lt;/code&gt;å˜é‡ï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;title = &amp;quot;Hugo é›†æˆ Mathjaxå’Œgraphviz&amp;quot;
plugins = [&amp;quot;mathjax&amp;quot;, &amp;quot;viz&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå†&lt;code&gt;partials&lt;/code&gt;ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª&lt;code&gt;post_plugins.html&lt;/code&gt;ï¼Œå¹¶åœ¨&lt;code&gt;post/single.html&lt;/code&gt;å¼•å…¥è¿™ä¸ªæ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  {{ partial &amp;quot;post_plugins.html&amp;quot; . }}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;post_plugins.html&lt;/code&gt;æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{{ if isset .Params &amp;quot;plugins&amp;quot; }}
    {{ range .Params.plugins }}
        {{ $path := . | printf &amp;quot;post_plugins/%s.html&amp;quot;}}
        {{ partial $path }}
    {{ end }}
{{ end }}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€»è¾‘å³é€šè¿‡ä¾¿åˆ©&lt;code&gt;plugins&lt;/code&gt;å‚æ•°å†…å®¹ï¼Œç„¶åå¼•å…¥å¯¹åº”çš„htmlæ–‡ä»¶ã€‚åœ¨ç›®å‰çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†mathjaxå’Œvizã€‚å…¶ä¸­&lt;code&gt;post_plugins/mathjax.html&lt;/code&gt;çš„å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;script type=&amp;quot;text/javascript&amp;quot; src=&amp;quot;//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&amp;quot;&amp;gt; &amp;lt;/script&amp;gt;
&amp;lt;script type=&amp;quot;text/x-mathjax-config&amp;quot;&amp;gt;
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [[&#39;$&#39;,&#39;$&#39;], [&#39;\\(&#39;,&#39;\\)&#39;]],
    displayMath: [[&#39;$$&#39;,&#39;$$&#39;], [&#39;\[&#39;,&#39;\]&#39;]],
    processEscapes: true,
    processEnvironments: true,
    skipTags: [&#39;script&#39;, &#39;noscript&#39;, &#39;style&#39;, &#39;textarea&#39;, &#39;pre&#39;],
    TeX: { equationNumbers: { autoNumber: &amp;quot;AMS&amp;quot; },
         extensions: [&amp;quot;AMSmath.js&amp;quot;, &amp;quot;AMSsymbols.js&amp;quot;] }
  }
});
MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i = 0; i &amp;lt; all.length; i += 1) {
      all[i].SourceElement().parentNode.className += &#39; has-jax&#39;;
  }
});
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·æˆ‘ä»¬å°±èƒ½ä½¿ç”¨&lt;code&gt;\$&lt;/code&gt;æˆ–&lt;code&gt;\$\$&lt;/code&gt;æ¥ç¼–å†™å…¬å¼äº†ï¼Œæœ€ç»ˆç¤ºä¾‹è¡¨ç°å¦‚ä¸‹ï¼š
$$ [ \left [ &amp;#8211; \frac{\hbar^2}{2 m} \frac{\partial^2}{\partial x^2} + V \right ] \Psi = i \hbar \frac{\partial}{\partial t} \Psi ]$$&lt;/p&gt;

&lt;p&gt;å¯¹äº&lt;code&gt;post_plugins/viz.html&lt;/code&gt;å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;script type=&amp;quot;text/javascript&amp;quot; src=&amp;quot;//cdn.bootcss.com/viz.js/1.3.0/viz.js&amp;quot;&amp;gt; &amp;lt;/script&amp;gt;
&amp;lt;script type=&amp;quot;text/javascript&amp;quot;&amp;gt;
(function(){
    var vizPrefix = &amp;quot;language-viz-&amp;quot;;
    Array.prototype.forEach.call(document.querySelectorAll(&amp;quot;[class^=&amp;quot; + vizPrefix + &amp;quot;]&amp;quot;), function(x){
        var engine;
        x.getAttribute(&amp;quot;class&amp;quot;).split(&amp;quot; &amp;quot;).forEach(function(cls){
            if (cls.startsWith(vizPrefix)) {
                engine = cls.substr(vizPrefix.length);
            }
        });
        var image = new DOMParser().parseFromString(Viz(x.innerText, {format:&amp;quot;svg&amp;quot;, engine:engine}), &amp;quot;image/svg+xml&amp;quot;);
        x.parentNode.insertBefore(image.documentElement, x);
        x.style.display = &#39;none&#39;
    });
})();
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»£ç çš„ä½œç”¨ï¼Œå°±æ˜¯å°†codeblockç±»å‹ä¸ºlanguage-viz-xxxçš„è‡ªåŠ¨æ¸²æŸ“ä¸ºsvgå›¾åƒæ˜¾ç¤ºï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;p&gt;åŸå§‹å†…å®¹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    ```viz-dot
    digraph g { a -&amp;gt; b; }
    ```

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¾“å‡ºç»“æœï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-viz-dot&#34;&gt;    digraph g { a -&amp;gt; b; }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒç†ï¼Œå¯¹äºå…¶ä»–éœ€è¦ç‰¹æ®Šæ”¯æŒçš„æ ¼å¼æˆ–è¡¨ç°ï¼Œéƒ½å¯ä»¥é€šè¿‡æ·»åŠ post_pluginsæ¥å®ç°ã€‚ä»¥ä¸Šä»£ç éƒ½åœ¨æœ¬ç½‘ç«™çš„&lt;a href=&#34;https://github.com/usbuild/site.git&#34;&gt;github&lt;/a&gt;ä¸Šã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Lua Tableä¸­HashMapä»‹ç»</title>
      <link>http://sysfork.com/post/2016/lua-hashtable-introduction/</link>
      <pubDate>Thu, 01 Sep 2016 17:40:08 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2016/lua-hashtable-introduction/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://www.lua.org/pil/2.5.html&#34;&gt;Table&lt;/a&gt; åœ¨Luaä¸­æœ‰ç€æå…¶é‡è¦çš„åº”ç”¨ï¼Œä»æ ¸å¿ƒè¯­è¨€å®ç°ï¼Œå¦‚&lt;a href=&#34;https://en.wikipedia.org/wiki/String_interning&#34;&gt;short string intern&lt;/a&gt;ï¼Œ
åˆ°åˆ©ç”¨&lt;a href=&#34;https://www.lua.org/pil/13.html&#34;&gt;metatable&lt;/a&gt;å®ç°çš„&lt;a href=&#34;lua-users.org/wiki/LuaClassesWithMetatable&#34;&gt;class&lt;/a&gt;ï¼Œtableå‡ ä¹æ— æ‰€ä¸èƒ½ã€‚å¦‚æ­¤é«˜é¢‘åº¦åœ°åˆ©ç”¨ä¹Ÿå°±æ„å‘³ç€luaå¿…é¡»è¦æœ‰ä¸€ä¸ªé«˜æ•ˆçš„
tableå®ç°ã€‚&lt;/p&gt;

&lt;p&gt;å¾ˆå¤šè¯­è¨€æä¾›äº†arrayå’Œassociative arrayä¸¤ç§æ•°æ®ç»“æ„ã€‚arrayæ˜¯æŒ‡ä»¥æŸä¸ªæŒ‡å®šçš„æœ€å°æ•´æ•°ä¸‹æ ‡(ä¸€èˆ¬æ˜¯0)å¼€å§‹çš„è¿ç»­å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ‰vectorã€listã€arrayã€ArrayListç­‰å¤šç§åç§°ï¼›associative arrayï¼Œä¸­æ–‡
ä¹Ÿå«å…³è”æ•°ç»„ï¼Œå³å°†ä¸€å¯¹key/pairä¹‹é—´å…³è”èµ·æ¥ï¼Œå®ƒä¸€èˆ¬ä¹Ÿè¢«ç§°ä¸ºmapã€dictç­‰ã€‚Luaå¹¶ä¸æä¾›arrayï¼Œå› ä¸ºæ•°ç»„æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„å…³è”æ•°ç»„ã€‚ä½†æ˜¯ä»å†…éƒ¨è¡¨ç¤ºä¸Šï¼Œarrayå’Œmapæœ‰ç€æå¤§çš„ä¸åŒï¼Œarrayåªéœ€è¦ä¸€å—è¿ç»­çš„
å†…å­˜å³å¯å®ç°ï¼Œè€Œmapåˆ™æœ‰å¤šç§å®ç°ã€‚Luaä¸ºäº†æ•ˆç‡ï¼Œå°†ä¸€éƒ¨åˆ†æ•´æ•°ä¸‹æ ‡çš„å…ƒç´ å­˜å‚¨åœ¨array partä¸­ï¼Œè€Œå°†å…¶ä»–å…ƒç´ å­˜å‚¨åœ¨hashmapä¸­ï¼Œå®ç°åœ¨å¤–éƒ¨æ¥å£ä¸å˜çš„æƒ…å†µä¸‹å®ç°äº†æ•ˆç‡çš„æœ€å¤§åŒ–ã€‚arrayéƒ¨åˆ†æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éœ€è¦
ä¼˜åŒ–çš„ï¼Œå…¶å°±æ˜¯ä¸€æ•´å—è¿ç»­çš„å†…å­˜ï¼Œå­˜å‚¨å’Œè¯»å–çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼Œè€Œhashmapçš„å®ç°ç§°ä¸ºäº†lua tableè®¾è®¡çš„é‡ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;mapæœ‰å¤šç§å®ç°æ‰‹æ®µï¼Œåœ¨stlä¸­ï¼Œé»˜è®¤çš„mapä½¿ç”¨çš„æ˜¯çº¢é»‘æ ‘ï¼Œå­˜å‚¨å’Œè¯»å–çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(logn)ï¼›è™½ç„¶çº¢é»‘æ ‘çš„è¡¨ç°ååˆ†ç¨³å®šï¼Œä½†æ˜¯å®ç°æ¯”è¾ƒå¤æ‚è€Œä¸”æ— æ³•æ»¡è¶³æç«¯æ€§èƒ½è¦æ±‚ï¼Œ
C++11ä¸­æ·»åŠ æ–°çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/container/unordered_map&#34;&gt;unordered_map&lt;/a&gt;ï¼Œå…¶å®ç°å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªhashmapã€‚hashmapçš„åŸºæœ¬æµç¨‹æ˜¯ä½¿ç”¨ä¸€ä¸ªhashå‡½æ•°æ¥å°†
ä¸€ä¸ªkeyæ˜ å°„åˆ°ä¸€å—è¿ç»­å†…å­˜ä¸­ï¼Œå®ç°åœ¨ç†æƒ³æƒ…å†µä¸‹è®¿é—®å’Œåˆ é™¤æ¥è¿‘O(1)çš„æ—¶é—´å¤æ‚åº¦ã€‚&lt;/p&gt;

&lt;p&gt;ç”±äºä¸€èˆ¬keyçš„å–å€¼èŒƒå›´å¤§äºhashmap slotæ•°ç›®ï¼Œæ‰€ä»¥ä¸å¯é¿å…åœ°å‡ºç°å†²çªçš„çŠ¶å†µã€‚åœ¨æ•™ç§‘ä¹¦ä¸­ï¼Œè§£å†³è¿™ç§å†²çªä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š&lt;a href=&#34;https://en.wikipedia.org/wiki/Hash_table#Separate_chaining&#34;&gt;é“¾è¡¨æ³•&lt;/a&gt;
å’Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/Open_addressing&#34;&gt;å¼€æ”¾å¯»å€æ³•&lt;/a&gt;ã€‚é“¾è¡¨æ³•çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå°†å†²çªçš„å…ƒç´ ä½¿ç”¨é“¾è¡¨é“¾æ¥èµ·æ¥å³å¯ï¼›è€Œå¼€æ”¾å¯»å€æ³•åˆ™éœ€è¦å¤šæ¬¡è®¡ç®—ï¼Œç›´è‡³æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰å†²çªçš„slotä¸ºæ­¢ã€‚
è¿™ä¸¤è€…éƒ½æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œé“¾è¡¨æ³•ç”±äºä½¿ç”¨äº†é“¾è¡¨ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨CPUç¼“å­˜ï¼Œå¹¶ä¸”å®ç°æ·±æ‹·è´éš¾åº¦è¾ƒå¤§ï¼›è€Œå¼€æ”¾å¯»å€æ³•æ— æ³•å®ç°åˆ é™¤å…ƒç´ çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å½“å…ƒç´ å¯†åº¦æ¯”è¾ƒå¤§æ—¶ï¼Œæ•ˆç‡éå¸¸ä½ã€‚&lt;/p&gt;

&lt;p&gt;Lua tableä½¿ç”¨äº†ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œå«åš&lt;a href=&#34;https://en.wikipedia.org/wiki/Coalesced_hashing&#34;&gt;Coalesced_hashing&lt;/a&gt;ï¼Œç»“åˆä½¿ç”¨äº†é“¾è¡¨æ³•å’Œå¼€æ”¾å¯»å€æ³•ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/4/4c/CoalescedHash.jpg&#34; alt=&#34;Coalesced_hashing&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å½“æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®šä¹‰å…¶åŸæœ¬åº”è¯¥åœ¨çš„ä½ç½®ä¸ºmainpositionï¼Œå¦‚æœmainpoisitionå¯¹åº”çš„slotæ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥æ’å…¥ï¼›å¦‚æœéç©ºï¼Œçœ‹çœ‹åœ¨é‚£ä¸ªä½ç½®ä¸Šçš„å…ƒç´ çš„mainpositionæ˜¯ä¸æ˜¯å½“å‰çš„slotï¼Œå¦‚æœä¸æ˜¯çš„
è¯ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ°ä»»æ„ä¸€ä¸ªç©ºçš„slot(ä½ç½®A)ï¼Œç„¶åå°†å½“å‰çš„å…ƒç´ æ’å…¥åˆ°mainpositionä½ç½®ï¼Œå¹¶å°†å½“å‰çš„nextå­—æ®µè®¾ç½®æˆä½ç½®Aï¼Œå½¢æˆé“¾è¡¨ã€‚å¦‚æœå ç”¨å…ƒç´ mainpositionå°±æ˜¯å½“å‰ä½ç½®ï¼Œåˆ™å°†å¾…æ’å…¥çš„
å…ƒç´ æ’å…¥åˆ°ä»»æ„ä¸€ä¸ªç©ºçš„ä½ç½®ä¸Šï¼Œå¹¶é“¾æ¥åˆ°å ç”¨å…ƒç´ çš„åé¢ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå®ç°äº†æ‰€æœ‰çš„å…ƒç´ éƒ½å°½é‡ä¿å­˜åœ¨mainpositionä¸Šï¼Œå½“æŸ¥æ‰¾çš„æ—¶å€™ä¹Ÿèƒ½ä½¿ç”¨æ›´å°‘çš„æ¬¡æ•°æ¥æ‰¾åˆ°å…ƒç´ ä½ç½®ã€‚è¿™å¯¹å…ƒç´ æœ¬æ¥å°±åœ¨hashmapä¸­ï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒé«˜çš„ã€‚ä½†æ˜¯ï¼Œå½“å…ƒç´ ä¸åœ¨hashmapä¸­ï¼ŒæŸ¥æ‰¾çš„ä»£ä»·
æ¯”è¾ƒé«˜ã€‚&lt;/p&gt;

&lt;p&gt;lua tableçš„ä»£ç å®ç°åœ¨&lt;a href=&#34;https://www.lua.org/source/5.3/ltable.c.html&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼Œå®ç°éå¸¸ç®€æ´æ˜äº†ï¼Œä¹Ÿä¸æ˜¯å¾ˆéš¾æ‡‚ï¼Œä½†æ˜¯å¯¹äºå¹³æ—¶ç»å¸¸ä½¿ç”¨luaçš„åŒå­¦æ¥è¯´è¯»ä¸€è¯»è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>