<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on sysğŸ”±fork</title>
    <link>http://sysfork.com/post/</link>
    <description>Recent content in Posts on sysğŸ”±fork</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>&amp;copy; 2017. All rights reserved.</copyright>
    <lastBuildDate>Mon, 01 May 2017 22:30:00 +0800</lastBuildDate>
    <atom:link href="http://sysfork.com/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>ä¸€ç§åœ¨elfä¸­é›†æˆè„šæœ¬æ–‡ä»¶çš„æ–¹æ¡ˆ</title>
      <link>http://sysfork.com/post/a-solution-for-elf-integrate-scripts/</link>
      <pubDate>Mon, 01 May 2017 22:30:00 +0800</pubDate>
      
      <guid>http://sysfork.com/post/a-solution-for-elf-integrate-scripts/</guid>
      <description>

&lt;p&gt;è¿›è¡Œæ¸¸æˆæœåŠ¡å™¨å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å°†&lt;code&gt;C++&lt;/code&gt;çš„éƒ¨åˆ†ç§°ä¹‹ä¸ºå¼•æ“å±‚ï¼Œè€Œ&lt;code&gt;lua&lt;/code&gt;ç§°ä¹‹ä¸ºè„šæœ¬å±‚ã€‚ä½†æ˜¯å¾€å¾€æœ‰äº›æ ¸å¿ƒé€»è¾‘æ˜¯å„ä¸ªæ¸¸æˆå…¬ç”¨çš„ï¼Œ
æˆ–è€…è¯´æœ‰äº›å¼•æ“å±‚çš„ä»£ç ç”¨&lt;code&gt;C++&lt;/code&gt;å†™èµ·æ¥ååˆ†éº»çƒ¦ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šä½¿ç”¨&lt;code&gt;lua&lt;/code&gt;æ¥ç¼–å†™ã€‚è¿™å°±å¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬çš„æ¸¸æˆç›®å½•ç»“æ„å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;â”œâ”€bin               // å¯æ‰§è¡Œæ–‡ä»¶
â””â”€scripts           // è„šæœ¬ç›®å½•ï¼Œluaæ–‡ä»¶
    â”œâ”€framework     // æ ¸å¿ƒluaæ–‡ä»¶ï¼Œå„ä¸ªé¡¹ç›®å…¬ç”¨çš„
    â””â”€server        // æ¸¸æˆé€»è¾‘luaæ–‡ä»¶
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;scripts/framework&lt;/code&gt;æ˜¯å„ä¸ªé¡¹ç›®å…¬ç”¨çš„ï¼Œå¹¶ä¸”å’Œ&lt;code&gt;bin&lt;/code&gt;ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶åŒæ—¶å‘å¸ƒå’Œæ›´æ–°ã€‚æ‰€ä»¥æœ‰ä¸€ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯å°†&lt;code&gt;framework&lt;/code&gt;ä¸­
çš„luaæ–‡ä»¶é›†æˆåˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå‡å°‘ç»´æŠ¤çš„æˆæœ¬ã€‚&lt;/p&gt;

&lt;h1 id=&#34;1-æ–‡ä»¶å­˜å‚¨&#34;&gt;1. æ–‡ä»¶å­˜å‚¨&lt;/h1&gt;

&lt;p&gt;ä¸‹é¢æ˜¯elfæ–‡ä»¶çš„ç¤ºæ„å›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/thumb/7/77/Elf-layout--en.svg/260px-Elf-layout--en.svg.png&#34; alt=&#34;elf&#34; /&gt;&lt;/p&gt;

&lt;p&gt;elfæ–‡ä»¶æœ‰å¤šä¸ªsectionï¼Œé™¤äº†ä¸€äº›é¢„å®šä¹‰çš„sectionå¦‚&lt;code&gt;.rodata&lt;/code&gt;ã€&lt;code&gt;.text&lt;/code&gt;ã€&lt;code&gt;.init&lt;/code&gt;ç­‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€äº›è‡ªå·±çš„sectionã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æ‰€éœ€è¦çš„luaæ–‡ä»¶
æ”¾è¿›è¿™ä¸ªsectionä¸­ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™åŠ¨æ€è¯»å‡ºæ¥ï¼Œå®ç°ç›®çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://linux.die.net/man/1/objcopy&#34;&gt;objcopy&lt;/a&gt;å‘½ä»¤æ¥å®ç°åˆ›å»ºè‡ªå®šä¹‰sectionçš„åŠŸèƒ½ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;objcopy infile.out --add-section .lua-data=section_file outfile.out
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶è€Œ&lt;code&gt;framework&lt;/code&gt;é‡Œé¢æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œè€Œä¸”åŒ…å«åµŒå¥—çš„æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå°†æ–‡ä»¶å¤¹å˜æˆå•ä¸ªæ–‡ä»¶çš„åŠŸèƒ½ï¼Œç±»ä¼¼äº&lt;a href=&#34;https://linux.die.net/man/1/tar&#34;&gt;tar&lt;/a&gt;ã€‚è™½ç„¶åˆ›å»º
sectionæ—¶ä½¿ç”¨&lt;code&gt;tar&lt;/code&gt;å‘½ä»¤æ˜¯ç®€å•çš„ï¼Œä½†æ˜¯åœ¨è¯»å–çš„æ—¶å€™éœ€è¦ä¸€äº›ç¬¬ä¸‰æ–¹çš„åº“æ¥æ”¯æŒï¼Œè¿™æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚è€Œç”±äºæˆ‘ä»¬çš„ç›®å½•ä¸­åªåŒ…å«&lt;code&gt;lua&lt;/code&gt;æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–è®¾è®¡ã€‚
é¦–å…ˆç©ºæ–‡ä»¶å¤¹å¯¹äºæˆ‘ä»¬æ˜¯æ— æ„ä¹‰çš„ï¼Œåªéœ€è¦&lt;code&gt;lua&lt;/code&gt;æ–‡ä»¶å°±å¯ä»¥ã€‚æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹çš„è¡¨:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ libs/json.lua      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core/entity.lua    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ app/game.lua       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libs/bson.lua      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ ¼å¼è½¬æ¢æˆå•ä¸ªæ–‡ä»¶&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚name_lenâ”‚content_lenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core.entity        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚name_lenâ”‚content_lenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libs.bson          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .................  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;name_len&lt;/code&gt;ä¸ºæ–‡ä»¶åçš„é•¿åº¦ï¼Œè¿™é‡Œç›´æ¥è½¬æ¢æˆäº†luaä¸­&lt;code&gt;require&lt;/code&gt;çš„æ ¼å¼ï¼Œä½¿ç”¨ç‚¹ç¬¦å·ã€‚&lt;code&gt;content_len&lt;/code&gt;æ˜¯æ–‡ä»¶å†…å®¹çš„é•¿åº¦ï¼Œå³æ–‡ä»¶çš„å…·ä½“å†…å®¹é•¿åº¦ã€‚æœ€åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code&gt;zip&lt;/code&gt;æŒ‡ä»¤
å°†è¿™éƒ¨åˆ†å†…å®¹å‹ç¼©å­˜å‚¨åœ¨&lt;code&gt;elf&lt;/code&gt;æ–‡ä»¶ä¸­ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;#!/usr/bin/env python
#coding: utf-8

import os, struct, StringIO, zlib, subprocess, sys, tempfile, argparse

argParser = argparse.ArgumentParser()

argParser.add_argument(&amp;quot;luafolder&amp;quot;, type=str)
argParser.add_argument(&amp;quot;exe&amp;quot;, type=str)
argParser.add_argument(&amp;quot;out&amp;quot;, type=str)

args = argParser.parse_args()

files = []

path = args.luafolder

for (dirpath, dirname, filenames) in os.walk(path):
    dirp = dirpath[len(path):]
    if dirp:
        if dirp[-1] != &amp;quot;/&amp;quot;:
            dirp += &amp;quot;/&amp;quot;

        while dirp[0] == &amp;quot;/&amp;quot;:
            dirp = dirp[1:]

    files.extend([dirp + x for x in filenames])

output = StringIO.StringIO()

for fpath in files:
    realp = path + &amp;quot;/&amp;quot; + fpath
    filesize = os.path.getsize(realp)

    if fpath.endswith(&amp;quot;.lua&amp;quot;):
        fpath = fpath[:-4]
    elif fpath.endswith(&amp;quot;.luac&amp;quot;):
        fpath = fpath[:-5]
    else:
        continue

    package_pattern = fpath.replace(&amp;quot;/&amp;quot;, &amp;quot;.&amp;quot;)
    package_pattern = &amp;quot;pg.&amp;quot; + package_pattern
    with open(realp, &amp;quot;rb&amp;quot;) as rf:
        content = rf.read()
        output.write(struct.pack(&amp;quot;=hL&amp;quot;, len(package_pattern), len(content)))
        output.write(package_pattern)
        output.write(content)

f = tempfile.NamedTemporaryFile()

outdata = output.getvalue()
f.write(struct.pack(&amp;quot;=L&amp;quot;, len(outdata)))
f.write(zlib.compress(output.getvalue()))
f.flush()

subprocess.call(&amp;quot;objcopy %s --remove-section .lua-data&amp;quot;%(args.exe, ), shell=True)
subprocess.call(&amp;quot;objcopy %s --add-section .lua-data=%s %s&amp;quot;%(args.exe, f.name, args.out), shell=True)

&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;2-æ–‡ä»¶å†…å®¹çš„è¯»å–&#34;&gt;2. æ–‡ä»¶å†…å®¹çš„è¯»å–&lt;/h1&gt;

&lt;p&gt;æˆ‘ä»¬éœ€è¦ä½¿ç”¨&lt;code&gt;elf.h&lt;/code&gt;æ–‡ä»¶æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚æ ¹æ®ä¸Šè¿°çš„æ ¼å¼ç¤ºæ„å›¾ï¼Œ&lt;code&gt;elf&lt;/code&gt;æ–‡ä»¶å¼€å¤´çš„æ˜¯Headerï¼Œå…¶æ ¼å¼ä¸º&lt;code&gt;ElfXX_Ehdr&lt;/code&gt;ï¼Œ
æˆ‘ä»¬å¯ä»¥ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹åˆ°å†…å­˜ã€‚ç„¶åè¯»å–&lt;code&gt;e_shoff&lt;/code&gt;å­—æ®µè·å¾—section headerçš„ä½ç½®ï¼Œå®šä½åˆ°ä½ç½®å¹¶ä¾æ¬¡è¯»å–å†…å®¹åˆ°&lt;code&gt;ElfXX_Shdr&lt;/code&gt;
ç»“æ„ä½“ä¸­ï¼Œç„¶åé€šè¿‡å„ä¸ªentryçš„&lt;code&gt;sh_name&lt;/code&gt;å¾—åˆ°æœ€ç»ˆsectionï¼Œç„¶åè¯»å–æ–‡ä»¶è¾¾åˆ°ç›®çš„ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static std::map&amp;lt;std::string, std::string&amp;gt; readElfLuaData(const std::string &amp;amp;filepath) {
    std::map&amp;lt;std::string, std::string&amp;gt; files;
#if __x86_64__
    typedef Elf64_Ehdr ELF_EHDR;
    typedef Elf64_Shdr ELF_SHDR;
#else
    typedef Elf32_Ehdr ELF_EHDR;
    typedef Elf32_Shdr ELF_SHDR;
#endif

    std::ifstream ifs(filepath);

    ELF_EHDR hdr;
    ifs.read(reinterpret_cast&amp;lt;char *&amp;gt;(&amp;amp;hdr), sizeof(hdr));

    std::vector&amp;lt;ELF_SHDR&amp;gt; sh_tables(hdr.e_shnum);
    ifs.seekg(static_cast&amp;lt;long&amp;gt;(hdr.e_shoff));

    for (size_t i = 0; i &amp;lt; hdr.e_shnum; ++i) {
        ifs.read(reinterpret_cast&amp;lt;char *&amp;gt;(&amp;amp;sh_tables[i]), sizeof(sh_tables[i]));
    }

    // read shstr

    std::vector&amp;lt;char&amp;gt; shstr(sh_tables[hdr.e_shstrndx].sh_size);
    ifs.seekg(static_cast&amp;lt;long&amp;gt;(sh_tables[hdr.e_shstrndx].sh_offset));
    ifs.read(shstr.data(), static_cast&amp;lt;long&amp;gt;(shstr.size()));

    ELF_SHDR *lua_sh = nullptr;

    for (size_t i = 0; i &amp;lt; hdr.e_shnum; ++i) {
        char *name = shstr.data() + sh_tables[i].sh_name;
        if (strcmp(name, &amp;quot;.lua-data&amp;quot;) == 0) {
            lua_sh = &amp;amp;sh_tables[i];
            break;
        }
    }

    if (lua_sh) {
        std::vector&amp;lt;char&amp;gt; buf(lua_sh-&amp;gt;sh_size);
        ifs.seekg(static_cast&amp;lt;long&amp;gt;(lua_sh-&amp;gt;sh_offset));
        ifs.read(buf.data(), static_cast&amp;lt;std::streamsize&amp;gt;(buf.size()));

        size_t idx = 0;
#define READ_TO(TARGET, SIZE)                                                                      \
    memcpy(TARGET, buf.data() + idx, SIZE);                                                        \
    idx += SIZE;

        uint32_t raw_len = 0;
        READ_TO(&amp;amp;raw_len, sizeof(raw_len));

        std::vector&amp;lt;char&amp;gt; tmp(raw_len);
        uLongf dest_len = tmp.size();
        uncompress(reinterpret_cast&amp;lt;Bytef *&amp;gt;(tmp.data()), &amp;amp;dest_len,
                   reinterpret_cast&amp;lt;Bytef *&amp;gt;(buf.data() + idx), buf.size() - idx);

        buf.swap(tmp);
        idx = 0;

        while (idx &amp;lt; dest_len) {
            uint16_t name_len;
            uint32_t content_len;
            READ_TO(&amp;amp;name_len, sizeof(name_len));
            READ_TO(&amp;amp;content_len, sizeof(content_len));
            std::string filename(name_len, 0), content(content_len, 0);
            READ_TO(&amp;amp;*filename.begin(), filename.size());
            READ_TO(&amp;amp;*content.begin(), content.size());
            files.emplace(std::piecewise_construct, std::forward_as_tuple(std::move(filename)),
                          std::forward_as_tuple(std::move(content)));
        }
#undef READ_TO
    }
    return files;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥ä¾¿å¯ä»¥é€šè¿‡æ·»åŠ åˆ°&lt;code&gt;package.preload&lt;/code&gt;å®ç°åœ¨luaä¸­è°ƒç”¨è¿™äº›æ–‡ä»¶çš„ç›®çš„ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ä½¿ç”¨C&#43;&#43; mapå®ç°æ³¨å†Œå›è°ƒçš„åŠŸèƒ½</title>
      <link>http://sysfork.com/post/cpp-function-container/</link>
      <pubDate>Sat, 29 Apr 2017 15:38:38 +0800</pubDate>
      
      <guid>http://sysfork.com/post/cpp-function-container/</guid>
      <description>

&lt;p&gt;åœ¨&lt;code&gt;C++/lua&lt;/code&gt;æ··åˆç¼–ç¨‹ä¸­ï¼Œå¾€å¾€å­˜åœ¨éœ€è¦å›è°ƒçš„æƒ…å†µã€‚æ¯”å¦‚åœ¨æ¸¸æˆä¸­ï¼Œé€»è¾‘è¿›ç¨‹ä¸­çš„è„šæœ¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“è®¿é—®æ“ä½œï¼Œå¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;dbmgr.query({name=&amp;quot;hello&amp;quot;}, function(ret)
-- do something
end)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äº&lt;code&gt;dbmgr.query&lt;/code&gt;æ˜¯å¼‚æ­¥æ“ä½œï¼Œè¿™æ¡è¯­å¥æ˜¯ç«‹å³è¿”å›çš„ã€‚å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡å‘&lt;code&gt;dbmgr&lt;/code&gt;è¿›ç¨‹å‘é€ä¸€ä¸ª&lt;code&gt;query&lt;/code&gt;è¯·æ±‚ï¼Œç„¶åé€»è¾‘è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚å½“&lt;code&gt;dbmgr&lt;/code&gt;æ”¶åˆ°è¯·æ±‚åï¼Œå…¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œå¾—åˆ°
ç»“æœç„¶åä¹Ÿæ˜¯é€šè¿‡ç½‘ç»œå°†å…¶å‘é€ç»™é€»è¾‘è¿›ç¨‹ã€‚é€»è¾‘è¿›ç¨‹æ”¶åˆ°ç»“æœåè°ƒç”¨åˆ°&lt;code&gt;lua&lt;/code&gt;çš„å›è°ƒå‡½æ•°é‡Œã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ªç®€åŒ–æ–¹æ¡ˆï¼Œå¦‚æœæ—¶ä»…ä»…é’ˆå¯¹&lt;code&gt;lua&lt;/code&gt;çš„è¯ï¼Œåªéœ€è¦åœ¨å‘&lt;code&gt;dbmgr&lt;/code&gt;è¿›ç¨‹å‘é€è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Š&lt;code&gt;lua function&lt;/code&gt;çš„æ³¨å†ŒIDå°±å¥½äº†ï¼ŒæŸ¥è¯¢åˆ°ç»“æœåè¿”å›è¿‡æ¥å°±èƒ½ç›´æ¥è°ƒç”¨ã€‚ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæ¥å£ä¸ä»…ä»…åœ¨
&lt;code&gt;lua&lt;/code&gt;ä¸­ä½¿ç”¨ï¼Œå¸Œæœ›åœ¨&lt;code&gt;C++&lt;/code&gt;ä¸­ä¹Ÿèƒ½è°ƒç”¨ï¼Œå¹¶ä¸”å¸Œæœ›æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¨¡å—æ¥è´Ÿè´£è¿™ç±»äº‹æƒ…ï¼Œè¯¥å¦‚ä½•è®¾è®¡ï¼Ÿä¸€ä¸ªç®€åŒ–åçš„é—®é¢˜å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;functional&amp;gt;
#include &amp;lt;map&amp;gt;

std::map&amp;lt;int, std::function&amp;lt;void(void*)&amp;gt;&amp;gt; callbacks;
int last_idx = 0;

//ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œéœ€è¦æ”¯æŒå„ç§function
template&amp;lt;typename T&amp;gt;
int addCallback(T &amp;amp;&amp;amp; t) {
}

//ç”¨äºè°ƒç”¨å›è°ƒå‡½æ•°
template&amp;lt;typename ... ARGS&amp;gt;
void call(int idx, ARGS &amp;amp;&amp;amp; ... args) {
}

void func(int i) {}

class Functor {
public:
	void operator()(const std::string &amp;amp;s, int i) {}
};

int main() {
	int c1 = addCallback(&amp;amp;func);
	int i;
	int c2 = addCallback([i](double j) {});
	int c3 = addCallback(Functor());

	call(c1, 1);
	call(c2, 1.0);
	call(c3, std::string(&amp;quot;string&amp;quot;), 1);

	return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;addCallback&lt;/code&gt;çš„ä½œç”¨ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;ã€&lt;code&gt;functor&lt;/code&gt;ã€æ™®é€šçš„å‡½æ•°ã€æˆå‘˜å‡½æ•°ç­‰ç­‰ã€‚è¿™é‡Œä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œæˆ‘ä»¬åª
å¤„ç†&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;å’Œæ™®é€šå‡½æ•°ï¼Œå…¶ä½™çš„ä¸å†èµ˜è¿°ã€‚ä¸‹é¢æ˜¯ä¸€äº›é—®é¢˜ï¼š&lt;/p&gt;

&lt;h1 id=&#34;1-å‚æ•°çš„å¤„ç†&#34;&gt;1. å‚æ•°çš„å¤„ç†ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯&lt;code&gt;map&lt;/code&gt;ï¼Œ&lt;code&gt;value_type&lt;/code&gt;æ˜¯ä¸€å®šçš„ï¼Œä½ æ— æ³•å°†å¤šä¸ªä¸åŒç±»å‹çš„&lt;code&gt;std::function&lt;/code&gt;æ”¾è¿›å»ï¼Œæ‰€ä»¥éœ€è¦éœ€è¦åŒ…ä¸€å±‚ï¼Œè¿™é‡Œå­˜å‚¨çš„æ˜¯&lt;code&gt;std::function&amp;lt;void(void*)&amp;gt;&lt;/code&gt;ï¼Œ
ç”±äºæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œè¿”å›å€¼æˆ‘ä»¬ä¸å…³å¿ƒã€‚å‚æ•°ä½¿ç”¨çš„æ˜¯&lt;code&gt;void*&lt;/code&gt;ï¼Œå°†ç±»å‹ç»™æŠ¹é™¤æ‰äº†ã€‚é‚£ä¹ˆå‚æ•°çš„å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨&lt;code&gt;std::tuple&lt;/code&gt;æ¥å­˜å‚¨ï¼Œé‚£&lt;code&gt;call&lt;/code&gt;çš„å®ç°å°±å¾ˆç®€å•äº†:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename ... ARGS&amp;gt;
void call(int idx, ARGS &amp;amp;&amp;amp; ... args) {
	auto it = callbacks.find(idx);
	if (it != callbacks.end() {
		auto tuple = std::tuple&amp;lt;ARGS...&amp;gt;(args...);
		it-&amp;gt;second(&amp;amp;tuple);
	}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;2-callbacks-å­˜å‚¨çš„å†…å®¹æ˜¯&#34;&gt;2. &lt;code&gt;callbacks&lt;/code&gt;å­˜å‚¨çš„å†…å®¹æ˜¯ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œ&lt;code&gt;map&lt;/code&gt;çš„&lt;code&gt;value_type&lt;/code&gt;æ˜¯&lt;code&gt;std::function&amp;lt;void(*)&amp;gt;&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°†å¤–éƒ¨ä¼ å…¥çš„å›è°ƒè®¾ç½®è¿›å»ï¼Œéœ€è¦å†åŒ…ä¸€å±‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
int addCallback(T &amp;amp;&amp;amp; t) {
    last_idx++;
    callbacks[last_idx] = [t](void *data){
        auto ptr = static_cast&amp;lt;std::tuple&amp;lt;...&amp;gt; *&amp;gt;(data); // æ¨¡æ¿å‚æ•°æ€ä¹ˆå¤„ç†ï¼Ÿ
        std::apply(t, *ptr);
    };
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†&lt;code&gt;C++17&lt;/code&gt;ä¸­çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/utility/apply&#34;&gt;std::apply&lt;/a&gt;ï¼Œå…¶ä½œç”¨å°±æ˜¯è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°æ˜¯ä¸€ä¸ª&lt;code&gt;tuple&lt;/code&gt;ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ä»æºç ä¸­çœ‹çœ‹&lt;code&gt;apply&lt;/code&gt;çš„å®ç°ï¼Œ
è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚
é—®é¢˜æ˜¯ï¼Œ&lt;code&gt;tuple&lt;/code&gt;çš„å‚æ•°å¦‚ä½•å¤„ç†ï¼Ÿæˆ‘ä»¬æ²¡æ³•ä»&lt;code&gt;data&lt;/code&gt;ä¸­å¾—åˆ°ç±»å‹å¿ƒç³»ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯ä»&lt;code&gt;T&lt;/code&gt;ä¸­è·å–ï¼Œé‚£å¦‚ä½•è·å–å‘¢ï¼Ÿ&lt;/p&gt;

&lt;h1 id=&#34;3-callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–&#34;&gt;3. callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–&lt;/h1&gt;

&lt;p&gt;ç°åœ¨çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œå¦‚ä½•ä»&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;ã€æ™®é€šå‡½æ•°ç­‰ç±»å‹ä¸­æå–å‚æ•°ä¿¡æ¯ã€‚å¯¹äºæ™®é€šå‡½æ•°å’Œ&lt;code&gt;std::function&lt;/code&gt;æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‰¹åŒ–æ¥åš&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
struct CallbackTypeHelper;

template&amp;lt;typename RET, typename ... ARGS&amp;gt;
struct CallbackTypeHelper&amp;lt;RET(*)(ARGS...)&amp;gt; {
    typedef std::tuple&amp;lt;ARGS...&amp;gt; typle_type;
}

template&amp;lt;typename RET, typename ... ARGS&amp;gt;
struct CallbackTypeHelper&amp;lt;std::function&amp;lt;RET(ARGS...)&amp;gt;&amp;gt; {
    typedef std::tuple&amp;lt;ARGS...&amp;gt; typle_type;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¹äº&lt;code&gt;lambda&lt;/code&gt;è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;lambda&lt;/code&gt;ä½œä¸º&lt;code&gt;C++11&lt;/code&gt;ä¸­æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå…¶ä½œç”¨æ˜¯å®ç°ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç”±äºæ•è·ç»„çš„å­˜åœ¨ï¼Œå…¶ä¸èƒ½ä»…ä»…å®ç°æˆä¸€ä¸ª&lt;code&gt;C Function&lt;/code&gt;ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼Œå„ä¸ªæ•è·å‚æ•°å³ä¸ºæˆå‘˜
å˜é‡ï¼Œä¸ºäº†å®ç°å¯è¢«è°ƒç”¨ï¼Œå…¶é‡è½½äº†&lt;code&gt;operator()&lt;/code&gt;ã€‚æ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è·å–å‚æ•°çš„æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
struct CallbackFunctorHelper;

template&amp;lt;typename RET, typename C, typename ... ARGS&amp;gt;
struct CallbackFunctorHelper&amp;lt;RET(C::*)(ARGS...) const&amp;gt; {
  typedef std::tuple&amp;lt;ARGS...&amp;gt; tuple_type;
};

template&amp;lt;typename RET, typename C, typename ... ARGS&amp;gt;
struct CallbackFunctorHelper&amp;lt;RET(C::*)(ARGS...)&amp;gt; {
  typedef std::tuple&amp;lt;ARGS...&amp;gt; tuple_type;
};

template &amp;lt;typename T, typename Enabled=void&amp;gt;
struct CallbackTypeHelper {
  typedef typename CallbackFunctorHelper&amp;lt;decltype(&amp;amp;std::decay&amp;lt;T&amp;gt;::type::operator())&amp;gt;::tuple_type tuple_type;
};

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ³¨æ„ç”±äºå‚æ•°æœ‰å¯èƒ½æ˜¯å¼•ç”¨ï¼Œæ‰€æœ‰è¿™é‡Œéœ€è¦&lt;a href=&#34;http://en.cppreference.com/w/cpp/types/decay&#34;&gt;decay&lt;/a&gt;æ¥å¤„ç†è¿™äº›å¼•ç”¨ã€‚åŒæ—¶ç”±äº&lt;code&gt;lambda&lt;/code&gt;çš„&lt;code&gt;mutable&lt;/code&gt;å±æ€§çš„å­˜åœ¨ï¼Œæ‰€ä»¥&lt;code&gt;CallbackFunctorHelper&lt;/code&gt;
éœ€è¦&lt;code&gt;const&lt;/code&gt;å’Œ&lt;code&gt;non-const&lt;/code&gt;çš„ç‰¹åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;æœ€åï¼Œç”±äºè¿™åªæ˜¯æ¼”ç¤ºæ€§è´¨çš„ä»£ç ï¼Œæœ‰äº›é€»è¾‘å¦‚æˆå‘˜å‡½æ•°ç­‰å¹¶æ²¡æœ‰è€ƒè™‘è¿›å»ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;enable_if&lt;/code&gt;åšä¸ªå•ç‹¬çš„ç‰¹åŒ–ï¼Œè€Œä¸éœ€è¦åœ¨é»˜è®¤å‡½æ•°ä¸Šå†™&lt;code&gt;functor&lt;/code&gt;çš„å®ç°ç­‰ã€‚åœ¨å®é™…
åº”ç”¨ä¸­å¯ä»¥ä¿®æ”¹å¾—æ›´åŠ å…¨é¢å’Œä¼˜é›…ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>luaä¸Cäº¤äº’ä¸­çš„æ­»å¾ªç¯æ£€æµ‹</title>
      <link>http://sysfork.com/post/lua-c-detect-inifinite-loop/</link>
      <pubDate>Fri, 21 Apr 2017 17:37:30 +0800</pubDate>
      
      <guid>http://sysfork.com/post/lua-c-detect-inifinite-loop/</guid>
      <description>

&lt;p&gt;ç°åœ¨å¾ˆå¤šæ¸¸æˆå¼•æ“éƒ½æ˜¯&lt;code&gt;C++&lt;/code&gt; + &lt;code&gt;lua&lt;/code&gt;çš„ç»“æ„ï¼Œä¸€æ—¦æŸä¸ªæœåŠ¡å™¨å¼€å‘äººå‘˜å¤§æ„å†™å‡ºæ­»å¾ªç¯ä»£ç ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æœåŠ¡æ— å“åº”ï¼Œå½±å“æœåŠ¡å™¨ç¨³å®šã€‚æ‰€ä»¥å¼•æ“ä¸­æœ€å¥½èƒ½æä¾›ä¸€ä¸ªæ­»å¾ªç¯çš„æ£€æµ‹æœºåˆ¶ï¼Œä¸€æ—¦å‡ºç°æ­»å¾ªç¯åˆ™æ‰§è¡Œä¸€äº›è¡Œä¸ºæ‰“æ–­å½“å‰æµç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;æ­»å¾ªç¯çš„æ£€æµ‹æ˜¯ä¸€ä¸ª&lt;a href=&#34;https://en.wikipedia.org/wiki/Halting_problem&#34;&gt;åœæœºé—®é¢˜&lt;/a&gt;ã€‚æˆ‘ä»¬æ— æ³•åˆ¤æ–­åˆ°åº•æ˜¯ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¿˜æ˜¯è¿›å…¥äº†çœŸæ­£çš„æ­»å¾ªç¯ï¼Œå¥½åœ¨è¿™å¯¹æˆ‘ä»¬çš„æœåŠ¡æ¥è¯´åŒºåˆ«å¹¶ä¸é‡è¦ã€‚æ‰€ä»¥ä¸€ä¸ªç®€å•çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼Œæ‰§è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡äº†é¢„å®šçš„é˜ˆå€¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;C++&lt;/code&gt;ä¸­é›†æˆ&lt;code&gt;lua&lt;/code&gt;ï¼Œè°ƒç”¨åˆ°æ¸¸æˆé€»è¾‘æ—¶ï¼Œä¸€èˆ¬é€šè¿‡&lt;a href=&#34;http://pgl.yoyo.org/luai/i/lua_pcall&#34;&gt;pcall&lt;/a&gt;ï¼Œä½†æ˜¯ä¸€æ—¦è°ƒç”¨äº†&lt;code&gt;pcall&lt;/code&gt;ï¼Œä»£ç çš„æ‰§è¡Œè·¯å¾„ä¾¿è¿›å…¥äº†&lt;code&gt;lua&lt;/code&gt;çš„ä¸–ç•Œï¼Œé™¤éé€šè¿‡ä¿¡å·æœºåˆ¶æ‰èƒ½åœ¨å½“å‰çº¿ç¨‹ä¸­ä¸­æ–­ï¼Œå®ç°æ‰§è¡Œå…¶ä»–åˆ†æ”¯çš„ç›®çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œ&lt;code&gt;lua&lt;/code&gt;è¿˜æä¾›äº†&lt;code&gt;debug.sethook&lt;/code&gt;å‡½æ•°ï¼Œå¯ä»¥åœ¨æ‰§è¡Œæ­£å¸¸é€»è¾‘ä¸­è§¦å‘&lt;code&gt;hook&lt;/code&gt;ï¼Œå®ç°ç›‘æµ‹è¶…æ—¶çš„åŠŸèƒ½ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š&lt;/p&gt;

&lt;h1 id=&#34;1-ä½¿ç”¨-debug-sethook-æ¥å®ç°&#34;&gt;1. ä½¿ç”¨&lt;code&gt;debug.sethook()&lt;/code&gt;æ¥å®ç°&lt;/h1&gt;

&lt;blockquote&gt;
&lt;p&gt;debug.sethook ([thread,] hook, mask [, count])
Sets the given function as a hook. The string mask and the number count describe when the hook will be called. The string mask may have the following characters, with the given meaning:&lt;/p&gt;

&lt;p&gt;&amp;ldquo;c&amp;rdquo;: the hook is called every time Lua calls a function;
&amp;ldquo;r&amp;rdquo;: the hook is called every time Lua returns from a function;
&amp;ldquo;l&amp;rdquo;: the hook is called every time Lua enters a new line of code.
With a count different from zero, the hook is called after every count instructions.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨æ‰§è¡Œ&lt;code&gt;pcall&lt;/code&gt;ä¹‹å‰è®¾å®šç±»ä¼¼å¦‚ä¸‹çš„ä»£ç :&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;debug.sethook(function()error(&amp;quot;timeout&amp;quot;)end, &amp;quot;c&amp;quot;, 10000)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç†è®ºä¸Šåªè¦ä»£ç æŒ‡ä»¤æ•°è¶…è¿‡10000æ¡å°±èƒ½è§¦å‘&lt;code&gt;error&lt;/code&gt;ã€‚å¥½åƒæŒºå®Œç¾çš„ã€‚&lt;/p&gt;

&lt;p&gt;Butï¼Œåœ¨&lt;code&gt;luajit&lt;/code&gt;ä¸‹è¿™æ¡ä¸ä¸€å®šæˆç«‹ï¼Œå› ä¸ºæ‰§è¡Œçš„é€»è¾‘è¢«&lt;code&gt;jit&lt;/code&gt;ç¼–è¯‘äº†ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ&lt;code&gt;hook&lt;/code&gt;æ˜¯ä¸ä¼šè§¦å‘çš„&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If your program is running in a tight loop and never falls back to the interpreter, the debug hook never runs and can&amp;rsquo;t throw the &amp;ldquo;interrupted!&amp;rdquo; error.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªæœªå…¬å¼€çš„ç¼–è¯‘é€‰é¡¹&lt;code&gt;LUAJIT_ENABLE_CHECKHOOK&lt;/code&gt;ï¼Œåœ¨&lt;code&gt;lj_record.c&lt;/code&gt;æ–‡ä»¶çš„æœ€åé¢ï¼Œä¸Šé¢å†™é“&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Regularly check for instruction/line hooks from compiled code and
exit to the interpreter if the hooks are set.&lt;/p&gt;

&lt;p&gt;This is a compile-time option and disabled by default, since the
hook checks may be quite expensive in tight loops.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;çœ‹ä¼¼å¯ä»¥ï¼Œä½†æ˜¯æ³¨æ„ï¼Œå¦‚æœ&lt;code&gt;hook&lt;/code&gt;è¢«è®¾ç½®äº†ï¼Œåˆ™æ‰§è¡Œçš„ä»£ä»·æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ã€‚å¯¹äºæ¸¸æˆè€Œè¨€ï¼Œå¤§éƒ¨åˆ†çš„æ—¶é—´éƒ½åœ¨&lt;code&gt;lua&lt;/code&gt;å±‚ï¼Œè€Œä¸ºäº†ç›‘æµ‹æ­»å¾ªç¯ï¼Œå‡ ä¹
è¦åœ¨æ‰€æœ‰çš„luaæ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®&lt;code&gt;hook&lt;/code&gt;ï¼Œè¿™æ˜¯ä¸å¤ªå®¹æ˜“æ¥å—çš„ã€‚å¥½åœ¨ä¸‹é¢çš„æ³¨é‡Šæåˆ°äº†&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;You can set the instruction hook via lua_sethook() with a count of 1
from a signal handler or another native thread. Please have a look
at the first few functions in luajit.c for an example (Ctrl-C handler).&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å—¯ï¼Œçœ‹æ ·å­åªèƒ½ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆäº†ã€‚&lt;/p&gt;

&lt;h1 id=&#34;2-ä½¿ç”¨ä¿¡å·æ¥å®ç°&#34;&gt;2. ä½¿ç”¨ä¿¡å·æ¥å®ç°&lt;/h1&gt;

&lt;p&gt;åœ¨luaçš„å‘½ä»¤è¡Œç¨‹åºä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡&lt;code&gt;Ctrl-C&lt;/code&gt;ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ç¨‹åº&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt;  for i=1,10000000 do sum = sum + i end
^Cinterrupted!
stack traceback:
        stdin:1: in main chunk
        [C]: in ?

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»”ç»†çœ‹&lt;code&gt;lua.c&lt;/code&gt;æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-C&#34;&gt;static void lstop (lua_State *L, lua_Debug *ar) {
  (void)ar;  /* unused arg. */
  lua_sethook(L, NULL, 0, 0);
  luaL_error(L, &amp;quot;interrupted!&amp;quot;);
}


static void laction (int i) {
  signal(i, SIG_DFL); /* if another SIGINT happens before lstop,
                              terminate process (default action) */
  lua_sethook(globalL, lstop, LUA_MASKCALL | LUA_MASKRET | LUA_MASKCOUNT, 1);
}

// ....
//in docall
signal(SIGINT, laction);
status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
signal(SIGINT, SIG_DFL);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å—¯ï¼Œåœ¨æ‰§è¡Œ&lt;code&gt;pcall&lt;/code&gt;ä¹‹å‰è®¾ç½®äº†ä¿¡å·å¤„ç†å‡½æ•°ï¼Œæ•æ‰&lt;code&gt;Ctrl-C&lt;/code&gt;çš„ä¿¡å·ï¼Œä¸€æ—¦å‘ç”Ÿï¼Œåˆ™ç«‹é©¬è°ƒç”¨&lt;code&gt;lua_sethook&lt;/code&gt;å‡½æ•°ï¼ŒæŒ‡å®šåœ¨æ‰§è¡Œä¸‹ä¸€è¡Œä»£ç æ—¶è°ƒç”¨&lt;code&gt;lstop&lt;/code&gt;ï¼Œè€Œåœ¨&lt;code&gt;lstop&lt;/code&gt;ä¸­å°±ç›´æ¥æŠ›å‡º&lt;code&gt;error&lt;/code&gt;äº†ã€‚æ‰€ä»¥é—®é¢˜æ˜¯ &lt;strong&gt;&lt;code&gt;lua_sethook&lt;/code&gt;æ˜¯å¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨çš„&lt;/strong&gt;ï¼Ÿ&lt;/p&gt;

&lt;p&gt;ç­”æ¡ˆï¼šæ˜¯&lt;/p&gt;

&lt;p&gt;ä»æºç ä¸­å¯ä»¥çœ‹åˆ°&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/* This function can be called asynchronously (e.g. during a signal). */
LUA_API int lua_sethook(lua_State *L, lua_Hook func, int mask, int count)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œä»&lt;code&gt;luajit&lt;/code&gt;çš„æºç æ³¨é‡Šæ¥çœ‹ï¼Œä¸ä»…ä»…åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­ï¼Œåœ¨å…¶ä»–çº¿ç¨‹ä¸­ä¹Ÿèƒ½è¢«è°ƒç”¨
&amp;gt; from a signal handler or another native thread.&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ï¼Œè¿™ç§æ–¹æ¡ˆæ˜¯å¯è¡Œçš„ã€‚å› æ­¤ï¼Œå¯¹äºå•çº¿ç¨‹ç¨‹åºè€Œè¨€ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®&lt;code&gt;alarm&lt;/code&gt;æ¥å®ç°è¶…æ—¶è®¾ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;alarm(10);// trigger after 10s
signal(SIGALRM, laction);
status = lua_pcall(L, narg, (clear ? 0 : LUA_MULTRET), base);
alarm(0)
signal(SIGALRM, SIG_DFL);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è€Œå¯¹äºå¤šçº¿ç¨‹ç¨‹åºï¼Œå¯ä»¥ç›´æ¥å¯ä¸€ä¸ªå®šæ—¶å™¨æ¥æ¥&lt;code&gt;check&lt;/code&gt;ï¼Œè€Œä¸ç”¨ä½¿ç”¨å¾ˆæ¶å¿ƒçš„ä¿¡å·ã€‚&lt;/p&gt;

&lt;p&gt;å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼è§¦å‘è¶…æ—¶&lt;code&gt;error&lt;/code&gt;å¯ä»¥å¾ˆè½»æ˜“åœ°åœ¨&lt;code&gt;pcall&lt;/code&gt;ä¸­æ•è·ï¼Œä»è€Œè€Œå·²å®ç°å †æ ˆçš„æ‰“å°ç­‰åŠŸèƒ½ï¼Œæ–¹ä¾¿æŸ¥æ‰¾å’Œå®šä½é—®é¢˜ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>æµ…è°ˆC&#43;&#43;ä¸­çš„åœ°å€å¯¹é½</title>
      <link>http://sysfork.com/post/about-cpp-alignment/</link>
      <pubDate>Sun, 25 Sep 2016 09:13:27 +0800</pubDate>
      
      <guid>http://sysfork.com/post/about-cpp-alignment/</guid>
      <description>

&lt;h1 id=&#34;1-åŠ¨æœº&#34;&gt;1. åŠ¨æœº&lt;/h1&gt;

&lt;p&gt;æœ€è¿‘åœ¨æ•´ç†C++11ä¸­çš„æ–°å¢ç‰¹æ€§ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª&lt;a href=&#34;http://en.cppreference.com/w/cpp/language/alignas&#34;&gt;alignas&lt;/a&gt;å…³é”®å­—ã€‚åœ¨å­¦ä¹ è¿™ä¸ªçš„æ—¶å€™é¡ºä¾¿ç ”ç©¶äº†
ä¸‹C/C++ä¸­çš„å­—èŠ‚å¯¹é½é—®é¢˜ï¼Œå‘ç°æœ‰å¾ˆå¤šå¯ä»¥æ¢ç´¢çš„åœ°æ–¹ã€‚&lt;/p&gt;

&lt;h1 id=&#34;2-ä»€ä¹ˆæ˜¯åœ°å€å¯¹é½&#34;&gt;2. ä»€ä¹ˆæ˜¯åœ°å€å¯¹é½&lt;/h1&gt;

&lt;p&gt;å‚è€ƒç»´åŸºç™¾ç§‘çš„è§£é‡Šï¼š&lt;a href=&#34;https://en.wikipedia.org/wiki/Data_structure_alignment&#34;&gt;Data_structure_alignment&lt;/a&gt;ã€‚æ‰€è°“åœ°å€å¯¹é½ï¼Œå³æŸä¸ªåœ°å€Aæ»¡è¶³æ˜¯nçš„å€æ•°ï¼Œå…¶ä¸­næ˜¯2çš„å¹‚æ¬¡æ–¹(å¦‚1ã€2ã€4ã€8ç­‰ç­‰)ã€‚å¦‚æœç”¨äºŒè¿›åˆ¶è¡¨ç¤ºçš„è¯ï¼Œé‚£ä¹ˆ
Açš„æœ«å°¾è‡³å°‘æœ‰&lt;code&gt;log&lt;sub&gt;2&lt;/sub&gt;n&lt;/code&gt;ä¸ª0(åºŸè¯)ã€‚å½“æˆ‘ä»¬è¯´åˆ°æŸä¸ªå˜é‡æ˜¯nå­—èŠ‚å¯¹é½çš„æ—¶å€™ï¼Œå…¶æ„æ€æ˜¯æŒ‡è¿™ä¸ªå˜é‡çš„åœ°å€æ˜¯å¯¹é½çš„ã€‚&lt;/p&gt;

&lt;h1 id=&#34;3-åœ°å€å¯¹é½çš„æ„ä¹‰&#34;&gt;3. åœ°å€å¯¹é½çš„æ„ä¹‰&lt;/h1&gt;

&lt;p&gt;ä»æˆ‘ä»¬ç¼–å†™çš„ç¨‹åºæ¥çœ‹ï¼ŒCPUå¥½åƒå¯ä»¥è®¿é—®å†…å­˜ä¸­çš„ä»»æ„ä½ç½®ï¼›ä½†æ˜¯å®é™…ä¸ŠCPUå¾€å¾€æ˜¯æŒ‰ç…§å—ä¸ºåŸºæœ¬å•ä½è®¿é—®å†…å­˜çš„ã€‚å¦‚æœæŸä¸ªå˜é‡çš„èµ·å§‹åœ°å€ä½äºæŸä¸ªå—çš„çš„èµ·å§‹å¤„ï¼Œåˆ™åªéœ€è¾ƒå°‘çš„æ¬¡æ•°ä¾¿èƒ½å®Œæˆè¯»å–ã€‚
æ¯”å¦‚åœ¨æŸä¸ªCPUä¸­ï¼Œå…¶æ¯æ¬¡å–å†…å­˜çš„å¤§å°ä¸º8å­—èŠ‚ï¼Œå¯¹äºä¸€ä¸ª8å­—èŠ‚çš„longç±»å‹å˜é‡ï¼Œå¦‚æœè¯¥å˜é‡çš„åœ°å€æ˜¯8çš„å€æ•°ï¼Œé‚£ä¹ˆæ¯æ¬¡loadè¿™ä¸ªlongå˜é‡åªéœ€è¦ä¸€æ¬¡æ“ä½œã€‚å¦‚æœä¸æ˜¯8çš„å€æ•°åˆ™éœ€è¦ä¸¤æ¬¡ï¼Œå½±å“äº†æ•ˆç‡ã€‚
æ›´å¤šçš„æ•°æ®æµ‹è¯„å‚è€ƒ&lt;a href=&#34;http://www.ibm.com/developerworks/library/pa-dalign/&#34;&gt;è¿™é‡Œ&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;4-è‡ªç„¶å¯¹é½&#34;&gt;4. è‡ªç„¶å¯¹é½&lt;/h1&gt;

&lt;p&gt;ä¸ºäº†ä¿è¯è¿è¡Œæ•ˆç‡ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºçš„æ—¶å€™ä¼šå¯¹æˆ‘ä»¬ä½¿ç”¨çš„å˜é‡è‡ªåŠ¨å¯¹é½ã€‚è¿™ä¸ªå€¼å¾€å¾€å°±æ˜¯å˜é‡ç±»å‹çš„sizeæˆ–æ˜¯èƒ½è¢«sizeæ•´é™¤ã€‚å¦‚charçš„è‡ªç„¶å¯¹é½åœ°å€ä¸º1ï¼Œè€Œintåˆ™æ˜¯4æˆ–8ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯æœ‰ä¸Šé™çš„ã€‚åœ¨&lt;code&gt;C++11&lt;/code&gt;ä¸­ï¼Œ
ä¸Šé™ä¸º&lt;code&gt;std::max_align_t&lt;/code&gt;çš„å¯¹é½å€¼ï¼Œåœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œè¿™ä¸ªç±»å‹éƒ½è¢«å®šä¹‰ä¸º&lt;code&gt;long double&lt;/code&gt;ï¼Œå› ä¸ºè¿™å¾€å¾€ä¹Ÿæ˜¯æœ€å¤§çš„æ ‡é‡ã€‚å½“æˆ‘ä»¬å®šä¹‰æ•°ç»„æ—¶ï¼Œå¦‚ &lt;code&gt;TYPE f[10]&lt;/code&gt;ï¼Œå…¶ä¸­ç¬¬Nä¸ªå…ƒç´ çš„åœ°å€ä¸º&lt;code&gt;f + sizeof(TYPE) * N&lt;/code&gt;ã€‚
å¦‚æœ&lt;code&gt;TYPE&lt;/code&gt;çš„å¯¹é½å€¼èƒ½è¢«&lt;code&gt;sizeof(TYPE)&lt;/code&gt;æ•´é™¤çš„è¯ï¼Œåˆ™èƒ½ä¿è¯åªè¦æ•°ç»„å¼€å§‹åœ°å€æ—¶å¯¹é½çš„ï¼Œé‚£ä¹ˆæ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¯¹é½çš„ã€‚&lt;/p&gt;

&lt;h1 id=&#34;4-å˜é‡çš„å†…å­˜å¯¹é½æ§åˆ¶&#34;&gt;4. å˜é‡çš„å†…å­˜å¯¹é½æ§åˆ¶&lt;/h1&gt;

&lt;p&gt;GCCæœ‰ä¸€ä¸ªè‡ªå·±çš„æ‰©å±•æ¥æ§åˆ¶å˜é‡çš„å¯¹é½å†…å­˜ï¼Œ&lt;code&gt;__attribute__((aligned()))&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;int __attribute__((aligned(16))) i;                          //(1)
int j __attribute__((aligned(16)));                          //(2)
struct S { short f[3]; } __attribute__ ((aligned (8)));      //(3)
typedef int more_aligned_int __attribute__ ((aligned (8)));  //(4)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;(1)å’Œ(2)å£°æ˜äº†ä¸¤ä¸ªå˜é‡ï¼ŒæŒ‡å®šè¿™ä¸¤ä¸ªå˜é‡çš„å¯¹é½å¤§å°ä¸º16ï¼›(3)å’Œ(4)åˆ™ä½œç”¨ä¸ç±»å‹ï¼Œä½¿å¾—Så’Œ&lt;code&gt;more_aligned_int&lt;/code&gt;ç±»å‹çš„å˜é‡å¯¹é½éƒ½æ˜¯8ã€‚
è¿™ä¸ªå¯¹é½çš„å¤§å°å¯ä»¥ä¸ºä»»æ„2çš„å¹‚æ¬¡æ•°ï¼Œä½†æ˜¯æœ‰æœ€å¤§ä¸Šé™ï¼Œåœ¨æˆ‘çš„x86_64çš„ubuntuä¸Šè¿™ä¸ªå€¼æ˜¯2&lt;sup&gt;28&lt;/sup&gt;ã€‚æŒ‰ç…§GCC&lt;a href=&#34;https://gcc.gnu.org/onlinedocs/gcc-3.3/gcc/Type-Attributes.html&#34;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ä¸­çš„è§£é‡Šï¼Œ
è¿™ä¸ªattributeå¹¶ä¸èƒ½ä¿è¯å˜é‡çš„å¯¹é½ä¸€å®šæ˜¯æŒ‡å®šçš„å¤§å°ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ä¸ªæœ€å°å€¼ã€‚ä½†æ˜¯å®æµ‹çš„æ—¶å€™ï¼Œå¯¹äºæ ‡é‡ï¼Œå…¶æä¾›çš„å€¼å°±æ˜¯æœ€åå¯¹é½çš„å€¼ã€‚å¦‚intçš„è‡ªç„¶å¯¹é½ä¸º4ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨&lt;code&gt;__attribute__&lt;/code&gt;æŒ‡å®šæ—¶ï¼Œæ— è®ºæ—¶&lt;code&gt;1&lt;/code&gt;æˆ–&lt;code&gt;8&lt;/code&gt;
éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯å¯¹äºSï¼ŒæŒ‡å®šå…¶å¯¹é½å¤§å°ä¸º1å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œå…¶ä¾ç„¶æ˜¯2ï¼Œå…¶æŒ‘é€‰äº†ä¸€ä¸ªæŒ‡å®šå€¼ä¸è‡ªç„¶å¯¹é½ä¸­è¾ƒå¤§çš„é‚£ä¸ªã€‚&lt;/p&gt;

&lt;p&gt;C++å¼•å…¥äº†æ–°çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/language/alignas&#34;&gt;alignas&lt;/a&gt;å…³é”®å­—ï¼Œå…¶å¹¶ä¸æ˜¯ç›´æ¥æŒ‡å®šå˜é‡æˆ–ç±»å‹çš„å¯¹é½å€¼ï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ªæœ€ä¸¥æ ¼çš„éœ€æ±‚ã€‚ç”±äºå¯¹é½å€¼æ˜¯è¶Šå¤§è¶Šä¸¥æ ¼çš„ï¼ˆ8å­—èŠ‚å¯¹å…¶çš„ä¸€å®šæ˜¯4å­—èŠ‚å¯¹é½ï¼‰ï¼Œ
å› æ­¤å…¶å®šä¹‰çš„æ˜¯ä¸€ä¸ªä¸Šé™ã€‚åœ¨GCCä¸­ï¼Œæˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™æ²¡æœ‰å‘ç°ä¸&lt;code&gt;__attribute__((aligned()))&lt;/code&gt;çš„åŒºåˆ«ï¼ŒåŒæ ·å¯ä»¥è®¾ç½®intçš„å¯¹é½å€¼ä¸º1ï¼Œå’Œè¯´å¥½çš„ä¸ä¸€æ ·å•Šï¼ˆæ‘”ï¼‰ï¼ä½†æ˜¯åœ¨clangä¸­å°±ç¬¦åˆè¦æ±‚äº†ï¼Œä¼šæç¤º&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;alignment.cpp:15:3: error: requested alignment is less than minimum alignment of 4 for type &#39;int&#39;
  alignas(1) int b;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ‰€ä»¥å¤§å®¶åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±ä¸è¦éšä¾¿å°†ä¸€ä¸ªå˜é‡è®¾ç½®æˆå°äºè‡ªç„¶å¯¹é½çš„å€¼ï¼Œå¦åˆ™å®¹æ˜“å¯¼è‡´è·¨å¹³å°é—®é¢˜ã€‚&lt;/p&gt;

&lt;h1 id=&#34;5-struct&#34;&gt;5. struct&lt;/h1&gt;

&lt;p&gt;structä¸æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ•°æ®ç±»å‹ã€‚è¿™é‡Œæœ‰ESRçš„&lt;a href=&#34;http://www.catb.org/esr/structure-packing/&#34;&gt;ä¸€ç¯‡æ–‡ç« &lt;/a&gt;ï¼Œæœ¬æ–‡ç®€å•çš„æ€»ç»“ä¸€èµ·ä»–çš„æ„æ€ã€‚
structä¸­çš„å…ƒç´ å¹¶ä¸æ˜¯ç´§è‡´æ’åˆ—çš„ï¼Œä¸ºäº†ä¿è¯æ¯ä¸ªæˆå‘˜éƒ½æ˜¯å¯¹é½çš„ï¼Œç¼–è¯‘å™¨ä¼šåœ¨structä¸­çš„å…ƒç´ ä¹‹é—´æ’å…¥padï¼Œä¾‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo1 {
    char *p;
    char c;
    long x;
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‡è®¾åœ¨64bitçš„æœºå™¨ä¸Šï¼Œé‚£ä¹ˆfoo1çš„å¯¹é½å€¼ä¸º8ï¼Œè¿™ä¸ªå€¼å…¶å®å°±æ˜¯æ‰€æœ‰æˆå‘˜å˜é‡ä¸­å¯¹é½å€¼æœ€å¤§çš„é‚£ä¸ªï¼ˆä¸€æ—¦æ»¡è¶³æœ€å¤§çš„é‚£ä¸ªéœ€æ±‚ï¼Œå…¶ä»–å°±éƒ½èƒ½æ»¡è¶³äº†ï¼‰ï¼Œå°±æ˜¯&lt;code&gt;char *p&lt;/code&gt;ã€‚ä¸ºäº†ä¿è¯æ‰€æœ‰æˆå‘˜éƒ½æ˜¯å¯¹é½çš„ï¼Œç¼–è¯‘å™¨ä¼š
è°ƒæ•´å†…å­˜å¸ƒå±€ï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo1 {
    char *p;     /* 8 bytes */
    char c;      /* 1 byte  */
    char pad[7]; /* 7 bytes */
    long x;      /* 8 bytes */
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äº&lt;code&gt;long&lt;/code&gt;æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œè€Œ&lt;code&gt;char&lt;/code&gt;æ˜¯1å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥æ’å…¥äº†7ä¸ªcharä»¥ä¿è¯éƒ½æ˜¯å¯¹é½çš„ã€‚
åœ¨ä¸Šé¢æˆ‘ä»¬è¯´åˆ°ï¼Œæ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ éƒ½æ˜¯å¯¹é½çš„ï¼Œå¯¹äºstructä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo4 {
    short s;     /* 2 bytes */
    char c;      /* 1 byte */
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;foo4çš„å¯¹é½å€¼ä¸º2ï¼Œä½†æ˜¯å…¶sizeä¸º3ï¼Œè¿™æ ·æ”¾åˆ°æ•°ç»„ä¸­ä¸æ˜¯å¯¹é½çš„ã€‚æ‰€ä»¥ï¼Œä¸ºäº†è¾¾åˆ°éœ€æ±‚ï¼Œç¼–è¯‘å™¨ä¼šåœ¨structçš„æœ«å°¾æ’å…¥ç©ºç™½ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;struct foo4 {
    short s;     /* 2 bytes */
    char c;      /* 1 byte */
    char pad[1];
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å…¶sizeä¸º4ï¼Œå°±èƒ½æ»¡è¶³éœ€æ±‚äº†ã€‚ä»¥ä¸Šçš„è¦æ±‚å¯¹äºåµŒå¥—çš„structä¹Ÿæ˜¯éœ€è¦æ»¡è¶³çš„ã€‚&lt;/p&gt;

&lt;p&gt;ç„¶è€Œæˆ‘ä»¬åœ¨ç¼–ç æ—¶å¾€å¾€éœ€è¦ç¼–è¯‘å™¨ä¿è¯structæˆå‘˜æ—¶ç´§å¯†ç›¸è¿çš„ï¼Œè¿™æ ·å¯ä»¥ç²¾ç¡®æ§åˆ¶å†…å­˜çš„layoutã€‚ç°ä»£ç¼–è¯‘å™¨ä¸€èˆ¬éƒ½æä¾›&lt;code&gt;#pragma pack&lt;/code&gt;è¯­å¥æ¥å®Œæˆè¿™ä¸€ç›®çš„ã€‚
ä¸€æ—¦å®šä¹‰äº†packï¼Œé‚£ä¹ˆåé¢æ‰€æœ‰çš„structéƒ½è¦æ»¡è¶³è¿™ä¸ªå…¶éœ€æ±‚ã€‚å…¶ä¿è¯æˆå‘˜å˜é‡çš„å¯¹é½å€¼å–è‡ªç„¶å¯¹é½å¤§å°å’Œpackä¸­çš„è¾ƒå°å€¼ã€‚æ‰€ä»¥å¯¹äºä»¥ä¸‹ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#pragma pack(1)
struct S1 {
    char a;
    long b;
};
#pragma pack()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¦‚æœæ²¡æœ‰packï¼Œç¼–è¯‘å™¨ä¼šåœ¨å…¶ä¸­æ’å…¥7ä¸ªå­—èŠ‚çš„padï¼Œæœ€åçš„sizeä¸º16å­—èŠ‚ã€‚æœ‰äº†packä¹‹åï¼Œlong bçš„å¯¹é½å€¼æˆäº†1ï¼Œé‚£ä¹ˆå°±æ˜¯ç´§å‡‘æ’åˆ—äº†ï¼Œ sizeä¸º9å­—èŠ‚ã€‚å¦‚æœä»¬å°†1æ”¹æˆ2å‘¢ï¼Ÿ
æ­¤æ—¶long bçš„å¯¹é½å€¼ä¸º2ï¼Œé‚£ä¹ˆæ’å…¥ä¸€ä¸ªpadï¼Œsizeä¸º10å­—èŠ‚ã€‚å¦‚æœpackçš„å€¼ä¸º16å‘¢ï¼Ÿç”±äºå…¶è¶…è¿‡äº†longçš„alignå€¼8ï¼Œé‚£ä¹ˆä¿æŒlongçš„è‡ªç„¶å¯¹é½å°±å¥½äº†ï¼Œæœ€ç»ˆçš„å€¼sizeä¸º16ã€‚&lt;/p&gt;

&lt;p&gt;é¡ºä¾¿è¯´ä¸€å¥ï¼Œpackä»…ä»…å¯¹structå’Œclassæœ‰æ•ˆï¼Œä¸€æ—¦è®¾ç½®åï¼Œå¯¹äºåé¢æ‰€æœ‰çš„struct/classéƒ½ç”Ÿæ•ˆï¼Œé™¤éä½¿ç”¨ç©ºçš„&lt;code&gt;pack()&lt;/code&gt;å–æ¶ˆï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨çš„æ—¶å€™å¾€å¾€åœ¨structçš„å®šä¹‰
å‰åéƒ½å†™ä¸Šé¢„å¤„ç†è¯­å¥ã€‚é™¤æ­¤è¿˜æœ‰&lt;code&gt;push&lt;/code&gt;å’Œ&lt;code&gt;pop&lt;/code&gt;ï¼Œå…¶ä½œç”¨ä¸&lt;code&gt;pack&lt;/code&gt;ç›¸åŒï¼Œåªæ˜¯ä¿å­˜äº†å†å²çºªå½•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#pragma pack(push, 1)
struct A {
  char c;
  double lf;
#pragma pack(push, 2)
  struct C {
    char e;
    double f;
    char s;
  } e;
#pragma pack(pop)
};
#pragma pack(pop)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶sizeä¸º&lt;code&gt;21 = 1(char) + 8(double) + 1(pad) + 1(char) + 1(pad) + 8(double) + 1(char) + 1(pad)&lt;/code&gt;ã€‚&lt;/p&gt;

&lt;h1 id=&#34;6-æ€»ç»“&#34;&gt;6. æ€»ç»“&lt;/h1&gt;

&lt;p&gt;alignåœ¨å®é™…å¼€å‘ä¸­åº”ç”¨å¾—å¹¶ä¸å¤šï¼Œä½†æ˜¯å½“æˆ‘ä»¬äº†è§£å…¶åŸç†ï¼Œå°±èƒ½æ›´å¥½åœ°ä¼˜åŒ–structæˆ–ç±»çš„ç»“æ„ï¼Œå‡å°‘æ— è°“çš„padï¼Œä»è¾¾åˆ°å‡å°‘å†…å­˜å ç”¨çš„ç›®çš„ã€‚é™¤æ­¤åªç©ï¼Œå½“ç¼–å†™æŸäº›éœ€è¦ä¸¥æ ¼æ§åˆ¶å†…å­˜
layoutçš„æ—¶å€™ï¼Œpackèƒ½è®©æˆ‘ä»¬æ›´å¥½åœ°æ§åˆ¶äº§å‡ºçš„ä»£ç ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>ç†è§£Linuxä¸‹åŠ¨æ€é“¾æ¥åº“å»¶è¿Ÿç»‘å®š</title>
      <link>http://sysfork.com/post/linux-dynamic-lib-lazy-load/</link>
      <pubDate>Wed, 07 Sep 2016 22:08:20 +0800</pubDate>
      
      <guid>http://sysfork.com/post/linux-dynamic-lib-lazy-load/</guid>
      <description>&lt;script src=&#34;//cdn.bootcss.com/highlight.js/9.6.0/languages/x86asm.min.js&#34;&gt;&lt;/script&gt;

&lt;p&gt;åœ¨ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“æ—¶ï¼Œä¸ºäº†ä¿è¯èƒ½è¢«æ­£å¸¸ä½¿ç”¨ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šåŠ ä¸Š-fPICå‚æ•°ã€‚åœ¨ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°æ—¶ï¼ŒLinuxä½¿ç”¨äº†ä¸€ç§
å«å»¶è¿Ÿç»‘å®šçš„æŠ€æœ¯å®ç°è¿è¡Œæ—¶çš„symbol relocationã€‚å…¶ä¸­çš„å…³é”®å°±æ˜¯GOT(Global Offset Table)å’ŒPLT(Procedure linkage Table)ã€‚ä¸‹é¢å°±
è¿™ä¸€æŠ€æœ¯çš„å®ç°ç®€å•è§£é‡Šä¸€ä¸‹ã€‚&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå†™ä¸€ä¸ªå¾ˆç®€å•çš„éœ€è¦åŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;//dl_test.c
#include &amp;lt;stdio.h&amp;gt;
int main(int argc, const char *argv[])
{
    puts(&amp;quot;1234&amp;quot;);
    puts(&amp;quot;1234&amp;quot;);
    return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åä½¿ç”¨&lt;code&gt;gcc&lt;/code&gt;ç¼–è¯‘å¹¶é“¾æ¥: &lt;code&gt;gcc -g dl_test.c -o dl_test.c&lt;/code&gt;ã€‚å…ˆåˆ«æ€¥ç€è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæˆ‘ä»¬ä½¿ç”¨&lt;code&gt;objdump&lt;/code&gt;åç¼–è¯‘ä¸€ä¸‹çœ‹çœ‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ objdump -S dl_test
......
0000000000400506 &amp;lt;main&amp;gt;:
#include &amp;lt;stdio.h&amp;gt;
int main(int argc, const char *argv[])
{
  400506:       55                      push   %rbp
  400507:       48 89 e5                mov    %rsp,%rbp
  40050a:       48 83 ec 10             sub    $0x10,%rsp
  40050e:       89 7d fc                mov    %edi,-0x4(%rbp)
  400511:       48 89 75 f0             mov    %rsi,-0x10(%rbp)
    puts(&amp;quot;1234&amp;quot;);
  400515:       bf b4 05 40 00          mov    $0x4005b4,%edi
  40051a:       e8 c1 fe ff ff          callq  4003e0 &amp;lt;puts@plt&amp;gt;
    puts(&amp;quot;1234&amp;quot;);
  40051f:       bf b4 05 40 00          mov    $0x4005b4,%edi
  400524:       e8 b7 fe ff ff          callq  4003e0 &amp;lt;puts@plt&amp;gt;
    return 0;
  400529:       b8 00 00 00 00          mov    $0x0,%eax
}
  40052e:       c9                      leaveq
  40052f:       c3                      retq
......
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œåœ¨&lt;code&gt;40051a&lt;/code&gt;å’Œ&lt;code&gt;400524&lt;/code&gt;ä¸¤å¤„éƒ½è°ƒç”¨äº†æˆ‘ä»¬çš„&lt;code&gt;puts&lt;/code&gt;å‡½æ•°ã€‚ä½†æ˜¯çœ‹åé¢çš„æ³¨è§£ï¼Œ&lt;code&gt;&amp;lt;puts@plt&amp;gt;&lt;/code&gt;è¡¨ç¤ºè¿™å¹¶ä¸æ˜¯&lt;code&gt;puts&lt;/code&gt;çš„åœ°å€ï¼Œè€Œæ˜¯å¦æœ‰ç›®çš„ã€‚
æˆ‘ä»¬ä½¿ç”¨&lt;code&gt;gdb&lt;/code&gt;æ¥è·Ÿè¸ªä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ï¼š&lt;code&gt;gdb dl_test&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) l
1	#include &amp;lt;stdio.h&amp;gt;
2	int main(int argc, const char *argv[])
3	{
4	    puts(&amp;quot;1234&amp;quot;);
5	    puts(&amp;quot;1234&amp;quot;);
6	    return 0;
7	}
(gdb) b 4
Breakpoint 1 at 0x400515: file dl_test.c, line 4.
(gdb) r
Starting program: /home/zqc/workspace/cpptest/dl_test

Breakpoint 1, main (argc=1, argv=0x7fffffffeb98) at dl_test.c:4
4	    puts(&amp;quot;1234&amp;quot;);
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œè®¾ç½®äº†ä¸€ä¸‹æ–­ç‚¹åˆ°ç¬¬ä¸€ä¸ª&lt;code&gt;puts&lt;/code&gt;çš„è°ƒç”¨å‡ºï¼Œä½¿ç”¨&lt;code&gt;layout asm&lt;/code&gt;åˆ‡æ¢æˆæ±‡ç¼–æ¨¡å¼:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;(gdb) layout asm
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
B+&amp;gt;â”‚0x400515 &amp;lt;main+15&amp;gt;              mov    $0x4005b4,%edi                                       â”‚
   â”‚0x40051a &amp;lt;main+20&amp;gt;              callq  0x4003e0 &amp;lt;puts@plt&amp;gt;                                  â”‚
   â”‚0x40051f &amp;lt;main+25&amp;gt;              mov    $0x4005b4,%edi                                       â”‚
   â”‚0x400524 &amp;lt;main+30&amp;gt;              callq  0x4003e0 &amp;lt;puts@plt&amp;gt;                                  â”‚
   â”‚0x400529 &amp;lt;main+35&amp;gt;              mov    $0x0,%eax                                            â”‚
   â”‚0x40052e &amp;lt;main+40&amp;gt;              leaveq                                                      â”‚
   â”‚0x40052f &amp;lt;main+41&amp;gt;              retq                                                        â”‚
   â”‚0x400530 &amp;lt;__libc_csu_init&amp;gt;      push   %r15                                                 â”‚
   â”‚0x400532 &amp;lt;__libc_csu_init+2&amp;gt;    mov    %edi,%r15d                                           â”‚
   â”‚0x400535 &amp;lt;__libc_csu_init+5&amp;gt;    push   %r14                                                 â”‚
   â”‚0x400537 &amp;lt;__libc_csu_init+7&amp;gt;    mov    %rsi,%r14                                            â”‚
   â”‚0x40053a &amp;lt;__libc_csu_init+10&amp;gt;   push   %r13                                                 â”‚
   â”‚0x40053c &amp;lt;__libc_csu_init+12&amp;gt;   mov    %rdx,%r13                                            â”‚
   â”‚0x40053f &amp;lt;__libc_csu_init+15&amp;gt;   push   %r12                                                 â”‚
   â”‚0x400541 &amp;lt;__libc_csu_init+17&amp;gt;   lea    0x2001a0(%rip),%r12        # 0x6006e8                â”‚
   â”‚0x400548 &amp;lt;__libc_csu_init+24&amp;gt;   push   %rbp                                                 â”‚
   â”‚0x400549 &amp;lt;__libc_csu_init+25&amp;gt;   lea    0x2001a0(%rip),%rbp        # 0x6006f0                â”‚
   â”‚0x400550 &amp;lt;__libc_csu_init+32&amp;gt;   push   %rbx                                                 â”‚
   â”‚0x400551 &amp;lt;__libc_csu_init+33&amp;gt;   sub    %r12,%rbp                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
child process 8855 In: main                                              Line: 4    PC: 0x400515
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½¿ç”¨&lt;code&gt;stepi&lt;/code&gt;æˆ–è€…ç®€å†™ä¸º&lt;code&gt;si&lt;/code&gt;æ‰§è¡Œä¸‹ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤ã€‚æˆ‘ä»¬ä¸€ç›´è·Ÿè¸ªåˆ°&lt;code&gt;call&lt;/code&gt;æŒ‡ä»¤ä¸­å»ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  &amp;gt;â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)   # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;              â”‚
   â”‚0x4003e6 &amp;lt;puts@plt+6&amp;gt;                   pushq  $0x0                                                     â”‚
   â”‚0x4003eb &amp;lt;puts@plt+11&amp;gt;                  jmpq   0x4003d0                                                 â”‚
   â”‚0x4003f0 &amp;lt;__libc_start_main@plt&amp;gt;        jmpq   *0x200502(%rip)   # 0x6008f8 &amp;lt;__libc_start_main@got.plt&amp;gt; â”‚
   â”‚0x4003f6 &amp;lt;__libc_start_main@plt+6&amp;gt;      pushq  $0x1                                                     â”‚
   â”‚0x4003fb &amp;lt;__libc_start_main@plt+11&amp;gt;     jmpq   0x4003d0                                                 â”‚
   â”‚0x400400 &amp;lt;__gmon_start__@plt&amp;gt;           jmpq   *0x2004fa(%rip)   # 0x600900 &amp;lt;__gmon_start__@got.plt&amp;gt;    â”‚
   â”‚0x400406 &amp;lt;__gmon_start__@plt+6&amp;gt;         pushq  $0x2                                                     â”‚
   â”‚0x40040b &amp;lt;__gmon_start__@plt+11&amp;gt;        jmpq   0x4003d0                                                 â”‚
   â”‚0x400410 &amp;lt;_start&amp;gt;                       xor    %ebp,%ebp                                                â”‚
   â”‚0x400412 &amp;lt;_start+2&amp;gt;                     mov    %rdx,%r9                                                 â”‚
   â”‚0x400415 &amp;lt;_start+5&amp;gt;                     pop    %rsi                                                     â”‚
   â”‚0x400416 &amp;lt;_start+6&amp;gt;                     mov    %rsp,%rdx                                                â”‚
   â”‚0x400419 &amp;lt;_start+9&amp;gt;                     and    $0xfffffffffffffff0,%rsp                                 â”‚
   â”‚0x40041d &amp;lt;_start+13&amp;gt;                    push   %rax                                                     â”‚
   â”‚0x40041e &amp;lt;_start+14&amp;gt;                    push   %rsp                                                     â”‚
   â”‚0x40041f &amp;lt;_start+15&amp;gt;                    mov    $0x4005a0,%r8                                            â”‚
   â”‚0x400426 &amp;lt;_start+22&amp;gt;                    mov    $0x400530,%rcx                                           â”‚
   â”‚0x40042d &amp;lt;_start+29&amp;gt;                    mov    $0x400506,%rdi                                           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
child process 9211 In: puts@plt                                                      Line: ??   PC: 0x4003e0
0x00000000004003e0 in puts@plt ()
(gdb)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;0x4003e0&lt;/code&gt;æ˜¯åˆšåˆšè·³è½¬çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯&lt;code&gt;&amp;lt;puts@plt&amp;gt;&lt;/code&gt;ï¼Œä»è¿™ä¸ªåå­—ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªåœ°å€æ˜¯å±äº&lt;code&gt;plt&lt;/code&gt;çš„ã€‚å…ˆè¯´ä¸€ä¸‹&lt;code&gt;plt&lt;/code&gt;çš„ä½œç”¨ï¼Œ&lt;code&gt;plt&lt;/code&gt;çš„å…¨ç§°æ˜¯
è¿‡ç¨‹é“¾æ¥è¡¨ï¼Œæ„æ€å°±æ˜¯å½“è°ƒç”¨ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°æ—¶ï¼Œå…¶è®¿é—®çš„æ˜¯å…¶å®æ˜¯&lt;code&gt;plt&lt;/code&gt;ä¸­çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå®ŒæˆçœŸæ­£çš„è°ƒç”¨ã€‚æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å±äº&lt;code&gt;puts&lt;/code&gt;ä¸­
&lt;code&gt;plt&lt;/code&gt;çš„é¡¹ç›®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;  &amp;gt;â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;     â”‚
   â”‚0x4003e6 &amp;lt;puts@plt+6&amp;gt;                   pushq  $0x0                                                 â”‚
   â”‚0x4003eb &amp;lt;puts@plt+11&amp;gt;                  jmpq   0x4003d0                                             â”‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ &lt;code&gt;0x20050a(%rip)&lt;/code&gt; å³ &lt;code&gt;got&lt;/code&gt;ä¸­çš„åœ°å€ï¼Œåœ¨åˆå§‹æƒ…å†µä¸‹ï¼Œè¯¥é€‰é¡¹ä¸º&lt;code&gt;plt&lt;/code&gt;é¡¹ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ‰€ä»¥æ‰§è¡Œ&lt;code&gt;jmpq   *0x20050a(%rip)&lt;/code&gt; ç›´æ¥ä¼šè¿›å…¥åˆ°
ä¸‹ä¸€æ¡æŒ‡ä»¤&lt;code&gt;pushq&lt;/code&gt;ï¼Œ &lt;code&gt;pushq $0x0&lt;/code&gt;çš„ç›®çš„æ˜¯æŠŠå½“å‰åœ¨ç¬¦å·(&lt;code&gt;puts&lt;/code&gt;)åœ¨&lt;code&gt;.rela.plt&lt;/code&gt;ä¸­çš„indexã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code&gt;readelf&lt;/code&gt;æŒ‡ä»¤çœ‹ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ readelf -r dl_test

Relocation section &#39;.rela.dyn&#39; at offset 0x348 contains 1 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000006008d0  000300000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start__ + 0

Relocation section &#39;.rela.plt&#39; at offset 0x360 contains 3 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
0000006008f0  000100000007 R_X86_64_JUMP_SLO 0000000000000000 puts + 0
0000006008f8  000200000007 R_X86_64_JUMP_SLO 0000000000000000 __libc_start_main + 0
000000600900  000300000007 R_X86_64_JUMP_SLO 0000000000000000 __gmon_start__ + 0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code&gt;puts&lt;/code&gt;çš„indexä¸º0ï¼Œç¬¬ä¸€é¡¹ï¼Œæ‰€ä»¥è¿™é‡Œpushçš„æ˜¯&lt;code&gt;$0x0&lt;/code&gt;ã€‚åŒç†ï¼Œä¸‹é¢çš„&lt;code&gt;__libc_start_main&lt;/code&gt;å°±æ˜¯&lt;code&gt;$0x1&lt;/code&gt;ã€‚ ä¸‹ä¸€è¡Œè¯­å¥æ˜¯&lt;code&gt;jmpq   0x4003d0&lt;/code&gt;ï¼Œè¿™ä¸ªåœ°å€æ˜¯
å›ºå®šçš„ï¼Œæ‰€æœ‰çš„&lt;code&gt;plt&lt;/code&gt;å…¥å£æœ€åä¸€å¥è¯­å¥éƒ½æ˜¯è¿™ä¸ªï¼Œè¿™æ˜¯ä¸ªé€šç”¨çš„è¿‡ç¨‹ã€‚
ç»§ç»­&lt;code&gt;stepi&lt;/code&gt;åˆ°jumpçš„ä½ç½®&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;  &amp;gt;â”‚0x4003d0                                pushq  0x20050a(%rip)        # 0x6008e0                     â”‚
   â”‚0x4003d6                                jmpq   *0x20050c(%rip)        # 0x6008e8                    â”‚
   â”‚0x4003dc                                nopl   0x0(%rax)                                            â”‚
   â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;     â”‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å‘ç°è¿™ä¸ªåœ°å€å°±æ˜¯åœ¨&lt;code&gt;puts@plt&lt;/code&gt;çš„ä¸Šé¢ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯ä¸ºäº†ä¿è¯å’Œæ™®é€š&lt;code&gt;plt&lt;/code&gt;å…¥å£é¡¹ç›®å¤§å°(&lt;code&gt;0x10&lt;/code&gt;)ï¼Œå…¶æœ«å°¾è¿˜ç”¨0è¡¥é½äº†(&lt;code&gt;nopl   0x0(%rax)&lt;/code&gt;)ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹å‰é¢ä¸¤å¥ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;pushq  0x20050a(%rip)        # 0x6008e0&lt;/code&gt;ï¼Œè¿™é‡Œpushäº†ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯å¹²å˜›çš„ï¼Ÿæˆ‘ä»¬ä½¿ç”¨&lt;code&gt;gdb&lt;/code&gt;çœ‹ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) x /16x 0x6008e0
0x6008e0:       0xf7ffe1a8      0x00007fff      0xf7df02b0      0x00007fff
0x6008f0 &amp;lt;puts@got.plt&amp;gt;:        0x004003e6      0x00000000      0xf7a52a50      0x00007fff
0x600900 &amp;lt;__gmon_start__@got.plt&amp;gt;:      0x00400406      0x00000000      0x00000000      0x00000000
0x600910:       0x00000000      0x00000000      0x00000000      0x00000000
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¸ªåœ°å€å…¶å®å°±æ˜¯&lt;code&gt;got&lt;/code&gt;ä¸­çš„ä¸€é¡¹ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰æ™®é€šç¬¦å·&lt;code&gt;got&lt;/code&gt;çš„å‰é¢ã€‚é‚£ä¹ˆç›®å‰æ ˆä¸Šçš„å…ƒç´ æ˜¯ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;| 0x00007ffff7ffe1a8 |
| 0x0                |
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ¥ä¸‹æ¥åˆ°æ˜¯&lt;code&gt;jmpq   *0x20050c(%rip)&lt;/code&gt; è¿™ä¸ªåœ°å€ä¹Ÿæ˜¯åœ¨pltä¸Šï¼Œç´§æŒ¨ç€ä¸Šé¢pushçš„åœ°å€ï¼Œå€¼ä¸º&lt;code&gt;0x00007ffff7df02b0&lt;/code&gt;ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­&lt;code&gt;stepi&lt;/code&gt;è¿›å»ï¼Œä¹Ÿå¯ä»¥
é€šè¿‡&lt;code&gt;disassemble 0x00007ffff7df02b0&lt;/code&gt;æŸ¥çœ‹ã€‚æˆ–è€…ï¼Œä½¿ç”¨&lt;code&gt;info symbol 0x00007ffff7df02b0&lt;/code&gt;ç›´æ¥æŸ¥çœ‹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(gdb) info symbol 0x00007ffff7df02b0
_dl_runtime_resolve in section .text of /lib64/ld-linux-x86-64.so.2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯å±äº&lt;code&gt;ld-linux-x86-64.so.2&lt;/code&gt;é‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•ã€‚è¿™ä¸ªsoå±äº&lt;code&gt;glibc&lt;/code&gt;çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸‹è½½&lt;a href=&#34;ftp://ftp.gnu.org/gnu/glibc&#34;&gt;glibc&lt;/a&gt;æ¥æŸ¥çœ‹ã€‚æœ€ç»ˆæˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ªç¬¦å·å®šä¹‰æ–‡ä»¶ï¼Œ
å…¶ä½ç½®åœ¨&lt;code&gt;sysdeps/x86_64/dl-trampoline.S&lt;/code&gt;ï¼Œå†…å®¹å¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt; 28     .globl _dl_runtime_resolve
 29     .type _dl_runtime_resolve, @function
 30     .align 16
 31     cfi_startproc
 32 _dl_runtime_resolve:
 33     cfi_adjust_cfa_offset(16) # Incorporate PLT
 34     subq $56,%rsp
 35     cfi_adjust_cfa_offset(56)
 36     movq %rax,(%rsp)    # Preserve registers otherwise clobbered.
 37     movq %rcx, 8(%rsp)
 38     movq %rdx, 16(%rsp)
 39     movq %rsi, 24(%rsp)
 40     movq %rdi, 32(%rsp)
 41     movq %r8, 40(%rsp)
 42     movq %r9, 48(%rsp)
 43     movq 64(%rsp), %rsi # Copy args pushed by PLT in register.
 44     movq 56(%rsp), %rdi # %rdi: link_map, %rsi: reloc_index
 45     call _dl_fixup      # Call resolver.
 46     movq %rax, %r11     # Save return value
 47     movq 48(%rsp), %r9  # Get register content back.
 48     movq 40(%rsp), %r8
 49     movq 32(%rsp), %rdi
 50     movq 24(%rsp), %rsi
 51     movq 16(%rsp), %rdx
 52     movq 8(%rsp), %rcx
 53     movq (%rsp), %rax
 54     addq $72, %rsp      # Adjust stack(PLT did 2 pushes)
 55     cfi_adjust_cfa_offset(-72)
 56     jmp *%r11       # Jump to function address.
 57     cfi_endproc
 58     .size _dl_runtime_resolve, .-_dl_runtime_resolve
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»43è¡Œå¼€å§‹æ˜¯æˆ‘ä»¬çš„é€»è¾‘ã€‚43è¡Œå–å‡ºäº†æˆ‘ä»¬åˆšåˆšpushçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯&lt;code&gt;$0x0&lt;/code&gt;ï¼Œæ”¾åˆ°&lt;code&gt;%rsi&lt;/code&gt;ä¸­ï¼Œç„¶åæ˜¯æˆ‘ä»¬pushçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œ&lt;code&gt;0x00007ffff7ffe1a8&lt;/code&gt;åˆ°&lt;code&gt;%rsi&lt;/code&gt;ä¸­ã€‚
ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸¤ä¸ªå¯„å­˜å™¨å‘¢ï¼Ÿæˆ‘ä»¬&lt;code&gt;man syscall&lt;/code&gt;ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;       arch/ABI   arg1   arg2   arg3   arg4   arg5   arg6   arg7
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       x86_64     rdi    rsi    rdx    r10    r8     r9     -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹å‡ºlinuxä¸‹çš„å‡½æ•°ä¼ å‚æ–¹å¼ï¼Œ é‚£ä¹ˆ&lt;code&gt;%rdi&lt;/code&gt;å°±æ˜¯å‚æ•°1ï¼Œè€Œ&lt;code&gt;%rsi&lt;/code&gt;å°±æ˜¯å‚æ•°2äº†ã€‚æ¥ä¸‹æ¥æ˜¯&lt;code&gt;call _dl_fixup&lt;/code&gt;ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›å€¼å°±æ˜¯æŒ‡å‘&lt;code&gt;puts&lt;/code&gt;å­˜å‚¨åœ°å€ä½ç½®çš„æŒ‡é’ˆäº†ï¼Œåé¢å¯ä»¥çœ‹åˆ°
ä»£ç ä¸­å°†è¿™ä¸ªæŒ‡é’ˆä¿å­˜åˆ°äº†&lt;code&gt;%r11&lt;/code&gt;ï¼Œç„¶å&lt;code&gt;jmp *%r11&lt;/code&gt;ã€‚å®Œæˆäº†ä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹&lt;code&gt;_dl_fixup&lt;/code&gt;åšäº†äº›ä»€ä¹ˆã€‚åŒæ ·ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ˜¯&lt;code&gt;gblic&lt;/code&gt;ä¸­å®šä¹‰çš„ï¼Œä½ç½®åœ¨&lt;code&gt;elf/dl-runtime.c&lt;/code&gt;ä¸­ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;59 DL_FIXUP_VALUE_TYPE
60 __attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE
61 _dl_fixup (
62 # ifdef ELF_MACHINE_RUNTIME_FIXUP_ARGS
63        ELF_MACHINE_RUNTIME_FIXUP_ARGS,
64 # endif
65        struct link_map *l, ElfW(Word) reloc_arg)
66 {
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»å‡½æ•°åŸå‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¹‹å‰&lt;code&gt;push&lt;/code&gt;çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯&lt;code&gt;link_map&lt;/code&gt;å’Œ&lt;code&gt;reloc_arg&lt;/code&gt;ï¼Œ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt; 67   const ElfW(Sym) *const symtab
 68     = (const void *) D_PTR (l, l_info[DT_SYMTAB]);
 69   const char *strtab = (const void *) D_PTR (l, l_info[DT_STRTAB]);
 70 
 71   const PLTREL *const reloc
 72     = (const void *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);
 73   const ElfW(Sym) *sym = &amp;amp;symtab[ELFW(R_SYM) (reloc-&amp;gt;r_info)];
 74   void *const rel_addr = (void *)(l-&amp;gt;l_addr + reloc-&amp;gt;r_offset);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œåšäº†ä¸€ä¸‹è½¬å‹ï¼Œé‚£ä¹ˆ&lt;code&gt;symtab&lt;/code&gt;å’Œ&lt;code&gt;strtab&lt;/code&gt;åˆ†åˆ«æ˜¯å¯¹äº&lt;code&gt;section&lt;/code&gt;çš„åœ°å€ï¼Œè€Œ&lt;code&gt;reloc_addr&lt;/code&gt;å°±æ˜¯æˆ‘ä»¬&lt;code&gt;got&lt;/code&gt;ä¸­çš„&lt;code&gt;puts@got.plt&lt;/code&gt;çš„åœ°å€ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç¬¦å·è§£æè¿‡ç¨‹äº†ï¼Œ
åé¢å¯èƒ½ä¼šæœ‰æ–‡ç« æ¥è§£é‡Šè¿™ä¸ªè¿‡ç¨‹ã€‚å½“æ‰¾åˆ°ç›®æ ‡åœ°å€å&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;//elf/dl-runtime.c
148   return elf_machine_fixup_plt (l, result, reloc, rel_addr, value);
//sysdeps/x86_64/dl-machine.h
205 static inline ElfW(Addr)
206 elf_machine_fixup_plt (struct link_map *map, lookup_t t,
207                const ElfW(Rela) *reloc,
208                ElfW(Addr) *reloc_addr, ElfW(Addr) value)
209 {
210   return *reloc_addr = value;
211 }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œçš„&lt;code&gt;value&lt;/code&gt;å°±æ˜¯ç›®æ ‡å‡½æ•°åœ°å€ï¼Œä¹Ÿå°±æ˜¯&lt;code&gt;puts&lt;/code&gt;çš„çœŸæ­£åœ°å€ï¼Œä»£ç ä¸­è®¾ç½®å…¶åˆ°äº†&lt;code&gt;puts@got.plt&lt;/code&gt;çš„ä½ç½®å¹¶è¿”å›ã€‚&lt;/p&gt;

&lt;p&gt;ä»¥ä¸Šå°±æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨&lt;code&gt;puts&lt;/code&gt;çš„è¿‡ç¨‹äº†ï¼Œå½“ç¬¬äºŒæ¬¡è°ƒç”¨&lt;code&gt;puts&lt;/code&gt;æ—¶ï¼Œç”±äº&lt;code&gt;puts@got.plt&lt;/code&gt;å·²ç»æœ‰äº†æ­£ç¡®çš„åœ°å€ï¼Œæ‰€ä»¥&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-x86asm&#34;&gt;  &amp;gt;â”‚0x4003e0 &amp;lt;puts@plt&amp;gt;                     jmpq   *0x20050a(%rip)        # 0x6008f0 &amp;lt;puts@got.plt&amp;gt;    â”‚
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å°±ç›´æ¥è·³è½¬åˆ°æ­£ç¡®çš„&lt;code&gt;puts&lt;/code&gt;ä½ç½®ï¼Œå®Œæˆäº†å‡½æ•°è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œ&lt;code&gt;linux&lt;/code&gt;ä¸‹çš„è¿™ç§æ‡’ç»‘å®šæ–¹å¼å®ç°äº†åœ¨ä¸ä½¿ç”¨ç¬¦å·çš„æ—¶å€™ä¸è§£æï¼Œè€Œéœ€è¦ä½¿ç”¨çš„æ—¶å€™
åªåœ¨ç¬¬ä¸€æ­¥å¼€é”€æ¯”è¾ƒå¤§ï¼Œåé¢çš„è°ƒç”¨å¼€é”€æ— éå¤šäº†ä¸€æ¬¡è·³è½¬å’Œä¸€æ¬¡å¯»å€æ“ä½œè€Œå·²ã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Hugo é›†æˆ Mathjaxå’Œgraphviz</title>
      <link>http://sysfork.com/post/integrate-mathjax-viz-with-hugo/</link>
      <pubDate>Fri, 02 Sep 2016 09:41:17 +0800</pubDate>
      
      <guid>http://sysfork.com/post/integrate-mathjax-viz-with-hugo/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://gohugo.io/&#34;&gt;hugo&lt;/a&gt;æ˜¯ä¸€ä¸ªæ¯”&lt;a href=&#34;https://hexo.io&#34;&gt;hexo&lt;/a&gt;æ›´ç®€å•æ˜“ç”¨çš„é™æ€é¡µé¢ç”Ÿæˆå·¥å…·ï¼Œå…¶åªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²ç¯å¢ƒç®€å•ï¼Œæœ¬åšå®¢å°±æ˜¯åŸºäºhugoæ„å»ºçš„ã€‚&lt;/p&gt;

&lt;p&gt;æˆ‘ä»¬åœ¨å†™åšå®¢çš„æ—¶å€™ç»å¸¸åº”ç”¨åˆ°å…¬å¼å’Œå›¾è¡¨ï¼Œè¿™åˆ†åˆ«å¯ä»¥ä½¿ç”¨&lt;a href=&#34;https://www.mathjax.org/&#34;&gt;mathjax&lt;/a&gt;å’Œ&lt;a href=&#34;https://github.com/mdaines/viz.js&#34;&gt;viz.js&lt;/a&gt;å®ç°ã€‚hugoå¹¶æ²¡æœ‰æä¾›
å†…ç½®çš„æ”¯æŒï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬è‡ªå·±å†™ç›¸å…³çš„æ”¯æŒã€‚&lt;/p&gt;

&lt;p&gt;ç”±äºå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ–‡ç« éƒ½éœ€è¦mathjaxå’Œviz.jsï¼Œæ‰€ä»¥éœ€è¦æŒ‰éœ€ä½¿ç”¨ï¼Œè¿™ä¸ªå¯ä»¥åœ¨æ¯ä¸ªpostçš„å‰è¨€ä¸Šå®šä¹‰&lt;code&gt;plugins&lt;/code&gt;å˜é‡ï¼Œå¦‚ä¸‹&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;title = &amp;quot;Hugo é›†æˆ Mathjaxå’Œgraphviz&amp;quot;
plugins = [&amp;quot;mathjax&amp;quot;, &amp;quot;viz&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶åå†&lt;code&gt;partials&lt;/code&gt;ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª&lt;code&gt;post_plugins.html&lt;/code&gt;ï¼Œå¹¶åœ¨&lt;code&gt;post/single.html&lt;/code&gt;å¼•å…¥è¿™ä¸ªæ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  {{ partial &amp;quot;post_plugins.html&amp;quot; . }}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;post_plugins.html&lt;/code&gt;æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{{ if isset .Params &amp;quot;plugins&amp;quot; }}
    {{ range .Params.plugins }}
        {{ $path := . | printf &amp;quot;post_plugins/%s.html&amp;quot;}}
        {{ partial $path }}
    {{ end }}
{{ end }}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é€»è¾‘å³é€šè¿‡ä¾¿åˆ©&lt;code&gt;plugins&lt;/code&gt;å‚æ•°å†…å®¹ï¼Œç„¶åå¼•å…¥å¯¹åº”çš„htmlæ–‡ä»¶ã€‚åœ¨ç›®å‰çš„è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†mathjaxå’Œvizã€‚å…¶ä¸­&lt;code&gt;post_plugins/mathjax.html&lt;/code&gt;çš„å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;script type=&amp;quot;text/javascript&amp;quot; src=&amp;quot;//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML&amp;quot;&amp;gt; &amp;lt;/script&amp;gt;
&amp;lt;script type=&amp;quot;text/x-mathjax-config&amp;quot;&amp;gt;
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [[&#39;$&#39;,&#39;$&#39;], [&#39;\\(&#39;,&#39;\\)&#39;]],
    displayMath: [[&#39;$$&#39;,&#39;$$&#39;], [&#39;\[&#39;,&#39;\]&#39;]],
    processEscapes: true,
    processEnvironments: true,
    skipTags: [&#39;script&#39;, &#39;noscript&#39;, &#39;style&#39;, &#39;textarea&#39;, &#39;pre&#39;],
    TeX: { equationNumbers: { autoNumber: &amp;quot;AMS&amp;quot; },
         extensions: [&amp;quot;AMSmath.js&amp;quot;, &amp;quot;AMSsymbols.js&amp;quot;] }
  }
});
MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i = 0; i &amp;lt; all.length; i += 1) {
      all[i].SourceElement().parentNode.className += &#39; has-jax&#39;;
  }
});
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·æˆ‘ä»¬å°±èƒ½ä½¿ç”¨&lt;code&gt;\$&lt;/code&gt;æˆ–&lt;code&gt;\$\$&lt;/code&gt;æ¥ç¼–å†™å…¬å¼äº†ï¼Œæœ€ç»ˆç¤ºä¾‹è¡¨ç°å¦‚ä¸‹ï¼š
$$ [ \left [ &amp;#8211; \frac{\hbar^2}{2 m} \frac{\partial^2}{\partial x^2} + V \right ] \Psi = i \hbar \frac{\partial}{\partial t} \Psi ]$$&lt;/p&gt;

&lt;p&gt;å¯¹äº&lt;code&gt;post_plugins/viz.html&lt;/code&gt;å†…å®¹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;script type=&amp;quot;text/javascript&amp;quot; src=&amp;quot;//cdn.bootcss.com/viz.js/1.3.0/viz.js&amp;quot;&amp;gt; &amp;lt;/script&amp;gt;
&amp;lt;script type=&amp;quot;text/javascript&amp;quot;&amp;gt;
(function(){
    var vizPrefix = &amp;quot;language-viz-&amp;quot;;
    Array.prototype.forEach.call(document.querySelectorAll(&amp;quot;[class^=&amp;quot; + vizPrefix + &amp;quot;]&amp;quot;), function(x){
        var engine;
        x.getAttribute(&amp;quot;class&amp;quot;).split(&amp;quot; &amp;quot;).forEach(function(cls){
            if (cls.startsWith(vizPrefix)) {
                engine = cls.substr(vizPrefix.length);
            }
        });
        var image = new DOMParser().parseFromString(Viz(x.innerText, {format:&amp;quot;svg&amp;quot;, engine:engine}), &amp;quot;image/svg+xml&amp;quot;);
        x.parentNode.insertBefore(image.documentElement, x);
        x.style.display = &#39;none&#39;
    });
})();
&amp;lt;/script&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»£ç çš„ä½œç”¨ï¼Œå°±æ˜¯å°†codeblockç±»å‹ä¸ºlanguage-viz-xxxçš„è‡ªåŠ¨æ¸²æŸ“ä¸ºsvgå›¾åƒæ˜¾ç¤ºï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹ï¼š&lt;/p&gt;

&lt;p&gt;åŸå§‹å†…å®¹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    ```viz-dot
    digraph g { a -&amp;gt; b; }
    ```

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¾“å‡ºç»“æœï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-viz-dot&#34;&gt;    digraph g { a -&amp;gt; b; }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;åŒç†ï¼Œå¯¹äºå…¶ä»–éœ€è¦ç‰¹æ®Šæ”¯æŒçš„æ ¼å¼æˆ–è¡¨ç°ï¼Œéƒ½å¯ä»¥é€šè¿‡æ·»åŠ post_pluginsæ¥å®ç°ã€‚ä»¥ä¸Šä»£ç éƒ½åœ¨æœ¬ç½‘ç«™çš„&lt;a href=&#34;https://github.com/usbuild/site.git&#34;&gt;github&lt;/a&gt;ä¸Šã€‚&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Lua Tableä¸­HashMapä»‹ç»</title>
      <link>http://sysfork.com/post/lua-hashtable-introduction/</link>
      <pubDate>Thu, 01 Sep 2016 17:40:08 +0800</pubDate>
      
      <guid>http://sysfork.com/post/lua-hashtable-introduction/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://www.lua.org/pil/2.5.html&#34;&gt;Table&lt;/a&gt; åœ¨Luaä¸­æœ‰ç€æå…¶é‡è¦çš„åº”ç”¨ï¼Œä»æ ¸å¿ƒè¯­è¨€å®ç°ï¼Œå¦‚&lt;a href=&#34;https://en.wikipedia.org/wiki/String_interning&#34;&gt;short string intern&lt;/a&gt;ï¼Œ
åˆ°åˆ©ç”¨&lt;a href=&#34;https://www.lua.org/pil/13.html&#34;&gt;metatable&lt;/a&gt;å®ç°çš„&lt;a href=&#34;lua-users.org/wiki/LuaClassesWithMetatable&#34;&gt;class&lt;/a&gt;ï¼Œtableå‡ ä¹æ— æ‰€ä¸èƒ½ã€‚å¦‚æ­¤é«˜é¢‘åº¦åœ°åˆ©ç”¨ä¹Ÿå°±æ„å‘³ç€luaå¿…é¡»è¦æœ‰ä¸€ä¸ªé«˜æ•ˆçš„
tableå®ç°ã€‚&lt;/p&gt;

&lt;p&gt;å¾ˆå¤šè¯­è¨€æä¾›äº†arrayå’Œassociative arrayä¸¤ç§æ•°æ®ç»“æ„ã€‚arrayæ˜¯æŒ‡ä»¥æŸä¸ªæŒ‡å®šçš„æœ€å°æ•´æ•°ä¸‹æ ‡(ä¸€èˆ¬æ˜¯0)å¼€å§‹çš„è¿ç»­å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œå®ƒæœ‰vectorã€listã€arrayã€ArrayListç­‰å¤šç§åç§°ï¼›associative arrayï¼Œä¸­æ–‡
ä¹Ÿå«å…³è”æ•°ç»„ï¼Œå³å°†ä¸€å¯¹key/pairä¹‹é—´å…³è”èµ·æ¥ï¼Œå®ƒä¸€èˆ¬ä¹Ÿè¢«ç§°ä¸ºmapã€dictç­‰ã€‚Luaå¹¶ä¸æä¾›arrayï¼Œå› ä¸ºæ•°ç»„æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„å…³è”æ•°ç»„ã€‚ä½†æ˜¯ä»å†…éƒ¨è¡¨ç¤ºä¸Šï¼Œarrayå’Œmapæœ‰ç€æå¤§çš„ä¸åŒï¼Œarrayåªéœ€è¦ä¸€å—è¿ç»­çš„
å†…å­˜å³å¯å®ç°ï¼Œè€Œmapåˆ™æœ‰å¤šç§å®ç°ã€‚Luaä¸ºäº†æ•ˆç‡ï¼Œå°†ä¸€éƒ¨åˆ†æ•´æ•°ä¸‹æ ‡çš„å…ƒç´ å­˜å‚¨åœ¨array partä¸­ï¼Œè€Œå°†å…¶ä»–å…ƒç´ å­˜å‚¨åœ¨hashmapä¸­ï¼Œå®ç°åœ¨å¤–éƒ¨æ¥å£ä¸å˜çš„æƒ…å†µä¸‹å®ç°äº†æ•ˆç‡çš„æœ€å¤§åŒ–ã€‚arrayéƒ¨åˆ†æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«éœ€è¦
ä¼˜åŒ–çš„ï¼Œå…¶å°±æ˜¯ä¸€æ•´å—è¿ç»­çš„å†…å­˜ï¼Œå­˜å‚¨å’Œè¯»å–çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼Œè€Œhashmapçš„å®ç°ç§°ä¸ºäº†lua tableè®¾è®¡çš„é‡ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;mapæœ‰å¤šç§å®ç°æ‰‹æ®µï¼Œåœ¨stlä¸­ï¼Œé»˜è®¤çš„mapä½¿ç”¨çš„æ˜¯çº¢é»‘æ ‘ï¼Œå­˜å‚¨å’Œè¯»å–çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(logn)ï¼›è™½ç„¶çº¢é»‘æ ‘çš„è¡¨ç°ååˆ†ç¨³å®šï¼Œä½†æ˜¯å®ç°æ¯”è¾ƒå¤æ‚è€Œä¸”æ— æ³•æ»¡è¶³æç«¯æ€§èƒ½è¦æ±‚ï¼Œ
C++11ä¸­æ·»åŠ æ–°çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/container/unordered_map&#34;&gt;unordered_map&lt;/a&gt;ï¼Œå…¶å®ç°å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªhashmapã€‚hashmapçš„åŸºæœ¬æµç¨‹æ˜¯ä½¿ç”¨ä¸€ä¸ªhashå‡½æ•°æ¥å°†
ä¸€ä¸ªkeyæ˜ å°„åˆ°ä¸€å—è¿ç»­å†…å­˜ä¸­ï¼Œå®ç°åœ¨ç†æƒ³æƒ…å†µä¸‹è®¿é—®å’Œåˆ é™¤æ¥è¿‘O(1)çš„æ—¶é—´å¤æ‚åº¦ã€‚&lt;/p&gt;

&lt;p&gt;ç”±äºä¸€èˆ¬keyçš„å–å€¼èŒƒå›´å¤§äºhashmap slotæ•°ç›®ï¼Œæ‰€ä»¥ä¸å¯é¿å…åœ°å‡ºç°å†²çªçš„çŠ¶å†µã€‚åœ¨æ•™ç§‘ä¹¦ä¸­ï¼Œè§£å†³è¿™ç§å†²çªä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š&lt;a href=&#34;https://en.wikipedia.org/wiki/Hash_table#Separate_chaining&#34;&gt;é“¾è¡¨æ³•&lt;/a&gt;
å’Œ&lt;a href=&#34;https://en.wikipedia.org/wiki/Open_addressing&#34;&gt;å¼€æ”¾å¯»å€æ³•&lt;/a&gt;ã€‚é“¾è¡¨æ³•çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå°†å†²çªçš„å…ƒç´ ä½¿ç”¨é“¾è¡¨é“¾æ¥èµ·æ¥å³å¯ï¼›è€Œå¼€æ”¾å¯»å€æ³•åˆ™éœ€è¦å¤šæ¬¡è®¡ç®—ï¼Œç›´è‡³æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰å†²çªçš„slotä¸ºæ­¢ã€‚
è¿™ä¸¤è€…éƒ½æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œé“¾è¡¨æ³•ç”±äºä½¿ç”¨äº†é“¾è¡¨ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨CPUç¼“å­˜ï¼Œå¹¶ä¸”å®ç°æ·±æ‹·è´éš¾åº¦è¾ƒå¤§ï¼›è€Œå¼€æ”¾å¯»å€æ³•æ— æ³•å®ç°åˆ é™¤å…ƒç´ çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å½“å…ƒç´ å¯†åº¦æ¯”è¾ƒå¤§æ—¶ï¼Œæ•ˆç‡éå¸¸ä½ã€‚&lt;/p&gt;

&lt;p&gt;Lua tableä½¿ç”¨äº†ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆï¼Œå«åš&lt;a href=&#34;https://en.wikipedia.org/wiki/Coalesced_hashing&#34;&gt;Coalesced_hashing&lt;/a&gt;ï¼Œç»“åˆä½¿ç”¨äº†é“¾è¡¨æ³•å’Œå¼€æ”¾å¯»å€æ³•ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/4/4c/CoalescedHash.jpg&#34; alt=&#34;Coalesced_hashing&#34; /&gt;&lt;/p&gt;

&lt;p&gt;å½“æ’å…¥ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®šä¹‰å…¶åŸæœ¬åº”è¯¥åœ¨çš„ä½ç½®ä¸ºmainpositionï¼Œå¦‚æœmainpoisitionå¯¹åº”çš„slotæ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥æ’å…¥ï¼›å¦‚æœéç©ºï¼Œçœ‹çœ‹åœ¨é‚£ä¸ªä½ç½®ä¸Šçš„å…ƒç´ çš„mainpositionæ˜¯ä¸æ˜¯å½“å‰çš„slotï¼Œå¦‚æœä¸æ˜¯çš„
è¯ï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ°ä»»æ„ä¸€ä¸ªç©ºçš„slot(ä½ç½®A)ï¼Œç„¶åå°†å½“å‰çš„å…ƒç´ æ’å…¥åˆ°mainpositionä½ç½®ï¼Œå¹¶å°†å½“å‰çš„nextå­—æ®µè®¾ç½®æˆä½ç½®Aï¼Œå½¢æˆé“¾è¡¨ã€‚å¦‚æœå ç”¨å…ƒç´ mainpositionå°±æ˜¯å½“å‰ä½ç½®ï¼Œåˆ™å°†å¾…æ’å…¥çš„
å…ƒç´ æ’å…¥åˆ°ä»»æ„ä¸€ä¸ªç©ºçš„ä½ç½®ä¸Šï¼Œå¹¶é“¾æ¥åˆ°å ç”¨å…ƒç´ çš„åé¢ã€‚&lt;/p&gt;

&lt;p&gt;é€šè¿‡ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå®ç°äº†æ‰€æœ‰çš„å…ƒç´ éƒ½å°½é‡ä¿å­˜åœ¨mainpositionä¸Šï¼Œå½“æŸ¥æ‰¾çš„æ—¶å€™ä¹Ÿèƒ½ä½¿ç”¨æ›´å°‘çš„æ¬¡æ•°æ¥æ‰¾åˆ°å…ƒç´ ä½ç½®ã€‚è¿™å¯¹å…ƒç´ æœ¬æ¥å°±åœ¨hashmapä¸­ï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒé«˜çš„ã€‚ä½†æ˜¯ï¼Œå½“å…ƒç´ ä¸åœ¨hashmapä¸­ï¼ŒæŸ¥æ‰¾çš„ä»£ä»·
æ¯”è¾ƒé«˜ã€‚&lt;/p&gt;

&lt;p&gt;lua tableçš„ä»£ç å®ç°åœ¨&lt;a href=&#34;https://www.lua.org/source/5.3/ltable.c.html&#34;&gt;è¿™é‡Œ&lt;/a&gt;ï¼Œå®ç°éå¸¸ç®€æ´æ˜äº†ï¼Œä¹Ÿä¸æ˜¯å¾ˆéš¾æ‡‚ï¼Œä½†æ˜¯å¯¹äºå¹³æ—¶ç»å¸¸ä½¿ç”¨luaçš„åŒå­¦æ¥è¯´è¯»ä¸€è¯»è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>