<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>ä¸€ç§åœ¨elfä¸­é›†æˆè„šæœ¬æ–‡ä»¶çš„æ–¹æ¡ˆ &middot; sysğŸ”±fork</title>

  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://sysfork.com/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://sysfork.com/css/blackburn.css">

  
  <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  

  
  

  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.4.0/styles/gruvbox-light.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.4.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://sysfork.com/img/favicon.ico" type="image/x-icon" />

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://sysfork.com/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/usbuild" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/usbuild" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>ä¸€ç§åœ¨elfä¸­é›†æˆè„šæœ¬æ–‡ä»¶çš„æ–¹æ¡ˆ</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>01 May 2017, 22:30</time>
  </div>

  

  
  
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/elf">elf</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="http://sysfork.com/tags/lua">lua</a>
    
  </div>
  
  

</div>

  

<p>è¿›è¡Œæ¸¸æˆæœåŠ¡å™¨å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å°†<code>C++</code>çš„éƒ¨åˆ†ç§°ä¹‹ä¸ºå¼•æ“å±‚ï¼Œè€Œ<code>lua</code>ç§°ä¹‹ä¸ºè„šæœ¬å±‚ã€‚ä½†æ˜¯å¾€å¾€æœ‰äº›æ ¸å¿ƒé€»è¾‘æ˜¯å„ä¸ªæ¸¸æˆå…¬ç”¨çš„ï¼Œ
æˆ–è€…è¯´æœ‰äº›å¼•æ“å±‚çš„ä»£ç ç”¨<code>C++</code>å†™èµ·æ¥ååˆ†éº»çƒ¦ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šä½¿ç”¨<code>lua</code>æ¥ç¼–å†™ã€‚è¿™å°±å¸¦æ¥äº†ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬çš„æ¸¸æˆç›®å½•ç»“æ„å¦‚ä¸‹:</p>

<pre><code>â”œâ”€bin               // å¯æ‰§è¡Œæ–‡ä»¶
â””â”€scripts           // è„šæœ¬ç›®å½•ï¼Œluaæ–‡ä»¶
    â”œâ”€framework     // æ ¸å¿ƒluaæ–‡ä»¶ï¼Œå„ä¸ªé¡¹ç›®å…¬ç”¨çš„
    â””â”€server        // æ¸¸æˆé€»è¾‘luaæ–‡ä»¶
</code></pre>

<p>å…¶ä¸­<code>scripts/framework</code>æ˜¯å„ä¸ªé¡¹ç›®å…¬ç”¨çš„ï¼Œå¹¶ä¸”å’Œ<code>bin</code>ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶åŒæ—¶å‘å¸ƒå’Œæ›´æ–°ã€‚æ‰€ä»¥æœ‰ä¸€ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯å°†<code>framework</code>ä¸­
çš„luaæ–‡ä»¶é›†æˆåˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå‡å°‘ç»´æŠ¤çš„æˆæœ¬ã€‚</p>

<h1 id="æ–‡ä»¶å­˜å‚¨">æ–‡ä»¶å­˜å‚¨</h1>

<p>ä¸‹é¢æ˜¯elfæ–‡ä»¶çš„ç¤ºæ„å›¾</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/77/Elf-layout--en.svg/260px-Elf-layout--en.svg.png" alt="elf" /></p>

<p>elfæ–‡ä»¶æœ‰å¤šä¸ªsectionï¼Œé™¤äº†ä¸€äº›é¢„å®šä¹‰çš„sectionå¦‚<code>.rodata</code>ã€<code>.text</code>ã€<code>.init</code>ç­‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€äº›è‡ªå·±çš„sectionã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†æ‰€éœ€è¦çš„luaæ–‡ä»¶
æ”¾è¿›è¿™ä¸ªsectionä¸­ï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™åŠ¨æ€è¯»å‡ºæ¥ï¼Œå®ç°ç›®çš„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="https://linux.die.net/man/1/objcopy">objcopy</a>å‘½ä»¤æ¥å®ç°åˆ›å»ºè‡ªå®šä¹‰sectionçš„åŠŸèƒ½ã€‚</p>

<pre><code>objcopy infile.out --add-section .lua-data=section_file outfile.out
</code></pre>

<p>ç„¶è€Œ<code>framework</code>é‡Œé¢æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œè€Œä¸”åŒ…å«åµŒå¥—çš„æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå°†æ–‡ä»¶å¤¹å˜æˆå•ä¸ªæ–‡ä»¶çš„åŠŸèƒ½ï¼Œç±»ä¼¼äº<a href="https://linux.die.net/man/1/tar">tar</a>ã€‚è™½ç„¶åˆ›å»º
sectionæ—¶ä½¿ç”¨<code>tar</code>å‘½ä»¤æ˜¯ç®€å•çš„ï¼Œä½†æ˜¯åœ¨è¯»å–çš„æ—¶å€™éœ€è¦ä¸€äº›ç¬¬ä¸‰æ–¹çš„åº“æ¥æ”¯æŒï¼Œè¿™æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚è€Œç”±äºæˆ‘ä»¬çš„ç›®å½•ä¸­åªåŒ…å«<code>lua</code>æ–‡ä»¶ï¼Œæ‰€ä»¥å¯ä»¥ç®€åŒ–è®¾è®¡ã€‚
é¦–å…ˆç©ºæ–‡ä»¶å¤¹å¯¹äºæˆ‘ä»¬æ˜¯æ— æ„ä¹‰çš„ï¼Œåªéœ€è¦<code>lua</code>æ–‡ä»¶å°±å¯ä»¥ã€‚æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹çš„è¡¨:</p>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ libs/json.lua      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core/entity.lua    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ app/game.lua       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libs/bson.lua      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<p>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ ¼å¼è½¬æ¢æˆå•ä¸ªæ–‡ä»¶</p>

<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚name_lenâ”‚content_lenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ core.entity        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚name_lenâ”‚content_lenâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ libs.bson          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ .................  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<p>å…¶ä¸­<code>name_len</code>ä¸ºæ–‡ä»¶åçš„é•¿åº¦ï¼Œè¿™é‡Œç›´æ¥è½¬æ¢æˆäº†luaä¸­<code>require</code>çš„æ ¼å¼ï¼Œä½¿ç”¨ç‚¹ç¬¦å·ã€‚<code>content_len</code>æ˜¯æ–‡ä»¶å†…å®¹çš„é•¿åº¦ï¼Œå³æ–‡ä»¶çš„å…·ä½“å†…å®¹é•¿åº¦ã€‚æœ€åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>zip</code>æŒ‡ä»¤
å°†è¿™éƒ¨åˆ†å†…å®¹å‹ç¼©å­˜å‚¨åœ¨<code>elf</code>æ–‡ä»¶ä¸­ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹:</p>

<pre><code class="language-python">#!/usr/bin/env python
#coding: utf-8

import os, struct, StringIO, zlib, subprocess, sys, tempfile, argparse

argParser = argparse.ArgumentParser()

argParser.add_argument(&quot;luafolder&quot;, type=str)
argParser.add_argument(&quot;exe&quot;, type=str)
argParser.add_argument(&quot;out&quot;, type=str)

args = argParser.parse_args()

files = []

path = args.luafolder

for (dirpath, dirname, filenames) in os.walk(path):
    dirp = dirpath[len(path):]
    if dirp:
        if dirp[-1] != &quot;/&quot;:
            dirp += &quot;/&quot;

        while dirp[0] == &quot;/&quot;:
            dirp = dirp[1:]

    files.extend([dirp + x for x in filenames])

output = StringIO.StringIO()

for fpath in files:
    realp = path + &quot;/&quot; + fpath
    filesize = os.path.getsize(realp)

    if fpath.endswith(&quot;.lua&quot;):
        fpath = fpath[:-4]
    elif fpath.endswith(&quot;.luac&quot;):
        fpath = fpath[:-5]
    else:
        continue

    package_pattern = fpath.replace(&quot;/&quot;, &quot;.&quot;)
    package_pattern = &quot;pg.&quot; + package_pattern
    with open(realp, &quot;rb&quot;) as rf:
        content = rf.read()
        output.write(struct.pack(&quot;=hL&quot;, len(package_pattern), len(content)))
        output.write(package_pattern)
        output.write(content)

f = tempfile.NamedTemporaryFile()

outdata = output.getvalue()
f.write(struct.pack(&quot;=L&quot;, len(outdata)))
f.write(zlib.compress(output.getvalue()))
f.flush()

subprocess.call(&quot;objcopy %s --remove-section .lua-data&quot;%(args.exe, ), shell=True)
subprocess.call(&quot;objcopy %s --add-section .lua-data=%s %s&quot;%(args.exe, f.name, args.out), shell=True)

</code></pre>

<h1 id="æ–‡ä»¶å†…å®¹çš„è¯»å–">æ–‡ä»¶å†…å®¹çš„è¯»å–</h1>

<p>æˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>elf.h</code>æ–‡ä»¶æ¥è¯»å–æ–‡ä»¶å†…å®¹ã€‚æ ¹æ®ä¸Šè¿°çš„æ ¼å¼ç¤ºæ„å›¾ï¼Œ<code>elf</code>æ–‡ä»¶å¼€å¤´çš„æ˜¯Headerï¼Œå…¶æ ¼å¼ä¸º<code>ElfXX_Ehdr</code>ï¼Œ
æˆ‘ä»¬å¯ä»¥ç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹åˆ°å†…å­˜ã€‚ç„¶åè¯»å–<code>e_shoff</code>å­—æ®µè·å¾—section headerçš„ä½ç½®ï¼Œå®šä½åˆ°ä½ç½®å¹¶ä¾æ¬¡è¯»å–å†…å®¹åˆ°<code>ElfXX_Shdr</code>
ç»“æ„ä½“ä¸­ï¼Œç„¶åé€šè¿‡å„ä¸ªentryçš„<code>sh_name</code>å¾—åˆ°æœ€ç»ˆsectionï¼Œç„¶åè¯»å–æ–‡ä»¶è¾¾åˆ°ç›®çš„ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>

<pre><code>static std::map&lt;std::string, std::string&gt; readElfLuaData(const std::string &amp;filepath) {
    std::map&lt;std::string, std::string&gt; files;
#if __x86_64__
    typedef Elf64_Ehdr ELF_EHDR;
    typedef Elf64_Shdr ELF_SHDR;
#else
    typedef Elf32_Ehdr ELF_EHDR;
    typedef Elf32_Shdr ELF_SHDR;
#endif

    std::ifstream ifs(filepath);

    ELF_EHDR hdr;
    ifs.read(reinterpret_cast&lt;char *&gt;(&amp;hdr), sizeof(hdr));

    std::vector&lt;ELF_SHDR&gt; sh_tables(hdr.e_shnum);
    ifs.seekg(static_cast&lt;long&gt;(hdr.e_shoff));

    for (size_t i = 0; i &lt; hdr.e_shnum; ++i) {
        ifs.read(reinterpret_cast&lt;char *&gt;(&amp;sh_tables[i]), sizeof(sh_tables[i]));
    }

    // read shstr

    std::vector&lt;char&gt; shstr(sh_tables[hdr.e_shstrndx].sh_size);
    ifs.seekg(static_cast&lt;long&gt;(sh_tables[hdr.e_shstrndx].sh_offset));
    ifs.read(shstr.data(), static_cast&lt;long&gt;(shstr.size()));

    ELF_SHDR *lua_sh = nullptr;

    for (size_t i = 0; i &lt; hdr.e_shnum; ++i) {
        char *name = shstr.data() + sh_tables[i].sh_name;
        if (strcmp(name, &quot;.lua-data&quot;) == 0) {
            lua_sh = &amp;sh_tables[i];
            break;
        }
    }

    if (lua_sh) {
        std::vector&lt;char&gt; buf(lua_sh-&gt;sh_size);
        ifs.seekg(static_cast&lt;long&gt;(lua_sh-&gt;sh_offset));
        ifs.read(buf.data(), static_cast&lt;std::streamsize&gt;(buf.size()));

        size_t idx = 0;
#define READ_TO(TARGET, SIZE)                                                                      \
    memcpy(TARGET, buf.data() + idx, SIZE);                                                        \
    idx += SIZE;

        uint32_t raw_len = 0;
        READ_TO(&amp;raw_len, sizeof(raw_len));

        std::vector&lt;char&gt; tmp(raw_len);
        uLongf dest_len = tmp.size();
        uncompress(reinterpret_cast&lt;Bytef *&gt;(tmp.data()), &amp;dest_len,
                   reinterpret_cast&lt;Bytef *&gt;(buf.data() + idx), buf.size() - idx);

        buf.swap(tmp);
        idx = 0;

        while (idx &lt; dest_len) {
            uint16_t name_len;
            uint32_t content_len;
            READ_TO(&amp;name_len, sizeof(name_len));
            READ_TO(&amp;content_len, sizeof(content_len));
            std::string filename(name_len, 0), content(content_len, 0);
            READ_TO(&amp;*filename.begin(), filename.size());
            READ_TO(&amp;*content.begin(), content.size());
            files.emplace(std::piecewise_construct, std::forward_as_tuple(std::move(filename)),
                          std::forward_as_tuple(std::move(content)));
        }
#undef READ_TO
    }
    return files;
}
</code></pre>

<p>æ¥ä¸‹æ¥ä¾¿å¯ä»¥é€šè¿‡æ·»åŠ åˆ°<code>package.preload</code>å®ç°åœ¨luaä¸­è°ƒç”¨è¿™äº›æ–‡ä»¶çš„ç›®çš„ã€‚</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://sysfork.com/post/cpp-function-container/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://sysfork.com/post/cpp-function-container/">ä½¿ç”¨C&#43;&#43; mapå®ç°æ³¨å†Œå›è°ƒçš„åŠŸèƒ½</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'sysfork-com';
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  
  
</div>

</div>
</div>
<script src="http://sysfork.com/js/ui.js"></script>



</script>
</body>
</html>

