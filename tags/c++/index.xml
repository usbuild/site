<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>C&#43;&#43; on sysğŸ”±fork</title>
    <link>http://sysfork.com/tags/c&#43;&#43;/</link>
    <description>Recent content in C&#43;&#43; on sysğŸ”±fork</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>&amp;copy; 2017. All rights reserved.</copyright>
    <lastBuildDate>Sat, 29 Apr 2017 15:38:38 +0800</lastBuildDate>
    <atom:link href="http://sysfork.com/tags/c&#43;&#43;/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>ä½¿ç”¨C&#43;&#43; mapå®ç°æ³¨å†Œå›è°ƒçš„åŠŸèƒ½</title>
      <link>http://sysfork.com/post/cpp-function-container/</link>
      <pubDate>Sat, 29 Apr 2017 15:38:38 +0800</pubDate>
      
      <guid>http://sysfork.com/post/cpp-function-container/</guid>
      <description>

&lt;p&gt;åœ¨&lt;code&gt;C++/lua&lt;/code&gt;æ··åˆç¼–ç¨‹ä¸­ï¼Œå¾€å¾€å­˜åœ¨éœ€è¦å›è°ƒçš„æƒ…å†µã€‚æ¯”å¦‚åœ¨æ¸¸æˆä¸­ï¼Œé€»è¾‘è¿›ç¨‹ä¸­çš„è„šæœ¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“è®¿é—®æ“ä½œï¼Œå¦‚ä¸‹:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;dbmgr.query({name=&amp;quot;hello&amp;quot;}, function(ret)
-- do something
end)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±äº&lt;code&gt;dbmgr.query&lt;/code&gt;æ˜¯å¼‚æ­¥æ“ä½œï¼Œè¿™æ¡è¯­å¥æ˜¯ç«‹å³è¿”å›çš„ã€‚å†…éƒ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ˜¯é€šè¿‡å‘&lt;code&gt;dbmgr&lt;/code&gt;è¿›ç¨‹å‘é€ä¸€ä¸ª&lt;code&gt;query&lt;/code&gt;è¯·æ±‚ï¼Œç„¶åé€»è¾‘è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚å½“&lt;code&gt;dbmgr&lt;/code&gt;æ”¶åˆ°è¯·æ±‚åï¼Œå…¶æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œå¾—åˆ°
ç»“æœç„¶åä¹Ÿæ˜¯é€šè¿‡ç½‘ç»œå°†å…¶å‘é€ç»™é€»è¾‘è¿›ç¨‹ã€‚é€»è¾‘è¿›ç¨‹æ”¶åˆ°ç»“æœåè°ƒç”¨åˆ°&lt;code&gt;lua&lt;/code&gt;çš„å›è°ƒå‡½æ•°é‡Œã€‚&lt;/p&gt;

&lt;p&gt;è¿™é‡Œæœ‰ä¸€ä¸ªç®€åŒ–æ–¹æ¡ˆï¼Œå¦‚æœæ—¶ä»…ä»…é’ˆå¯¹&lt;code&gt;lua&lt;/code&gt;çš„è¯ï¼Œåªéœ€è¦åœ¨å‘&lt;code&gt;dbmgr&lt;/code&gt;è¿›ç¨‹å‘é€è¯·æ±‚çš„æ—¶å€™å¸¦ä¸Š&lt;code&gt;lua function&lt;/code&gt;çš„æ³¨å†ŒIDå°±å¥½äº†ï¼ŒæŸ¥è¯¢åˆ°ç»“æœåè¿”å›è¿‡æ¥å°±èƒ½ç›´æ¥è°ƒç”¨ã€‚ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæ¥å£ä¸ä»…ä»…åœ¨
&lt;code&gt;lua&lt;/code&gt;ä¸­ä½¿ç”¨ï¼Œå¸Œæœ›åœ¨&lt;code&gt;C++&lt;/code&gt;ä¸­ä¹Ÿèƒ½è°ƒç”¨ï¼Œå¹¶ä¸”å¸Œæœ›æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¨¡å—æ¥è´Ÿè´£è¿™ç±»äº‹æƒ…ï¼Œè¯¥å¦‚ä½•è®¾è®¡ï¼Ÿä¸€ä¸ªç®€åŒ–åçš„é—®é¢˜å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#include &amp;lt;functional&amp;gt;
#include &amp;lt;map&amp;gt;

std::map&amp;lt;int, std::function&amp;lt;void(void*)&amp;gt;&amp;gt; callbacks;
int last_idx = 0;

//ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œéœ€è¦æ”¯æŒå„ç§function
template&amp;lt;typename T&amp;gt;
int addCallback(T &amp;amp;&amp;amp; t) {
}

//ç”¨äºè°ƒç”¨å›è°ƒå‡½æ•°
template&amp;lt;typename ... ARGS&amp;gt;
void call(int idx, ARGS &amp;amp;&amp;amp; ... args) {
}

void func(int i) {}

class Functor {
public:
	void operator()(const std::string &amp;amp;s, int i) {}
};

int main() {
	int c1 = addCallback(&amp;amp;func);
	int i;
	int c2 = addCallback([i](double j) {});
	int c3 = addCallback(Functor());

	call(c1, 1);
	call(c2, 1.0);
	call(c3, std::string(&amp;quot;string&amp;quot;), 1);

	return 0;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­&lt;code&gt;addCallback&lt;/code&gt;çš„ä½œç”¨ç”¨äºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;ã€&lt;code&gt;functor&lt;/code&gt;ã€æ™®é€šçš„å‡½æ•°ã€æˆå‘˜å‡½æ•°ç­‰ç­‰ã€‚è¿™é‡Œä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œæˆ‘ä»¬åª
å¤„ç†&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;å’Œæ™®é€šå‡½æ•°ï¼Œå…¶ä½™çš„ä¸å†èµ˜è¿°ã€‚ä¸‹é¢æ˜¯ä¸€äº›é—®é¢˜ï¼š&lt;/p&gt;

&lt;h1 id=&#34;å‚æ•°çš„å¤„ç†&#34;&gt;å‚æ•°çš„å¤„ç†ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯&lt;code&gt;map&lt;/code&gt;ï¼Œ&lt;code&gt;value_type&lt;/code&gt;æ˜¯ä¸€å®šçš„ï¼Œä½ æ— æ³•å°†å¤šä¸ªä¸åŒç±»å‹çš„&lt;code&gt;std::function&lt;/code&gt;æ”¾è¿›å»ï¼Œæ‰€ä»¥éœ€è¦éœ€è¦åŒ…ä¸€å±‚ï¼Œè¿™é‡Œå­˜å‚¨çš„æ˜¯&lt;code&gt;std::function&amp;lt;void(void*)&amp;gt;&lt;/code&gt;ï¼Œ
ç”±äºæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œè¿”å›å€¼æˆ‘ä»¬ä¸å…³å¿ƒã€‚å‚æ•°ä½¿ç”¨çš„æ˜¯&lt;code&gt;void*&lt;/code&gt;ï¼Œå°†ç±»å‹ç»™æŠ¹é™¤æ‰äº†ã€‚é‚£ä¹ˆå‚æ•°çš„å…·ä½“å†…å®¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨&lt;code&gt;std::tuple&lt;/code&gt;æ¥å­˜å‚¨ï¼Œé‚£&lt;code&gt;call&lt;/code&gt;çš„å®ç°å°±å¾ˆç®€å•äº†:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename ... ARGS&amp;gt;
void call(int idx, ARGS &amp;amp;&amp;amp; ... args) {
	auto it = callbacks.find(idx);
	if (it != callbacks.end() {
		auto tuple = std::tuple&amp;lt;ARGS...&amp;gt;(args...);
		it-&amp;gt;second(&amp;amp;tuple);
	}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;callbacks-å­˜å‚¨çš„å†…å®¹æ˜¯&#34;&gt;&lt;code&gt;callbacks&lt;/code&gt;å­˜å‚¨çš„å†…å®¹æ˜¯ï¼Ÿ&lt;/h1&gt;

&lt;p&gt;ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œ&lt;code&gt;map&lt;/code&gt;çš„&lt;code&gt;value_type&lt;/code&gt;æ˜¯&lt;code&gt;std::function&amp;lt;void(*)&amp;gt;&lt;/code&gt;ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥å°†å¤–éƒ¨ä¼ å…¥çš„å›è°ƒè®¾ç½®è¿›å»ï¼Œéœ€è¦å†åŒ…ä¸€å±‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
int addCallback(T &amp;amp;&amp;amp; t) {
    last_idx++;
    callbacks[last_idx] = [t](void *data){
        auto ptr = static_cast&amp;lt;std::tuple&amp;lt;...&amp;gt; *&amp;gt;(data); // æ¨¡æ¿å‚æ•°æ€ä¹ˆå¤„ç†ï¼Ÿ
        std::apply(t, *ptr);
    };
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†&lt;code&gt;C++17&lt;/code&gt;ä¸­çš„&lt;a href=&#34;http://en.cppreference.com/w/cpp/utility/apply&#34;&gt;std::apply&lt;/a&gt;ï¼Œå…¶ä½œç”¨å°±æ˜¯è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°æ˜¯ä¸€ä¸ª&lt;code&gt;tuple&lt;/code&gt;ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ä»æºç ä¸­çœ‹çœ‹&lt;code&gt;apply&lt;/code&gt;çš„å®ç°ï¼Œ
è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚
é—®é¢˜æ˜¯ï¼Œ&lt;code&gt;tuple&lt;/code&gt;çš„å‚æ•°å¦‚ä½•å¤„ç†ï¼Ÿæˆ‘ä»¬æ²¡æ³•ä»&lt;code&gt;data&lt;/code&gt;ä¸­å¾—åˆ°ç±»å‹å¿ƒç³»ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯ä»&lt;code&gt;T&lt;/code&gt;ä¸­è·å–ï¼Œé‚£å¦‚ä½•è·å–å‘¢ï¼Ÿ&lt;/p&gt;

&lt;h1 id=&#34;callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–&#34;&gt;callableå¯¹è±¡è°ƒç”¨å‚æ•°èƒå–&lt;/h1&gt;

&lt;p&gt;ç°åœ¨çš„ä¸»è¦é—®é¢˜æ˜¯ï¼Œå¦‚ä½•ä»&lt;code&gt;std::function&lt;/code&gt;ã€&lt;code&gt;lambda&lt;/code&gt;ã€æ™®é€šå‡½æ•°ç­‰ç±»å‹ä¸­æå–å‚æ•°ä¿¡æ¯ã€‚å¯¹äºæ™®é€šå‡½æ•°å’Œ&lt;code&gt;std::function&lt;/code&gt;æˆ‘ä»¬å¯ä»¥é€šè¿‡ç‰¹åŒ–æ¥åš&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
struct CallbackTypeHelper;

template&amp;lt;typename RET, typename ... ARGS&amp;gt;
struct CallbackTypeHelper&amp;lt;RET(*)(ARGS...)&amp;gt; {
    typedef std::tuple&amp;lt;ARGS...&amp;gt; typle_type;
}

template&amp;lt;typename RET, typename ... ARGS&amp;gt;
struct CallbackTypeHelper&amp;lt;std::function&amp;lt;RET(ARGS...)&amp;gt;&amp;gt; {
    typedef std::tuple&amp;lt;ARGS...&amp;gt; typle_type;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯¹äº&lt;code&gt;lambda&lt;/code&gt;è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ&lt;/p&gt;

&lt;p&gt;&lt;code&gt;lambda&lt;/code&gt;ä½œä¸º&lt;code&gt;C++11&lt;/code&gt;ä¸­æ–°å¼•è¿›çš„ç‰¹æ€§ï¼Œå…¶ä½œç”¨æ˜¯å®ç°ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œç”±äºæ•è·ç»„çš„å­˜åœ¨ï¼Œå…¶ä¸èƒ½ä»…ä»…å®ç°æˆä¸€ä¸ª&lt;code&gt;C Function&lt;/code&gt;ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªåŒ¿åç±»ï¼Œå„ä¸ªæ•è·å‚æ•°å³ä¸ºæˆå‘˜
å˜é‡ï¼Œä¸ºäº†å®ç°å¯è¢«è°ƒç”¨ï¼Œå…¶é‡è½½äº†&lt;code&gt;operator()&lt;/code&gt;ã€‚æ ¹æ®è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†è·å–å‚æ•°çš„æ–¹æ³•ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;template&amp;lt;typename T&amp;gt;
struct CallbackFunctorHelper;

template&amp;lt;typename RET, typename C, typename ... ARGS&amp;gt;
struct CallbackFunctorHelper&amp;lt;RET(C::*)(ARGS...) const&amp;gt; {
  typedef std::tuple&amp;lt;ARGS...&amp;gt; tuple_type;
};

template&amp;lt;typename RET, typename C, typename ... ARGS&amp;gt;
struct CallbackFunctorHelper&amp;lt;RET(C::*)(ARGS...)&amp;gt; {
  typedef std::tuple&amp;lt;ARGS...&amp;gt; tuple_type;
};

template &amp;lt;typename T, typename Enabled=void&amp;gt;
struct CallbackTypeHelper {
  typedef typename CallbackFunctorHelper&amp;lt;decltype(&amp;amp;std::decay&amp;lt;T&amp;gt;::type::operator())&amp;gt;::tuple_type tuple_type;
};

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;æ³¨æ„ç”±äºå‚æ•°æœ‰å¯èƒ½æ˜¯å¼•ç”¨ï¼Œæ‰€æœ‰è¿™é‡Œéœ€è¦&lt;a href=&#34;http://en.cppreference.com/w/cpp/types/decay&#34;&gt;decay&lt;/a&gt;æ¥å¤„ç†è¿™äº›å¼•ç”¨ã€‚åŒæ—¶ç”±äº&lt;code&gt;lambda&lt;/code&gt;çš„&lt;code&gt;mutable&lt;/code&gt;å±æ€§çš„å­˜åœ¨ï¼Œæ‰€ä»¥&lt;code&gt;CallbackFunctorHelper&lt;/code&gt;
éœ€è¦&lt;code&gt;const&lt;/code&gt;å’Œ&lt;code&gt;non-const&lt;/code&gt;çš„ç‰¹åŒ–ã€‚&lt;/p&gt;

&lt;p&gt;æœ€åï¼Œç”±äºè¿™åªæ˜¯æ¼”ç¤ºæ€§è´¨çš„ä»£ç ï¼Œæœ‰äº›é€»è¾‘å¦‚æˆå‘˜å‡½æ•°ç­‰å¹¶æ²¡æœ‰è€ƒè™‘è¿›å»ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;enable_if&lt;/code&gt;åšä¸ªå•ç‹¬çš„ç‰¹åŒ–ï¼Œè€Œä¸éœ€è¦åœ¨é»˜è®¤å‡½æ•°ä¸Šå†™&lt;code&gt;functor&lt;/code&gt;çš„å®ç°ç­‰ã€‚åœ¨å®é™…
åº”ç”¨ä¸­å¯ä»¥ä¿®æ”¹å¾—æ›´åŠ å…¨é¢å’Œä¼˜é›…ã€‚&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>