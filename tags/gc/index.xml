<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Gc on sysğŸ”±fork</title>
    <link>http://sysfork.com/tags/gc/</link>
    <description>Recent content in Gc on sysğŸ”±fork</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>&amp;copy; 2017. All rights reserved.</copyright>
    <lastBuildDate>Wed, 10 May 2017 20:05:41 +0800</lastBuildDate>
    <atom:link href="http://sysfork.com/tags/gc/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>è§£ælua gc ä¸­çš„å‚æ•°æ§åˆ¶</title>
      <link>http://sysfork.com/post/2017/lua-gc-paramter-internal/</link>
      <pubDate>Wed, 10 May 2017 20:05:41 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/lua-gc-paramter-internal/</guid>
      <description>&lt;p&gt;lua gc è°ƒä¼˜ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªä¸¤ä¸ªå‚æ•°&lt;code&gt;setpause&lt;/code&gt;å’Œ&lt;code&gt;setstepmul&lt;/code&gt;ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;collectgarbage(&amp;quot;setpause&amp;quot;, 200)
collectgarbage(&amp;quot;setstepmul&amp;quot;, 200)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™ä¸¤ä¸ªå€¼çš„é»˜è®¤å€¼éƒ½æ˜¯&lt;code&gt;200&lt;/code&gt;ï¼Œé‚£ä¹ˆè¿™ä»£è¡¨ç€ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé€šè¿‡æŸ¥çœ‹ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code&gt;static const char *const opts[] = {&amp;quot;stop&amp;quot;, &amp;quot;restart&amp;quot;, &amp;quot;collect&amp;quot;,
  &amp;quot;count&amp;quot;, &amp;quot;step&amp;quot;, &amp;quot;setpause&amp;quot;, &amp;quot;setstepmul&amp;quot;, NULL};
static const int optsnum[] = {LUA_GCSTOP, LUA_GCRESTART, LUA_GCCOLLECT,
  LUA_GCCOUNT, LUA_GCSTEP, LUA_GCSETPAUSE, LUA_GCSETSTEPMUL};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶å®&lt;code&gt;collectgarbage&lt;/code&gt;å¯¹åº”çš„å°±æ˜¯&lt;code&gt;lua_gc&lt;/code&gt;æ–¹æ³•ï¼Œä¸‹é¢æ˜¯å…¶ä¸­çš„éƒ¨åˆ†é€»è¾‘çš„ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;LUA_API int lua_gc (lua_State *L, int what, int data) {
  switch (what) {
    case LUA_GCSTOP: g-&amp;gt;GCthreshold = MAX_LUMEM;
    case LUA_GCRESTART: g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes;
    case LUA_GCCOLLECT: luaC_fullgc(L);
    case LUA_GCCOUNT: res = cast_int(g-&amp;gt;totalbytes &amp;gt;&amp;gt; 10);
    case LUA_GCCOUNTB:  res = cast_int(g-&amp;gt;totalbytes &amp;amp; 0x3ff);
    case LUA_GCSTEP: {
      lu_mem a = (cast(lu_mem, data) &amp;lt;&amp;lt; 10);
      if (a &amp;lt;= g-&amp;gt;totalbytes)
        g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes - a;
      else
        g-&amp;gt;GCthreshold = 0;
      while (g-&amp;gt;GCthreshold &amp;lt;= g-&amp;gt;totalbytes) {
        luaC_step(L);
        if (g-&amp;gt;gcstate == GCSpause) {  /* end of cycle? */
          res = 1;  /* signal it */
          break;
        }
      }
      break;
    }
    case LUA_GCSETPAUSE: res = g-&amp;gt;gcpause; g-&amp;gt;gcpause = data;
    case LUA_GCSETSTEPMUL: res = g-&amp;gt;gcstepmul; g-&amp;gt;gcstepmul = data;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­æˆ‘ä»¬çœ‹åˆ°ä¸€äº›æœ‰æ„æ€çš„å‚æ•°ï¼Œåœ¨&lt;code&gt;g(global_State)&lt;/code&gt;ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;/*
** `global state&#39;, shared by all threads of this state
*/
typedef struct global_State {
//.....
  lu_mem GCthreshold;
  lu_mem totalbytes;  /* number of bytes currently allocated */
  lu_mem estimate;  /* an estimate of number of bytes actually in use */
  lu_mem gcdept;  /* how much GC is `behind schedule&#39; */
  int gcpause;  /* size of pause between successive GCs */
  int gcstepmul;  /* GC `granularity&#39; */
//......
} global_State;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äº&lt;code&gt;LUA_GCSTOP&lt;/code&gt;æ˜¯å°†&lt;code&gt;GCthreshold&lt;/code&gt;è®¾ç½®æˆä¸€ä¸ªå¾ˆå¤§çš„å€¼&lt;code&gt;MAX_LUMEM&lt;/code&gt;(&lt;code&gt;~(size_t)0)-2&lt;/code&gt;)ï¼Œè€Œ&lt;code&gt;LUA_GCRESTART&lt;/code&gt;åˆ™å°†&lt;code&gt;GCthreshold&lt;/code&gt;è®¾ç½®æˆ&lt;code&gt;totalbytes&lt;/code&gt;ã€‚å¯¹äº&lt;code&gt;LUA_GCSETPAUSE&lt;/code&gt;å’Œ&lt;code&gt;LUA_GCSETSTEPMUL&lt;/code&gt;åˆ™æ˜¯åˆ†åˆ«è®¾ç½®äº†&lt;code&gt;gcpause&lt;/code&gt;å’Œ&lt;code&gt;gcstepmul&lt;/code&gt;çš„å€¼ã€‚ä»æ³¨é‡Šä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å„è‡ªå€¼çš„è§£é‡Šã€‚&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å‚æ•°&lt;/th&gt;
&lt;th&gt;æ„ä¹‰&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;GCthreshold&lt;/td&gt;
&lt;td&gt;GCçš„é—¨æ§›ï¼Œå½“totalbyteså¤§äºè¿™ä¸ªå€¼æ—¶è§¦å‘gc step&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;totalbytes&lt;/td&gt;
&lt;td&gt;ç”±å†…å­˜åˆ†é…å™¨åˆ†é…çš„&lt;strong&gt;å®é™…&lt;/strong&gt;å†…å­˜&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;estimate&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;ä¼°è®¡&lt;/strong&gt;çš„ï¼Œæ­£åœ¨ä½¿ç”¨çš„å†…å­˜å¤§å°ï¼Œå°äº &lt;code&gt;totalbytes&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;ä¸‹é¢è¿™æ®µä»£ç æ˜¯ä»£ç ä¸­éšå¤„å¯è§ï¼Œå¦‚&lt;code&gt;lua_createtable&lt;/code&gt;ç­‰ï¼Œåœ¨æ‰§è¡Œæ“ä½œä¹‹å‰éƒ½ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘&lt;code&gt;gc&lt;/code&gt;ï¼Œä»¥ä¿è¯å†…å­˜åˆ©ç”¨ç‡ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;80	#define luaC_checkGC(L) { \
81	  condhardstacktests(luaD_reallocstack(L, L-&amp;gt;stacksize - EXTRA_STACK - 1)); \
82	  if (G(L)-&amp;gt;totalbytes &amp;gt;= G(L)-&amp;gt;GCthreshold) \
83		luaC_step(L); }
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å½“ &lt;code&gt;totalbytes &amp;gt;= GCthreshold&lt;/code&gt;æ—¶è§¦å‘stepã€‚å› æ­¤&lt;code&gt;LUA_GCRESTART&lt;/code&gt;ä¹‹åï¼Œä¸‹ä¸€æ¬¡&lt;code&gt;checkGC&lt;/code&gt;çš„æ—¶å€™ä¼šç«‹å³å‡ºå‘&lt;code&gt;luaC_step&lt;/code&gt;ã€‚å¯ä»¥çœ‹åˆ°
&lt;code&gt;totalbytes&lt;/code&gt;å’Œ&lt;code&gt;GCthreshold&lt;/code&gt;æ˜¯æ§åˆ¶&lt;code&gt;GC&lt;/code&gt;çš„å…³é”®å‚æ•°ã€‚&lt;/p&gt;

&lt;p&gt;æ¯ä¸ªå›æ”¶å‘¨æœŸç»“æŸé‡ç½®&lt;code&gt;GCthreshold&lt;/code&gt; ï¼Œè¿™é‡Œç”¨åˆ°äº†çš„estimateã€‚å› ä¸ºå¸¦æœ‰ __gc å…ƒæ–¹æ³•çš„ &lt;code&gt;userdata&lt;/code&gt; éœ€è¦ä¸¤ä¸ªgcå‘¨æœŸ
æ‰èƒ½å›æ”¶ï¼Œåœ¨ç¬¬ä¸€ä¸ªgcå‘¨æœŸä¸­å…¶ &lt;code&gt;__gc&lt;/code&gt;å…ƒæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œè€Œåœ¨ç¬¬äºŒä¸ªå›æ”¶å‘¨æœŸå†…å†…å­˜ä¼šè¢«çœŸæ­£å›æ”¶ã€‚å› æ­¤ï¼Œ&lt;code&gt;estimate&lt;/code&gt;æ˜¯ä¸åŒ…å«é‚£äº›&lt;code&gt;__gc&lt;/code&gt;å…ƒæ–¹æ³•è¢«è°ƒç”¨çš„&lt;code&gt;userdata&lt;/code&gt;çš„ï¼Œè€Œ&lt;code&gt;totalbytes&lt;/code&gt;ä¼šåŒ…å«ï¼ˆå› ä¸ºå…¶åæ˜ çš„æ˜¯çœŸå®å†…å­˜å ç”¨æƒ…å†µï¼‰ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;#define setthreshold(g)  (g-&amp;gt;GCthreshold = (g-&amp;gt;estimate/100) * g-&amp;gt;gcpause)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç”±è¿™æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è®¾ç½®çš„&lt;code&gt;gcpause&lt;/code&gt;å€¼å½±å“çš„æ˜¯ä¸‹ä¸€å‘¨æœŸå¼€å§‹çš„äº‹ä»¶ï¼Œé»˜è®¤&lt;code&gt;200&lt;/code&gt;çš„æ„æ€æ—¶ï¼Œå½“å½“å‰&lt;strong&gt;çœŸå®&lt;/strong&gt;å†…å­˜å ç”¨è¶…è¿‡å½“å‰&lt;strong&gt;ä¼°è®¡&lt;/strong&gt;å†…å­˜å ç”¨çš„ä¸¤å€æ—¶ï¼Œæ‰å¼€å¯ä¸‹ä¸€å›æ”¶å‘¨æœŸã€‚æ‰€ä»¥å¦‚æœä½ å«&lt;code&gt;__gc&lt;/code&gt;æ–¹æ³•çš„&lt;code&gt;userdata&lt;/code&gt;è¿‡å¤§çš„è¯ï¼Œå¾ˆå¯èƒ½åœ¨ç¬¬ä¸€æ¬¡å‘¨æœŸç»“æŸåç«‹é©¬å¼€å¯äº†ç¬¬äºŒå‘¨æœŸã€‚å¦‚æœè®¾ç½®çš„&lt;code&gt;gcpause&lt;/code&gt;å€¼å°äº&lt;code&gt;100&lt;/code&gt;çš„è¯ï¼Œé‚£ä¹ˆåŒæ ·ä¸¤æ¬¡&lt;code&gt;gc&lt;/code&gt;å‘¨æœŸä¸­é—´æ˜¯æ²¡æœ‰é—´éš”çš„ã€‚&lt;/p&gt;

&lt;p&gt;æ¥ä¸‹æ¥çœ‹&lt;code&gt;luaC_step&lt;/code&gt;çš„ä»£ç &lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;610	void luaC_step (lua_State *L) {
611	  global_State *g = G(L);
612	  l_mem lim = (GCSTEPSIZE/100) * g-&amp;gt;gcstepmul;
613	  if (lim == 0)
614	    lim = (MAX_LUMEM-1)/2;  /* no limit */
615	  g-&amp;gt;gcdept += g-&amp;gt;totalbytes - g-&amp;gt;GCthreshold;
616	  do {
617	    lim -= singlestep(L);
618	    if (g-&amp;gt;gcstate == GCSpause)
619	      break;
620	  } while (lim &amp;gt; 0);
621	  if (g-&amp;gt;gcstate != GCSpause) {
622	    if (g-&amp;gt;gcdept &amp;lt; GCSTEPSIZE)
623	      g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes + GCSTEPSIZE;  /* - lim/g-&amp;gt;gcstepmul;*/
624	    else {
625	      g-&amp;gt;gcdept -= GCSTEPSIZE;
626	      g-&amp;gt;GCthreshold = g-&amp;gt;totalbytes;
627	    }
628	  }
629	  else {
630	    setthreshold(g);
631	  }
632	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œ&lt;code&gt;stepmul&lt;/code&gt;æ§åˆ¶çš„å°±æ˜¯&lt;code&gt;step&lt;/code&gt;çš„é•¿åº¦ï¼Œè¶Šå¤§åˆ™æ¯æ­¥æ‰€è¿›è¡Œçš„æ“ä½œä¹Ÿå°±è¶Šå¤šï¼Œæ‹¥æœ‰æ›´å¤šçš„ã€Œè´¹ã€ã€‚å…¶ä¸­&lt;code&gt;GCSTEPSIZE&lt;/code&gt;çš„å€¼ä¸º&lt;code&gt;1024&lt;/code&gt;ã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤&lt;code&gt;stepmul&lt;/code&gt;ä¸º200çš„æƒ…å†µä¸‹ï¼Œå¤§çº¦å¯å·²è¿›è¡Œ&lt;code&gt;2048&lt;/code&gt;ã€Œè´¹ã€ï¼Œé‚£ä¹ˆã€Œè´¹ã€æ˜¯æ€ä¹ˆå®šä¹‰çš„å‘¢ï¼Ÿä»ä»£ç å¯ä»¥çœ‹åˆ°æ¸…é™¤ä¸€æ¡&lt;code&gt;string&lt;/code&gt;è¡¨å’Œä»»æ„ä¸€ä¸ª&lt;code&gt;gc&lt;/code&gt;å¯¹è±¡ä¸º&lt;code&gt;10&lt;/code&gt;ã€Œè´¹ã€ï¼Œè°ƒç”¨&lt;code&gt;__gc&lt;/code&gt;å…ƒæ–¹æ³•ä¸º&lt;code&gt;100&lt;/code&gt;ã€Œè´¹ã€ï¼Œé™¤éæ˜¯&lt;code&gt;sweep&lt;/code&gt;é˜¶æ®µå¦åˆ™å†…å­˜ä¸ä¼šå‡å°‘ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨å†…å­˜å·®å€¼æ¥è¡¨ç¤ºå·¥ä½œè¿›åº¦ï¼Œæ‰€ä»¥å¼•å…¥äº†ã€Œè´¹ã€ã€‚å¦‚æœä½ æŠŠ&lt;code&gt;stepmul&lt;/code&gt;è®¾ç½®ä¸º&lt;code&gt;0&lt;/code&gt;çš„è¯ï¼Œé‚£ä¹ˆ&lt;code&gt;lim&lt;/code&gt;å°±æ˜¯&lt;code&gt;(MAX_LUMEM-1)/2&lt;/code&gt;
ä¸ºä»€ä¹ˆæ˜¯è¿™ä¹ˆå¥‡æ€ªçš„æ•°å€¼ï¼Ÿå› ä¸º&lt;code&gt;MAX_LUAEME&lt;/code&gt;æ˜¯&lt;code&gt;~(size_t)0)-2&lt;/code&gt;ï¼Œæ— ç¬¦å·æ•´å‹ï¼Œè€Œ&lt;code&gt;l_mem&lt;/code&gt;æ˜¯æœ‰ç¬¦å·çš„ï¼Œç›´æ¥èµ‹å€¼ä¼šæº¢å‡ºçš„ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;luaC_step&lt;/code&gt;çš„è®¾è®¡æ€è·¯æ˜¯ï¼š æ¯å½“æ–°å¢åˆ†é…çš„å†…å­˜æ•°è¶…è¿‡&lt;code&gt;GCSTEPSIZE&lt;/code&gt;å°±è§¦å‘ä¸€æ¬¡ã€‚ç”±äºluaåªä¼šåœ¨gcè¿‡ç¨‹ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œæ‰€ä»¥
&lt;code&gt;totalbytes&lt;/code&gt;åœ¨gcè¿‡ç¨‹å¤–æ—¶åªå¢ä¸å‡çš„ï¼Œå› æ­¤&lt;code&gt;luaC_step&lt;/code&gt;æ€»æ˜¯ä¼šå¾—ä»¥è§¦å‘ã€‚ä¸ºäº†å‡†ç¡®è®°å½•æ–°å¢å†…å­˜ä½¿ç”¨é‡ï¼Œlua ä½¿ç”¨äº†&lt;code&gt;gcdept&lt;/code&gt;å˜é‡ã€‚
è¿™ç§è®¾è®¡æ˜¯ä¸ºäº†é˜²æ­¢&lt;code&gt;luaC_step&lt;/code&gt;è¢«é¢‘ç¹è§¦å‘ï¼Œæ§åˆ¶ä¸€ä¸ªè¾ƒåˆç†çš„ç²’åº¦ã€‚&lt;/p&gt;

&lt;p&gt;å¦å¤–ï¼Œ&lt;code&gt;gcdept&lt;/code&gt;åœ¨æ¯ä¸ªå‘¨æœŸæœ«å°¾ä¼šæ¸…é›¶ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;592	    case GCSfinalize: {
593	      if (g-&amp;gt;tmudata) {
594	        GCTM(L);
595	        if (g-&amp;gt;estimate &amp;gt; GCFINALIZECOST)
596	          g-&amp;gt;estimate -= GCFINALIZECOST;
597	        return GCFINALIZECOST;
598	      }
599	      else {
600	        g-&amp;gt;gcstate = GCSpause;  /* end collection */
601	        g-&amp;gt;gcdept = 0;
602	        return 0;
603	      }
604	    }
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
  </channel>
</rss>