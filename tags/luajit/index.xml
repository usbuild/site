<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Luajit on sysğŸ”±fork</title>
    <link>http://sysfork.com/tags/luajit/</link>
    <description>Recent content in Luajit on sysğŸ”±fork</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <copyright>&amp;copy; 2017. All rights reserved.</copyright>
    <lastBuildDate>Tue, 09 May 2017 22:05:47 +0800</lastBuildDate>
    <atom:link href="http://sysfork.com/tags/luajit/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>åµŒå…¥ luajit æ—¶åŒæ—¶ä½¿ç”¨ ffi å’Œ c api çš„è§£å†³æ–¹æ¡ˆ</title>
      <link>http://sysfork.com/post/2017/compatible-embed-luajit-ffi-load/</link>
      <pubDate>Tue, 09 May 2017 22:05:47 +0800</pubDate>
      
      <guid>http://sysfork.com/post/2017/compatible-embed-luajit-ffi-load/</guid>
      <description>&lt;p&gt;æˆ‘ä»¬éƒ½å–œæ¬¢&lt;a href=&#34;http://luajit.org/ext_ffi.html&#34;&gt;ffi&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ffi çš„æ¥å£ç®€å•æ˜“ç”¨ï¼Œå½“ä½¿ç”¨ç¬¬ä¸‰æ–¹æ²¡æœ‰æä¾› lua æ¥å£çš„åº“æ¥è¯´ï¼Œä½¿ç”¨ ffi æ¥å…¥ç›¸å½“å®¹æ˜“ã€‚
è€Œä¸”æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œé€šè¿‡ ffi è°ƒç”¨çš„æ¥å£æ˜¯å¯ä»¥è¢« jit ç¼–è¯‘çš„ï¼Œæ•ˆç‡ç›¸å¯¹äºä½¿ç”¨ä¼ ç»Ÿçš„ &lt;a href=&#34;https://www.lua.org/pil/24.html&#34;&gt;lua c api&lt;/a&gt;æ¥è¯´è¦
é«˜å¾—å¤šã€‚ffi ç›´æ¥ä½¿ç”¨äº†æ“ä½œç³»ç»Ÿçš„è°ƒç”¨æ¨¡å‹ï¼Œé™¤äº†æ•°æ®ç»“æ„è½¬åŒ–çš„ä»£ä»·å¤–æ²¡æœ‰é¢å¤–çš„è´Ÿæ‹…ã€‚è€Œä½¿ç”¨ä¼ ç»Ÿ c api åˆ™æ˜¯
é€šè¿‡ lua è™šæ‹Ÿæ ˆæ¥å®ç°ï¼Œå¹¶ä¸”éœ€è¦å’Œ lua çš„è°ƒç”¨æ¨¡å‹å…¼å®¹ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒå¤æ‚ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯ï¼Œå¯¹äºæ¥å…¥ lua çš„ç¨‹åºè€Œè¨€ï¼Œä»…ä»…æ”¯æŒ luajit æ˜¯æœ‰ä¸€å®šé£é™©çš„ï¼Œç›¸å¯¹äº &lt;a href=&#34;https://www.lua.org/&#34;&gt;puc lua&lt;/a&gt;ï¼Œ luajit çš„ä¸»è¦å¼€å‘è€…å’Œç»´æŠ¤è€…
æ¯”è¾ƒå°‘ï¼Œåº”ç”¨é¢ä¹Ÿä¸å¦‚ luaã€‚æ‰€ä»¥å¤§éƒ¨åˆ†çš„é¢ç›¸ lua çš„ç¨‹åºéƒ½ä¼šåŒæ—¶æ”¯æŒ luajit å’Œ luaã€‚ffi æ˜¯ luajit å†…ç½®çš„æ¨¡å—ï¼Œè€Œ lua å´ä¸æºå¸¦è¿™ä¸ªæ¨¡å—ï¼Œ
æœ‰ä¸€äº›å¼€æºçš„é¡¹ç›®ï¼Œ å¦‚ facebook å¼€å‘çš„&lt;a href=&#34;https://github.com/facebook/luaffifb&#34;&gt;è¿™ä¸ª&lt;/a&gt;ï¼Œä½†æ˜¯ç»è¿‡æˆ‘ä»¬çš„æµ‹è¯•å…¶æ•ˆç‡æ¯”æ™®é€šçš„c apiè¿˜æ…¢: (ã€‚
æ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒæŠ˜ä¸­çš„æ–¹æ¡ˆæ˜¯åŒæ—¶æä¾› ffi binding å’Œ c binding çš„æ–¹æ¡ˆï¼Œè¿™æ˜¯å¤§éƒ¨åˆ† lua åº“çš„é€‰æ‹©ã€‚&lt;/p&gt;

&lt;p&gt;å¦‚æœæä¾›çš„æ˜¯ä¸€ä¸ª so åº“ï¼Œé‚£ä¹ˆåªéœ€è¦æä¾›ä¸ª lua å…¥å£æ–‡ä»¶ï¼Œå¦‚æœä½¿ç”¨ ffi çš„è¯ï¼Œåˆ™è°ƒç”¨ç›¸å…³çš„ lua æ–‡ä»¶ã€‚å¦‚æœæ˜¯ c binding çš„è¯ï¼Œé‚£å°±è°ƒç”¨å…·ä½“çš„
soæ–‡ä»¶ã€‚ç„¶è€Œè¿™åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­æ˜¯ä¸å¯è¡Œçš„ï¼Œä¸ºäº†ä¿è¯éƒ¨ç½²çš„ç®€åŒ–ï¼Œæˆ‘ä»¬çš„ç¨‹åºåªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸ä¼šä¾èµ–é™¤ä¸€äº›æ ¸å¿ƒ so åº“ä¹‹å¤–çš„ so åº“ã€‚æ‰€æœ‰çš„
c binding ä»£ç éƒ½æ˜¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢çš„ã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦ &lt;code&gt;ffi.load&lt;/code&gt; æˆ‘ä»¬è‡ªå·±çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¤§æ¦‚çš„ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-C&#34;&gt;// main.c

char* encode(const char* input, size_t size, size_t *out_size) { // å‡è®¾è¿™æ˜¯æˆ‘ä»¬çš„å·¥ä½œå‡½æ•°
    //...
}

// c api
int l_encode(lua_State* L) { // ä¸ºäº†è®©ä¸Šé¢çš„æ¥å£èƒ½è¢« lua è°ƒç”¨ï¼Œéœ€è¦è½¬æ¢ä¸€ä¸‹
    size_t length, out_size;
    char *in_data, *out_data;
    in_data = lua_tolstring(L, 1, &amp;amp;length);
    out_data = encode(in_data, length, &amp;amp;out_size);
    lua_pushlstring(L, out_data, out_size);
    return 1;
}

// register in some place 
lua_pushcfunction(L, l_encode); // æ³¨å†Œåˆ° lua è™šæ‹Ÿæœºä¸­
lua_setglobal(L, &amp;quot;c_encode&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™é‡Œæ˜¯ç»Ÿä¸€çš„å…¥å£æ–‡ä»¶ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;-- ffi.lua

if ffi then -- å¦‚æœèƒ½ä½¿ç”¨ ffi çš„è¯
    lib = ffi.load(????) -- è¿™é‡Œæ”¹æ€ä¹ˆå†™
    ffi.cdef[[
        char* encode(const char* input, size_t size, size_t *out_size);
    ]]
    -- do some dirty jobs
    lib.encode -- ...
else
    encode = c_encode -- ä½¿ç”¨ c api ç‰ˆæœ¬
end


&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç„¶è€Œè¿™æ˜¯ä¸å¯è¡Œçš„ã€‚&lt;/p&gt;

&lt;p&gt;ffi load è°ƒç”¨çš„å…¶å®å°±æ˜¯&lt;a href=&#34;http://man7.org/linux/man-pages/man3/dlopen.3.html&#34;&gt;dlopen&lt;/a&gt;ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ &lt;code&gt;a.out&lt;/code&gt;ï¼Œåœ¨è¿™é‡Œé¢
è°ƒç”¨ &lt;code&gt;dlopen(&amp;quot;a.out&amp;quot;, ...)&lt;/code&gt;ï¼Œå…¶ä½œç”¨æ˜¯å°† &lt;code&gt;a.out&lt;/code&gt; çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼ŒåŠ ä¸Šæˆ‘ä»¬ä¹‹å‰è¿è¡Œ &lt;code&gt;a.out&lt;/code&gt; çš„ç¨‹åºï¼ˆå…¶å®ä¹Ÿæ˜¯ç”¨ &lt;code&gt;/lib64/ld-linux-x86-64.so&lt;/code&gt; åŠ è½½çš„ï¼‰ã€‚
è¿™æ ·å†…å­˜ä¸­å°±æœ‰äº†ä¸¤ä»½ä¸€æ ·çš„é•œåƒï¼Œä¸€ä¸ªå…¨å±€å˜é‡ä¼šå¯¹åº”ä¸¤ä¸ªå†…å­˜åœ°å€ã€‚è¿™ç§äº§ç”Ÿçš„åŸå› å¯ä»¥å‚è€ƒ&lt;a href=&#34;https://book.douban.com/subject/3652388/&#34;&gt;ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;ä½¿ç”¨ç°æœ‰çš„ luajit æ¥å£æ˜¯æ— æ³•åšåˆ°çš„ã€‚ä½†æ˜¯ &lt;code&gt;dlopen&lt;/code&gt; å¯ä»¥&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If filename is  NULL,  then  the  returned handle  is for the main program&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å½“ filename ä¸º NULL æ—¶ï¼Œç›´æ¥è¿”å›å½“å‰ç¨‹åºçš„ dl handleï¼Œå¯ä»¥å–å¾—å„ç§ symbol çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¨å¾®ä¿®æ”¹ä¸‹ luajit çš„å®ç°:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// in lj_clib.c
static const char *clib_extname(lua_State *L, const char *name
{
  if (!name[0]) return NULL; // æ·»åŠ è¿™ä¸€è¡Œ
  if (!strchr(name, &#39;/&#39;)
#if LJ_TARGET_CYGWIN
      &amp;amp;&amp;amp; !strchr(name, &#39;\\&#39;)
#endif
     ) {
    if (!strchr(name, &#39;.&#39;)) {
      name = lj_strfmt_pushf(L, CLIB_SOEXT, name);
      L-&amp;gt;top--;
// ...
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;é‚£ä¹ˆåœ¨åº”ç”¨ä¸­å°±å¯ä»¥è¿™æ ·ä½¿ç”¨äº†&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lua&#34;&gt;local ffi = require(&amp;quot;ffi&amp;quot;)
local lib = ffi.load(&amp;quot;&amp;quot;)
ffi.cdef[[...]]
-- lib.doSomething
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¿™æ ·å¯¹äºå•å¯æ‰§è¡Œæ–‡ä»¶å°±å¯ä»¥æ˜¯çš„ c binding å’Œ ffi binding å…±å­˜äº†ã€‚&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>